<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>äººç‰©å¿— - å¾€æ˜”å›å“</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: "PingFang SC", sans-serif; background: #fff; padding: 40px; color: #333; }
        .back-btn { padding: 8px 15px; border: 1px solid #333; text-decoration: none; color: #333; border-radius: 4px; font-size: 0.9em; }
        .story-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; margin-top: 30px; }
        
        .story-card { 
            border: 1px solid #eee; padding: 20px; border-radius: 8px; 
            cursor: pointer; transition: 0.3s; position: relative; 
            background: #fff; display: flex; flex-direction: column;
        }
        .story-card:hover { border-color: #333; box-shadow: 0 5px 15px rgba(0,0,0,0.08); transform: translateY(-3px); }
        .time-tag { font-size: 0.7em; color: #999; margin-bottom: 8px; }
        .owner-tag { font-size: 0.7em; color: #3498db; margin-top: 10px; border-top: 1px solid #f5f5f5; padding-top: 8px; }
        
        #loading-hint { text-align: center; color: #999; margin-top: 50px; }
    </style>
</head>
<body>
    <a href="index.html" class="back-btn">â¬… è¿”å›ä¸»ç•Œé¢</a>
    <h1>ğŸ“œ äººç‰©å¿— / äº’åŠ¨é—´ç« </h1>
    <p style="color: #666;">åœ¨æ­¤é‡æ¸©é‚£äº›ä¸“å±äºä½ çš„ã€æˆ–æ˜¯è¿™ä¸ªä¸–ç•Œçš„å†å²ç¢å½±ã€‚</p>

    <div id="loading-hint">æ­£åœ¨è¯»å–å› æœè®°å½•...</div>
    <div id="story-grid" class="story-grid"></div>

    <script>
        // Supabase é…ç½®
        const SUPABASE_URL = 'https://vbzfpgucpciqgaakqndz.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZiemZwZ3VjcGNpcWdhYWtxbmR6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc1OTc2MzMsImV4cCI6MjA4MzE3MzYzM30.fBVDirEJ52bvrYJZ5DNv7fVDLNgCwITKwdKqT6YJDYw';
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // --- æ•…äº‹å…ƒæ•°æ®åˆ—è¡¨ ---
        // ä»¥åæœ‰æ–°æ•…äº‹ï¼Œåªéœ€è¦åœ¨è¿™é‡Œå¢åŠ ä¸€é¡¹å³å¯
        const allStories = [
            {
                id: "clem_01",
                owner: "master@almorel.com",
                time: "FR1494 - 2æœˆ",
                title: "æ‰¿è¯ºçš„é‡é‡",
                desc: "å…³äºå…‹è±é—¨æ±€ã€æƒåŠ›ä¸é‚£ä¸€æ ‹å°šæœªäº¤ä»˜çš„å®…é‚¸ã€‚",
                roleName: "å…‹è±é—¨æ±€Â·ç“¦å‹’ç•™æ–¯"
            },
            // ç¤ºä¾‹ï¼šå¦ä¸€ä¸ªæ•…äº‹
            // {
            //     id: "boris_01",
            //     owner: "another_player@qq.com",
            //     time: "FR2025 - ç§‹",
            //     title: "fakerç¬¬å…­å† ",
            //     desc: "é©¬å¤´ç‰›é€¼ã€‚",
            //     roleName: "ç‚«ç‹—"
            // }
        ];

        async function renderStories() {
            const grid = document.getElementById('story-grid');
            const hint = document.getElementById('loading-hint');

            // 1. è·å–å½“å‰ç™»å½•è€…
            const { data: { user } } = await supabaseClient.auth.getUser();
            if (!user) {
                alert("è¯·å…ˆç™»å½•ã€‚");
                window.location.href = 'index.html';
                return;
            }

            // 2. è·å–æƒé™ç­‰çº§
            const { data: admin } = await supabaseClient.from('admin_users').select('role_level').eq('id', user.id).maybeSingle();
            const userRole = admin ? admin.role_level : 'player';

            hint.style.display = 'none';
            grid.innerHTML = '';

            // 3. è¿‡æ»¤å¹¶æ¸²æŸ“
            allStories.forEach(story => {
                // åˆ¤å®šï¼šå¦‚æœæ˜¯ Root/DMï¼Œæˆ–è€…å½“å‰ç”¨æˆ·æ˜¯ ownerï¼Œåˆ™æ˜¾ç¤º
                const hasAccess = (userRole === 'root' || userRole === 'dm' || user.email === story.owner);

                if (hasAccess) {
                    const card = document.createElement('div');
                    card.className = 'story-card';
                    card.onclick = () => window.location.href = `play-story.html?id=${story.id}`;
                    
                    card.innerHTML = `
                        <div class="time-tag">${story.time}</div>
                        <div style="font-weight:bold; font-size:1.1em; color:#2c3e50;">${story.title}</div>
                        <p style="font-size:0.85em; color:#666; margin:10px 0; flex-grow:1;">${story.desc}</p>
                        <div class="owner-tag">
                            è§’è‰²ï¼š${story.roleName} 
                            ${(userRole === 'root' || userRole === 'dm') ? `<br><span style="color:#e67e22">[æ‰€å±: ${story.owner}]</span>` : ''}
                        </div>
                    `;
                    grid.appendChild(card);
                }
            });

            if (grid.innerHTML === '') {
                grid.innerHTML = '<p style="color:#999; grid-column:1/-1; text-align:center;">ç›®å‰æ²¡æœ‰å±äºä½ çš„é—´ç« æ•…äº‹ã€‚</p>';
            }
        }

        renderStories();
    </script>
</body>
</html>
