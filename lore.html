<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>äººç‰©å¿— - å¾€æ˜”å›å“</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="stories/list.js"></script> <!-- å¼•å…¥æ•…äº‹åˆ—è¡¨ -->
    <style>
        body { font-family: "PingFang SC", sans-serif; background: #fff; padding: 40px; color: #333; }
        .back-btn { padding: 8px 15px; border: 1px solid #333; text-decoration: none; color: #333; border-radius: 4px; }
        .story-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; margin-top: 30px; }
        .story-card { border: 1px solid #eee; padding: 20px; border-radius: 8px; cursor: pointer; transition: 0.2s; position: relative; }
        .story-card:hover { border-color: #333; box-shadow: 0 5px 15px rgba(0,0,0,0.05); transform: translateY(-3px); }
        .time-tag { font-size: 0.7em; color: #999; margin-bottom: 5px; }
        .owner-tag { font-size: 0.7em; color: #3498db; margin-top: 10px; border-top: 1px solid #f5f5f5; padding-top: 5px; }
    </style>
</head>
<body>
    <a href="index.html" class="back-btn">â¬… è¿”å›ä¸»ç•Œé¢</a>
    <h1>ğŸ“œ äººç‰©å¿— / äº’åŠ¨é—´ç« </h1>
    <div id="loading">æ­£åœ¨è¿æ¥ä½é¢ï¼Œæ£€ç´¢å› æœè®°å½•...</div>
    <div id="story-grid" class="story-grid"></div>

    <script>
        const SUPABASE_URL = 'https://vbzfpgucpciqgaakqndz.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZiemZwZ3VjcGNpcWdhYWtxbmR6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc1OTc2MzMsImV4cCI6MjA4MzE3MzYzM30.fBVDirEJ52bvrYJZ5DNv7fVDLNgCwITKwdKqT6YJDYw';
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        async function init() {
            const { data: { user } } = await supabaseClient.auth.getUser();
            if (!user) { window.location.href = 'index.html'; return; }

            // 1. è·å–æˆ‘çš„è§’è‰²å’Œè´Ÿè´£çš„ç©å®¶
            const { data: admin } = await supabaseClient.from('admin_users').select('role_level').eq('id', user.id).maybeSingle();
            const role = admin ? admin.role_level : 'player';

            // 2. å¦‚æœæ˜¯ DMï¼ŒæŸ¥å‡ºæˆ‘è´Ÿè´£çš„æ‰€æœ‰ç©å®¶ Email
            let myPlayers = [];
            if (role === 'dm') {
                const { data: profiles } = await supabaseClient.from('profiles').select('email').eq('assigned_dm_id', user.id);
                myPlayers = profiles.map(p => p.email);
            }

            // 3. è¿‡æ»¤æ•…äº‹åˆ—è¡¨
            const visibleStories = storyList.filter(story => {
                if (role === 'root') return true; // Root çœ‹æ‰€æœ‰
                if (user.email === story.owner) return true; // ç©å®¶çœ‹è‡ªå·±çš„
                if (role === 'dm' && myPlayers.includes(story.owner)) return true; // DM çœ‹è‡ªå·±æ‰‹ä¸‹ç©å®¶çš„
                return false;
            });

            // 4. æ¸²æŸ“
            document.getElementById('loading').style.display = 'none';
            const grid = document.getElementById('story-grid');
            
            if (visibleStories.length === 0) {
                grid.innerHTML = "<p style='color:#999'>ç›®å‰æ²¡æœ‰ä»»ä½•å±äºä½ çš„æ•…äº‹è®°è½½ã€‚</p>";
                return;
            }

            visibleStories.forEach(s => {
                grid.innerHTML += `
                    <div class="story-card" onclick="window.location.href='play-story.html?id=${s.id}'">
                        <div class="time-tag">${s.date}</div>
                        <div style="font-weight:bold; font-size:1.1em;">${s.title}</div>
                        <p style="font-size:0.85em; color:#666;">${s.description}</p>
                        <div class="owner-tag">æŒæœ‰è€…: ${s.owner}</div>
                    </div>`;
            });
        }

        init();
    </script>
</body>
</html>
