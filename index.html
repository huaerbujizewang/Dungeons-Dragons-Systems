<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>D&D ç³»ç»Ÿ - å•†åº—ä¸èµ„äº§</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: "PingFang SC", sans-serif; background: #fff; color: #333; margin: 0; padding: 20px; }
        .container { max-width: 1000px; margin: 0 auto; }
        
        /* å¯¼èˆªæ  */
        .nav { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #333; padding-bottom: 10px; margin-bottom: 20px; }
        .tab-btn { padding: 10px 20px; cursor: pointer; border: none; background: none; font-size: 1.1em; }
        .tab-btn.active { font-weight: bold; border-bottom: 3px solid #333; }
        .user-assets { text-align: right; }
        .gold-display { color: #d35400; font-weight: bold; font-size: 1.2em; }

        /* å†…å®¹åŒº */
        .section { display: none; }
        .section.active { display: block; }

        /* å•†åº—æ ·å¼ */
        .filter-bar { margin-bottom: 20px; display: flex; gap: 8px; flex-wrap: wrap; }
        .filter-btn { padding: 4px 10px; border: 1px solid #ddd; background: #fff; cursor: pointer; font-size: 0.85em; }
        .filter-btn.active { background: #333; color: #fff; }
        .item-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 20px; }
        .item-card { border: 1px solid #eee; padding: 15px; border-radius: 4px; position: relative; }
        .rarity-tag { font-size: 0.7em; padding: 2px 6px; color: #fff; border-radius: 2px; position: absolute; top: 10px; right: 10px; }

        /* èƒŒåŒ…æ ·å¼ */
        .inventory-category { margin-top: 30px; }
        .inventory-category h3 { border-left: 4px solid #333; padding-left: 10px; margin-bottom: 15px; }
        .inventory-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 15px; }
        .inv-card { background: #f9f9f9; padding: 12px; border-radius: 4px; font-size: 0.9em; display: flex; justify-content: space-between; }
        .inv-qty { font-weight: bold; color: #7f8c8d; }

        /* ç®¡ç†é¢æ¿ */
        #admin-panel { display: none; position: fixed; top: 10%; left: 10%; width: 80%; height: 80%; background: white; border: 2px solid #333; z-index: 100; padding: 20px; overflow-y: auto; box-shadow: 0 0 20px rgba(0,0,0,0.2); }

        button { cursor: pointer; }
        .btn-main { background: #333; color: #fff; border: none; padding: 8px 15px; width: 100%; margin-top: 10px; }
        .btn-main:disabled { background: #ccc; }
    </style>
</head>
<body>

<div class="container">
    <div id="login-section" style="max-width:300px; margin:100px auto; text-align:center;">
        <h2>D&D èµ„äº§ç®¡ç†ç³»ç»Ÿ</h2>
        <input type="email" id="login-email" placeholder="é‚®ç®±" style="width:100%; padding:10px; margin-bottom:10px;">
        <input type="password" id="login-password" placeholder="å¯†ç " style="width:100%; padding:10px; margin-bottom:10px;">
        <button onclick="login()" class="btn-main">è¿›å…¥ç³»ç»Ÿ</button>
    </div>

    <div id="main-section" style="display:none;">
        <div class="nav">
            <div>
                <button class="tab-btn active" onclick="switchTab('shop')">é›†å¸‚</button>
                <button class="tab-btn" onclick="switchTab('inventory')">æˆ‘çš„èƒŒåŒ…</button>
                <span id="admin-link" style="display:none; color:blue; cursor:pointer; margin-left:20px;" onclick="toggleAdmin()">âš™ï¸ DMåå°</span>
            </div>
            <div class="user-assets">
                <span class="gold-display">ğŸ’° <span id="gold-amount">0</span> GP</span>
                <div style="font-size:0.7em; color:#999;" id="user-email-display"></div>
                <button onclick="logout()" style="font-size:0.7em; border:none; background:none; text-decoration:underline; cursor:pointer;">é€€å‡º</button>
            </div>
        </div>

        <!-- å•†åº—éƒ¨åˆ† -->
        <div id="shop-section" class="section active">
            <div class="filter-bar" id="filter-bar">
                <!-- åŠ¨æ€ç”Ÿæˆè¿‡æ»¤æŒ‰é’® -->
            </div>
            <div id="shop-grid" class="item-list"></div>
        </div>

        <!-- èƒŒåŒ…éƒ¨åˆ† -->
        <div id="inventory-section" class="section">
            <div id="inventory-container">
                <!-- åŠ¨æ€ç”Ÿæˆåˆ†ç±»èƒŒåŒ…è£…è½½ -->
            </div>
        </div>
    </div>
</div>

<!-- DM ç®¡ç†é¢æ¿ -->
<div id="admin-panel">
    <div style="display:flex; justify-content:space-between;"><h3>DM ç‰©èµ„è¡¥ç»™ç®¡ç†</h3><button onclick="toggleAdmin()">å…³é—­</button></div>
    <hr>
    <p>æ–°å¢ç‰©å“ï¼š</p>
    <input type="text" id="adm-name" placeholder="åç§°">
    <select id="adm-rarity">
        <option value="æ™®é€š">æ™®é€š</option><option value="éæ™®é€š">éæ™®é€š</option>
        <option value="çç¨€">çç¨€</option><option value="æçç¨€">æçç¨€</option>
        <option value="ä¼ è¯´">ä¼ è¯´</option><option value="ç¥å™¨">ç¥å™¨</option>
    </select>
    <select id="adm-category">
        <option value="è£…å¤‡">è£…å¤‡</option><option value="é­”æ³•ç‰©å“">é­”æ³•ç‰©å“</option>
        <option value="è¯æ°´">è¯æ°´</option><option value="å·è½´">å·è½´</option>
    </select>
    <input type="number" id="adm-price" placeholder="ä»·æ ¼ GP">
    <input type="number" id="adm-stock" placeholder="æ•°é‡" value="1">
    <textarea id="adm-desc" placeholder="æè¿°"></textarea>
    <button onclick="adminAddItem()" class="btn-main" style="background:green">ç¡®è®¤ä¸Šæ¶</button>
</div>

<script>
    const SUPABASE_URL = 'https://vbzfpgucpciqgaakqndz.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZiemZwZ3VjcGNpcWdhYWtxbmR6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc1OTc2MzMsImV4cCI6MjA4MzE3MzYzM30.fBVDirEJ52bvrYJZ5DNv7fVDLNgCwITKwdKqT6YJDYw';
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    let userProfile = null;
    let shopItems = [];
    const DM_EMAIL = '739477825@qq.com';
    const rarityColors = { 'æ™®é€š': '#95a5a6', 'éæ™®é€š': '#2ecc71', 'çç¨€': '#3498db', 'æçç¨€': '#9b59b6', 'ä¼ è¯´': '#f1c40f', 'ç¥å™¨': '#e74c3c' };

    async function login() {
        const email = document.getElementById('login-email').value;
        const password = document.getElementById('login-password').value;
        const { data, error } = await supabaseClient.auth.signInWithPassword({ email, password });
        if (error) alert(error.message); else checkUser();
    }

    async function logout() { await supabaseClient.auth.signOut(); location.reload(); }

    async function checkUser() {
        const { data: { user } } = await supabaseClient.auth.getUser();
        if (user) {
            document.getElementById('login-section').style.display = 'none';
            document.getElementById('main-section').style.display = 'block';
            document.getElementById('user-email-display').innerText = user.email;
            if (user.email === DM_EMAIL) document.getElementById('admin-link').style.display = 'inline';
            loadAllData();
        }
    }

    async function loadAllData() {
        const { data: { user } } = await supabaseClient.auth.getUser();
        // åŠ è½½é‡‘å¸
        const { data: profile } = await supabaseClient.from('profiles').select('*').eq('id', user.id).single();
        userProfile = profile;
        document.getElementById('gold-amount').innerText = profile ? profile.gold_gp : 0;
        
        loadShop();
        loadInventory();
    }

    async function loadShop() {
        const { data } = await supabaseClient.from('shop_items').select('*').order('rarity');
        const grid = document.getElementById('shop-grid');
        grid.innerHTML = '';
        data.forEach(item => {
            const card = document.createElement('div');
            card.className = 'item-card';
            const color = rarityColors[item.rarity];
            card.innerHTML = `
                <span class="rarity-tag" style="background:${color}">${item.rarity}</span>
                <div style="font-weight:bold">${item.name}</div>
                <div style="font-size:0.8em; color:#666; margin:5px 0">${item.description || ''}</div>
                <div style="color:#d35400; font-weight:bold">${item.price} GP</div>
                <div style="font-size:0.75em; color:#999">åº“å­˜: ${item.stock}</div>
                <button class="btn-main" onclick="buyItem(${item.id}, ${item.price}, '${item.name}', '${item.category}')" ${item.stock <= 0 ? 'disabled' : ''}>
                    ${item.stock <= 0 ? 'ç¼ºè´§' : 'è´­ä¹°'}
                </button>
            `;
            grid.appendChild(card);
        });
    }

    async function loadInventory() {
        const { data: { user } } = await supabaseClient.auth.getUser();
        const { data } = await supabaseClient.from('user_inventory').select('*').order('category');
        const container = document.getElementById('inventory-container');
        container.innerHTML = '';

        const categories = [...new Set(data.map(i => i.category))];
        categories.forEach(cat => {
            const section = document.createElement('div');
            section.className = 'inventory-category';
            section.innerHTML = `<h3>${cat || 'æ‚é¡¹'}</h3>`;
            const grid = document.createElement('div');
            grid.className = 'inventory-grid';
            data.filter(i => i.category === cat).forEach(item => {
                grid.innerHTML += `<div class="inv-card"><span>${item.item_name}</span> <span class="inv-qty">x${item.quantity}</span></div>`;
            });
            section.appendChild(grid);
            container.appendChild(section);
        });
    }

    async function buyItem(id, price, name, category) {
        if (userProfile.gold_gp < price) { alert('é‡‘å¸ä¸è¶³ï¼'); return; }
        if (!confirm(`ç¡®å®šèŠ±è´¹ ${price} GP è´­ä¹° ${name} å—ï¼Ÿ`)) return;

        // 1. æ‰£é’±
        const newGold = userProfile.gold_gp - price;
        await supabaseClient.from('profiles').update({ gold_gp: newGold }).eq('id', userProfile.id);

        // 2. å‡åº“å­˜
        const { data: item } = await supabaseClient.from('shop_items').select('stock').eq('id', id).single();
        await supabaseClient.from('shop_items').update({ stock: item.stock - 1 }).eq('id', id);

        // 3. è¿›èƒŒåŒ… (æ£€æŸ¥æ˜¯å¦å·²æœ‰)
        const { data: invItem } = await supabaseClient.from('user_inventory').select('*').eq('user_id', userProfile.id).eq('item_name', name).maybeSingle();
        if (invItem) {
            await supabaseClient.from('user_inventory').update({ quantity: invItem.quantity + 1 }).eq('id', invItem.id);
        } else {
            await supabaseClient.from('user_inventory').insert([{ user_id: userProfile.id, item_name: name, quantity: 1, category: category }]);
        }

        alert('è´­ä¹°æˆåŠŸï¼');
        loadAllData();
    }

    function switchTab(tab) {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        document.querySelector(`.tab-btn[onclick*="${tab}"]`).classList.add('active');
        document.getElementById(`${tab}-section`).classList.add('active');
    }

    function toggleAdmin() { const p = document.getElementById('admin-panel'); p.style.display = p.style.display === 'block' ? 'none' : 'block'; }

    async function adminAddItem() {
        const name = document.getElementById('adm-name').value;
        const rarity = document.getElementById('adm-rarity').value;
        const category = document.getElementById('adm-category').value;
        const price = document.getElementById('adm-price').value;
        const stock = document.getElementById('adm-stock').value;
        const desc = document.getElementById('adm-desc').value;

        await supabaseClient.from('shop_items').insert([{ name, rarity, category, price, stock, description: desc }]);
        alert('ä¸Šæ¶æˆåŠŸ');
        toggleAdmin();
        loadShop();
    }

    checkUser();
</script>
</body>
</html>
