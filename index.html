<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>D&D å†’é™©è€…å•†åº—ç³»ç»Ÿ</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --common: #95a5a6; --uncommon: #2ecc71; --rare: #3498db;
            --very-rare: #9b59b6; --legendary: #f1c40f; --artifact: #e74c3c;
        }
        body { font-family: "PingFang SC", "Microsoft YaHei", sans-serif; background: #fff; color: #333; margin: 0; padding: 20px; }
        .container { max-width: 900px; margin: 0 auto; }
        
        /* å¯¼èˆª */
        .nav { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; padding-bottom: 15px; margin-bottom: 20px; }
        .user-info { font-size: 0.85em; color: #666; }
        .admin-link { color: #3498db; cursor: pointer; text-decoration: underline; margin-right: 15px; display: none; }
        
        /* ç­›é€‰å™¨ */
        .filter-bar { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 30px; }
        .filter-btn { padding: 6px 12px; border: 1px solid #ddd; border-radius: 4px; background: none; cursor: pointer; font-size: 0.85em; }
        .filter-btn.active { background: #333; color: #fff; border-color: #333; }

        /* å•†å“åˆ—è¡¨ */
        .item-list { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .item-card { border: 1px solid #f0f0f0; padding: 15px; border-radius: 8px; position: relative; }
        .rarity-tag { font-size: 0.7em; padding: 2px 6px; border-radius: 3px; color: #fff; position: absolute; top: 15px; right: 15px; }
        .item-name { font-weight: bold; font-size: 1.1em; margin-bottom: 5px; display: block; }
        .item-desc { font-size: 0.85em; color: #7f8c8d; margin-bottom: 10px; line-height: 1.4; }
        .price { font-weight: bold; color: #d35400; }
        .stock { font-size: 0.8em; color: #999; margin-left: 10px; }
        
        /* æŒ‰é’®æ ·å¼ */
        button { cursor: pointer; transition: 0.2s; }
        .buy-btn { width: 100%; margin-top: 10px; padding: 8px; background: #fff; border: 1px solid #333; }
        .buy-btn:hover { background: #333; color: #fff; }
        .buy-btn:disabled { border-color: #eee; color: #ccc; cursor: not-allowed; }

        /* ç®¡ç†é¢æ¿å¼¹çª— */
        #admin-panel { display: none; position: fixed; top: 5%; left: 5%; width: 90%; height: 90%; background: white; border: 2px solid #333; z-index: 100; padding: 20px; box-sizing: border-box; overflow-y: auto; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-size: 0.9em; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
        
        #login-section { max-width: 300px; margin: 100px auto; text-align: center; border: 1px solid #eee; padding: 40px; }
        #shop-section { display: none; }
    </style>
</head>
<body>

<div class="container">
    <!-- ç™»å½• -->
    <div id="login-section">
        <h2>å›¢é˜Ÿé€šè¡Œ</h2>
        <input type="email" id="email" placeholder="é‚®ç®±">
        <input type="password" id="password" placeholder="å¯†ç ">
        <button onclick="login()" style="width:100%; padding:10px; background:#333; color:#fff;">è¿›å…¥</button>
        <p id="login-error" style="color:red; font-size:0.8em;"></p>
    </div>

    <!-- å•†åº— -->
    <div id="shop-section">
        <div class="nav">
            <div class="user-info">
                <span id="admin-entry" class="admin-link" onclick="toggleAdmin()">âš™ï¸ ç®¡ç†é¢æ¿</span>
                ç”¨æˆ·: <span id="user-display"></span>
            </div>
            <button onclick="logout()" style="border:none; background:none; text-decoration:underline; color:#999; font-size:0.8em;">é€€å‡º</button>
        </div>

        <header style="text-align:center; margin-bottom:30px;">
            <h1 style="font-weight:300;">å†’é™©è€…è¡¥ç»™ç«™</h1>
        </header>

        <div class="filter-bar" id="filter-bar">
            <button class="filter-btn active" onclick="setFilter('å…¨éƒ¨')">å…¨éƒ¨</button>
            <button class="filter-btn" onclick="setFilter('æ™®é€š')">æ™®é€š</button>
            <button class="filter-btn" onclick="setFilter('éæ™®é€š')">éæ™®é€š</button>
            <button class="filter-btn" onclick="setFilter('çç¨€')">çç¨€</button>
            <button class="filter-btn" onclick="setFilter('æçç¨€')">æçç¨€</button>
            <button class="filter-btn" onclick="setFilter('ä¼ è¯´')">ä¼ è¯´</button>
            <button class="filter-btn" onclick="setFilter('ç¥å™¨')">ç¥å™¨</button>
        </div>

        <div id="shop-grid" class="item-list"></div>
    </div>
</div>

<!-- DMç®¡ç†é¢æ¿ -->
<div id="admin-panel">
    <div style="display:flex; justify-content:space-between;">
        <h3>DM è¿›è´§ç®¡ç†</h3>
        <button onclick="toggleAdmin()">å…³é—­</button>
    </div>
    <hr>
    <div class="form-group">
        <label>ç‰©å“åç§°</label>
        <input type="text" id="new-name">
    </div>
    <div class="form-group">
        <label>ç¨€æœ‰åº¦</label>
        <select id="new-rarity">
            <option value="æ™®é€š">æ™®é€š</option>
            <option value="éæ™®é€š">éæ™®é€š</option>
            <option value="çç¨€">çç¨€</option>
            <option value="æçç¨€">æçç¨€</option>
            <option value="ä¼ è¯´">ä¼ è¯´</option>
            <option value="ç¥å™¨">ç¥å™¨</option>
        </select>
    </div>
    <div class="form-group">
        <label>ä»·æ ¼ (GP)</label>
        <input type="number" id="new-price">
    </div>
    <div class="form-group">
        <label>åˆå§‹åº“å­˜</label>
        <input type="number" id="new-stock" value="1">
    </div>
    <div class="form-group">
        <label>ç‰©å“æè¿°</label>
        <textarea id="new-desc" rows="3"></textarea>
    </div>
    <button onclick="addItem()" style="width:100%; padding:10px; background:#2ecc71; color:#fff; border:none;">ç¡®è®¤è¿›è´§</button>
</div>

<script>
    const SUPABASE_URL = 'https://vbzfpgucpciqgaakqndz.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZiemZwZ3VjcGNpcWdhYWtxbmR6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc1OTc2MzMsImV4cCI6MjA4MzE3MzYzM30.fBVDirEJ52bvrYJZ5DNv7fVDLNgCwITKwdKqT6YJDYw';
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    let currentFilter = 'å…¨éƒ¨';
    const DM_EMAIL = '739477825@qq.com';

    const rarityColors = { 'æ™®é€š': '#95a5a6', 'éæ™®é€š': '#2ecc71', 'çç¨€': '#3498db', 'æçç¨€': '#9b59b6', 'ä¼ è¯´': '#f1c40f', 'ç¥å™¨': '#e74c3c' };

    async function login() {
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        const { error } = await supabaseClient.auth.signInWithPassword({ email, password });
        if (error) alert(error.message);
        else checkUser();
    }

    async function logout() { await supabaseClient.auth.signOut(); checkUser(); }

    async function checkUser() {
        const { data: { user } } = await supabaseClient.auth.getUser();
        if (user) {
            document.getElementById('login-section').style.display = 'none';
            document.getElementById('shop-section').style.display = 'block';
            document.getElementById('user-display').innerText = user.email;
            // åˆ¤æ–­æ˜¯å¦æ˜¾ç¤ºç®¡ç†å…¥å£
            if (user.email === DM_EMAIL) {
                document.getElementById('admin-entry').style.display = 'inline';
            }
            loadShop();
        } else {
            document.getElementById('login-section').style.display = 'block';
            document.getElementById('shop-section').style.display = 'none';
        }
    }

    function setFilter(rarity) {
        currentFilter = rarity;
        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.classList.toggle('active', btn.innerText === rarity);
        });
        loadShop();
    }

    async function loadShop() {
        const grid = document.getElementById('shop-grid');
        grid.innerHTML = 'åŠ è½½ä¸­...';

        let query = supabaseClient.from('shop_items').select('*').order('id', { ascending: false });
        if (currentFilter !== 'å…¨éƒ¨') {
            query = query.eq('rarity', currentFilter);
        }

        const { data, error } = await query;
        if (error) return;

        grid.innerHTML = '';
        data.forEach(item => {
            const card = document.createElement('div');
            card.className = 'item-card';
            const color = rarityColors[item.rarity] || '#eee';
            const isOut = item.stock <= 0;

            card.innerHTML = `
                <span class="rarity-tag" style="background:${color}">${item.rarity}</span>
                <span class="item-name">${item.name}</span>
                <div class="item-desc">${item.description || 'æ— æè¿°'}</div>
                <div class="price">ğŸ’° ${item.price} GP <span class="stock">åº“å­˜: ${item.stock}</span></div>
                <button class="buy-btn" ${isOut ? 'disabled' : ''} onclick="buy(${item.id}, ${item.stock})">
                    ${isOut ? 'å”®ç½„' : 'è´­ä¹°'}
                </button>
            `;
            grid.appendChild(card);
        });
    }

    async function buy(id, stock) {
        if (!confirm('ç¡®è®¤è´­ä¹°ï¼Ÿ')) return;
        const { error } = await supabaseClient.from('shop_items').update({ stock: stock - 1 }).eq('id', id);
        if (error) alert(error.message);
        else loadShop();
    }

    // DM ç®¡ç†åŠŸèƒ½
    function toggleAdmin() {
        const panel = document.getElementById('admin-panel');
        panel.style.display = panel.style.display === 'block' ? 'none' : 'block';
    }

    async function addItem() {
        const name = document.getElementById('new-name').value;
        const rarity = document.getElementById('new-rarity').value;
        const price = document.getElementById('new-price').value;
        const stock = document.getElementById('new-stock').value;
        const description = document.getElementById('new-desc').value;

        if (!name || !price) { alert('è¯·å¡«å†™åç§°å’Œä»·æ ¼'); return; }

        const { error } = await supabaseClient.from('shop_items').insert([{ name, rarity, price, stock, description }]);
        if (error) alert(error.message);
        else {
            alert('è¿›è´§æˆåŠŸï¼');
            toggleAdmin();
            loadShop();
        }
    }

    checkUser();
</script>
</body>
</html>
