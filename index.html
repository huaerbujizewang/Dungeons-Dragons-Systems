<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>D&D å°é˜Ÿç®¡ç†ç³»ç»Ÿ</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --border: #e0e0e0; --bg: #f8f9fa; --active: #333; }
        body { font-family: "PingFang SC", sans-serif; background: #fff; color: #333; margin: 0; padding: 20px; }
        .container { max-width: 1100px; margin: 0 auto; }
        
        /* å¯¼èˆª */
        .nav { display: flex; gap: 10px; border-bottom: 2px solid #333; padding-bottom: 10px; margin-bottom: 20px; align-items: center; }
        .tab-btn { padding: 8px 16px; border: 1px solid transparent; background: none; cursor: pointer; font-size: 1em; color: #666; border-radius: 4px; }
        .tab-btn.active { background: #333; color: #fff; font-weight: bold; }
        .info-bar { margin-left: auto; text-align: right; font-size: 0.9em; }
        .section { display: none; }
        .section.active { display: block; }
        
        /* æ ‡é¢˜åˆ†å‰²çº¿ */
        .section-title { margin: 30px 0 15px 0; border-left: 5px solid #333; padding-left: 10px; font-weight: bold; font-size: 1.1em; color: #444; background: #f9f9f9; padding-top: 5px; padding-bottom: 5px; }
        
        /* ç½‘æ ¼å¸ƒå±€ */
        .team-grid, .shop-grid, .inventory-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 20px; }
        
        /* å¡ç‰‡é€šç”¨ */
        .card, .team-card, .inv-card { background: #fff; border: 1px solid var(--border); border-radius: 8px; padding: 15px; position: relative; transition: 0.2s; }
        .card:hover, .team-card:hover { box-shadow: 0 4px 10px rgba(0,0,0,0.05); border-color: #ccc; }
        
        /* é˜Ÿä¼å¡ç‰‡ç‰¹æœ‰ */
        .team-header { display: flex; align-items: center; gap: 15px; margin-bottom: 15px; }
        .team-avatar { width: 60px; height: 60px; border-radius: 50%; object-fit: cover; background: #eee; border: 1px solid #ddd; }
        .team-info h3 { margin: 0; font-size: 1.1em; }
        .team-info p { margin: 2px 0 0; font-size: 0.8em; color: #666; }
        .btn-leave { position: absolute; top: 10px; right: 10px; font-size: 0.7em; color: #999; cursor: pointer; border: 1px solid #eee; padding: 2px 6px; border-radius: 4px; }
        .btn-leave:hover { background: #eee; color: #333; }

        /* è£…å¤‡æ§½ */
        .slots-container { display: grid; grid-template-columns: repeat(5, 1fr); gap: 6px; }
        .slot { aspect-ratio: 1; border: 1px dashed #ccc; border-radius: 4px; display: flex; align-items: center; justify-content: center; font-size: 0.7em; text-align: center; cursor: pointer; background: #fafafa; padding: 2px; overflow: hidden; transition: 0.2s; }
        .slot:hover { border-color: #333; background: #f0f0f0; }
        .slot.filled { border: 1px solid #999; background: #fff; border-style: solid; color: #333; font-weight: 600; }
        .slot-name { word-break: break-all; pointer-events: none; transform: scale(0.9); }
        
        /* é›‡å‘˜ä¸­å¿ƒå¡ç‰‡ */
        .emp-card-content { text-align: center; }
        .emp-card-content img { width: 70px; height: 70px; border-radius: 50%; object-fit: cover; margin-bottom: 10px; border: 1px solid #eee; }
        
        /* å¼¹çª— & Loading */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; align-items: center; justify-content: center; }
        .modal-box { background: #fff; padding: 20px; border-radius: 8px; width: 400px; max-height: 80vh; overflow-y: auto; }
        .item-select-list div { padding: 10px; border-bottom: 1px solid #eee; cursor: pointer; display: flex; justify-content: space-between; }
        .item-select-list div:hover { background: #f9f9f9; }
        #loading-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.8); z-index: 5000; align-items: center; justify-content: center; flex-direction: column; }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #333; border-radius: 50%; width: 40px; height: 40px; animation: spin 0.8s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* æŒ‰é’® */
        button { cursor: pointer; }
        .btn-buy { width: 100%; margin-top: 10px; padding: 6px; background: #fff; border: 1px solid #333; }
        .btn-buy:hover { background: #333; color: #fff; }
        .danger-btn { color: #e74c3c; border-color: #e74c3c; margin-top: 8px; width: 100%; padding: 4px; background: none; border: 1px solid; border-radius: 4px; font-size: 0.9em; }
        .danger-btn:hover { background: #e74c3c; color: white; }
        .add-member-card { border: 2px dashed #ddd; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #999; cursor: pointer; min-height: 200px; }
        .add-member-card:hover { border-color: #333; color: #333; }

        #admin-panel { display: none; position: fixed; top: 5%; left: 5%; width: 90%; height: 90%; background: #fff; border: 2px solid #333; z-index: 3000; padding: 20px; overflow-y: auto; }
    </style>
</head>
<body>

<!-- Loading é®ç½© -->
<div id="loading-overlay">
    <div class="spinner"></div>
    <div style="margin-top:15px; color:#555; font-weight:bold;">åŒæ­¥ä¸­...</div>
</div>

<div class="container">
    <div id="login-section" style="max-width:300px; margin:100px auto; text-align:center;">
        <h2>å†’é™©è€…å·¥ä¼šç»ˆç«¯</h2>
        <input type="email" id="login-email" placeholder="é‚®ç®±" style="width:100%; padding:10px; margin-bottom:10px;">
        <input type="password" id="login-password" placeholder="å¯†ç " style="width:100%; padding:10px; margin-bottom:10px;">
        <button onclick="login()" style="width:100%; padding:10px; background:#333; color:#fff; border:none;">å¯åŠ¨</button>
    </div>

    <div id="main-section" style="display:none;">
        <div class="nav">
            <button class="tab-btn active" onclick="switchTab('shop')">é›†å¸‚</button>
            <button class="tab-btn" onclick="switchTab('team')">é˜Ÿä¼</button>
            <button class="tab-btn" onclick="switchTab('inventory')">èƒŒåŒ…</button>
            <button class="tab-btn" onclick="switchTab('employees')">é›‡å‘˜ä¸­å¿ƒ</button>
            <span id="admin-link" style="display:none; color:#3498db; cursor:pointer; font-weight:bold" onclick="toggleAdmin()">âš™ï¸ DM</span>
            
            <div class="info-bar">
                <div id="date-text" style="font-weight:bold; background:#f1c40f; display:inline-block; padding:2px 6px; border-radius:4px;"></div>
                <div style="color:#d35400; font-weight:bold; margin-top:4px;">ğŸ’° <span id="gold-amount">0</span> GP</div>
                <a href="#" onclick="logout()" style="color:#999; font-size:0.8em;">é€€å‡º</a>
            </div>
        </div>

        <div id="shop-section" class="section active"><div id="shop-grid" class="shop-grid"></div></div>

        <!-- é˜Ÿä¼é¢æ¿ (ç»Ÿä¸€æ˜¾ç¤º) -->
        <div id="team-section" class="section">
            <div id="team-grid" class="team-grid"></div>
        </div>

        <div id="inventory-section" class="section"><div id="inventory-container"></div></div>
        
        <!-- é›‡å‘˜ä¸­å¿ƒ (åˆ†ç±»æ˜¾ç¤º) -->
        <div id="employees-section" class="section">
            <div id="emp-container"></div>
        </div>
    </div>
</div>

<!-- å¼¹çª— -->
<div id="equip-modal" class="modal">
    <div class="modal-box">
        <h3>é€‰æ‹©è¦è£…å¤‡çš„ç‰©å“</h3>
        <div id="equip-list" class="item-select-list"></div>
        <button onclick="closeModal('equip-modal')" style="width:100%; margin-top:15px; padding:10px;">å–æ¶ˆ</button>
    </div>
</div>
<div id="member-modal" class="modal">
    <div class="modal-box">
        <h3>é€‰æ‹©åŠ å…¥é˜Ÿä¼çš„æˆå‘˜</h3>
        <p style="font-size:0.8em;color:#999">ä»…æ˜¾ç¤ºåœ¨èŒä¸”æœªå…¥é˜Ÿçš„äººå‘˜</p>
        <div id="member-select-list" class="item-select-list"></div>
        <button onclick="closeModal('member-modal')" style="width:100%; margin-top:15px; padding:10px;">å–æ¶ˆ</button>
    </div>
</div>

<!-- DMåå° -->
<div id="admin-panel">
    <div style="display:flex; justify-content:space-between; margin-bottom:20px; border-bottom:1px solid #eee; padding-bottom:10px;">
        <h2 style="margin:0">DM ä¸Šå¸æ§åˆ¶å°</h2>
        <button onclick="toggleAdmin()" style="background:#e74c3c; color:white; border:none; padding:8px 16px; border-radius:4px;">å…³é—­é¢æ¿</button>
    </div>
    
    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px; height: 85%;">
        
        <!-- å·¦ä¾§ï¼šåŠŸèƒ½åŒº -->
        <div style="display:flex; flex-direction:column; gap:20px; overflow-y:auto;">
            <!-- æ—¶é—´ -->
            <div class="admin-box" style="border:1px solid #ddd; padding:15px; border-radius:8px;">
                <h3 style="margin-top:0">â³ æ—¶é—´æµé€</h3>
                <button onclick="advanceTime()" style="width:100%; padding:10px; background:#f1c40f; font-weight:bold; border:none; border-radius:4px;">æ¨è¿›ä¸€å¤© (Next Day)</button>
            </div>

            <!-- ç©å®¶ç®¡ç† -->
            <div class="admin-box" style="border:1px solid #333; padding:15px; border-radius:8px; background:#fafafa;">
                <h3 style="margin-top:0">ğŸ‘¤ ç©å®¶èµ„äº§æ“æ§</h3>
                <div style="display:flex; gap:10px; margin-bottom:10px;">
                    <select id="adm-user-list" onchange="loadUserDetail()" style="flex:1; padding:8px;">
                        <option value="">-- é€‰æ‹©ç©å®¶ --</option>
                    </select>
                    <button onclick="loadAdminData()">ğŸ”„</button>
                </div>
                
                <div id="user-detail" style="display:none; border-top:1px solid #ccc; padding-top:10px;">
                    <div style="margin-bottom:10px;">
                        <label>ğŸ’° é‡‘å¸:</label>
                        <input type="number" id="adm-user-gold" style="width:80px; padding:5px;">
                        <button onclick="updateUserGold()" style="background:#2ecc71; color:white; border:none; padding:5px 10px; border-radius:4px;">æ”¹</button>
                    </div>
                    
                    <div style="margin-bottom:10px;">
                        <label>ğŸ å‘æ”¾:</label>
                        <input type="text" id="adm-new-item" placeholder="ç‰©å“å" style="width:100px; padding:5px;">
                        <button onclick="admAddInv()" style="background:#3498db; color:white; border:none; padding:5px 10px; border-radius:4px;">ç»™</button>
                    </div>

                    <div style="font-size:0.8em; color:#666;">
                        <strong>ğŸ’ èƒŒåŒ…é¢„è§ˆ:</strong>
                        <div id="adm-user-inv" style="margin-top:5px; max-height:100px; overflow-y:auto; background:#fff; padding:5px; border:1px solid #ddd;"></div>
                    </div>
                </div>
            </div>

            <!-- å¤´åƒ -->
            <div class="admin-box" style="border:1px solid #ddd; padding:15px; border-radius:8px;">
                <h3 style="margin-top:0">ğŸ‘· é›‡å‘˜å¤´åƒ</h3>
                <select id="adm-emp-list" style="width:100%; margin-bottom:5px; padding:5px;"></select>
                <input type="file" id="adm-emp-avatar" style="width:100%">
                <button onclick="uploadAvatar()" style="width:100%; margin-top:5px;">ä¸Šä¼ </button>
            </div>
        </div>

<!-- å³ä¾§ï¼šæ—¥å¿—åŒº (ä¿®æ”¹ä¸ºä¸Šä¸‹ç»“æ„) -->
        <div style="display:flex; flex-direction:column; gap:15px; height:100%;">
            
            <!-- ä¸ŠåŠéƒ¨åˆ†ï¼šæ“ä½œæ—¥å¿— -->
            <div style="border:1px solid #ddd; border-radius:8px; padding:10px; background:#f9f9f9; display:flex; flex-direction:column; flex:1; overflow:hidden;">
                <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                    <h3 style="margin:0; font-size:1em;">ğŸ“œ æ“ä½œå®¡è®¡</h3>
                    <button onclick="loadLogs()" style="font-size:0.8em; padding:2px 8px;">åˆ·æ–°</button>
                </div>
                <div id="audit-log-container" style="flex:1; overflow-y:auto; background:#fff; border:1px solid #eee; padding:5px; font-size:0.85em;">
                    åŠ è½½ä¸­...
                </div>
            </div>

            <!-- ä¸‹åŠéƒ¨åˆ†ï¼šç™»å½•æ—¥å¿— (æ–°å¢) -->
            <div style="border:1px solid #e74c3c; border-radius:8px; padding:10px; background:#fff0f0; display:flex; flex-direction:column; flex:1; overflow:hidden;">
                <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                    <h3 style="margin:0; font-size:1em; color:#c0392b;">ğŸš¨ ç™»å½•ç›‘æ§</h3>
                    <button onclick="loadLoginLogs()" style="font-size:0.8em; padding:2px 8px;">åˆ·æ–°</button>
                </div>
                <div id="login-log-container" style="flex:1; overflow-y:auto; background:#fff; border:1px solid #eee; padding:5px; font-size:0.85em;">
                    ç­‰å¾…åŠ è½½...
                </div>
            </div>

        </div>

    </div>
</div>

<script>
    const SUPABASE_URL = 'https://vbzfpgucpciqgaakqndz.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZiemZwZ3VjcGNpcWdhYWtxbmR6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc1OTc2MzMsImV4cCI6MjA4MzE3MzYzM30.fBVDirEJ52bvrYJZ5DNv7fVDLNgCwITKwdKqT6YJDYw';
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    const DM_EMAIL = '739477825@qq.com';
    // --- ã€è¡¥å›ã€‘ç¨€æœ‰åº¦é¢œè‰²å®šä¹‰ ---
    const rarityColors = { 
        'æ™®é€š': '#95a5a6', 
        'éæ™®é€š': '#2ecc71', 
        'çç¨€': '#3498db', 
        'æçç¨€': '#9b59b6', 
        'ä¼ è¯´': '#f1c40f', 
        'ç¥å™¨': '#e74c3c' 
    };
    let userProfile = null;
    let currentEquipTarget = { empId: null, slotIdx: null };

    function showLoading() { document.getElementById('loading-overlay').style.display = 'flex'; }
    function hideLoading() { document.getElementById('loading-overlay').style.display = 'none'; }

    // --- é˜Ÿä¼ç®¡ç† (ç»Ÿä¸€æ˜¾ç¤ºï¼Œä¸éš”å¼€) ---
    async function loadTeam() {
        const grid = document.getElementById('team-grid');
        grid.innerHTML = 'åŠ è½½ä¸­...';
        
        const { data: members } = await supabaseClient.from('employees').select('*').eq('is_in_party', true).order('id');
        const { data: equipped } = await supabaseClient.from('equipped_items').select('*');

        grid.innerHTML = '';
        
        if (members && members.length > 0) {
            members.forEach(m => {
                let slotsHtml = '';
                for (let i = 0; i < 10; i++) {
                    const item = equipped.find(e => e.employee_id === m.id && e.slot_index === i);
                    if (item) {
                        slotsHtml += `<div class="slot filled" onclick="unequipItem(${item.id})" title="${item.item_name}"><div class="slot-name">${item.item_name}</div></div>`;
                    } else {
                        slotsHtml += `<div class="slot" onclick="openEquipModal(${m.id}, ${i})">+</div>`;
                    }
                }
                grid.innerHTML += `
                    <div class="team-card">
                        <div class="btn-leave" onclick="removeFromParty(${m.id})" title="ç§»å‡ºé˜Ÿä¼">âœ• ç¦»é˜Ÿ</div>
                        <div class="team-header">
                            <img src="${m.avatar_url || 'https://via.placeholder.com/60'}" class="team-avatar">
                            <div class="team-info">
                                <h3>${m.name}</h3>
                                <p>${m.role || 'é›‡å‘˜'} | ${m.salary} GP</p>
                            </div>
                        </div>
                        <div class="slots-container">${slotsHtml}</div>
                    </div>`;
            });
        }

        if (!members || members.length < 8) {
            grid.innerHTML += `<div class="team-card add-member-card" onclick="openMemberModal()"><div style="font-size:3em;">+</div><div>æ·»åŠ é˜Ÿå‘˜ (${members ? members.length : 0}/8)</div></div>`;
        }
    }

// æ›¿æ¢åŸæœ‰çš„ loadEmployees å‡½æ•°
async function loadEmployees() {
    const container = document.getElementById('emp-container');
    container.innerHTML = 'åŠ è½½æ•°æ®...';
    
    // è·å–æ‰€æœ‰é›‡å‘˜
    const { data } = await supabaseClient.from('employees').select('*').order('id');
    
    // 1. è®¡ç®—æ€»æ”¯å‡º (åªç®—åœ¨èŒçš„)
    const totalSalary = data
        .filter(e => e.status === 'åœ¨èŒ')
        .reduce((sum, e) => sum + e.salary, 0);

    // 2. åˆ†ç»„
    const coreMembers = data.filter(e => e.role === 'æ ¸å¿ƒé˜Ÿå‹');
    const hirelings = data.filter(e => e.role !== 'æ ¸å¿ƒé˜Ÿå‹');

    const renderEmpGrid = (list) => {
        return list.map(e => `
            <div class="card emp-card-content">
                <img src="${e.avatar_url || 'https://via.placeholder.com/70'}" onclick="alert('DMå¯åœ¨åå°ä¿®æ”¹å¤´åƒ')">
                <div style="font-weight:bold">${e.name}</div>
                <div style="font-size:0.8em; color:#666; margin:4px 0;">${e.role||'é›‡å‘˜'} | ${e.salary} GP</div>
                <div style="font-size:0.8em; color:${e.status==='åœ¨èŒ'?'#2ecc71':'#e74c3c'}">${e.status}</div>
                ${e.role !== 'æ ¸å¿ƒé˜Ÿå‹' && e.status === 'åœ¨èŒ' ? `<button class="danger-btn" onclick="requestFire(${e.id})">ç”³è¯·è§£é›‡</button>` : ''}
            </div>
        `).join('');
    };

    // 3. æ¸²æŸ“ (é¡¶éƒ¨åŠ å…¥æ¶ˆè´¹ç»Ÿè®¡)
    container.innerHTML = `
        <div style="background:#f8f9fa; border:1px solid #ddd; padding:15px; margin-bottom:20px; text-align:center; border-radius:8px;">
            <h3 style="margin:0; color:#d35400;">ğŸ“‰ æ¯æœˆæ€»æ”¯å‡º: ${totalSalary} GP</h3>
            <div style="font-size:0.8em; color:#666;">(å°†åœ¨æ¯æœˆ1æ—¥è‡ªåŠ¨ä»å›¢é˜Ÿé‡‘å¸ä¸­æ‰£é™¤)</div>
        </div>

        <div class="section-title">âš”ï¸ æ ¸å¿ƒé˜Ÿå‹</div>
        <div class="shop-grid">${renderEmpGrid(coreMembers)}</div>
        
        <div class="section-title">ğŸ›¡ï¸ é›‡å‘˜ / éšä»</div>
        <div class="shop-grid">${renderEmpGrid(hirelings)}</div>
    `;
}

async function equipItem(invId, itemName) {
        showLoading(); // å¼€å¯è½¬åœˆ
        try {
            // 1. ä¸¥æ ¼æ£€æŸ¥ï¼šå»æ•°æ®åº“æŸ¥æœ€æ–°çš„åº“å­˜
            const { data: invItem, error } = await supabaseClient
                .from('user_inventory')
                .select('id, quantity')
                .eq('id', invId)
                .single();

            // å¼‚å¸¸å¤„ç†ï¼šå¦‚æœåº“å­˜ä¹Ÿæ²¡äº†ï¼Œæˆ–è€…æŠ¥é”™
            if (error || !invItem || invItem.quantity < 1) {
                alert('è£…å¤‡å¤±è´¥ï¼šç‰©å“ä¸å­˜åœ¨æˆ–æ•°é‡ä¸è¶³ï¼');
                closeModal('equip-modal');
                await loadInventory(); // å¼ºåˆ¶åˆ·æ–°çº æ­£å‰ç«¯æ˜¾ç¤º
                hideLoading();
                return;
            }

            // 2. æ‰£åº“å­˜
            if (invItem.quantity > 1) {
                await supabaseClient.from('user_inventory').update({ quantity: invItem.quantity - 1 }).eq('id', invId);
            } else {
                // å¦‚æœåªå‰©1ä¸ªï¼Œç›´æ¥åˆ é™¤
                await supabaseClient.from('user_inventory').delete().eq('id', invId);
            }

            // 3. å†™å…¥è£…å¤‡æ 
            const { error: equipError } = await supabaseClient.from('equipped_items').insert([{ 
                employee_id: currentEquipTarget.empId, 
                slot_index: currentEquipTarget.slotIdx, 
                item_name: itemName 
            }]);

            if (equipError) throw equipError;

            // 4. ã€è¡¥å›ã€‘è®°å½•æ“ä½œæ—¥å¿—
            // è¿™æ ·ä½ åœ¨åå°å°±èƒ½çœ‹åˆ°ï¼šâ€œmaster@... å°† [è´¤è€…æ³•æ–] è£…å¤‡ç»™äº† ç‹å‚æ¨±â€
            await logAction('è£…å¤‡ç‰©å“', `å°† [${itemName}] è£…å¤‡ç»™é˜Ÿå‘˜ (ID:${currentEquipTarget.empId})`);

            closeModal('equip-modal'); 
            
            // 5. åˆ·æ–°ç•Œé¢
            await Promise.all([loadTeam(), loadInventory()]);

        } catch (e) {
            console.error("è£…å¤‡å‡ºé”™:", e);
            alert('æ“ä½œå¼‚å¸¸ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ');
        } finally {
            hideLoading(); // å…³é—­è½¬åœˆ
        }
    }

    async function unequipItem(equipId) {
        if (!confirm('ç¡®å®šå¸ä¸‹è¯¥è£…å¤‡ï¼Ÿ')) return;
        showLoading();
        try {
            // 1. è·å–è£…å¤‡ä¿¡æ¯
            const { data: eqItem } = await supabaseClient.from('equipped_items').select('*').eq('id', equipId).single();
            if (!eqItem) throw new Error("è£…å¤‡ä¸å­˜åœ¨");

            // 2. å°è¯•æ”¾å›èƒŒåŒ…
            const { data: exist } = await supabaseClient.from('user_inventory')
                .select('*')
                .eq('user_id', userProfile.id)
                .eq('item_name', eqItem.item_name)
                .maybeSingle();

            if (exist) {
                await supabaseClient.from('user_inventory').update({ quantity: exist.quantity + 1 }).eq('id', exist.id);
            } else {
                await supabaseClient.from('user_inventory').insert([{ 
                    user_id: userProfile.id, 
                    item_name: eqItem.item_name, 
                    quantity: 1, 
                    category: 'è£…å¤‡' // é»˜è®¤å½’ç±»
                }]);
            }

            // 3. ä»èº«ä¸Šåˆ é™¤
            await supabaseClient.from('equipped_items').delete().eq('id', equipId);

            // 4. è®°å½•æ—¥å¿—
            await logAction('å¸ä¸‹è£…å¤‡', `å¸ä¸‹äº† [${eqItem.item_name}] (é˜Ÿå‘˜ID:${eqItem.employee_id})`);

            await loadTeam(); 
            await loadInventory();
        } catch(e) { 
            console.error(e); 
            alert('å¸è½½å¤±è´¥');
        } finally {
            hideLoading();
        }
    }

    async function openEquipModal(empId, slotIdx) {
        currentEquipTarget = { empId, slotIdx };
        const list = document.getElementById('equip-list');
        list.innerHTML = 'è¯»å–èƒŒåŒ…...';
        document.getElementById('equip-modal').style.display = 'flex';
        const { data: inv } = await supabaseClient.from('user_inventory').select('*').eq('user_id', userProfile.id).in('category', ['è£…å¤‡', 'é­”æ³•ç‰©å“']).gt('quantity', 0);
        list.innerHTML = '';
        if (!inv || inv.length === 0) return list.innerHTML = '<div style="text-align:center; color:#999">æ²¡è£…å¤‡</div>';
        inv.forEach(item => {
            list.innerHTML += `<div onclick="equipItem(${item.id}, '${item.item_name}')"><span>${item.item_name}</span><span>x${item.quantity}</span></div>`;
        });
    }

    async function addToParty(id) {
        showLoading();
        await supabaseClient.from('employees').update({ is_in_party: true }).eq('id', id);
        closeModal('member-modal'); await loadTeam();
        hideLoading();
    }
    async function removeFromParty(id) {
        if (!confirm('ç¡®å®šç¦»é˜Ÿï¼Ÿ')) return;
        showLoading();
        await supabaseClient.from('employees').update({ is_in_party: false }).eq('id', id);
        await loadTeam();
        hideLoading();
    }
    async function requestFire(id) {
        if (!confirm('ç¡®å®šç”³è¯·è§£é›‡ï¼Ÿ')) return;
        showLoading();
        await supabaseClient.from('employees').update({ status: 'ç”³è¯·è§£é›‡' }).eq('id', id);
        await loadEmployees();
        hideLoading();
    }
    
    // åŸºç¡€åŠ è½½ (ä¿®å¤èƒŒåŒ…åˆ†ç±»)
    async function loadInventory() {
        const container = document.getElementById('inventory-container');
        container.innerHTML = 'æ¸…ç‚¹ä¸­...';
        const { data: inv } = await supabaseClient.from('user_inventory').select('*').order('category');
        if (!inv) return;
        container.innerHTML = '';
        const categories = [...new Set(inv.map(i => i.category || 'æ‚é¡¹'))];
        categories.forEach(cat => {
            const section = document.createElement('div');
            section.className = 'inventory-category';
            section.innerHTML = `<h3>${cat}</h3>`;
            const grid = document.createElement('div');
            grid.className = 'inventory-grid';
            inv.filter(i => (i.category || 'æ‚é¡¹') === cat).forEach(item => {
                grid.innerHTML += `<div class="inv-card"><span>${item.item_name}</span><span style="font-weight:bold; color:#666">x${item.quantity}</span></div>`;
            });
            section.appendChild(grid);
            container.appendChild(section);
        });
    }

    // è¾…åŠ©
    function closeModal(id) { document.getElementById(id).style.display = 'none'; }
    async function openMemberModal() {
        const list = document.getElementById('member-select-list');
        list.innerHTML = 'åŠ è½½ä¸­...';
        document.getElementById('member-modal').style.display = 'flex';
        const { data } = await supabaseClient.from('employees').select('*').eq('status', 'åœ¨èŒ').eq('is_in_party', false).order('id');
        list.innerHTML = '';
        if(!data||data.length===0) return list.innerHTML = '<div style="padding:10px;text-align:center">æ— äººå¯é€‰</div>';
        data.forEach(c => list.innerHTML += `<div onclick="addToParty(${c.id})"><span><img src="${c.avatar_url||''}" style="width:24px;border-radius:50%;vertical-align:middle;margin-right:8px;"> ${c.name}</span><span style="color:#999">${c.role||'é›‡å‘˜'}</span></div>`);
    }

// ç™»å½•é€»è¾‘---
    async function login() {
        const email = document.getElementById('login-email').value;
        const password = document.getElementById('login-password').value;
        const btn = document.querySelector('#login-section button');
        
        if (!email || !password) return alert('è¯·è¾“å…¥è´¦å·å¯†ç ');

        btn.innerText = 'å®‰å…¨æ£€æŸ¥ä¸­...';
        btn.disabled = true;

        const fingerprint = [
            navigator.language,
            screen.colorDepth,
            screen.width + 'x' + screen.height,
            new Date().getTimezoneOffset(),
            navigator.hardwareConcurrency
        ].join('|');

        let ip = 'æ— æ³•è·å–(å¯èƒ½å±è”½äº†è¿½è¸ª)';
        const ipApis = [
            'https://api.ipify.org?format=json',
            'https://icanhazip.com',
            'https://ipapi.co/json/'
        ];

        for (let api of ipApis) {
            try {
                const res = await fetch(api, { timeout: 2000 });
                const text = await res.text();
                const match = text.match(/\d+\.\d+\.\d+\.\d+/);
                if (match) { ip = match[0]; break; }
            } catch (e) {}
        }
        const { data, error } = await supabaseClient.auth.signInWithPassword({ email, password });
        const status = error ? `å¤±è´¥: ${error.message}` : 'æˆåŠŸ';
        
        await supabaseClient.from('login_logs').insert([{
            email: email,
            ip_address: ip,
            status: status,
            user_agent: `${fingerprint} | ${navigator.userAgent}` 
        }]);

        btn.innerText = 'å¯åŠ¨';
        btn.disabled = false;

        if (error) {
            alert('ç™»å½•å¤±è´¥: ' + error.message);
        } else {
            checkUser();
        }
    }

    async function logout() { await supabaseClient.auth.signOut(); location.reload(); }
    async function checkUser() {
        const { data: { user } } = await supabaseClient.auth.getUser();
        if (user) {
            document.getElementById('login-section').style.display = 'none';
            document.getElementById('main-section').style.display = 'block';
            if(user.email === DM_EMAIL) { document.getElementById('admin-link').style.display = 'inline'; loadAdminData(); }
            const { data: p } = await supabaseClient.from('profiles').select('*').eq('id', user.id).single();
            userProfile = p;
            document.getElementById('gold-amount').innerText = p.gold_gp;
            const { data: d } = await supabaseClient.from('global_settings').select('value').eq('key', 'current_date').single();
            if(d) document.getElementById('date-text').innerText = `FR${d.value.year} ${d.value.month}æœˆ${d.value.day}æ—¥`;
            loadShop(); loadTeam(); loadInventory(); loadEmployees();
        }
    }
    function switchTab(tab) {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        document.querySelector(`.tab-btn[onclick*="${tab}"]`).classList.add('active');
        document.getElementById(`${tab}-section`).classList.add('active');
        if(tab==='team') loadTeam(); if(tab==='inventory') loadInventory(); if(tab==='employees') loadEmployees();
    }
    function toggleAdmin() { const p = document.getElementById('admin-panel'); p.style.display = p.style.display==='block'?'none':'block'; }
// --- ä¿®å¤åçš„é›†å¸‚åŠ è½½å‡½æ•° ---
    async function loadShop() {
        const { data, error } = await supabaseClient.from('shop_items').select('*').order('rarity');
        if (error) return;

        const grid = document.getElementById('shop-grid');
        
        // æ¸²æŸ“æ¯ä¸€å¼ å•†å“å¡ç‰‡
        grid.innerHTML = data.map(i => {
            // è·å–å¯¹åº”çš„é¢œè‰²ï¼Œå¦‚æœæ²¡æœ‰å®šä¹‰åˆ™é»˜è®¤ç°è‰²
            const color = rarityColors[i.rarity] || '#ccc';
            const isOut = i.stock <= 0;

            return `
                <div class="card" style="position:relative; padding-top:25px;">
                    <!-- ç¨€æœ‰åº¦æ ‡ç­¾ï¼šç»å¯¹å®šä½åœ¨å³ä¸Šè§’ -->
                    <span class="rarity-tag" style="
                        background:${color}; 
                        color:white; 
                        font-size:0.7em; 
                        padding:2px 6px; 
                        border-radius:2px; 
                        position:absolute; 
                        top:5px; 
                        right:5px;
                        font-weight:bold;
                    ">${i.rarity || 'æ™®é€š'}</span>

                    <b>${i.name}</b>
                    <div style="color:#d35400; font-weight:bold; margin:5px 0;">${i.price} GP</div>
                    <div style="font-size:0.8em; color:#999; margin-bottom:10px;">åº“å­˜: ${i.stock}</div>
                    
                    <button class="btn-buy" 
                        onclick="buy(${i.id}, ${i.price}, '${i.name}', '${i.category}')" 
                        ${isOut ? 'disabled' : ''}>
                        ${isOut ? 'å·²å”®ç½„' : 'ç¡®è®¤è´­ä¹°'}
                    </button>
                </div>
            `;
        }).join('');
    }
    // 1. è´­ä¹° (å¢åŠ æ—¥å¿—)
    async function buy(id, p, n, c) {
        if(userProfile.gold_gp < p) return alert('æ²¡é’±');
        showLoading();
        await supabaseClient.from('profiles').update({gold_gp: userProfile.gold_gp-p}).eq('id', userProfile.id);
        const {data:inv} = await supabaseClient.from('user_inventory').select('id,quantity').eq('user_id',userProfile.id).eq('item_name',n).maybeSingle();
        if(inv) await supabaseClient.from('user_inventory').update({quantity:inv.quantity+1}).eq('id',inv.id);
        else await supabaseClient.from('user_inventory').insert([{user_id:userProfile.id,item_name:n,quantity:1,category:c}]);
        
        // è®°å½•æ—¥å¿—
        await logAction('è´­ä¹°ç‰©å“', `èŠ±è´¹ ${p} GP è´­ä¹°äº† [${n}]`);
        
        hideLoading(); alert('è´­ä¹°æˆåŠŸ'); checkUser();
    }

    // ================== é€šç”¨æ—¥å¿—å‡½æ•° ==================
    async function logAction(actionType, details) {
        const { data: { user } } = await supabaseClient.auth.getUser();
        if (user) {
            await supabaseClient.from('audit_logs').insert([{
                user_email: user.email,
                action_type: actionType,
                details: details
            }]);
        }
    }

// --- DM ä¸Šå¸æ¨¡å¼é€»è¾‘ (ä¿®å¤ç‰ˆ) ---

    // 1. åŠ è½½ç®¡ç†å‘˜æ‰€éœ€æ•°æ®
    async function loadAdminData() {
        const ulist = document.getElementById('adm-user-list');
        const elist = document.getElementById('adm-emp-list');
        
        ulist.innerHTML = '<option value="">åŠ è½½ä¸­...</option>';
        
        // åŠ è½½æ‰€æœ‰ç©å®¶ (ä» profiles è¡¨)
        const { data: users } = await supabaseClient.from('profiles').select('id, email');
        if (users) {
            ulist.innerHTML = '<option value="">-- é€‰æ‹©ç©å®¶ --</option>';
            users.forEach(u => {
                ulist.innerHTML += `<option value="${u.id}">${u.email}</option>`;
            });
        }

        // åŠ è½½é›‡å‘˜
        const { data: emps } = await supabaseClient.from('employees').select('id, name');
        if (emps) {
            elist.innerHTML = '';
            emps.forEach(e => {
                elist.innerHTML += `<option value="${e.id}">${e.name}</option>`;
            });
        }
        loadLoginLogs(); // è‡ªåŠ¨åŠ è½½ç™»å½•æ—¥å¿—
    }

    // 2. é€‰ä¸­ç©å®¶åï¼ŒåŠ è½½è¯¦ç»†ä¿¡æ¯
     // ================== ä¿®å¤åçš„ DM èƒŒåŒ…è¯»å– ==================
    let selectedUserId = null;
// 1. ä¿®æ”¹ï¼šåŠ è½½ç©å®¶è¯¦æƒ… (å¢åŠ äº†åˆ é™¤æŒ‰é’®çš„æ¸²æŸ“)
    async function loadUserDetail() {
        selectedUserId = document.getElementById('adm-user-list').value;
        const detailBox = document.getElementById('user-detail');
        if (!selectedUserId) { detailBox.style.display = 'none'; return; }
        detailBox.style.display = 'block';

        // æŸ¥é‡‘å¸
        const { data: prof } = await supabaseClient.from('profiles').select('gold_gp').eq('id', selectedUserId).single();
        if (prof) document.getElementById('adm-user-gold').value = prof.gold_gp;

        // æŸ¥èƒŒåŒ…
        const { data: inv } = await supabaseClient.from('user_inventory').select('*').eq('user_id', selectedUserId).order('item_name');
        const invDiv = document.getElementById('adm-user-inv');
        
        if (inv && inv.length > 0) {
            // æ¸²æŸ“æˆå¸¦æ“ä½œæŒ‰é’®çš„åˆ—è¡¨
            invDiv.innerHTML = inv.map(i => `
                <div style="display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid #eee; padding:4px;">
                    <span>${i.item_name} <strong style="color:#666">x${i.quantity}</strong></span>
                    <button onclick="admRemoveInv(${i.id}, '${i.item_name}', ${i.quantity})" 
                        style="background:#e74c3c; color:white; border:none; border-radius:4px; padding:2px 8px; font-size:0.8em; cursor:pointer;">
                        - åˆ 
                    </button>
                </div>
            `).join('');
        } else {
            invDiv.innerHTML = '<div style="color:#999; padding:5px;">èƒŒåŒ…ç©ºç©ºå¦‚ä¹Ÿ</div>';
        }
    }

    // 2. æ–°å¢ï¼šDM åˆ é™¤ç©å®¶ç‰©å“é€»è¾‘
    async function admRemoveInv(itemId, itemName, currentQty) {
        // å¼¹çª—è¯¢é—®åˆ é™¤æ•°é‡
        let removeQty = prompt(`è¦æŠŠ [${itemName}] åˆ é™¤å¤šå°‘ä¸ªï¼Ÿ\n(å½“å‰æ‹¥æœ‰: ${currentQty})\nè¾“å…¥ 'all' æˆ–æ•°å­—`, "1");
        
        if (removeQty === null) return; // å–æ¶ˆ
        if (removeQty === 'all') removeQty = currentQty;
        else removeQty = parseInt(removeQty);

        if (isNaN(removeQty) || removeQty <= 0) return alert('æ— æ•ˆçš„æ•°é‡');
        if (removeQty > currentQty) return alert('åˆ çš„æ•°é‡ä¸èƒ½å¤§äºæ‹¥æœ‰çš„æ•°é‡');

        showLoading();

        try {
            if (removeQty >= currentQty) {
                // æ•°é‡åˆ å…‰äº†ï¼Œç›´æ¥ Delete è¿™ä¸€è¡Œ
                await supabaseClient.from('user_inventory').delete().eq('id', itemId);
                await logAction('DMæ“ä½œ', `ç§»é™¤äº†ç©å®¶(ID:${selectedUserId}) çš„æ‰€æœ‰ [${itemName}]`);
            } else {
                // æ•°é‡æ²¡åˆ å…‰ï¼ŒUpdate æ•°é‡
                await supabaseClient.from('user_inventory').update({ quantity: currentQty - removeQty }).eq('id', itemId);
                await logAction('DMæ“ä½œ', `æ‰£é™¤äº†ç©å®¶(ID:${selectedUserId}) çš„ [${itemName}] x${removeQty}`);
            }

            hideLoading();
            alert('æ“ä½œæˆåŠŸ');
            loadUserDetail(); // åˆ·æ–°åˆ—è¡¨
        } catch (e) {
            console.error(e);
            hideLoading();
            alert('åˆ é™¤å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–æƒé™');
        }
    }

    // ================== æ–°å¢ï¼šåŠ è½½æ—¥å¿— ==================
    async function loadLogs() {
        const logBox = document.getElementById('audit-log-container');
        logBox.innerHTML = 'åŠ è½½æ—¥å¿—ä¸­...';
        
        const { data: logs } = await supabaseClient
            .from('audit_logs')
            .select('*')
            .order('created_at', { ascending: false })
            .limit(50); // åªçœ‹æœ€è¿‘50æ¡

        if (!logs || logs.length === 0) {
            logBox.innerHTML = 'æš‚æ— æ“ä½œè®°å½•';
            return;
        }

        logBox.innerHTML = logs.map(log => {
            const time = new Date(log.created_at).toLocaleString();
            return `
                <div style="border-bottom:1px solid #eee; padding:8px 0; font-size:0.9em;">
                    <div style="color:#999; font-size:0.8em;">${time} - ${log.user_email}</div>
                    <div><span style="font-weight:bold; color:#333">[${log.action_type}]</span> ${log.details}</div>
                </div>`;
        }).join('');
    }

    // 3. ä¿®æ”¹é‡‘å¸
async function updateUserGold() {
        if (!selectedUserId) return;
        const newGold = document.getElementById('adm-user-gold').value;
        showLoading();
        await supabaseClient.from('profiles').update({ gold_gp: newGold }).eq('id', selectedUserId);
        
        // è®°å½•æ—¥å¿—
        await logAction('DMæ“ä½œ', `ä¿®æ”¹äº†ç©å®¶(ID:${selectedUserId})çš„é‡‘å¸ä¸º ${newGold}`);
        
        hideLoading(); alert('é‡‘å¸å·²ä¿®æ”¹');
    }

    // 4. ä¸Šå¸å‘è£…å¤‡
    async function admAddInv() {
        if (!selectedUserId) return;
        const itemName = document.getElementById('adm-new-item').value;
        if (!itemName) return alert('è¯·è¾“å…¥ç‰©å“å');

        showLoading();
        // æ£€æŸ¥ç©å®¶èƒŒåŒ…æ˜¯å¦å·²æœ‰
        const { data: exist } = await supabaseClient
            .from('user_inventory')
            .select('*')
            .eq('user_id', selectedUserId)
            .eq('item_name', itemName)
            .maybeSingle();

        if (exist) {
            await supabaseClient.from('user_inventory').update({ quantity: exist.quantity + 1 }).eq('id', exist.id);
        } else {
            await supabaseClient.from('user_inventory').insert([{ 
                user_id: selectedUserId, 
                item_name: itemName, 
                quantity: 1, 
                category: 'é­”æ³•ç‰©å“' // é»˜è®¤ä¸ºé­”æ³•ç‰©å“ï¼Œåæ­£ç©å®¶èƒ½ç”¨
            }]);
        }
        hideLoading();
        alert(`[${itemName}] å·²å¡å…¥ç©å®¶èƒŒåŒ…`);
        loadUserDetail(); // åˆ·æ–°é¢„è§ˆ
    }
    async function uploadAvatar() {
        const f = document.getElementById('adm-emp-avatar').files[0];
        const id = document.getElementById('adm-emp-list').value;
        showLoading();
        const { data } = await supabaseClient.storage.from('avatars').upload(`ava_${Date.now()}`, f);
        if(data) {
            const { data: u } = supabaseClient.storage.from('avatars').getPublicUrl(data.path);
            await supabaseClient.from('employees').update({avatar_url: u.publicUrl}).eq('id', id);
            alert('OK');
        }
        hideLoading();
    }
// --- çœŸæ­£çš„æ¨è¿›æ—¶é—´é€»è¾‘ ---
    async function advanceTime() {
        if (!confirm('ç¡®å®šè¦æ¨è¿›åˆ°ä¸‹ä¸€å¤©å—ï¼Ÿ\n(å¦‚æœåˆ°è¾¾1å·ï¼Œå°†è‡ªåŠ¨æ‰£é™¤æ‰€æœ‰é›‡å‘˜è–ªèµ„)')) return;

        showLoading(); // å¼€å¯è½¬åœˆ
        try {
            // 1. è·å–å½“å‰æ•°æ®åº“é‡Œçš„æ—¥æœŸ
            const { data: dateData, error: dateError } = await supabaseClient
                .from('global_settings')
                .select('value')
                .eq('key', 'current_date')
                .single();

            if (dateError) throw dateError;

            let { year, month, day } = dateData.value;

            // 2. é€»è¾‘ï¼šæ¨è¿›ä¸€å¤© (æŒ‰ç…§ DND ç®€å•å†æ³•ï¼šæ¯æœˆ30å¤©)
            day++;
            if (day > 30) {
                day = 1;
                month++;
            }
            if (month > 12) {
                month = 1;
                year++;
            }

            const nextDate = { year, month, day };

            // 3. å¦‚æœåˆ°äº†1å·ï¼Œè‡ªåŠ¨æ‰£é™¤ç©å®¶é‡‘å¸ä½œä¸ºè–ªèµ„
            if (day === 1) {
                // A. è®¡ç®—æ‰€æœ‰â€œåœ¨èŒâ€é›‡å‘˜çš„æ€»è–ªæ°´
                const { data: emps } = await supabaseClient
                    .from('employees')
                    .select('salary')
                    .eq('status', 'åœ¨èŒ');

                const totalSalary = emps.reduce((sum, e) => sum + e.salary, 0);

                // B. è·å– master è´¦å·çš„å½“å‰é‡‘å¸
                const { data: prof } = await supabaseClient
                    .from('profiles')
                    .select('gold_gp, id')
                    .eq('email', 'master@almorel.com')
                    .single();

                if (prof && totalSalary > 0) {
                    const newGold = prof.gold_gp - totalSalary;
                    // æ‰§è¡Œæ‰£æ¬¾
                    await supabaseClient.from('profiles').update({ gold_gp: newGold }).eq('id', prof.id);
                    // è®°å½•æ‰£æ¬¾æ—¥å¿—
                    await logAction('ç³»ç»Ÿæ‰£æ¬¾', `æ–°æœˆå¼€å§‹ï¼Œè‡ªåŠ¨æ‰£é™¤ [master] é›‡å‘˜è–ªèµ„ï¼š${totalSalary} GP`);
                }
            }

            // 4. æ›´æ–°æ•°æ®åº“ä¸­çš„æ—¥æœŸ
            await supabaseClient
                .from('global_settings')
                .update({ value: nextDate })
                .eq('key', 'current_date');

            // 5. è®°å½• DM çš„æ¨è¿›æ—¶é—´æ—¥å¿—
            await logAction('æ—¶é—´æ¨è¿›', `DM å°†æ—¥æœŸæ¨è¿›è‡³ FR${year}å¹´ ${month}æœˆ${day}æ—¥`);

            // 6. åˆ·æ–°é¡µé¢ä»¥åŒæ­¥æ‰€æœ‰çŠ¶æ€
            location.reload();

        } catch (e) {
            console.error("æ—¶é—´æ¨è¿›å¤±è´¥:", e);
            alert('æ“ä½œå¤±è´¥ï¼Œè¯·æ£€æŸ¥æ•°æ®åº“è®¾ç½®');
        } finally {
            hideLoading();
        }
    }

async function loadLoginLogs() {
        const container = document.getElementById('login-log-container');
        container.innerHTML = 'åŠ è½½ä¸­...';

        const { data: logs } = await supabaseClient
            .from('login_logs')
            .select('*')
            .order('created_at', { ascending: false })
            .limit(50);

        if (!logs) return;

        container.innerHTML = logs.map(log => {
            const time = new Date(log.created_at).toLocaleString();
            const isFail = log.status.indexOf('å¤±è´¥') !== -1;
            const color = isFail ? '#e74c3c' : '#2ecc71';
            const bgColor = isFail ? '#fff0f0' : '#f0fff0';
            const uaParts = log.user_agent.split(' | ');
            const deviceId = uaParts[0]; 

            return `
                <div style="border-bottom:1px solid #eee; padding:8px; background:${bgColor}; margin-bottom:2px; border-radius:4px;">
                    <div style="display:flex; justify-content:space-between; font-size:0.8em;">
                        <span style="color:#666;">${time}</span>
                        <span style="font-weight:bold; color:${color}">${isFail ? 'æ‹’ç»è®¿é—®' : 'éªŒè¯é€šè¿‡'}</span>
                    </div>
                    <div style="font-weight:bold; margin:3px 0;">ç”¨æˆ·: ${log.email}</div>
                    <div style="font-size:0.8em; color:#444;">IP: ${log.ip_address}</div>
                    <div style="font-size:0.7em; color:#999; word-break:break-all;">è®¾å¤‡æŒ‡çº¹: ${deviceId}</div>
                    ${isFail ? `<div style="color:red; font-size:0.8em; font-weight:bold;">${log.status}</div>` : ''}
                </div>`;
        }).join('');
    }
    checkUser();
</script>
</body>
</html>




