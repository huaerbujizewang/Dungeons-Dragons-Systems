<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>D&D å°é˜Ÿç®¡ç†ç³»ç»Ÿ</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --border: #e0e0e0; --bg: #f8f9fa; --active: #333; }
        body { font-family: "PingFang SC", "Microsoft YaHei", sans-serif; background: #fff; color: #333; margin: 0; padding: 0; height: 100vh; }
    
        #login-section {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 100%;
            max-width: 360px;
            padding: 40px;
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            text-align: center;
            border: 1px solid #eee;
            z-index: 100;
        }
        #login-section h2 { margin-top: 0; color: #2c3e50; font-weight: 300; margin-bottom: 25px; letter-spacing: 1px; }
        #login-section input { width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; font-size: 14px; transition: 0.2s; }
        #login-section input:focus { border-color: #333; outline: none; }
        #login-section button { width: 100%; padding: 12px; background: #2c3e50; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 16px; font-weight: bold; transition: 0.2s; }
        #login-section button:hover { background: #34495e; transform: translateY(-1px); }

        /* --- ä¸»ç•Œé¢å¸ƒå±€ --- */
        .container { max-width: 1100px; margin: 0 auto; padding: 20px; }
        
        /* å¯¼èˆª */
        .nav { display: flex; gap: 15px; border-bottom: 2px solid #333; padding-bottom: 15px; margin-bottom: 30px; align-items: center; }
        .tab-btn { padding: 8px 16px; border: none; background: none; cursor: pointer; font-size: 1em; color: #7f8c8d; border-radius: 4px; font-weight: 500; transition: 0.2s; }
        .tab-btn.active { background: #333; color: #fff; }
        .tab-btn:hover:not(.active) { color: #333; background: #f0f0f0; }
        
        .info-bar { margin-left: auto; text-align: right; font-size: 0.9em; display: flex; flex-direction: column; align-items: flex-end; gap: 4px; }
        
        /* å†…å®¹åŒº */
        .section { display: none; animation: fadeIn 0.3s ease; }
        .section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        /* æ ‡é¢˜åˆ†å‰²çº¿ */
        .section-title { margin: 35px 0 20px 0; border-left: 5px solid #333; padding-left: 12px; font-weight: bold; font-size: 1.1em; color: #444; background: linear-gradient(90deg, #f9f9f9, #fff); padding-top: 8px; padding-bottom: 8px; }
        
        /* ç½‘æ ¼å¸ƒå±€ */
        .team-grid, .shop-grid, .inventory-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(230px, 1fr)); gap: 20px; }
        
        /* å¡ç‰‡é€šç”¨ */
        .card, .team-card, .inv-card { background: #fff; border: 1px solid var(--border); border-radius: 8px; padding: 15px; position: relative; transition: 0.2s; box-shadow: 0 2px 5px rgba(0,0,0,0.02); }
        .card:hover, .team-card:hover { box-shadow: 0 5px 15px rgba(0,0,0,0.08); border-color: #bbb; transform: translateY(-2px); }
        
        /* é˜Ÿä¼å¡ç‰‡ç‰¹æœ‰ */
        .team-header { display: flex; align-items: center; gap: 15px; margin-bottom: 15px; }
        .team-avatar { width: 60px; height: 60px; border-radius: 50%; object-fit: cover; background: #eee; border: 1px solid #ddd; }
        .team-info h3 { margin: 0; font-size: 1.1em; }
        .team-info p { margin: 4px 0 0; font-size: 0.8em; color: #666; }
        .btn-leave { position: absolute; top: 10px; right: 10px; font-size: 0.7em; color: #999; cursor: pointer; border: 1px solid #eee; padding: 2px 8px; border-radius: 4px; background: #fff; }
        .btn-leave:hover { background: #fee; color: #e74c3c; border-color: #e74c3c; }

        /* è£…å¤‡æ§½ */
        .slots-container { display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; }
        .slot { aspect-ratio: 1; border: 1px dashed #ccc; border-radius: 4px; display: flex; align-items: center; justify-content: center; font-size: 0.7em; text-align: center; cursor: pointer; background: #fafafa; padding: 2px; overflow: hidden; transition: 0.2s; color: #aaa; }
        .slot:hover { border-color: #333; background: #fff; color: #333; }
        .slot.filled { border: 1px solid #bbb; background: #fff; border-style: solid; color: #333; font-weight: 600; box-shadow: inset 0 0 5px rgba(0,0,0,0.05); }
        .slot-name { word-break: break-all; pointer-events: none; transform: scale(0.9); line-height: 1.1; }
        
        /* é›‡å‘˜ä¸­å¿ƒå¡ç‰‡ */
        .emp-card-content { text-align: center; }
        .emp-card-content img { width: 70px; height: 70px; border-radius: 50%; object-fit: cover; margin-bottom: 10px; border: 1px solid #eee; }
        
        /* å¼¹çª— & Loading */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 2000; align-items: center; justify-content: center; backdrop-filter: blur(2px); }
        .modal-box { background: #fff; padding: 25px; border-radius: 12px; width: 400px; max-height: 80vh; overflow-y: auto; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        .item-select-list div { padding: 12px; border-bottom: 1px solid #f0f0f0; cursor: pointer; display: flex; justify-content: space-between; transition: 0.1s; }
        .item-select-list div:hover { background: #f8f9fa; padding-left: 15px; }
        
        #loading-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.8); z-index: 5000; align-items: center; justify-content: center; flex-direction: column; }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #333; border-radius: 50%; width: 40px; height: 40px; animation: spin 0.8s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* æŒ‰é’®ä¸è¾“å…¥ */
        button { cursor: pointer; font-family: inherit; }
        input, select, textarea { font-family: inherit; border: 1px solid #ddd; border-radius: 4px; padding: 6px; }
        .btn-buy { width: 100%; margin-top: 10px; padding: 8px; background: #fff; border: 1px solid #333; color: #333; border-radius: 4px; transition: 0.2s; }
        .btn-buy:hover { background: #333; color: #fff; }
        .btn-buy:disabled { border-color: #eee; color: #ccc; background: #fafafa; cursor: not-allowed; }
        
        .danger-btn { color: #e74c3c; border-color: #e74c3c; margin-top: 8px; width: 100%; padding: 5px; background: none; border: 1px solid; border-radius: 4px; font-size: 0.85em; transition: 0.2s; }
        .danger-btn:hover { background: #e74c3c; color: white; }
        
        .add-member-card { border: 2px dashed #ddd; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #999; cursor: pointer; min-height: 200px; background: #fafafa; }
        .add-member-card:hover { border-color: #333; color: #333; background: #fff; }

        /* èƒŒåŒ…æ ·å¼ */
        .inventory-category { margin-bottom: 25px; }
        .inventory-category h3 { border-left: 4px solid #333; padding-left: 10px; margin-bottom: 15px; font-size: 1.1em; background: #f9f9f9; padding: 8px 10px; border-radius: 0 4px 4px 0; }
        .inventory-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 12px; }
        .inv-card { background: #fff; border: 1px solid #eee; padding: 12px; border-radius: 6px; display: flex; justify-content: space-between; align-items: center; font-size: 0.95em; }

        /* DM ç®¡ç†é¢æ¿ */
        #admin-panel { display: none; position: fixed; top: 5%; left: 5%; width: 90%; height: 90%; background: #fff; border: 2px solid #333; z-index: 3000; padding: 25px; overflow-y: auto; border-radius: 8px; box-shadow: 0 20px 50px rgba(0,0,0,0.3); box-sizing: border-box; }
        .admin-box { margin-bottom: 0; } /* Reset margin for grid */
    </style>
</head>
<body>

<!-- Loading é®ç½© -->
<div id="loading-overlay">
    <div class="spinner"></div>
    <div style="margin-top:15px; color:#555; font-weight:bold;">æ­£åœ¨åŒæ­¥ä½é¢æ•°æ®...</div>
</div>

<!-- ç™»å½•ç•Œé¢ (ç‹¬ç«‹å±…ä¸­) -->
<div id="login-section">
    <h2>å†’é™©è€…å·¥ä¼šç»ˆç«¯</h2>
    <input type="email" id="login-email" placeholder="é‚®ç®±åœ°å€">
    <input type="password" id="login-password" placeholder="é€šè¡Œå¯†ç ">
    <button onclick="login()">è¿æ¥èŠ‚ç‚¹</button>
</div>

<!-- ä¸»ç•Œé¢ -->
<div id="main-section" class="container" style="display:none;">
    <div class="nav">
        <button class="tab-btn active" onclick="switchTab('shop')">å•†åŸ</button>
    <button class="tab-btn" onclick="switchTab('team')">é˜Ÿä¼</button>
    <button class="tab-btn" onclick="switchTab('inventory')">èƒŒåŒ…</button>
    <button class="tab-btn" onclick="switchTab('employees')">é›‡å‘˜ä¸­å¿ƒ</button>
    <button class="tab-btn" onclick="switchTab('others')">å…¶ä»–å†…å®¹</button>
    <button id="security-tab-btn" class="tab-btn" onclick="switchTab('security')" style="display:none; color:#e74c3c; border:1px solid #ff000033;">ğŸ›¡ï¸ å®‰å…¨ä¸æƒé™</button>
    <span id="admin-link" style="display:none; color:#3498db; cursor:pointer; font-weight:bold; margin-left: 10px;" onclick="toggleAdmin()">âš™ï¸ DM æ§åˆ¶å°</span>
        
        <div class="info-bar">
            <div id="date-text" style="font-weight:bold; background:#f1c40f; color:#333; padding:4px 10px; border-radius:4px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">æ—¥æœŸåŠ è½½ä¸­...</div>
            <div style="color:#d35400; font-weight:bold; margin-top:4px;">ğŸ’° <span id="gold-amount">0</span> GP</div>
            <a href="#" onclick="logout()" style="color:#999; font-size:0.8em; text-decoration: underline;">é€€å‡ºç™»å½•</a>
        </div>
    </div>

    <!-- é›†å¸‚ -->
    <div id="shop-section" class="section active">
        <div id="shop-grid" class="shop-grid"></div>
    </div>

    <!-- é˜Ÿä¼é¢æ¿ -->
    <div id="team-section" class="section">
        <div id="team-container"></div>
    </div>

    <!-- èƒŒåŒ… -->
    <div id="inventory-section" class="section">
        <div id="inventory-container"></div>
    </div>
    
    <!-- é›‡å‘˜ä¸­å¿ƒ -->
    <div id="employees-section" class="section">
        <div id="emp-container"></div>
    </div>

    <!-- å…¶ä»–å†…å®¹æ¿å— -->
    <div id="others-section" class="section">
        <div class="section-title">ğŸŒ ä¸–ç•Œè§‚ä¸è®°å½•</div>
        <div class="shop-grid"> <!-- å¤ç”¨é›†å¸‚ç½‘æ ¼æ ·å¼ -->
        
        <!-- å¡ç‰‡ 1ï¼šæ—¶é—´çº¿ -->
        <div class="card emp-card-content" onclick="window.location.href='timeline.html'" style="cursor:pointer;">
            <div style="font-size: 2.5em; margin-bottom:10px;">â³</div>
            <div style="font-weight:bold; font-size:1.1em;">ç¼–å¹´å² / æ—¶é—´çº¿</div>
            <p style="font-size:0.8em; color:#666;">è®°å½•è´¹ä¼¦å¤§é™†åŠå›¢é˜Ÿå¤§äº‹ä»¶</p>
        </div>

        <!-- å¡ç‰‡ 2ï¼šå›½å®¶ä¸ç»„ç»‡ -->
        <div class="card emp-card-content" onclick="window.location.href='world.html'" style="cursor:pointer;">
            <div style="font-size: 2.5em; margin-bottom:10px;">ğŸ°</div>
            <div style="font-weight:bold; font-size:1.1em;">åœ°ç† / ç»„ç»‡</div>
            <p style="font-size:0.8em; color:#666;">å›½å®¶èƒŒæ™¯ã€åŠ¿åŠ›èŒƒå›´ä¸å…³ç³»å›¾</p>
        </div>

        <!-- å¡ç‰‡ 3ï¼šä¼ è®°ä¸é—´ç«  -->
        <div class="card emp-card-content" onclick="window.location.href='lore.html'" style="cursor:pointer;">
            <div style="font-size: 2.5em; margin-bottom:10px;">ğŸ“œ</div>
            <div style="font-weight:bold; font-size:1.1em;">äººç‰©å¿— / é—´ç« </div>
            <p style="font-size:0.8em; color:#666;">NPC å¯¹è¯ã€èƒŒæ™¯æ•…äº‹ä¸äº¤æµè®°å½•</p>
        </div>

        <!-- å¯ä»¥æ ¹æ®éœ€è¦ç»§ç»­æ·»åŠ å¡ç‰‡ -->
        </div>
    </div>

     <!-- æ–°å¢ï¼šå®‰å…¨ä¸æƒé™ Section (Root ä¸“ç”¨) -->
    <div id="security-section" class="section">
        <div style="display:grid; grid-template-columns: 350px 1fr; gap:20px;">
            <!-- å·¦ä¾§ï¼šè´¦å·ç®¡ç† -->
            <div style="display:flex; flex-direction:column; gap:20px;">
                <div class="admin-box" style="border:1px solid #3498db; padding:15px; border-radius:8px; background:#f0f9ff;">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                        <h3 style="margin:0; color:#2980b9;">ğŸ”‘ è´¦å·æƒé™ç®¡ç†</h3>
                        <button onclick="loadAllAccounts()" style="font-size:0.8em;">åˆ·æ–°</button>
                    </div>
                    <div id="account-list-container" style="max-height:600px; overflow-y:auto; background:#fff; padding:10px; border-radius:4px; font-size:0.9em;"></div>
                </div>
            </div>
            
            <!-- å³ä¾§ï¼šåŒæ—¥å¿— -->
            <div style="display:flex; flex-direction:column; gap:20px;">
                <div class="admin-box" style="border:1px solid #ddd; padding:15px; border-radius:8px; background:#f9f9f9; flex:1;">
                    <h3 style="margin-top:0;">ğŸ“œ å…¨æœæ“ä½œå®¡è®¡</h3>
                    <div id="audit-log-container" style="height:300px; overflow-y:auto; background:#fff; padding:10px; border:1px solid #eee;"></div>
                </div>
                <div class="admin-box" style="border:1px solid #e74c3c; padding:15px; border-radius:8px; background:#fff0f0; flex:1;">
                    <h3 style="margin-top:0; color:#c0392b;">ğŸš¨ ç™»å½•ç›‘æ§æ—¥å¿—</h3>
                    <div id="login-log-container" style="height:300px; overflow-y:auto; background:#fff; padding:10px; border:1px solid #eee;"></div>
                </div>
            </div>
        </div>
    </div>


</div>

<!-- å¼¹çª—ï¼šè£…å¤‡é€‰æ‹© -->
<div id="equip-modal" class="modal">
    <div class="modal-box">
        <h3>é€‰æ‹©è¦è£…å¤‡çš„ç‰©å“</h3>
        <div id="equip-list" class="item-select-list"></div>
        <button onclick="closeModal('equip-modal')" style="width:100%; margin-top:15px; padding:10px; background:#f5f5f5; border:1px solid #ddd; border-radius:4px;">å–æ¶ˆ</button>
    </div>
</div>

<!-- å¼¹çª—ï¼šæˆå‘˜é€‰æ‹© -->
<div id="member-modal" class="modal">
    <div class="modal-box">
        <h3>é€‰æ‹©åŠ å…¥é˜Ÿä¼çš„æˆå‘˜</h3>
        <p style="font-size:0.8em;color:#999; margin-bottom:10px;">ä»…æ˜¾ç¤ºåœ¨èŒä¸”æœªå…¥é˜Ÿçš„äººå‘˜</p>
        <div id="member-select-list" class="item-select-list"></div>
        <button onclick="closeModal('member-modal')" style="width:100%; margin-top:15px; padding:10px; background:#f5f5f5; border:1px solid #ddd; border-radius:4px;">å–æ¶ˆ</button>
    </div>
</div>

<!-- DM ä¸Šå¸æ§åˆ¶å° -->
<div id="admin-panel">
    <div style="display:flex; justify-content:space-between; margin-bottom:20px; border-bottom:1px solid #eee; padding-bottom:15px;">
        <h2 style="margin:0;">DM æ§åˆ¶å° <span id="role-badge" style="font-size:0.5em; background:#333; color:white; padding:2px 8px; border-radius:12px; font-weight:normal;"></span></h2>
        <button onclick="toggleAdmin()" style="background:#e74c3c; color:white; border:none; padding:8px 20px; border-radius:6px; font-weight:bold;">å…³é—­</button>
    </div>
    
    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:25px; overflow-y:auto;">
        
        <!-- å·¦ä¾§åˆ— -->
        <div style="display:flex; flex-direction:column; gap:20px;">
            <!-- æ—¶é—´æ§åˆ¶ -->
            <div class="admin-box" style="border:1px solid #ddd; padding:15px; border-radius:8px;">
                <h3 style="margin-top:0">â³ æ—¶é—´çº¿æ“æ§</h3>
                <div style="display:flex; gap:5px; margin-bottom:10px;">
                    <input type="number" id="time-year" style="width:70px"> å¹´ 
                    <input type="number" id="time-month" style="width:50px"> æœˆ 
                    <input type="number" id="time-day" style="width:50px"> æ—¥
                </div>
                <button onclick="updateTimeManual()" style="width:100%; padding:10px; background:#34495e; color:white; border:none;">åŒæ­¥æ—¶ç©º</button>
            </div>

            <!-- é›†å¸‚è¿›è´§ -->
            <div class="admin-box" style="border:1px solid #ddd; padding:15px; border-radius:8px;">
                <h3 style="margin-top:0">ğŸ¬ ç‰©èµ„ä¸Šæ¶</h3>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:8px;">
                    <input type="text" id="adm-shop-name" placeholder="å•†å“åç§°" style="grid-column: 1/3;">
                    <select id="adm-shop-rarity"><option>æ™®é€š</option><option>éæ™®é€š</option><option>çç¨€</option><option>æçç¨€</option><option>ä¼ è¯´</option><option>ç¥å™¨</option></select>
                    <select id="adm-shop-cat"><option>é­”æ³•ç‰©å“</option><option>è£…å¤‡</option><option>å·è½´</option><option>è¯æ°´</option><option>ææ–™</option></select>
                    <input type="number" id="adm-shop-price" placeholder="ä»·æ ¼">
                    <input type="number" id="adm-shop-stock" placeholder="åº“å­˜">
                    <select id="adm-shop-target" style="grid-column: 1/3;"><option value="public">ğŸŒ å…¨æœå…¬å…±</option><option value="private">ğŸ‘¤ ä»…å½“å‰é€‰ä¸­çš„ç©å®¶</option></select>
                    <textarea id="adm-shop-desc" placeholder="æè¿°..." style="grid-column: 1/3; height:50px;"></textarea>
                </div>
                <button onclick="adminAddItem()" style="width:100%; margin-top:10px; background:#2ecc71; color:white; border:none; padding:10px;">ç¡®è®¤ä¸Šæ¶</button>
            </div>
        </div>

        <!-- å³ä¾§åˆ— -->
        <div style="display:flex; flex-direction:column; gap:20px;">
            <!-- ç©å®¶èµ„äº§æ§åˆ¶ (ä¸Šå¸ä¹‹æ‰‹) -->
            <div class="admin-box" style="border:1px solid #333; padding:15px; border-radius:8px; background:#fafafa;">
                <h3 style="margin-top:0">ğŸ‘¤ ç©å®¶èµ„äº§æ“æ§ (è§†è§’åˆ‡æ¢)</h3>
                <select id="adm-user-list" onchange="loadUserDetail()" style="width:100%; padding:10px; margin-bottom:10px; border:2px solid #333;"></select>
                
                <div id="user-detail" style="display:none;">
                    <div style="margin-bottom:10px;">
                        ğŸ’° é‡‘å¸: <input type="number" id="adm-user-gold" style="width:80px"> <button onclick="updateUserGold()">ä¿®æ”¹</button>
                    </div>
                    <!-- Root ä¸“ç”¨ï¼šåˆ†é…è´Ÿè´£ DM -->
                    <div id="root-assign-dm" style="display:none; margin-bottom:10px; padding:10px; border:1px dashed #3498db;">
                        ğŸ”— æŒ‡æ´¾è´Ÿè´£ DM: <select id="adm-assign-dm-list"></select> <button onclick="assignDM()">ä¿å­˜</button>
                    </div>
                    <div style="margin-bottom:10px;">
                        ğŸ å‘æ”¾: <input type="text" id="adm-new-item" style="width:100px"> 
                        <select id="adm-new-item-cat"><option>é­”æ³•ç‰©å“</option><option>è£…å¤‡</option><option>å·è½´</option><option>è¯æ°´</option></select>
                        <button onclick="admAddInv()">å‘æ”¾</button>
                    </div>
                    <div style="font-size:0.8em; color:#666;">èƒŒåŒ…é¢„è§ˆ:</div>
                    <div id="adm-user-inv" style="max-height:150px; overflow-y:auto; background:#fff; padding:5px; border:1px solid #ddd; margin-top:5px;"></div>
                </div>
            </div>

            <!-- é›‡å‘˜å¤´åƒ -->
            <div class="admin-box" style="border:1px solid #ddd; padding:15px; border-radius:8px;">
                <h3 style="margin-top:0">ğŸ‘· é›‡å‘˜å¤´åƒæ›´æ–°</h3>
                <select id="adm-emp-list" style="width:100%; margin-bottom:10px;"></select>
                <div style="display:flex; gap:10px;"><input type="file" id="adm-emp-avatar" style="flex:1"><button onclick="uploadAvatar()">ä¸Šä¼ </button></div>
            </div>
        </div>
    </div>
</div>

<script>
    let viewingUserId = null; // å½“å‰æ­£åœ¨æŸ¥çœ‹è°çš„åœºæ™¯
    let myId = null; // ç™»å½•è€…è‡ªå·±çš„ ID
    let currentUserRole = 'player'; //æƒé™åˆ’åˆ†
    let currentUserEmail = ''; 
    const SUPABASE_URL = 'https://vbzfpgucpciqgaakqndz.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZiemZwZ3VjcGNpcWdhYWtxbmR6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc1OTc2MzMsImV4cCI6MjA4MzE3MzYzM30.fBVDirEJ52bvrYJZ5DNv7fVDLNgCwITKwdKqT6YJDYw';
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    const DM_EMAIL = '739477825@qq.com';
    // --- ã€è¡¥å›ã€‘ç¨€æœ‰åº¦é¢œè‰²å®šä¹‰ ---
    const rarityColors = { 
        'æ™®é€š': '#95a5a6', 
        'éæ™®é€š': '#2ecc71', 
        'çç¨€': '#3498db', 
        'æçç¨€': '#9b59b6', 
        'ä¼ è¯´': '#f1c40f', 
        'ç¥å™¨': '#e74c3c' 
    };
    let userProfile = null;
    let currentEquipTarget = { empId: null, slotIdx: null };

    function showLoading() { document.getElementById('loading-overlay').style.display = 'flex'; }
    function hideLoading() { document.getElementById('loading-overlay').style.display = 'none'; }

    // --- é˜Ÿä¼ç®¡ç† (ç»Ÿä¸€æ˜¾ç¤ºï¼Œä¸éš”å¼€) ---
    async function loadTeam() {
        const container = document.getElementById('team-container');
        if (!container) return; 
        
        container.innerHTML = 'åŠ è½½é˜Ÿå‘˜æ•°æ®...';
        
        // æŸ¥è¯¢æ•°æ®
        const { data: members } = await supabaseClient
            .from('employees')
            .select('*')
            .eq('is_in_party', true)
            .eq('user_id', viewingUserId) // åªçœ‹å½“å‰è§†è§’çš„
            .order('id');
            
        const { data: equipped } = await supabaseClient.from('equipped_items').select('*');

        // æ¸…ç©ºå®¹å™¨ï¼Œå‡†å¤‡é‡æ–°æ¸²æŸ“
        container.innerHTML = '';
        
        // 1. æ¸²æŸ“ç°æœ‰é˜Ÿå‘˜
        if (members && members.length > 0) {
            members.forEach(m => {
                let slotsHtml = '';
                for (let i = 0; i < 10; i++) {
                    const item = equipped.find(e => e.employee_id === m.id && e.slot_index === i);
                    if (item) {
                        slotsHtml += `<div class="slot filled" onclick="unequipItem(${item.id})" title="${item.item_name}"><div class="slot-name">${item.item_name}</div></div>`;
                    } else {
                        slotsHtml += `<div class="slot" onclick="openEquipModal(${m.id}, ${i})">+</div>`;
                    }
                }
                
                // å°†å¡ç‰‡åŠ å…¥å®¹å™¨
                container.innerHTML += `
                    <div class="team-card">
                        <div class="btn-leave" onclick="removeFromParty(${m.id})" title="ç§»å‡ºé˜Ÿä¼">âœ• ç¦»é˜Ÿ</div>
                        <div class="team-header">
                            <img src="${m.avatar_url || 'https://via.placeholder.com/60'}" class="team-avatar">
                            <div class="team-info">
                                <h3>${m.name}</h3>
                                <p>${m.role || 'é›‡å‘˜'} | ${m.salary} GP</p>
                            </div>
                        </div>
                        <div class="slots-container">${slotsHtml}</div>
                    </div>`;
            });
        }

        // 2. æ¸²æŸ“æ·»åŠ æŒ‰é’® (å¦‚æœäººæ•°ä¸æ»¡8äºº)
        if (!members || members.length < 8) {
            container.innerHTML += `
                <div class="team-card add-member-card" onclick="openMemberModal()">
                    <div style="font-size:3em;">+</div>
                    <div>æ·»åŠ é˜Ÿå‘˜ (${members ? members.length : 0}/8)</div>
                </div>`;
        }
        
        container.className = 'team-grid';
    }

// æ›¿æ¢åŸæœ‰çš„ loadEmployees å‡½æ•°
async function loadEmployees() {
        const container = document.getElementById('emp-container');
        container.innerHTML = 'åŠ è½½æ•°æ®...';
        
        // ã€å…³é”®æ”¹åŠ¨ã€‘ï¼šåªæŸ¥å½’å±äº viewingUserId çš„é›‡å‘˜
        // å¦‚æœæ˜¯ DM é€‰äº† masterï¼Œè¿™é‡Œå°±ä¼šæŸ¥åˆ° master çš„é›‡å‘˜
        const { data, error } = await supabaseClient
            .from('employees')
            .select('*')
            .eq('user_id', viewingUserId)
            .order('id');
        
        if (error) {
            container.innerHTML = 'æƒé™ä¸è¶³æˆ–åŠ è½½å¤±è´¥';
            return;
        }

        // --- è´¦å•è®¡ç®— (åªç®—å½“å‰è§†è§’çš„) ---
        const totalSalary = data
            .filter(e => e.status === 'åœ¨èŒ')
            .reduce((sum, e) => sum + e.salary, 0);

        // åˆ†ç»„
        const coreMembers = data.filter(e => e.role === 'æ ¸å¿ƒé˜Ÿå‹');
        const hirelings = data.filter(e => e.role !== 'æ ¸å¿ƒé˜Ÿå‹');

        const renderEmpGrid = (list) => {
            if (list.length === 0) return '<div style="color:#999; padding:10px;">(æš‚æ— äººå‘˜)</div>';
            return list.map(e => `
                <div class="card emp-card-content">
                    <img src="${e.avatar_url || 'https://via.placeholder.com/70'}" onclick="alert('å¤´åƒID: ${e.id}')">
                    <div style="font-weight:bold">${e.name}</div>
                    <div style="font-size:0.8em; color:#666; margin:4px 0;">${e.role||'é›‡å‘˜'} | ${e.salary} GP</div>
                    <div style="font-size:0.8em; color:${e.status==='åœ¨èŒ'?'#2ecc71':'#e74c3c'}">${e.status}</div>
                    ${e.role !== 'æ ¸å¿ƒé˜Ÿå‹' && e.status === 'åœ¨èŒ' ? `<button class="danger-btn" onclick="requestFire(${e.id})">ç”³è¯·è§£é›‡</button>` : ''}
                </div>
            `).join('');
        };

        // æ¸²æŸ“ç•Œé¢
        // æ³¨æ„ï¼šè¿™é‡Œçš„è´¦å•æ˜¾ç¤ºçš„æ˜¯â€œå½“å‰è§†è§’â€çš„è´¦å•
        container.innerHTML = `
            <div style="background:#f8f9fa; border:1px solid #ddd; padding:15px; margin-bottom:20px; text-align:center; border-radius:8px;">
                <h3 style="margin:0; color:#d35400;">ğŸ“‰ æœ¬æœˆæ€»æ”¯å‡º: ${totalSalary} GP</h3>
                <div style="font-size:0.8em; color:#666;">(å°†åœ¨æ¯æœˆ1æ—¥ä» ${viewingUserId === myId ? 'æ‚¨çš„' : 'è¯¥ç©å®¶çš„'} è´¦æˆ·ä¸­æ‰£é™¤)</div>
            </div>

            <div class="section-title">âš”ï¸ æ ¸å¿ƒé˜Ÿå‹</div>
            <div class="shop-grid">${renderEmpGrid(coreMembers)}</div>
            
            <div class="section-title">ğŸ›¡ï¸ é›‡å‘˜ / éšä»</div>
            <div class="shop-grid">${renderEmpGrid(hirelings)}</div>
        `;
    }

async function equipItem(invId, itemName) {
        showLoading(); // å¼€å¯è½¬åœˆ
        try {
            // 1. ä¸¥æ ¼æ£€æŸ¥ï¼šå»æ•°æ®åº“æŸ¥æœ€æ–°çš„åº“å­˜
            const { data: invItem, error } = await supabaseClient
                .from('user_inventory')
                .select('id, quantity')
                .eq('id', invId)
                .single();

            // å¼‚å¸¸å¤„ç†ï¼šå¦‚æœåº“å­˜ä¹Ÿæ²¡äº†ï¼Œæˆ–è€…æŠ¥é”™
            if (error || !invItem || invItem.quantity < 1) {
                alert('è£…å¤‡å¤±è´¥ï¼šç‰©å“ä¸å­˜åœ¨æˆ–æ•°é‡ä¸è¶³ï¼');
                closeModal('equip-modal');
                await loadInventory(); // å¼ºåˆ¶åˆ·æ–°çº æ­£å‰ç«¯æ˜¾ç¤º
                hideLoading();
                return;
            }

            // 2. æ‰£åº“å­˜
            if (invItem.quantity > 1) {
                await supabaseClient.from('user_inventory').update({ quantity: invItem.quantity - 1 }).eq('id', invId);
            } else {
                // å¦‚æœåªå‰©1ä¸ªï¼Œç›´æ¥åˆ é™¤
                await supabaseClient.from('user_inventory').delete().eq('id', invId);
            }

            // 3. å†™å…¥è£…å¤‡æ 
            const { error: equipError } = await supabaseClient.from('equipped_items').insert([{ 
                employee_id: currentEquipTarget.empId, 
                slot_index: currentEquipTarget.slotIdx, 
                item_name: itemName 
            }]);

            if (equipError) throw equipError;

            // 4. ã€è¡¥å›ã€‘è®°å½•æ“ä½œæ—¥å¿—
            // è¿™æ ·ä½ åœ¨åå°å°±èƒ½çœ‹åˆ°ï¼šâ€œmaster@... å°† [è´¤è€…æ³•æ–] è£…å¤‡ç»™äº† ç‹å‚æ¨±â€
            await logAction('è£…å¤‡ç‰©å“', `å°† [${itemName}] è£…å¤‡ç»™é˜Ÿå‘˜ (ID:${currentEquipTarget.empId})`);

            closeModal('equip-modal'); 
            
            // 5. åˆ·æ–°ç•Œé¢
            await Promise.all([loadTeam(), loadInventory()]);

        } catch (e) {
            console.error("è£…å¤‡å‡ºé”™:", e);
            alert('æ“ä½œå¼‚å¸¸ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ');
        } finally {
            hideLoading(); // å…³é—­è½¬åœˆ
        }
    }

    async function unequipItem(equipId) {
        if (!confirm('ç¡®å®šå¸ä¸‹è¯¥è£…å¤‡ï¼Ÿ')) return;
        showLoading();
        try {
            // 1. è·å–è£…å¤‡ä¿¡æ¯
            const { data: eqItem } = await supabaseClient.from('equipped_items').select('*').eq('id', equipId).single();
            if (!eqItem) throw new Error("è£…å¤‡ä¸å­˜åœ¨");

            // 2. å°è¯•æ”¾å›èƒŒåŒ…
            const { data: exist } = await supabaseClient.from('user_inventory')
                .select('*')
                .eq('user_id', userProfile.id)
                .eq('item_name', eqItem.item_name)
                .maybeSingle();

            if (exist) {
                await supabaseClient.from('user_inventory').update({ quantity: exist.quantity + 1 }).eq('id', exist.id);
            } else {
                await supabaseClient.from('user_inventory').insert([{ 
                    user_id: userProfile.id, 
                    item_name: eqItem.item_name, 
                    quantity: 1, 
                    category: 'è£…å¤‡' // é»˜è®¤å½’ç±»
                }]);
            }

            // 3. ä»èº«ä¸Šåˆ é™¤
            await supabaseClient.from('equipped_items').delete().eq('id', equipId);

            // 4. è®°å½•æ—¥å¿—
            await logAction('å¸ä¸‹è£…å¤‡', `å¸ä¸‹äº† [${eqItem.item_name}] (é˜Ÿå‘˜ID:${eqItem.employee_id})`);

            await loadTeam(); 
            await loadInventory();
        } catch(e) { 
            console.error(e); 
            alert('å¸è½½å¤±è´¥');
        } finally {
            hideLoading();
        }
    }

async function openEquipModal(empId, slotIdx) {
        currentEquipTarget = { empId, slotIdx };
        const list = document.getElementById('equip-list');
        list.innerHTML = 'æ­£åœ¨å¼€å¯ä½é¢èƒŒåŒ…...';
        document.getElementById('equip-modal').style.display = 'flex';
        
        const { data: inv, error } = await supabaseClient
            .from('user_inventory')
            .select('*')
            .eq('user_id', viewingUserId) 
            .in('category', ['è£…å¤‡', 'é­”æ³•ç‰©å“'])
            .gt('quantity', 0);

        if (error) {
            console.error(error);
            list.innerHTML = '<div style="color:red">èƒŒåŒ…å¼€å¯å¤±è´¥</div>';
            return;
        }

        list.innerHTML = '';
        if (!inv || inv.length === 0) {
            list.innerHTML = '<div style="text-align:center; color:#999; padding:20px;">èƒŒåŒ…ä¸­æ²¡æœ‰å¯ç”¨çš„è£…å¤‡æˆ–é­”æ³•ç‰©å“</div>';
            return;
        }

        inv.forEach(item => {
            list.innerHTML += `
                <div onclick="equipItem(${item.id}, '${item.item_name}')">
                    <span>${item.item_name}</span>
                    <span style="color:#999; font-size:0.8em;">x${item.quantity}</span>
                </div>`;
        });
    }

    async function addToParty(id) {
        showLoading();
        await supabaseClient.from('employees').update({ is_in_party: true }).eq('id', id);
        closeModal('member-modal'); await loadTeam();
        hideLoading();
    }
    async function removeFromParty(id) {
        if (!confirm('ç¡®å®šç¦»é˜Ÿï¼Ÿ')) return;
        showLoading();
        await supabaseClient.from('employees').update({ is_in_party: false }).eq('id', id);
        await loadTeam();
        hideLoading();
    }
    async function requestFire(id) {
        if (!confirm('ç¡®å®šç”³è¯·è§£é›‡ï¼Ÿ')) return;
        showLoading();
        await supabaseClient.from('employees').update({ status: 'ç”³è¯·è§£é›‡' }).eq('id', id);
        await loadEmployees();
        hideLoading();
    }
    
    // åŸºç¡€åŠ è½½ (ä¿®å¤èƒŒåŒ…åˆ†ç±»)
    async function loadInventory() {
        const container = document.getElementById('inventory-container');
        container.innerHTML = 'æ¸…ç‚¹ä¸­...';
        const { data: inv } = await supabaseClient.from('user_inventory').select('*').eq('user_id', viewingUserId).order('category');
        if (!inv) return;
        container.innerHTML = '';
        const categories = [...new Set(inv.map(i => i.category || 'æ‚é¡¹'))];
        categories.forEach(cat => {
            const section = document.createElement('div');
            section.className = 'inventory-category';
            section.innerHTML = `<h3>${cat}</h3>`;
            const grid = document.createElement('div');
            grid.className = 'inventory-grid';
            inv.filter(i => (i.category || 'æ‚é¡¹') === cat).forEach(item => {
                grid.innerHTML += `<div class="inv-card"><span>${item.item_name}</span><span style="font-weight:bold; color:#666">x${item.quantity}</span></div>`;
            });
            section.appendChild(grid);
            container.appendChild(section);
        });
    }

    // è¾…åŠ©
    function closeModal(id) { document.getElementById(id).style.display = 'none'; }
    //é˜Ÿå‘˜å¼¹çª—
    async function openMemberModal() {
        const list = document.getElementById('member-select-list');
        list.innerHTML = 'åŠ è½½ä¸­...';
        document.getElementById('member-modal').style.display = 'flex';
        
        // è¿™æ ·å½“å‰è§†è§’æ˜¯è°ï¼Œå°±åªèƒ½çœ‹åˆ°è°çš„é›‡å‘˜
        const { data: candidates } = await supabaseClient
            .from('employees')
            .select('*')
            .eq('status', 'åœ¨èŒ')
            .eq('is_in_party', false)
            .eq('user_id', viewingUserId) 
            .order('id');
            
        list.innerHTML = '';
        if (!candidates || candidates.length === 0) {
            return list.innerHTML = '<div style="padding:10px;text-align:center;color:#999">æ²¡æœ‰å¯ç”¨çš„é›‡å‘˜</div>';
        }
        
        candidates.forEach(c => {
            list.innerHTML += `
                <div onclick="addToParty(${c.id})">
                    <span>
                        <img src="${c.avatar_url||''}" style="width:24px;border-radius:50%;vertical-align:middle;margin-right:8px;"> 
                        ${c.name}
                    </span>
                    <span style="color:#999">${c.role||'é›‡å‘˜'}</span>
                </div>`;
        });
    }

// ç™»å½•é€»è¾‘---
    async function login() {
        const email = document.getElementById('login-email').value;
        const password = document.getElementById('login-password').value;
        const btn = document.querySelector('#login-section button');
        
        if (!email || !password) return alert('è¯·è¾“å…¥è´¦å·å¯†ç ');

        btn.innerText = 'å®‰å…¨æ£€æŸ¥ä¸­...';
        btn.disabled = true;

        const fingerprint = [
            navigator.language,
            screen.colorDepth,
            screen.width + 'x' + screen.height,
            new Date().getTimezoneOffset(),
            navigator.hardwareConcurrency
        ].join('|');

        let ip = 'æ— æ³•è·å–(å¯èƒ½å±è”½äº†è¿½è¸ª)';
        const ipApis = [
            'https://api.ipify.org?format=json',
            'https://icanhazip.com',
            'https://ipapi.co/json/'
        ];

        for (let api of ipApis) {
            try {
                const res = await fetch(api, { timeout: 2000 });
                const text = await res.text();
                const match = text.match(/\d+\.\d+\.\d+\.\d+/);
                if (match) { ip = match[0]; break; }
            } catch (e) {}
        }
        const { data, error } = await supabaseClient.auth.signInWithPassword({ email, password });
        const status = error ? `å¤±è´¥: ${error.message}` : 'æˆåŠŸ';
        
        await supabaseClient.from('login_logs').insert([{
            email: email,
            ip_address: ip,
            status: status,
            user_agent: `${fingerprint} | ${navigator.userAgent}` 
        }]);

        btn.innerText = 'å¯åŠ¨';
        btn.disabled = false;

        if (error) {
            alert('ç™»å½•å¤±è´¥: ' + error.message);
        } else {
            checkUser();
        }
    }

    async function logout() { await supabaseClient.auth.signOut(); location.reload(); }

     // checkUserï¼šè·å–ç®¡ç†å‘˜ç­‰çº§
    async function checkUser() {
        const { data: { user } } = await supabaseClient.auth.getUser();
        if (user) {
            myId = user.id;
            currentUserEmail = user.email;
            
            const { data: adminData } = await supabaseClient.from('admin_users').select('role_level').eq('id', user.id).maybeSingle();

            if (adminData) {
                currentUserRole = adminData.role_level;
                document.getElementById('admin-link').style.display = 'inline';
                document.getElementById('role-badge').innerText = currentUserRole.toUpperCase();
                
                // ã€Root ä¸“äº«ã€‘ï¼šæ˜¾ç¤ºå¯¼èˆªæ çš„å®‰å…¨æ ‡ç­¾
                if (currentUserRole === 'root') {
                    document.getElementById('security-tab-btn').style.display = 'inline-block';
                }
                loadAdminData();
            }
            
            if (!viewingUserId) viewingUserId = user.id;
            document.getElementById('login-section').style.display = 'none';
            document.getElementById('main-section').style.display = 'block';
            refreshAllData();
        }
    }


let currentDate = { year: 1494, month: 2, day: 12 }; // é»˜è®¤å€¼

    // æ”¹åï¼šä¸å†æ˜¯ Global Dateï¼Œè€Œæ˜¯ User Date
    // 1. ä¿®æ”¹åŠ è½½æ—¶é—´å‡½æ•°ï¼šé¡ºä¾¿æŠŠæ—¶é—´å¡«å…¥è¾“å…¥æ¡†
    async function loadUserDate() {
        const { data: prof } = await supabaseClient.from('profiles').select('world_date').eq('id', viewingUserId).single();
        if (prof && prof.world_date) {
            currentDate = prof.world_date;
            document.getElementById('date-text').innerText = `FR${currentDate.year} ${currentDate.month}æœˆ${currentDate.day}æ—¥`;
            
            // ã€æ–°å¢ã€‘å›æ˜¾åˆ° DM åå°è¾“å…¥æ¡†
            if(document.getElementById('time-year')) {
                document.getElementById('time-year').value = currentDate.year;
                document.getElementById('time-month').value = currentDate.month;
                document.getElementById('time-day').value = currentDate.day;
            }
        }
    }

    // 2. æ–°å¢ï¼šä»»æ„ä¿®æ”¹æ—¶é—´é€»è¾‘
    async function updateTimeManual() {
        if (!viewingUserId) return alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªè§†è§’');

        const y = parseInt(document.getElementById('time-year').value);
        const m = parseInt(document.getElementById('time-month').value);
        const d = parseInt(document.getElementById('time-day').value);

        if (!y || !m || !d) return alert('æ—¥æœŸæ ¼å¼ä¸å¯¹');

        // åˆ¤æ–­æ˜¯å¦è·¨æœˆï¼ˆç®€å•çš„é€»è¾‘ï¼šåªè¦æœˆä»½æˆ–å¹´ä»½å˜äº†ï¼Œå°±æç¤ºæ‰£æ¬¾ï¼‰
        const isMonthChanged = (y !== currentDate.year) || (m !== currentDate.month);
        
        if (isMonthChanged) {
            const confirmPay = confirm(`âš ï¸ æ£€æµ‹åˆ°æœˆä»½å˜åŒ–ï¼\n\næ˜¯å¦è§¦å‘è¯¥ç©å®¶çš„ [æœˆåº¦è‡ªåŠ¨æ‰£è–ª]ï¼Ÿ\n\n[ç¡®å®š] = æ‰£é’±å¹¶è·³è½¬\n[å–æ¶ˆ] = ä¸æ‰£é’±ï¼Œä»…è·³è½¬`);
            
            if (confirmPay) {
                // æ‰§è¡Œæ‰£æ¬¾é€»è¾‘
                const { data: emps } = await supabaseClient.from('employees').select('salary').eq('user_id', viewingUserId).eq('status', 'åœ¨èŒ');
                if (emps && emps.length > 0) {
                    const totalSalary = emps.reduce((sum, e) => sum + e.salary, 0);
                    if (totalSalary > 0) {
                        const { data: prof } = await supabaseClient.from('profiles').select('gold_gp').eq('id', viewingUserId).single();
                        await supabaseClient.from('profiles').update({ gold_gp: prof.gold_gp - totalSalary }).eq('id', viewingUserId);
                        await logAction('ç³»ç»Ÿæ‰£æ¬¾', `æ—¶é—´è·ƒè¿è§¦å‘æ‰£è–ªï¼š${totalSalary} GP`);
                        alert(`å·²æ‰£é™¤ ${totalSalary} GP`);
                    }
                }
            }
        }

        // æ›´æ–°æ•°æ®åº“æ—¶é—´
        showLoading();
        await supabaseClient.from('profiles').update({ 
            world_date: { year: y, month: m, day: d } 
        }).eq('id', viewingUserId);
        
        await logAction('æ—¶é—´è·ƒè¿', `DM å°†æ—¶é—´è°ƒæ•´ä¸º FR${y}/${m}/${d}`);
        await refreshAllData();
        hideLoading();
    }


async function loadGold() {
        // æ¯æ¬¡éƒ½æ ¹æ®å½“å‰ viewingUserId é‡æ–°æŠ“å–
        const { data: profile, error } = await supabaseClient
            .from('profiles')
            .select('*')
            .eq('id', viewingUserId)
            .single();

        if (error) {
            console.error("åŠ è½½èµ„äº§å¤±è´¥:", error);
            userProfile = null;
            document.getElementById('gold-amount').innerText = "???";
            return;
        }

        userProfile = profile; // èµ‹å€¼ç»™å…¨å±€å˜é‡ä¾›å…¶ä»–å‡½æ•°ä½¿ç”¨
        document.getElementById('gold-amount').innerText = profile.gold_gp.toLocaleString();
    }


    function switchTab(tab) {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        
        // æ‰¾åˆ°ç‚¹å‡»çš„æŒ‰é’®å¹¶æ¿€æ´»
        const activeBtn = Array.from(document.querySelectorAll('.tab-btn')).find(b => b.getAttribute('onclick').includes(`'${tab}'`));
        if (activeBtn) activeBtn.classList.add('active');
        
        document.getElementById(`${tab}-section`).classList.add('active');
        
        // å¦‚æœåˆ‡åˆ°å®‰å…¨æ¨¡å—ï¼Œè‡ªåŠ¨åŠ è½½æ—¥å¿—
        if (tab === 'security') {
            loadAllAccounts();
            loadLogs();
            loadLoginLogs();
        }
    }

    function toggleAdmin() {
        const p = document.getElementById('admin-panel');
        p.style.display = p.style.display === 'block' ? 'none' : 'block';

        if (p.style.display === 'block') {
            const securityPanel = document.getElementById('security-panel-container');
            if (securityPanel) {
                // åªæœ‰ Root èƒ½çœ‹ç½‘å®‰
                securityPanel.style.display = (currentUserRole === 'root') ? 'flex' : 'none';
            }
        }
        if (p.style.display === 'block' && currentUserRole === 'root') {
            loadAllAccounts(); // è‡ªåŠ¨åŠ è½½è´¦å·
        }
    }
// --- é›†å¸‚åŠ è½½å‡½æ•° ---
    async function loadShop() {
        const grid = document.getElementById('shop-grid');
        grid.innerHTML = 'æ­£åœ¨è¿æ¥é›†å¸‚...';

        // --- æ ¸å¿ƒä¿®å¤ï¼šéš”ç¦»æŸ¥è¯¢ ---
        // é€»è¾‘ï¼šæŸ¥è¯¢ (user_id ä¸ºç©º) æˆ–è€… (user_id ç­‰äºå½“å‰æ­£åœ¨æŸ¥çœ‹çš„è§†è§’ID)
        const { data, error } = await supabaseClient
            .from('shop_items')
            .select('*')
            .or(`user_id.is.null,user_id.eq.${viewingUserId}`);

        if (error) {
            console.error(error);
            grid.innerHTML = 'é›†å¸‚åŠ è½½å¤±è´¥';
            return;
        }

        const canManage = currentUserRole === 'root' || currentUserRole === 'dm';
        const rarityWeight = { 'ç¥å™¨': 6, 'ä¼ è¯´': 5, 'æçç¨€': 4, 'çç¨€': 3, 'éæ™®é€š': 2, 'æ™®é€š': 1 };

        // --- æƒé‡æ’åº ---
        data.sort((a, b) => {
            const weightA = rarityWeight[a.rarity] || 0;
            const weightB = rarityWeight[b.rarity] || 0;
            if (weightA !== weightB) return weightB - weightA;
            return b.price - a.price;
        });

        grid.innerHTML = '';
        if (data.length === 0) {
            grid.innerHTML = '<div style="color:#999; padding:20px; grid-column:1/-1; text-align:center;">æ­¤ä½é¢é›†å¸‚ç©ºç©ºå¦‚ä¹Ÿ...</div>';
            return;
        }

        grid.innerHTML = data.map(i => {
            const color = rarityColors[i.rarity] || '#ccc';
            const isOut = i.stock <= 0;
            const deleteBtn = canManage ? `<button onclick="deleteShopItem(${i.id}, '${i.name}')" style="background:#e74c3c; color:white; border:none; margin-top:8px; font-size:0.8em; padding:5px; width:100%; border-radius:4px;">ğŸ—‘ï¸ ä¸‹æ¶å•†å“</button>` : '';

            return `
                <div class="card" style="position:relative; padding-top:25px; ${isOut ? 'opacity:0.6; background:#f9f9f9;' : ''}">
                    <span class="rarity-tag" style="background:${color}; color:white; font-size:0.7em; padding:2px 6px; border-radius:2px; position:absolute; top:8px; right:8px; font-weight:bold;">
                        ${i.rarity || 'æ™®é€š'}
                    </span>
                    <div style="font-size:0.7em; color:#3498db; margin-bottom:2px;">${i.user_id ? 'ğŸ‘¤ ç‰¹ä¾›' : 'ğŸŒ å…¬å…±'}</div>
                    <b>${i.name}</b>
                    <div style="font-size:0.75em; color:#777; margin:5px 0; line-height:1.4;">${i.description || ''}</div>
                    <div style="font-size:0.8em; color:#666; margin:5px 0;">åˆ†ç±»: ${i.category || 'æ‚é¡¹'}</div>
                    <div style="color:#d35400; font-weight:bold; font-size:1.1em; margin:8px 0;">ğŸ’° ${i.price} GP</div>
                    <div style="font-size:0.8em; color:${isOut ? 'red' : '#999'}; margin-bottom:8px;">
                        ${isOut ? 'âŒ å·²å”®ç½„' : `åº“å­˜: ${i.stock}`}
                    </div>
                    <button class="btn-buy" onclick="buy(${i.id}, ${i.price}, '${i.name}', '${i.category}')" ${isOut ? 'disabled' : ''}>
                        ${isOut ? 'ç¼ºè´§' : 'ç¡®è®¤è´­ä¹°'}
                    </button>
                    ${deleteBtn}
                </div>`;
        }).join('');
    }

    // 3. æ–°å¢ï¼šä¸‹æ¶å•†å“é€»è¾‘
    async function deleteShopItem(id, name) {
        if (!confirm(`ç¡®å®šè¦å°† [${name}] æ°¸ä¹…ä¸‹æ¶å—ï¼Ÿ`)) return;
        
        showLoading();
        const { error } = await supabaseClient.from('shop_items').delete().eq('id', id);
        
        if (error) {
            alert('ä¸‹æ¶å¤±è´¥ï¼š' + error.message);
        } else {
            await logAction('DMæ“ä½œ', `ä¸‹æ¶äº†é›†å¸‚å•†å“ [${name}]`);
            loadShop();
        }
        hideLoading();
    }



    // 1. è´­ä¹° (å¢åŠ æ—¥å¿—)
    async function buy(id, p, n, c) {
        showLoading();
        try {
            await loadGold(); 
            
            if (!userProfile) {
                alert('åŒæ­¥ä½é¢èµ„äº§å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
                hideLoading();
                return;
            }

            if (userProfile.gold_gp < p) {
                alert('é‡‘å¸ä¸è¶³ï¼');
                hideLoading();
                return;
            }

            // 1. æ‰£é™¤åº“å­˜é€»è¾‘ (å·²æœ‰çš„)
            const { data: shopItem } = await supabaseClient.from('shop_items').select('stock').eq('id', id).single();
            if (!shopItem || shopItem.stock <= 0) {
                alert('æ‰‹æ…¢äº†ï¼Œè¯¥ç‰©å“å·²å”®ç½„ï¼');
                loadShop();
                hideLoading();
                return;
            }

            // 2. æ›´æ–°æ•°æ®åº“ï¼šæ‰£é’± + å‡åº“å­˜
            await supabaseClient.from('profiles').update({ gold_gp: userProfile.gold_gp - p }).eq('id', viewingUserId);
            await supabaseClient.from('shop_items').update({ stock: shopItem.stock - 1 }).eq('id', id);

            // 3. æ”¾å…¥èƒŒåŒ…
            const { data: inv } = await supabaseClient.from('user_inventory').select('id,quantity').eq('user_id', viewingUserId).eq('item_name', n).maybeSingle();
            if (inv) {
                await supabaseClient.from('user_inventory').update({ quantity: inv.quantity + 1 }).eq('id', inv.id);
            } else {
                await supabaseClient.from('user_inventory').insert([{ user_id: viewingUserId, item_name: n, quantity: 1, category: c }]);
            }

            await logAction('è´­ä¹°ç‰©å“', `è´­ä¹°äº† [${n}]ï¼ŒèŠ±è´¹ ${p} GP`);
            alert('äº¤æ˜“æˆåŠŸï¼');
            await refreshAllData(); // åˆ·æ–°æ‰€æœ‰ç•Œé¢
        } catch (e) {
            console.error(e);
            alert('è´­ä¹°å¼‚å¸¸');
        } finally {
            hideLoading();
        }
    }

    // ================== é€šç”¨æ—¥å¿—å‡½æ•° ==================
    async function logAction(actionType, details) {
        const { data: { user } } = await supabaseClient.auth.getUser();
        if (user) {
            await supabaseClient.from('audit_logs').insert([{
                user_email: user.email,
                action_type: actionType,
                details: details
            }]);
        }
    }

// --- DM ä¸Šå¸æ¨¡å¼é€»è¾‘ (ä¿®å¤ç‰ˆ) ---

    // åŠ è½½ç®¡ç†å‘˜æ‰€éœ€æ•°æ®
    async function loadAdminData() {
        const ulist = document.getElementById('adm-user-list');
        ulist.innerHTML = '<option value="">åŠ è½½ä¸­...</option>';

        // åŸºç¡€æŸ¥è¯¢
        let query = supabaseClient.from('profiles').select('id, email');

        // --- æ ¸å¿ƒéš”ç¦»é€»è¾‘ ---
        if (currentUserRole === 'root') {
            // Root ç”¨æˆ·ï¼šä¸åŠ ä»»ä½• filterï¼Œç›´æ¥æŸ¥å…¨è¡¨
            console.log("Root æƒé™ï¼šåŠ è½½å…¨æœç©å®¶");
        } else if (currentUserRole === 'dm') {
            // æ™®é€š DMï¼šåªæŸ¥å½’å±è‡ªå·±çš„ç©å®¶
            console.log("DM æƒé™ï¼šåŠ è½½åä¸‹ç©å®¶");
            query = query.eq('assigned_dm_id', myId);
        } else {
            // ç©å®¶è§’è‰²ï¼šæ²¡æƒçœ‹è¿™ä¸ªåˆ—è¡¨
            ulist.innerHTML = '<option value="">æƒé™ä¸è¶³</option>';
            return;
        }

        const { data: users, error } = await query;
        
        if (error) {
            ulist.innerHTML = '<option value="">è¯»å–å¤±è´¥</option>';
            return;
        }

        ulist.innerHTML = '<option value="">-- é€‰æ‹©ç©å®¶ --</option>';
        if (users && users.length > 0) {
            users.forEach(u => {
                ulist.innerHTML += `<option value="${u.id}">${u.email}</option>`;
            });
        } else {
            ulist.innerHTML = '<option value="">(æ— å…³è”ç©å®¶)</option>';
        }

        // é¡ºä¾¿åˆ·æ–°ä¸€ä¸‹æ—¥å¿—è®°å½•
        if (currentUserRole === 'root') {
            loadLogs();
            loadLoginLogs();
        }
    }

    // 2. é€‰ä¸­ç©å®¶åï¼ŒåŠ è½½è¯¦ç»†ä¿¡æ¯
     // ================== ä¿®å¤åçš„ DM èƒŒåŒ…è¯»å– ==================
    let selectedUserId = null;
    // --- ä¿®å¤ç‰ˆ DM ç©å®¶è¯¦æƒ…åŠ è½½ ---
    async function loadUserDetail() {
        // 1. è·å–é€‰ä¸­çš„ ID
        selectedUserId = document.getElementById('adm-user-list').value;
        const detailBox = document.getElementById('user-detail');

        if (!selectedUserId) {
            detailBox.style.display = 'none';
            // å–æ¶ˆé€‰æ‹©ï¼Œåˆ‡å›è‡ªå·±
            viewingUserId = selectedUserId || myId; 
            await refreshAllData(); 
            // æ¸…ç©ºå¤´åƒåˆ—è¡¨
            document.getElementById('adm-emp-list').innerHTML = '';
            return;
        }

        // 2. æ˜¾ç¤ºé¢æ¿ & åˆ‡æ¢è§†è§’
        detailBox.style.display = 'block';
        viewingUserId = selectedUserId;
        
        // 3. åˆ·æ–°ä¸»ç•Œé¢æ•°æ®
        await refreshAllData();

        // 4. å¡« DM é¢æ¿çš„å°æ•°æ® (é‡‘å¸)
        const { data: prof } = await supabaseClient.from('profiles').select('gold_gp').eq('id', selectedUserId).single();
        if (prof) document.getElementById('adm-user-gold').value = prof.gold_gp;

        // 5. å¡« DM é¢æ¿çš„èƒŒåŒ…é¢„è§ˆ
        const { data: inv } = await supabaseClient
            .from('user_inventory')
            .select('item_name, quantity, category')
            .eq('user_id', selectedUserId)
            .order('category');

        const invDiv = document.getElementById('adm-user-inv');
        if (inv && inv.length > 0) {
            invDiv.innerHTML = inv.map(i => `
                <div style="display:flex; justify-content:space-between; font-size:0.85em; border-bottom:1px dashed #eee; padding:2px;">
                    <span>[${i.category||'æ‚'}] ${i.item_name}</span>
                    <strong>x${i.quantity}</strong>
                    <button onclick="admRemoveInv(${i.id}, '${i.item_name}', ${i.quantity})" style="border:none; background:none; color:red; cursor:pointer;">Ã—</button>
                </div>
            `).join('');
        } else {
            invDiv.innerHTML = '<div style="color:#999; text-align:center; padding:10px;">(èƒŒåŒ…æ˜¯ç©ºçš„)</div>';
        }

        // 6. ã€æ–°å¢ã€‘åˆ·æ–° DM é¢æ¿é‡Œçš„â€œé›‡å‘˜å¤´åƒåˆ—è¡¨â€
        // è¿™æ ·ä½ é€‰äº†è°ï¼Œå°±åªèƒ½ç»™è°çš„é›‡å‘˜ä¸Šä¼ å¤´åƒ
        const { data: emps } = await supabaseClient
            .from('employees')
            .select('id, name')
            .eq('user_id', selectedUserId); // åªæŸ¥è¿™ä¸ªç©å®¶çš„

        const empSelect = document.getElementById('adm-emp-list');
        empSelect.innerHTML = '';
        if (emps && emps.length > 0) {
            emps.forEach(e => {
                empSelect.innerHTML += `<option value="${e.id}">${e.name}</option>`;
            });
        } else {
            empSelect.innerHTML = '<option value="">(è¯¥ç©å®¶æ— é›‡å‘˜)</option>';
        }
        
        // å¦‚æœæ˜¯ Rootï¼Œæ˜¾ç¤º DM åˆ†é…æ¡†
    if (currentUserRole === 'root') {
        document.getElementById('root-assign-dm').style.display = 'block';
        
        // 1. æŸ¥å‡ºæ‰€æœ‰è´¦å·åŠå…¶é‚®ç®± (Root æœ‰æƒçœ‹å…¨è¡¨)
        const { data: allProfiles } = await supabaseClient.from('profiles').select('id, email');
        // 2. æŸ¥å‡ºæ‰€æœ‰ç®¡ç†å‘˜æƒé™
        const { data: allAdmins } = await supabaseClient.from('admin_users').select('id, role_level');

        const assignList = document.getElementById('adm-assign-dm-list');
        assignList.innerHTML = '<option value="">-- è®¾ç½®ä¸ºæœªåˆ†é… (å½’Rootç®¡) --</option>';
        
        if (allAdmins && allProfiles) {
            allAdmins.forEach(admin => {
                // åªè¦çº§åˆ«ä¸æ˜¯ playerï¼Œå°±æ˜¯æ½œåœ¨çš„è´Ÿè´£ DM
                if (admin.role_level !== 'player') {
                    // åŒ¹é…é‚®ç®±
                    const userProfile = allProfiles.find(p => p.id === admin.id);
                    if (userProfile) {
                        const email = userProfile.email;
                        assignList.innerHTML += `<option value="${admin.id}">${email} [${admin.role_level.toUpperCase()}]</option>`;
                    }
                }
            });
        }
        
        // å›æ˜¾å½“å‰ç©å®¶çš„å½’å±
        const { data: currentProf } = await supabaseClient.from('profiles').select('assigned_dm_id').eq('id', selectedUserId).single();
        assignList.value = currentProf.assigned_dm_id || "";
    }
    }

    async function assignDM() {
        const dmId = document.getElementById('adm-assign-dm-list').value;
        showLoading();
        await supabaseClient.from('profiles').update({ assigned_dm_id: dmId || null }).eq('id', selectedUserId);
        hideLoading();
        alert('åˆ†é…æˆåŠŸ');
    }

    // 2. æ–°å¢ï¼šDM åˆ é™¤ç©å®¶ç‰©å“é€»è¾‘
    async function admRemoveInv(itemId, itemName, currentQty) {
        // å¼¹çª—è¯¢é—®åˆ é™¤æ•°é‡
        let removeQty = prompt(`è¦æŠŠ [${itemName}] åˆ é™¤å¤šå°‘ä¸ªï¼Ÿ\n(å½“å‰æ‹¥æœ‰: ${currentQty})\nè¾“å…¥ 'all' æˆ–æ•°å­—`, "1");
        
        if (removeQty === null) return; // å–æ¶ˆ
        if (removeQty === 'all') removeQty = currentQty;
        else removeQty = parseInt(removeQty);

        if (isNaN(removeQty) || removeQty <= 0) return alert('æ— æ•ˆçš„æ•°é‡');
        if (removeQty > currentQty) return alert('åˆ çš„æ•°é‡ä¸èƒ½å¤§äºæ‹¥æœ‰çš„æ•°é‡');

        showLoading();

        try {
            if (removeQty >= currentQty) {
                // æ•°é‡åˆ å…‰äº†ï¼Œç›´æ¥ Delete è¿™ä¸€è¡Œ
                await supabaseClient.from('user_inventory').delete().eq('id', itemId);
                await logAction('DMæ“ä½œ', `ç§»é™¤äº†ç©å®¶(ID:${selectedUserId}) çš„æ‰€æœ‰ [${itemName}]`);
            } else {
                // æ•°é‡æ²¡åˆ å…‰ï¼ŒUpdate æ•°é‡
                await supabaseClient.from('user_inventory').update({ quantity: currentQty - removeQty }).eq('id', itemId);
                await logAction('DMæ“ä½œ', `æ‰£é™¤äº†ç©å®¶(ID:${selectedUserId}) çš„ [${itemName}] x${removeQty}`);
            }

            hideLoading();
            alert('æ“ä½œæˆåŠŸ');
            loadUserDetail(); // åˆ·æ–°åˆ—è¡¨
        } catch (e) {
            console.error(e);
            hideLoading();
            alert('åˆ é™¤å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–æƒé™');
        }
    }

    async function refreshAllData() {
        await loadUserDate();
        await loadGold();   
        await loadShop();
        await loadTeam();
        await loadInventory();
        await loadEmployees();
    }

    // ================== æ–°å¢ï¼šåŠ è½½æ—¥å¿— ==================
    async function loadLogs() {
        const logBox = document.getElementById('audit-log-container');
        logBox.innerHTML = 'åŠ è½½æ—¥å¿—ä¸­...';
        
        const { data: logs } = await supabaseClient
            .from('audit_logs')
            .select('*')
            .order('created_at', { ascending: false })
            .limit(50); // åªçœ‹æœ€è¿‘50æ¡

        if (!logs || logs.length === 0) {
            logBox.innerHTML = 'æš‚æ— æ“ä½œè®°å½•';
            return;
        }

        logBox.innerHTML = logs.map(log => {
            const time = new Date(log.created_at).toLocaleString();
            return `
                <div style="border-bottom:1px solid #eee; padding:8px 0; font-size:0.9em;">
                    <div style="color:#999; font-size:0.8em;">${time} - ${log.user_email}</div>
                    <div><span style="font-weight:bold; color:#333">[${log.action_type}]</span> ${log.details}</div>
                </div>`;
        }).join('');
    }

    // 3. ä¿®æ”¹é‡‘å¸
async function updateUserGold() {
        if (!selectedUserId) return;
        const newGold = document.getElementById('adm-user-gold').value;
        showLoading();
        await supabaseClient.from('profiles').update({ gold_gp: newGold }).eq('id', selectedUserId);
        
        // è®°å½•æ—¥å¿—
        await logAction('DMæ“ä½œ', `ä¿®æ”¹äº†ç©å®¶(ID:${selectedUserId})çš„é‡‘å¸ä¸º ${newGold}`);
        
        hideLoading(); alert('é‡‘å¸å·²ä¿®æ”¹');
    }

    // 4. ä¸Šå¸å‘è£…å¤‡
    async function admAddInv() {
        if (!selectedUserId) return alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªç©å®¶');
        
        const itemName = document.getElementById('adm-new-item').value;
        const itemCat = document.getElementById('adm-new-item-cat').value; // è·å–é€‰ä¸­çš„åˆ†ç±»
        
        if (!itemName) return alert('è¯·è¾“å…¥ç‰©å“å');

        showLoading();
        try {
            // æ£€æŸ¥ç©å®¶èƒŒåŒ…æ˜¯å¦å·²æœ‰ (åŒåä¸”åŒç±»)
            const { data: exist } = await supabaseClient
                .from('user_inventory')
                .select('*')
                .eq('user_id', selectedUserId)
                .eq('item_name', itemName)
                .maybeSingle();

            if (exist) {
                // å·²æœ‰åˆ™æ•°é‡+1
                await supabaseClient.from('user_inventory').update({ quantity: exist.quantity + 1 }).eq('id', exist.id);
            } else {
                // æ²¡æœ‰åˆ™æ–°å¢
                await supabaseClient.from('user_inventory').insert([{ 
                    user_id: selectedUserId, 
                    item_name: itemName, 
                    quantity: 1, 
                    category: itemCat 
                }]);
            }

            // è®°å½•æ—¥å¿—
            await logAction('DMæ“ä½œ', `ç»™ç©å®¶(ID:${selectedUserId}) å‘æ”¾äº† [${itemName}] (${itemCat})`);

            hideLoading();
            alert(`[${itemName}] å·²æˆåŠŸå¡å…¥èƒŒåŒ…`);
            document.getElementById('adm-new-item').value = ''; // æ¸…ç©ºè¾“å…¥æ¡†
            loadUserDetail(); // åˆ·æ–°è¯¦æƒ…
        } catch (e) {
            console.error(e);
            hideLoading();
            alert('å‘æ”¾å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ•°æ®åº“è¿æ¥');
        }
    }

    async function uploadAvatar() {
        const f = document.getElementById('adm-emp-avatar').files[0];
        const id = document.getElementById('adm-emp-list').value;
        showLoading();
        const { data } = await supabaseClient.storage.from('avatars').upload(`ava_${Date.now()}`, f);
        if(data) {
            const { data: u } = supabaseClient.storage.from('avatars').getPublicUrl(data.path);
            await supabaseClient.from('employees').update({avatar_url: u.publicUrl}).eq('id', id);
            alert('OK');
        }
        hideLoading();
    }
// --- çœŸæ­£çš„æ¨è¿›æ—¶é—´é€»è¾‘ ---
async function advanceTime() {
        if (!confirm(`ç¡®å®šæ¨è¿› [å½“å‰è§†è§’] çš„æ—¶é—´å—ï¼Ÿ\n(1å·å°†è‡ªåŠ¨æ‰£é™¤è¯¥ç©å®¶çš„è–ªèµ„)`)) return;

        showLoading();
        try {
            // 1. é€»è¾‘è®¡ç®—
            let { year, month, day } = currentDate;
            day++;
            if (day > 30) { day = 1; month++; }
            if (month > 12) { month = 1; year++; }
            
            const nextDate = { year, month, day };

            // 2. è‡ªåŠ¨æ‰£æ¬¾é€»è¾‘ (åªé’ˆå¯¹ viewingUserId)
            if (day === 1) {
                // åªæŸ¥å±äºå½“å‰è§†è§’ç©å®¶çš„é›‡å‘˜
                const { data: emps } = await supabaseClient
                    .from('employees')
                    .select('salary')
                    .eq('user_id', viewingUserId)
                    .eq('status', 'åœ¨èŒ');

                if (emps && emps.length > 0) {
                    const totalSalary = emps.reduce((sum, e) => sum + e.salary, 0);
                    
                    if (totalSalary > 0) {
                        // æŸ¥é’±
                        const { data: prof } = await supabaseClient.from('profiles').select('gold_gp').eq('id', viewingUserId).single();
                        // æ‰£é’±
                        await supabaseClient.from('profiles').update({ gold_gp: prof.gold_gp - totalSalary }).eq('id', viewingUserId);
                        // è®°æ—¥å¿—
                        await logAction('ç³»ç»Ÿæ‰£æ¬¾', `æ–°æœˆè‡ªåŠ¨æ‰£é™¤ç©å®¶(ID:${viewingUserId}) è–ªèµ„ï¼š${totalSalary} GP`);
                    }
                }
            }

            // 3. æ›´æ–°æ•°æ®åº“ (åªæ›´æ–° viewingUserId çš„æ—¶é—´)
            await supabaseClient
                .from('profiles')
                .update({ world_date: nextDate })
                .eq('id', viewingUserId);

            // 4. åˆ·æ–°
            await logAction('æ—¶é—´æ¨è¿›', `æ—¶é—´å˜æ›´ä¸º FR${year}/${month}/${day} (User:${viewingUserId})`);
            
            // å±€éƒ¨åˆ·æ–°å³å¯ï¼Œä¸éœ€è¦ reload æ•´ä¸ªé¡µé¢
            await refreshAllData(); 
            
        } catch (e) {
            console.error(e);
            alert('æ“ä½œå¤±è´¥');
        } finally {
            hideLoading();
        }
    }


async function adminAddItem() {
        const name = document.getElementById('adm-shop-name').value;
        const rarity = document.getElementById('adm-shop-rarity').value;
        const category = document.getElementById('adm-shop-cat').value;
        const price = parseInt(document.getElementById('adm-shop-price').value);
        const stock = parseInt(document.getElementById('adm-shop-stock').value);
        const description = document.getElementById('adm-shop-desc').value;
        const targetType = document.getElementById('adm-shop-target').value;

        if (!name || isNaN(price)) return alert('åç§°å’Œä»·æ ¼å¿…å¡«');

        // ã€æ ¸å¿ƒä¿®å¤ã€‘åŒé‡ä¿é™©è·å–ç›®æ ‡ç©å®¶ID
        // å¦‚æœ selectedUserId ä¸ºç©ºï¼Œå°è¯•ç›´æ¥ä»ä¸‹æ‹‰æ¡†å†å–ä¸€æ¬¡
        let targetUserId = selectedUserId;
        if (!targetUserId) {
            targetUserId = document.getElementById('adm-user-list').value;
        }

        // å¦‚æœé€‰äº† private ä½†æ²¡ IDï¼ŒæŠ¥é”™
        if (targetType === 'private') {
            if (!targetUserId) return alert('è¯·å…ˆåœ¨ä¸Šæ–¹ [ç©å®¶èµ„äº§æ“æ§] åˆ—è¡¨é€‰æ‹©ä¸€ä¸ªç©å®¶ï¼');
        } else {
            targetUserId = null; // å…¬å…±å•†å“ user_id ä¸ºç©º
        }

        showLoading();
        try {
            const { error } = await supabaseClient.from('shop_items').insert([{
                name, rarity, category, price, stock, description,
                user_id: targetUserId // å†™å…¥å½’å±
            }]);

            if (error) throw error;

            await logAction('DMè¿›è´§', `ä¸Šæ¶äº† [${name}] (${targetType === 'private' ? 'ç‰¹ä¾›' : 'å…¬å¼€'})`);
            alert('ä¸Šæ¶æˆåŠŸ');
            
            // æ¸…ç©ºè¾“å…¥
            document.getElementById('adm-shop-name').value = '';
            document.getElementById('adm-shop-price').value = '';
            document.getElementById('adm-shop-desc').value = '';
            loadShop();
        } catch (e) {
            console.error(e);
            alert('å¤±è´¥ï¼š' + e.message);
        } finally {
            hideLoading();
        }
    }


async function loadLoginLogs() {
        const container = document.getElementById('login-log-container');
        container.innerHTML = 'åŠ è½½ä¸­...';

        const { data: logs } = await supabaseClient
            .from('login_logs')
            .select('*')
            .order('created_at', { ascending: false })
            .limit(50);

        if (!logs) return;

        container.innerHTML = logs.map(log => {
            const time = new Date(log.created_at).toLocaleString();
            const isFail = log.status.indexOf('å¤±è´¥') !== -1;
            const color = isFail ? '#e74c3c' : '#2ecc71';
            const bgColor = isFail ? '#fff0f0' : '#f0fff0';
            const uaParts = log.user_agent.split(' | ');
            const deviceId = uaParts[0]; 

            return `
                <div style="border-bottom:1px solid #eee; padding:8px; background:${bgColor}; margin-bottom:2px; border-radius:4px;">
                    <div style="display:flex; justify-content:space-between; font-size:0.8em;">
                        <span style="color:#666;">${time}</span>
                        <span style="font-weight:bold; color:${color}">${isFail ? 'æ‹’ç»è®¿é—®' : 'éªŒè¯é€šè¿‡'}</span>
                    </div>
                    <div style="font-weight:bold; margin:3px 0;">ç”¨æˆ·: ${log.email}</div>
                    <div style="font-size:0.8em; color:#444;">IP: ${log.ip_address}</div>
                    <div style="font-size:0.7em; color:#999; word-break:break-all;">è®¾å¤‡æŒ‡çº¹: ${deviceId}</div>
                    ${isFail ? `<div style="color:red; font-size:0.8em; font-weight:bold;">${log.status}</div>` : ''}
                </div>`;
        }).join('');
    }
    // --- æ–°å¢ï¼šåŠ è½½æ‰€æœ‰è´¦å· (Rootä¸“ç”¨) ---
    async function loadAllAccounts() {
        const container = document.getElementById('account-list-container');
        container.innerHTML = 'æ­£åœ¨æ‹‰å–å…¨æœåå•...';

        // 1. è·å–æ‰€æœ‰ç”¨æˆ· (ä»æˆ‘ä»¬åˆšæ‰å»ºçš„ View æŸ¥)
        const { data: users, error } = await supabaseClient.from('admin_users_view').select('*').order('created_at', {ascending:false});
        
        if (error) {
            container.innerHTML = `<span style="color:red">åŠ è½½å¤±è´¥: ${error.message}</span>`;
            return;
        }

        // 2. è·å–å½“å‰çš„æƒé™è¡¨
        const { data: roles } = await supabaseClient.from('admin_users').select('*');
        
        // æ˜ å°„è¾…åŠ©å‡½æ•°
        const getRole = (id) => {
            const r = roles.find(x => x.id === id);
            return r ? r.role_level : 'player';
        };

        // 3. æ¸²æŸ“åˆ—è¡¨
        container.innerHTML = users.map(u => {
            const role = getRole(u.id);
            const roleColor = role === 'root' ? 'red' : (role === 'dm' ? 'blue' : 'green');
            const isMe = u.id === myId;

            return `
                <div style="border-bottom:1px solid #eee; padding:8px 4px; display:flex; justify-content:space-between; align-items:center;">
                    <div style="overflow:hidden; text-overflow:ellipsis;">
                        <div style="font-weight:bold;">${u.email}</div>
                        <div style="font-size:0.8em; color:#999;">${new Date(u.created_at).toLocaleDateString()} æ³¨å†Œ</div>
                    </div>
                    <div style="text-align:right;">
                        <span style="font-size:0.8em; color:${roleColor}; font-weight:bold; margin-right:5px;">${role.toUpperCase()}</span>
                        ${!isMe ? `
                        <select onchange="changeUserRole('${u.id}', this.value)" style="font-size:0.8em; padding:2px;">
                            <option value="">-- æ”¹æƒé™ --</option>
                            <option value="player">è®¾ä¸º Player</option>
                            <option value="dm">è®¾ä¸º DM</option>
                        </select>` : '<span style="font-size:0.8em; color:#ccc;">(è‡ªå·±)</span>'}
                    </div>
                </div>`;
        }).join('');
    }

    // --- æ–°å¢ï¼šä¿®æ”¹ç”¨æˆ·æƒé™ ---
    async function changeUserRole(targetId, newRole) {
        if (!newRole) return;
        if (!confirm(`ç¡®å®šè¦å°†è¯¥ç”¨æˆ·çš„æƒé™ä¿®æ”¹ä¸º [${newRole.toUpperCase()}] å—ï¼Ÿ`)) return;

        showLoading();
        try {
            const { error } = await supabaseClient.rpc('update_user_role', { 
                target_id: targetId, 
                new_role: newRole 
            });

            if (error) throw error;

            await logAction('æƒé™ä¿®æ”¹', `å°†ç”¨æˆ·(ID:${targetId}) æƒé™è®¾ä¸º ${newRole}`);
            alert('ä¿®æ”¹æˆåŠŸ');
            loadAllAccounts(); // åˆ·æ–°åˆ—è¡¨
        } catch (e) {
            console.error(e);
            alert('ä¿®æ”¹å¤±è´¥: ' + e.message);
        } finally {
            hideLoading();
        }
    }



    checkUser();
</script>
</body>
</html>



