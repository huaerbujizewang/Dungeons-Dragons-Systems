<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>D&D ç³»ç»Ÿ - å®Œç¾ç‰ˆ</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: "PingFang SC", sans-serif; background: #fff; color: #333; margin: 0; padding: 20px; }
        .container { max-width: 1100px; margin: 0 auto; }
        .nav { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #333; padding-bottom: 10px; margin-bottom: 20px; }
        .tab-btn { padding: 10px 15px; cursor: pointer; border: none; background: none; font-size: 1em; opacity: 0.6; }
        .tab-btn.active { font-weight: bold; border-bottom: 3px solid #333; opacity: 1; }
        .gold-display { color: #d35400; font-weight: bold; font-size: 1.2em; }
        .date-display { background: #f1c40f; padding: 2px 8px; border-radius: 4px; font-weight: bold; }

        .section { display: none; }
        .section.active { display: block; }

        /* é›‡å‘˜æ ·å¼ */
        .emp-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; }
        .emp-card { border: 1px solid #eee; padding: 15px; text-align: center; border-radius: 8px; }
        .emp-avatar { width: 80px; height: 80px; border-radius: 50%; object-fit: cover; background: #eee; margin-bottom: 10px; }
        .status-tag { font-size: 0.7em; padding: 2px 5px; border-radius: 3px; background: #eee; }

        /* ç®¡ç†é¢æ¿æ ·å¼ */
        #admin-panel { display: none; position: fixed; top: 5%; left: 5%; width: 90%; height: 90%; background: white; border: 2px solid #333; z-index: 1000; padding: 20px; overflow-y: auto; box-shadow: 0 0 30px rgba(0,0,0,0.3); }
        .admin-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; }
        .admin-box { border: 1px solid #ddd; padding: 15px; border-radius: 5px; }
        
        button { cursor: pointer; border: 1px solid #333; background: #fff; padding: 5px 10px; }
        button:hover { background: #333; color: #fff; }
        .danger { border-color: #e74c3c; color: #e74c3c; }
    </style>
</head>
<body>

<div class="container">
    <!-- ç™»å½•æ¨¡å—ä¿æŒä¸å˜ -->
    <div id="login-section" style="max-width:300px; margin:100px auto; text-align:center;">
        <h2>D&D èµ„äº§ç®¡ç†ç³»ç»Ÿ</h2>
        <input type="email" id="login-email" placeholder="é‚®ç®±" style="width:100%; padding:10px; margin-bottom:10px;">
        <input type="password" id="login-password" placeholder="å¯†ç " style="width:100%; padding:10px; margin-bottom:10px;">
        <button onclick="login()" style="width:100%; padding:10px;">ç™»å½•</button>
    </div>

    <!-- ä¸»ç•Œé¢ -->
    <div id="main-section" style="display:none;">
        <div class="nav">
            <div>
                <button class="tab-btn active" onclick="switchTab('shop')">é›†å¸‚</button>
                <button class="tab-btn" onclick="switchTab('inventory')">æˆ‘çš„èƒŒåŒ…</button>
                <button class="tab-btn" onclick="switchTab('employees')">é›‡å‘˜ä¸­å¿ƒ</button>
                <span id="admin-link" style="display:none; color:blue; cursor:pointer; margin-left:20px; font-weight:bold" onclick="toggleAdmin()">âš™ï¸ DMä¸Šå¸æ¨¡å¼</span>
            </div>
            <div style="text-align:right">
                <div class="date-display" id="date-text">FR1494 2æœˆ12æ—¥</div>
                <div class="gold-display">ğŸ’° <span id="gold-amount">0</span> GP</div>
                <button onclick="logout()" style="font-size:0.7em; margin-top:5px;">é€€å‡º</button>
            </div>
        </div>

        <!-- å„ä¸ª Section -->
        <div id="shop-section" class="section active"><div id="shop-grid" style="display:grid; grid-template-columns:repeat(auto-fill, minmax(200px, 1fr)); gap:15px;"></div></div>
        
        <div id="inventory-section" class="section"><div id="inventory-container"></div></div>
        
        <div id="employees-section" class="section">
            <h3 id="salary-info">æ¯æœˆæ€»æ”¯å‡ºï¼š1132 GP (æ¯æœˆ1æ—¥è‡ªåŠ¨æ‰£é™¤)</h3>
            <div class="emp-grid" id="emp-grid"></div>
        </div>
    </div>
</div>

<!-- DMä¸Šå¸æ¨¡å¼é¢æ¿ -->
<div id="admin-panel">
    <div style="display:flex; justify-content:space-between;"><h2>DM ä¸Šå¸ç®¡ç†åå°</h2><button onclick="toggleAdmin()">å…³é—­</button></div>
    <div class="admin-grid">
        <!-- æ—¶é—´æ§åˆ¶ -->
        <div class="admin-box">
            <h3>â³ æ—¶é—´æµé€</h3>
            <button onclick="advanceTime()" style="padding:15px; font-size:1.2em; background:#f1c40f">æ¨è¿›ä¸€å¤© (Next Day)</button>
            <p>â€» è‹¥æ¨è¿›åˆ°1æ—¥ï¼Œä¼šè‡ªåŠ¨æ‰£é™¤ç©å®¶é›‡å‘˜è–ªèµ„ã€‚</p>
        </div>
        <!-- ç©å®¶ç®¡ç† -->
        <div class="admin-box">
            <h3>ğŸ‘¤ ç©å®¶èµ„äº§æ“æ§</h3>
            <select id="adm-user-list" onchange="loadUserDetail()"><option value="">è¯·é€‰æ‹©ç©å®¶</option></select>
            <div id="user-detail" style="margin-top:10px; display:none;">
                <p>å½“å‰é‡‘å¸: <input type="number" id="adm-user-gold"> <button onclick="updateUserGold()">ä¿®æ”¹</button></p>
                <p>å¢åŠ ç‰©å“: <input type="text" id="adm-new-item" placeholder="ç‰©å“å"> <button onclick="admAddInv()">ç›´æ¥å‘æ”¾</button></p>
                <div id="adm-user-inv" style="font-size:0.8em; color:#666"></div>
            </div>
        </div>
        <!-- å®¡æ‰¹ä¸­å¿ƒ -->
        <div class="admin-box">
            <h3>âš–ï¸ å®¡æ‰¹ä¸­å¿ƒ</h3>
            <div id="request-list">æš‚æ— å¾…å¤„ç†è¯·æ±‚</div>
        </div>
        <!-- é›‡å‘˜ç®¡ç†ï¼ˆå¤´åƒä¸Šä¼ ï¼‰ -->
        <div class="admin-box">
            <h3>ğŸ‘· é›‡å‘˜ä¿¡æ¯ä¿®æ”¹</h3>
            <select id="adm-emp-list"></select>
            <input type="file" id="adm-emp-avatar" accept="image/*">
            <button onclick="uploadAvatar()">ä¸Šä¼ å¹¶æ›´æ–°å¤´åƒ</button>
        </div>
    </div>
</div>

<script>
    const SUPABASE_URL = 'https://vbzfpgucpciqgaakqndz.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZiemZwZ3VjcGNpcWdhYWtxbmR6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc1OTc2MzMsImV4cCI6MjA4MzE3MzYzM30.fBVDirEJ52bvrYJZ5DNv7fVDLNgCwITKwdKqT6YJDYw';
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    let currentDate = { year: 1494, month: 2, day: 12 };
    let userProfile = null;
    const DM_EMAIL = '739477825@qq.com';

    // åˆå§‹åŒ–
    async function checkUser() {
        const { data: { user } } = await supabaseClient.auth.getUser();
        if (user) {
            document.getElementById('login-section').style.display = 'none';
            document.getElementById('main-section').style.display = 'block';
            if (user.email === DM_EMAIL) {
                document.getElementById('admin-link').style.display = 'inline';
                loadAdminData();
            }
            loadGlobalDate();
            loadAllData();
        }
    }

    // --- æ—¶é—´ç³»ç»Ÿ ---
    async function loadGlobalDate() {
        const { data } = await supabaseClient.from('global_settings').select('value').eq('key', 'current_date').single();
        if (data) {
            currentDate = data.value;
            document.getElementById('date-text').innerText = `FR${currentDate.year} ${currentDate.month}æœˆ${currentDate.day}æ—¥`;
        }
    }

    async function advanceTime() {
        let { year, month, day } = currentDate;
        day++;
        if (day > 30) { day = 1; month++; } // DNDç®€å•å†æ³•ï¼šæ¯æœˆ30å¤©
        if (month > 12) { month = 1; year++; }
        
        const nextDate = { year, month, day };
        await supabaseClient.from('global_settings').update({ value: nextDate }).eq('key', 'current_date');
        
        // å¦‚æœæ˜¯1å·ï¼Œè‡ªåŠ¨æ‰£å·¥èµ„
        if (day === 1) {
            const { data: emps } = await supabaseClient.from('employees').select('salary').eq('status', 'åœ¨èŒ');
            const totalSalary = emps.reduce((sum, e) => sum + e.salary, 0);
            
            // å‡è®¾æ‰£é™¤ master@almorel.com çš„é’±
            const { data: prof } = await supabaseClient.from('profiles').select('gold_gp, id').eq('email', 'master@almorel.com').single();
            if (prof) {
                await supabaseClient.from('profiles').update({ gold_gp: prof.gold_gp - totalSalary }).eq('id', prof.id);
                alert(`æ–°çš„ä¸€æœˆå¼€å§‹äº†ï¼å·²è‡ªåŠ¨æ”¯ä»˜è–ªèµ„ï¼š${totalSalary} GP`);
            }
        }
        location.reload();
    }

    // --- é›‡å‘˜ç³»ç»Ÿ ---
    async function loadEmployees() {
        const { data } = await supabaseClient.from('employees').select('*');
        const grid = document.getElementById('emp-grid');
        grid.innerHTML = '';
        let total = 0;
        data.forEach(e => {
            if (e.status === 'åœ¨èŒ') total += e.salary;
            grid.innerHTML += `
                <div class="emp-card">
                    <img src="${e.avatar_url || 'https://via.placeholder.com/80'}" class="emp-avatar">
                    <div style="font-weight:bold">${e.name}</div>
                    <div style="color:#d35400">${e.salary} GP/æœˆ</div>
                    <div class="status-tag">${e.status}</div>
                    ${e.status === 'åœ¨èŒ' ? `<button class="danger" onclick="requestFire(${e.id})">ç”³è¯·è§£é›‡</button>` : ''}
                </div>`;
        });
        document.getElementById('salary-info').innerText = `æ¯æœˆæ€»æ”¯å‡ºï¼š${total} GP (æ¯æœˆ1æ—¥è‡ªåŠ¨æ‰£é™¤)`;
    }

    async function requestFire(id) {
        if (confirm('ç¡®è®¤ç”³è¯·è§£é›‡è¯¥é›‡å‘˜ï¼Ÿéœ€è¦DMå®¡æ‰¹ã€‚')) {
            await supabaseClient.from('employees').update({ status: 'ç”³è¯·è§£é›‡' }).eq('id', id);
            loadEmployees();
        }
    }

    // --- DM ä¸Šå¸æ¨¡å¼ ---
    async function loadAdminData() {
        const { data: users } = await supabaseClient.from('profiles').select('email, id');
        const list = document.getElementById('adm-user-list');
        users.forEach(u => list.innerHTML += `<option value="${u.id}">${u.email}</option>`);

        const { data: emps } = await supabaseClient.from('employees').select('id, name');
        const elist = document.getElementById('adm-emp-list');
        emps.forEach(e => elist.innerHTML += `<option value="${e.id}">${e.name}</option>`);

        const { data: reqs } = await supabaseClient.from('employees').select('*').eq('status', 'ç”³è¯·è§£é›‡');
        const rbox = document.getElementById('request-list');
        if (reqs.length > 0) {
            rbox.innerHTML = reqs.map(r => `<div>${r.name} ç”³è¯·è§£é›‡ <button onclick="approveFire(${r.id}, true)">æ‰¹å‡†</button> <button onclick="approveFire(${r.id}, false)">æ‹’ç»</button></div>`).join('');
        }
    }

    async function approveFire(id, ok) {
        await supabaseClient.from('employees').update({ status: ok ? 'å·²è§£é›‡' : 'åœ¨èŒ' }).eq('id', id);
        alert('å¤„ç†å®Œæˆ');
        location.reload();
    }

    async function uploadAvatar() {
        const file = document.getElementById('adm-emp-avatar').files[0];
        const empId = document.getElementById('adm-emp-list').value;
        if (!file) return;

        const fileName = `${Date.now()}_${file.name}`;
        const { data, error } = await supabaseClient.storage.from('avatars').upload(fileName, file);

        if (data) {
            const { data: urlData } = supabaseClient.storage.from('avatars').getPublicUrl(fileName);
            await supabaseClient.from('employees').update({ avatar_url: urlData.publicUrl }).eq('id', empId);
            alert('å¤´åƒæ›´æ–°æˆåŠŸ');
            location.reload();
        }
    }

    // --- ç©å®¶ç®¡ç† ---
    let selectedUserId = null;
    async function loadUserDetail() {
        selectedUserId = document.getElementById('adm-user-list').value;
        if (!selectedUserId) return;
        document.getElementById('user-detail').style.display = 'block';
        const { data: prof } = await supabaseClient.from('profiles').select('*').eq('id', selectedUserId).single();
        document.getElementById('adm-user-gold').value = prof.gold_gp;
        
        const { data: inv } = await supabaseClient.from('user_inventory').select('*').eq('user_id', selectedUserId);
        document.getElementById('adm-user-inv').innerHTML = inv.map(i => `${i.item_name} x${i.quantity}`).join(' | ');
    }

    async function updateUserGold() {
        const newGold = document.getElementById('adm-user-gold').value;
        await supabaseClient.from('profiles').update({ gold_gp: newGold }).eq('id', selectedUserId);
        alert('é‡‘å¸å·²ä¿®æ”¹');
    }

    async function admAddInv() {
        const name = document.getElementById('adm-new-item').value;
        await supabaseClient.from('user_inventory').insert([{ user_id: selectedUserId, item_name: name, quantity: 1, category: 'é­”æ³•ç‰©å“' }]);
        alert('ç‰©å“å·²å‘æ”¾');
        loadUserDetail();
    }

    // --- åŸºç¡€å·¥å…·å‡½æ•° ---
    function switchTab(tab) {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        document.querySelector(`.tab-btn[onclick*="${tab}"]`).classList.add('active');
        document.getElementById(`${tab}-section`).classList.add('active');
        if (tab === 'employees') loadEmployees();
    }
    function toggleAdmin() { const p = document.getElementById('admin-panel'); p.style.display = p.style.display === 'block' ? 'none' : 'block'; }
    async function login() {
        const email = document.getElementById('login-email').value;
        const password = document.getElementById('login-password').value;
        await supabaseClient.auth.signInWithPassword({ email, password });
        checkUser();
    }
    async function logout() { await supabaseClient.auth.signOut(); location.reload(); }
    async function loadAllData() {
        const { data: { user } } = await supabaseClient.auth.getUser();
        const { data: profile } = await supabaseClient.from('profiles').select('*').eq('id', user.id).single();
        document.getElementById('gold-amount').innerText = profile ? profile.gold_gp : 0;
    }

    checkUser();
</script>
</body>
</html>
