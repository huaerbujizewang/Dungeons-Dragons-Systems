<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>D&D å°é˜Ÿç®¡ç†ç³»ç»Ÿ</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* CSS ä¿æŒåŸæ ·ä¸åŠ¨ */
        :root { --border: #e0e0e0; --bg: #f8f9fa; --active: #333; }
        body { font-family: "PingFang SC", sans-serif; background: #fff; color: #333; margin: 0; padding: 20px; }
        .container { max-width: 1100px; margin: 0 auto; }
        .nav { display: flex; gap: 10px; border-bottom: 2px solid #333; padding-bottom: 10px; margin-bottom: 20px; align-items: center; }
        .tab-btn { padding: 8px 16px; border: 1px solid transparent; background: none; cursor: pointer; font-size: 1em; color: #666; border-radius: 4px; }
        .tab-btn.active { background: #333; color: #fff; font-weight: bold; }
        .info-bar { margin-left: auto; text-align: right; font-size: 0.9em; }
        .section { display: none; }
        .section.active { display: block; }
        .team-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); gap: 20px; }
        .team-card { border: 1px solid var(--border); border-radius: 8px; padding: 15px; background: #fff; position: relative; }
        .team-header { display: flex; align-items: center; gap: 15px; margin-bottom: 15px; }
        .team-avatar { width: 60px; height: 60px; border-radius: 50%; object-fit: cover; background: #eee; border: 1px solid #ddd; }
        .team-info h3 { margin: 0; font-size: 1.1em; }
        .team-info p { margin: 2px 0 0; font-size: 0.8em; color: #666; }
        .slots-container { display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; }
        .slot { aspect-ratio: 1; border: 1px dashed #ccc; border-radius: 4px; display: flex; align-items: center; justify-content: center; font-size: 0.7em; text-align: center; cursor: pointer; background: #fafafa; padding: 2px; overflow: hidden; transition: 0.2s; }
        .slot:hover { border-color: #333; background: #f0f0f0; }
        .slot.filled { border: 1px solid #999; background: #fff; border-style: solid; }
        .slot-name { word-break: break-all; pointer-events: none; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; align-items: center; justify-content: center; }
        .modal-box { background: #fff; padding: 20px; border-radius: 8px; width: 400px; max-height: 80vh; overflow-y: auto; }
        .item-select-list div { padding: 10px; border-bottom: 1px solid #eee; cursor: pointer; display: flex; justify-content: space-between; }
        .item-select-list div:hover { background: #f9f9f9; }
        .shop-grid, .inventory-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; }
        .card { border: 1px solid #eee; padding: 15px; border-radius: 6px; }
        .btn-buy { width: 100%; margin-top: 10px; padding: 6px; background: #fff; border: 1px solid #333; cursor: pointer; }
        .btn-buy:hover { background: #333; color: #fff; }
        #admin-panel { display: none; position: fixed; top: 5%; left: 5%; width: 90%; height: 90%; background: #fff; border: 2px solid #333; z-index: 3000; padding: 20px; overflow-y: auto; }
        
        /* æ–°å¢å¾®è°ƒï¼šç¦»é˜ŸæŒ‰é’®å’Œæ·»åŠ é˜Ÿå‘˜å¡ç‰‡ */
        .btn-leave { position: absolute; top: 10px; right: 10px; font-size: 0.7em; color: #999; cursor: pointer; border: 1px solid #eee; padding: 2px 6px; border-radius: 4px; }
        .btn-leave:hover { background: #eee; color: #333; }
        .add-member-card { border: 2px dashed #ddd; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #999; cursor: pointer; min-height: 200px; }
        .add-member-card:hover { border-color: #333; color: #333; }
        .danger-btn { color: #e74c3c; border-color: #e74c3c; margin-top: 5px; width: 100%; padding: 5px; background: none; border: 1px solid; cursor: pointer; border-radius: 4px; }
        .danger-btn:hover { background: #e74c3c; color: white; }
    </style>
</head>
<body>

<div class="container">
    <div id="login-section" style="max-width:300px; margin:100px auto; text-align:center;">
        <h2>å†’é™©è€…å·¥ä¼šç»ˆç«¯</h2>
        <input type="email" id="login-email" placeholder="é‚®ç®±" style="width:100%; padding:10px; margin-bottom:10px;">
        <input type="password" id="login-password" placeholder="å¯†ç " style="width:100%; padding:10px; margin-bottom:10px;">
        <button onclick="login()" style="width:100%; padding:10px; background:#333; color:#fff; border:none;">å¯åŠ¨</button>
    </div>

    <div id="main-section" style="display:none;">
        <div class="nav">
            <button class="tab-btn active" onclick="switchTab('shop')">é›†å¸‚</button>
            <button class="tab-btn" onclick="switchTab('team')">é˜Ÿä¼</button>
            <button class="tab-btn" onclick="switchTab('inventory')">èƒŒåŒ…</button>
            <button class="tab-btn" onclick="switchTab('employees')">é›‡å‘˜ä¸­å¿ƒ</button>
            <span id="admin-link" style="display:none; color:#3498db; cursor:pointer; font-weight:bold" onclick="toggleAdmin()">âš™ï¸ DM</span>
            
            <div class="info-bar">
                <div id="date-text" style="font-weight:bold; background:#f1c40f; display:inline-block; padding:2px 6px; border-radius:4px;"></div>
                <div style="color:#d35400; font-weight:bold; margin-top:4px;">ğŸ’° <span id="gold-amount">0</span> GP</div>
                <a href="#" onclick="logout()" style="color:#999; font-size:0.8em;">é€€å‡º</a>
            </div>
        </div>

        <div id="shop-section" class="section active"><div id="shop-grid" class="shop-grid"></div></div>

        <!-- é˜Ÿä¼é¢æ¿ -->
        <div id="team-section" class="section">
            <div id="team-grid" class="team-grid"></div>
        </div>

        <div id="inventory-section" class="section"><div id="inventory-container"></div></div>
        
        <!-- é›‡å‘˜åˆ—è¡¨ -->
        <div id="employees-section" class="section">
            <div id="emp-list" class="shop-grid"></div>
        </div>
    </div>
</div>

<!-- å¼¹çª—ï¼šé€‰æ‹©è£…å¤‡ -->
<div id="equip-modal" class="modal">
    <div class="modal-box">
        <h3>é€‰æ‹©è¦è£…å¤‡çš„ç‰©å“</h3>
        <div id="equip-list" class="item-select-list"></div>
        <button onclick="closeModal('equip-modal')" style="width:100%; margin-top:15px; padding:10px;">å–æ¶ˆ</button>
    </div>
</div>

<!-- å¼¹çª—ï¼šé€‰æ‹©é˜Ÿå‘˜åŠ å…¥ -->
<div id="member-modal" class="modal">
    <div class="modal-box">
        <h3>é€‰æ‹©åŠ å…¥é˜Ÿä¼çš„æˆå‘˜</h3>
        <p style="font-size:0.8em; color:#666;">åˆ—è¡¨ä»…æ˜¾ç¤ºåœ¨èŒä¸”æœªå…¥é˜Ÿçš„é›‡å‘˜/é˜Ÿå‹</p>
        <div id="member-select-list" class="item-select-list"></div>
        <button onclick="closeModal('member-modal')" style="width:100%; margin-top:15px; padding:10px;">å–æ¶ˆ</button>
    </div>
</div>

<!-- DMåå° -->
<div id="admin-panel">
    <div style="display:flex; justify-content:space-between;"><h2>DM æ§åˆ¶å°</h2><button onclick="toggleAdmin()">å…³é—­</button></div>
    <div style="display:grid; grid-template-columns:1fr 1fr; gap:20px;">
        <div>
            <h3>â³ æ—¶é—´</h3><button onclick="advanceTime()" style="padding:10px; background:#f1c40f;">æ¨è¿›ä¸€å¤©</button>
        </div>
        <div>
            <h3>ğŸ‘· å¤´åƒä¸Šä¼ </h3>
            <select id="adm-emp-list"></select>
            <input type="file" id="adm-emp-avatar">
            <button onclick="uploadAvatar()">ä¸Šä¼ </button>
        </div>
    </div>
</div>

<script>
    const SUPABASE_URL = 'https://vbzfpgucpciqgaakqndz.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZiemZwZ3VjcGNpcWdhYWtxbmR6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc1OTc2MzMsImV4cCI6MjA4MzE3MzYzM30.fBVDirEJ52bvrYJZ5DNv7fVDLNgCwITKwdKqT6YJDYw';
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    const DM_EMAIL = '739477825@qq.com';
    let userProfile = null;
    let currentEquipTarget = { empId: null, slotIdx: null };

    // --- é˜Ÿä¼ç®¡ç†é€»è¾‘ (ä¿®å¤ç‰ˆ) ---
    async function loadTeam() {
        const grid = document.getElementById('team-grid');
        grid.innerHTML = 'åŠ è½½é˜Ÿå‘˜æ•°æ®...';
        
        // 1. è·å–æ‰€æœ‰â€œis_in_party = trueâ€çš„é˜Ÿå‘˜
        const { data: members } = await supabaseClient.from('employees')
            .select('*')
            .eq('is_in_party', true)
            .order('id');
        
        // 2. è·å–æ‰€æœ‰äººçš„è£…å¤‡
        const { data: equipped } = await supabaseClient.from('equipped_items').select('*');

        grid.innerHTML = '';
        
        // æ¸²æŸ“ç°æœ‰é˜Ÿå‘˜
        if (members) {
            members.forEach(m => {
                const isCore = m.salary === 0;
                let slotsHtml = '';
                for (let i = 0; i < 10; i++) {
                    const item = equipped.find(e => e.employee_id === m.id && e.slot_index === i);
                    if (item) {
                        slotsHtml += `<div class="slot filled" onclick="unequipItem(${item.id})" title="${item.item_name}"><div class="slot-name">${item.item_name}</div></div>`;
                    } else {
                        slotsHtml += `<div class="slot" onclick="openEquipModal(${m.id}, ${i})">+</div>`;
                    }
                }

                grid.innerHTML += `
                    <div class="team-card">
                        <div class="btn-leave" onclick="removeFromParty(${m.id})" title="ç§»å‡ºé˜Ÿä¼">âœ• ç¦»é˜Ÿ</div>
                        <div class="team-header">
                            <img src="${m.avatar_url || 'https://via.placeholder.com/60'}" class="team-avatar">
                            <div class="team-info">
                                <h3>${m.name}</h3>
                                <p>${isCore ? 'æ ¸å¿ƒé˜Ÿå‹' : 'é›‡å‘˜'} | è–ªèµ„: ${m.salary}</p>
                            </div>
                        </div>
                        <div class="slots-container">${slotsHtml}</div>
                    </div>`;
            });
        }

        // æ¸²æŸ“ [ + æ·»åŠ é˜Ÿå‘˜ ] å¡ç‰‡ (å¦‚æœæœªæ»¡8äºº)
        if (members.length < 8) {
            grid.innerHTML += `
                <div class="team-card add-member-card" onclick="openMemberModal()">
                    <div style="font-size:3em;">+</div>
                    <div>æ·»åŠ é˜Ÿå‘˜ (${members.length}/8)</div>
                </div>`;
        }
    }

    // ç§»å‡ºé˜Ÿä¼
    async function removeFromParty(id) {
        if (!confirm('ç¡®å®šè®©è¯¥æˆå‘˜ç¦»å¼€å½“å‰å°é˜Ÿå—ï¼Ÿ(è£…å¤‡ä¼šä¿ç•™)')) return;
        await supabaseClient.from('employees').update({ is_in_party: false }).eq('id', id);
        loadTeam();
    }

    // æ‰“å¼€æ·»åŠ é˜Ÿå‘˜å¼¹çª—
    async function openMemberModal() {
        const list = document.getElementById('member-select-list');
        list.innerHTML = 'åŠ è½½ä¸­...';
        document.getElementById('member-modal').style.display = 'flex';

        // è·å–ï¼šçŠ¶æ€åœ¨èŒ AND ä¸åœ¨é˜Ÿä¼ä¸­
        const { data: candidates } = await supabaseClient.from('employees')
            .select('*')
            .eq('status', 'åœ¨èŒ')
            .eq('is_in_party', false);

        list.innerHTML = '';
        if (!candidates || candidates.length === 0) {
            list.innerHTML = '<div style="padding:10px; color:#999; text-align:center">æ²¡æœ‰é—²ç½®çš„é›‡å‘˜/é˜Ÿå‹</div>';
            return;
        }

        candidates.forEach(c => {
            list.innerHTML += `
                <div onclick="addToParty(${c.id})">
                    <div style="display:flex; align-items:center; gap:10px;">
                        <img src="${c.avatar_url || ''}" style="width:30px; height:30px; border-radius:50%">
                        <span>${c.name}</span>
                    </div>
                    <span style="color:#999; font-size:0.8em">${c.salary === 0 ? 'é˜Ÿå‹' : c.salary+'GP'}</span>
                </div>`;
        });
    }

    // åŠ å…¥é˜Ÿä¼
    async function addToParty(id) {
        await supabaseClient.from('employees').update({ is_in_party: true }).eq('id', id);
        closeModal('member-modal');
        loadTeam();
    }

    // --- é›‡å‘˜åˆ—è¡¨é€»è¾‘ (æ‰¾å›è§£é›‡æŒ‰é’®) ---
    async function loadEmployees() {
        const { data } = await supabaseClient.from('employees').select('*').order('id');
        const list = document.getElementById('emp-list');
        list.innerHTML = '';
        
        data.forEach(e => {
            const isCore = e.salary === 0;
            // åªæœ‰ä»˜è´¹é›‡å‘˜ä¸”åœ¨èŒï¼Œæ‰æ˜¾ç¤ºè§£é›‡æŒ‰é’®
            const showFireBtn = !isCore && e.status === 'åœ¨èŒ';
            
            list.innerHTML += `
                <div class="card" style="text-align:center">
                    <img src="${e.avatar_url || 'https://via.placeholder.com/60'}" style="width:60px; height:60px; border-radius:50%; object-fit:cover; margin-bottom:10px;">
                    <div style="font-weight:bold">${e.name}</div>
                    <div style="font-size:0.8em; color:#666">${isCore ? 'æ ¸å¿ƒé˜Ÿå‹' : 'é›‡å‘˜'} | ${e.salary} GP</div>
                    <div style="font-size:0.8em; margin:5px 0; color:${e.status==='åœ¨èŒ'?'green':'red'}">${e.status}</div>
                    ${showFireBtn ? `<button class="danger-btn" onclick="requestFire(${e.id})">ç”³è¯·è§£é›‡</button>` : ''}
                </div>`;
        });
    }

    async function requestFire(id) {
        if (!confirm('ç¡®å®šç”³è¯·è§£é›‡è¯¥é›‡å‘˜ï¼Ÿéœ€è¦DMæ‰¹å‡†ã€‚')) return;
        await supabaseClient.from('employees').update({ status: 'ç”³è¯·è§£é›‡' }).eq('id', id);
        loadEmployees();
    }

    // --- è£…å¤‡é€»è¾‘ (ä¿æŒä¸å˜) ---
    async function openEquipModal(empId, slotIdx) {
        currentEquipTarget = { empId, slotIdx };
        const list = document.getElementById('equip-list');
        list.innerHTML = 'è¯»å–èƒŒåŒ…...';
        document.getElementById('equip-modal').style.display = 'flex';
        const { data: inv } = await supabaseClient.from('user_inventory').select('*').eq('user_id', userProfile.id).in('category', ['è£…å¤‡', 'é­”æ³•ç‰©å“']).gt('quantity', 0);
        list.innerHTML = '';
        if (!inv || inv.length === 0) return list.innerHTML = '<div style="text-align:center; color:#999">æ²¡è£…å¤‡</div>';
        inv.forEach(item => {
            list.innerHTML += `<div onclick="equipItem(${item.id}, '${item.item_name}')"><span>${item.item_name}</span><span>x${item.quantity}</span></div>`;
        });
    }

    async function equipItem(invId, itemName) {
        const { data: invItem } = await supabaseClient.from('user_inventory').select('quantity').eq('id', invId).single();
        if (invItem.quantity > 1) await supabaseClient.from('user_inventory').update({ quantity: invItem.quantity - 1 }).eq('id', invId);
        else await supabaseClient.from('user_inventory').delete().eq('id', invId);
        await supabaseClient.from('equipped_items').insert([{ employee_id: currentEquipTarget.empId, slot_index: currentEquipTarget.slotIdx, item_name: itemName }]);
        closeModal('equip-modal'); loadTeam(); loadInventory();
    }

    async function unequipItem(equipId) {
        if (!confirm('å¸ä¸‹è¯¥è£…å¤‡ï¼Ÿ')) return;
        const { data: eqItem } = await supabaseClient.from('equipped_items').select('*').eq('id', equipId).single();
        const { data: exist } = await supabaseClient.from('user_inventory').select('*').eq('user_id', userProfile.id).eq('item_name', eqItem.item_name).maybeSingle();
        if (exist) await supabaseClient.from('user_inventory').update({ quantity: exist.quantity + 1 }).eq('id', exist.id);
        else await supabaseClient.from('user_inventory').insert([{ user_id: userProfile.id, item_name: eqItem.item_name, quantity: 1, category: 'è£…å¤‡' }]);
        await supabaseClient.from('equipped_items').delete().eq('id', equipId);
        loadTeam(); loadInventory();
    }

    function closeModal(id) { document.getElementById(id).style.display = 'none'; }

    // --- åŸºç¡€é€»è¾‘ ---
    async function login() {
        const email = document.getElementById('login-email').value;
        const password = document.getElementById('login-password').value;
        const { error } = await supabaseClient.auth.signInWithPassword({ email, password });
        if(error) alert(error.message); else checkUser();
    }
    async function logout() { await supabaseClient.auth.signOut(); location.reload(); }
    
    async function checkUser() {
        const { data: { user } } = await supabaseClient.auth.getUser();
        if (user) {
            document.getElementById('login-section').style.display = 'none';
            document.getElementById('main-section').style.display = 'block';
            if(user.email === DM_EMAIL) {
                document.getElementById('admin-link').style.display = 'inline';
                loadAdminData();
            }
            const { data: p } = await supabaseClient.from('profiles').select('*').eq('id', user.id).single();
            userProfile = p;
            document.getElementById('gold-amount').innerText = p.gold_gp;
            const { data: d } = await supabaseClient.from('global_settings').select('value').eq('key', 'current_date').single();
            if(d) document.getElementById('date-text').innerText = `FR${d.value.year} ${d.value.month}æœˆ${d.value.day}æ—¥`;
            loadShop(); loadTeam();
        }
    }

    function switchTab(tab) {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        document.querySelector(`.tab-btn[onclick*="${tab}"]`).classList.add('active');
        document.getElementById(`${tab}-section`).classList.add('active');
        if(tab==='team') loadTeam(); if(tab==='inventory') loadInventory(); if(tab==='employees') loadEmployees();
    }
    function toggleAdmin() { const p = document.getElementById('admin-panel'); p.style.display = p.style.display==='block'?'none':'block'; }

    // ç®€åŒ–ç‰ˆå…¶ä»–åŠ è½½å‡½æ•°
    async function loadShop() {
        const { data } = await supabaseClient.from('shop_items').select('*');
        document.getElementById('shop-grid').innerHTML = data.map(i => `<div class="card"><b>${i.name}</b><br>${i.price} GP<br>åº“å­˜:${i.stock}<button class="btn-buy" onclick="buy(${i.id},${i.price},'${i.name}','${i.category}')">è´­ä¹°</button></div>`).join('');
    }
    async function buy(id,p,n,c) {
        if(userProfile.gold_gp < p) return alert('æ²¡é’±');
        await supabaseClient.from('profiles').update({gold_gp: userProfile.gold_gp-p}).eq('id', userProfile.id);
        const {data:inv} = await supabaseClient.from('user_inventory').select('id,quantity').eq('user_id',userProfile.id).eq('item_name',n).maybeSingle();
        if(inv) await supabaseClient.from('user_inventory').update({quantity:inv.quantity+1}).eq('id',inv.id);
        else await supabaseClient.from('user_inventory').insert([{user_id:userProfile.id,item_name:n,quantity:1,category:c}]);
        alert('è´­ä¹°æˆåŠŸ'); checkUser();
    }
    async function loadInventory() {
        const { data } = await supabaseClient.from('user_inventory').select('*');
        document.getElementById('inventory-container').innerHTML = data.map(i => `<div>${i.item_name} x${i.quantity}</div>`).join('<br>');
    }
    async function loadAdminData() {
        const { data } = await supabaseClient.from('employees').select('id,name');
        document.getElementById('adm-emp-list').innerHTML = data.map(e => `<option value="${e.id}">${e.name}</option>`).join('');
    }
    async function uploadAvatar() {
        const f = document.getElementById('adm-emp-avatar').files[0];
        const id = document.getElementById('adm-emp-list').value;
        const { data } = await supabaseClient.storage.from('avatars').upload(`ava_${Date.now()}`, f);
        if(data) {
            const { data: u } = supabaseClient.storage.from('avatars').getPublicUrl(data.path);
            await supabaseClient.from('employees').update({avatar_url: u.publicUrl}).eq('id', id);
            alert('OK');
        }
    }
    async function advanceTime() { alert('æ—¶é—´æ¨è¿›åŠŸèƒ½è§ä¸Šä¸ªç‰ˆæœ¬'); }
    
    checkUser();
</script>
</body>
</html>
