<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>D&D èµ„äº§ç®¡ç†ç³»ç»Ÿ</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --common: #95a5a6; --uncommon: #2ecc71; --rare: #3498db; --very-rare: #9b59b6; --legendary: #f1c40f; --artifact: #e74c3c; }
        body { font-family: "PingFang SC", "Microsoft YaHei", sans-serif; background: #fff; color: #333; margin: 0; padding: 20px; line-height: 1.6; }
        .container { max-width: 1000px; margin: 0 auto; }
        
        .nav { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #333; padding-bottom: 10px; margin-bottom: 20px; }
        .tab-btn { padding: 10px 15px; cursor: pointer; border: none; background: none; font-size: 1em; opacity: 0.5; }
        .tab-btn.active { font-weight: bold; border-bottom: 3px solid #333; opacity: 1; }
        
        .gold-display { color: #d35400; font-weight: bold; font-size: 1.2em; }
        .date-display { background: #f1c40f; padding: 2px 8px; border-radius: 4px; font-weight: bold; font-size: 0.9em; }

        .section { display: none; }
        .section.active { display: block; }

        /* å•†åº— */
        .shop-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 20px; }
        .item-card { border: 1px solid #eee; padding: 15px; border-radius: 8px; position: relative; transition: 0.2s; }
        .item-card:hover { border-color: #333; }
        .rarity-tag { font-size: 0.7em; padding: 2px 6px; color: #fff; border-radius: 2px; position: absolute; top: 10px; right: 10px; }
        
        /* èƒŒåŒ… */
        .inventory-category { margin-top: 25px; }
        .inventory-category h3 { border-left: 4px solid #333; padding-left: 10px; margin-bottom: 15px; font-size: 1.1em; }
        .inventory-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 15px; }
        .inv-card { background: #f9f9f9; padding: 12px; border-radius: 4px; font-size: 0.9em; display: flex; justify-content: space-between; align-items: center; }

        /* é›‡å‘˜ */
        .emp-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; }
        .emp-card { border: 1px solid #eee; padding: 20px; text-align: center; border-radius: 12px; }
        .emp-avatar { width: 80px; height: 80px; border-radius: 50%; object-fit: cover; background: #f0f0f0; margin-bottom: 10px; border: 1px solid #eee; }

        /* ç®¡ç†é¢æ¿ */
        #admin-panel { display: none; position: fixed; top: 5%; left: 5%; width: 90%; height: 90%; background: white; border: 2px solid #333; z-index: 1000; padding: 25px; overflow-y: auto; box-shadow: 0 0 30px rgba(0,0,0,0.3); border-radius: 8px; }
        .admin-box { border: 1px solid #eee; padding: 15px; border-radius: 8px; margin-bottom: 20px; background: #fafafa; }
        
        input, select, textarea { padding: 8px; border: 1px solid #ddd; border-radius: 4px; margin: 5px 0; }
        button { cursor: pointer; border: 1px solid #333; background: #fff; padding: 6px 12px; border-radius: 4px; }
        button:hover { background: #333; color: #fff; }
        .btn-buy { width: 100%; margin-top: 10px; font-weight: bold; }
    </style>
</head>
<body>

<div class="container">
    <!-- ç™»å½• -->
    <div id="login-section" style="max-width:320px; margin:100px auto; text-align:center; padding:40px; border:1px solid #eee; border-radius:12px;">
        <h2 style="font-weight:300">D&D ç³»ç»Ÿç™»å½•</h2>
        <input type="email" id="login-email" placeholder="é‚®ç®±" style="width:100%">
        <input type="password" id="login-password" placeholder="å¯†ç " style="width:100%">
        <button onclick="login()" style="width:100%; margin-top:20px; background:#333; color:#fff; padding:12px;">è¿›å…¥ä½é¢</button>
    </div>

    <!-- ä¸»ç•Œé¢ -->
    <div id="main-section" style="display:none;">
        <div class="nav">
            <div>
                <button class="tab-btn active" onclick="switchTab('shop')">é›†å¸‚</button>
                <button class="tab-btn" onclick="switchTab('inventory')">èƒŒåŒ…</button>
                <button class="tab-btn" onclick="switchTab('employees')">é›‡å‘˜</button>
                <span id="admin-link" style="display:none; color:#3498db; cursor:pointer; margin-left:20px; font-size:0.9em;" onclick="toggleAdmin()">âš™ï¸ ä¸Šå¸æ¨¡å¼</span>
            </div>
            <div style="text-align:right">
                <span class="date-display" id="date-text">FR1494 2æœˆ12æ—¥</span>
                <span class="gold-display" style="margin-left:15px;">ğŸ’° <span id="gold-amount">0</span> GP</span>
                <div style="font-size:0.7em; color:#999; margin-top:4px;"><span id="user-email-display"></span> | <a href="#" onclick="logout()" style="color:#999">é€€å‡º</a></div>
            </div>
        </div>

        <div id="shop-section" class="section active">
            <div id="shop-grid" class="shop-grid"></div>
        </div>
        
        <div id="inventory-section" class="section">
            <div id="inventory-container"></div>
        </div>
        
        <div id="employees-section" class="section">
            <h4 id="salary-info" style="color:#666; margin-bottom:20px;">æœˆåº¦æ”¯å‡ºç»“ç®—ä¸­...</h4>
            <div class="emp-grid" id="emp-grid"></div>
        </div>
    </div>
</div>

<!-- DMç®¡ç†é¢æ¿ -->
<div id="admin-panel">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
        <h2 style="margin:0">DM ä¸Šå¸ç®¡ç†åå°</h2>
        <button onclick="toggleAdmin()" style="background:#e74c3c; color:#fff; border:none;">å…³é—­é¢æ¿</button>
    </div>
    
    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px;">
        <div class="admin-box">
            <h3>â³ æ—¶é—´ä¸èµ„äº§</h3>
            <button onclick="advanceTime()" style="background:#f1c40f; padding:10px 20px; font-weight:bold;">æ¨è¿›æ—¶é—´ï¼šNext Day</button>
            <hr>
            <label>å¿«é€Ÿè°ƒæ•´é‡‘å¸ï¼š</label><br>
            <select id="adm-user-list" onchange="loadUserDetail()" style="width:100%"><option value="">é€‰æ‹©ç©å®¶...</option></select>
            <div id="user-detail" style="display:none; margin-top:10px;">
                é‡‘å¸: <input type="number" id="adm-user-gold" style="width:80px"> <button onclick="updateUserGold()">ä¿®æ”¹</button>
            </div>
        </div>

        <div class="admin-box">
            <h3>ğŸ“¦ ç‰©å“å‘æ”¾</h3>
            <input type="text" id="adm-new-item" placeholder="ç‰©å“åç§°" style="width:60%">
            <button onclick="admAddInv()">ç›´æ¥æ”¾å…¥è¯¥ç©å®¶èƒŒåŒ…</button>
            <div id="adm-user-inv" style="font-size:0.8em; color:#666; margin-top:10px; height:60px; overflow-y:auto; border:1px solid #eee; padding:5px;"></div>
        </div>

        <div class="admin-box">
            <h3>âš–ï¸ å®¡æ‰¹ä¸­å¿ƒ</h3>
            <div id="request-list" style="font-size:0.9em; color:#666;">æš‚æ— å¾…å¤„ç†è¯·æ±‚</div>
        </div>

        <div class="admin-box">
            <h3>ğŸ‘· é›‡å‘˜å¤´åƒç®¡ç†</h3>
            <select id="adm-emp-list" style="width:100%"></select><br>
            <input type="file" id="adm-emp-avatar" accept="image/*" style="font-size:0.8em;"><br>
            <button onclick="uploadAvatar()" style="margin-top:5px;">ä¸Šä¼ å¹¶æ›´æ–°å¤´åƒ</button>
        </div>
    </div>
</div>

<script>
    const SUPABASE_URL = 'https://vbzfpgucpciqgaakqndz.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZiemZwZ3VjcGNpcWdhYWtxbmR6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc1OTc2MzMsImV4cCI6MjA4MzE3MzYzM30.fBVDirEJ52bvrYJZ5DNv7fVDLNgCwITKwdKqT6YJDYw';
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    let currentDate = { year: 1494, month: 2, day: 12 };
    let userProfile = null;
    const DM_EMAIL = '739477825@qq.com';
    const rarityColors = { 'æ™®é€š': '#95a5a6', 'éæ™®é€š': '#2ecc71', 'çç¨€': '#3498db', 'æçç¨€': '#9b59b6', 'ä¼ è¯´': '#f1c40f', 'ç¥å™¨': '#e74c3c' };

    // ç™»å½•ä¸æƒé™
    async function login() {
        const email = document.getElementById('login-email').value;
        const password = document.getElementById('login-password').value;
        const { error } = await supabaseClient.auth.signInWithPassword({ email, password });
        if (error) alert(error.message); else checkUser();
    }

    async function logout() { await supabaseClient.auth.signOut(); location.reload(); }

    async function checkUser() {
        const { data: { user } } = await supabaseClient.auth.getUser();
        if (user) {
            document.getElementById('login-section').style.display = 'none';
            document.getElementById('main-section').style.display = 'block';
            document.getElementById('user-email-display').innerText = user.email;
            if (user.email === DM_EMAIL) {
                document.getElementById('admin-link').style.display = 'inline';
                loadAdminData();
            }
            // æ ¸å¿ƒä¿®å¤ï¼šç™»å½•å³åŠ è½½æ‰€æœ‰é¢æ¿
            await loadGlobalDate();
            await loadGold();
            loadShop();
            loadInventory();
        }
    }

    // åŠ è½½é‡‘å¸
    async function loadGold() {
        const { data: { user } } = await supabaseClient.auth.getUser();
        const { data: profile } = await supabaseClient.from('profiles').select('*').eq('id', user.id).single();
        userProfile = profile;
        document.getElementById('gold-amount').innerText = profile ? profile.gold_gp : 0;
    }

    // å•†åº—é€»è¾‘
    async function loadShop() {
        const grid = document.getElementById('shop-grid');
        grid.innerHTML = 'é›†å¸‚è¡¥è´§ä¸­...';
        const { data, error } = await supabaseClient.from('shop_items').select('*').order('rarity');
        if (error) return;
        grid.innerHTML = '';
        data.forEach(item => {
            const card = document.createElement('div');
            card.className = 'item-card';
            const isOut = item.stock <= 0;
            card.innerHTML = `
                <span class="rarity-tag" style="background:${rarityColors[item.rarity]}">${item.rarity}</span>
                <div style="font-weight:bold; margin-bottom:5px;">${item.name}</div>
                <div style="font-size:0.8em; color:#777; height:40px; overflow:hidden;">${item.description || ''}</div>
                <div style="color:#d35400; font-weight:bold; margin-top:10px;">ğŸ’° ${item.price} GP</div>
                <div style="font-size:0.7em; color:#aaa">å‰©ä½™åº“å­˜: ${item.stock}</div>
                <button class="btn-buy" onclick="buyItem(${item.id}, ${item.price}, '${item.name}', '${item.category}')" ${isOut ? 'disabled' : ''}>
                    ${isOut ? 'å”®ç½„' : 'ç¡®è®¤è´­ä¹°'}
                </button>`;
            grid.appendChild(card);
        });
    }

    // èƒŒåŒ…é€»è¾‘
    async function loadInventory() {
        const container = document.getElementById('inventory-container');
        container.innerHTML = 'æ­£åœ¨æ¸…ç‚¹èµ„äº§...';
        const { data: inv } = await supabaseClient.from('user_inventory').select('*').order('category');
        if (!inv) return;
        container.innerHTML = '';
        const cats = [...new Set(inv.map(i => i.category))];
        cats.forEach(cat => {
            const sec = document.createElement('div');
            sec.className = 'inventory-category';
            sec.innerHTML = `<h3>${cat || 'æ‚é¡¹'}</h3>`;
            const g = document.createElement('div');
            g.className = 'inventory-grid';
            inv.filter(i => i.category === cat).forEach(item => {
                g.innerHTML += `<div class="inv-card"><span>${item.item_name}</span><span style="font-weight:bold; color:#666">x${item.quantity}</span></div>`;
            });
            sec.appendChild(g);
            container.appendChild(sec);
        });
    }

    async function buyItem(id, price, name, cat) {
        if (userProfile.gold_gp < price) return alert('é‡‘å¸ä¸è¶³ï¼');
        if (!confirm(`ç¡®è®¤è´­ä¹° [${name}]ï¼Ÿ`)) return;
        // æ‰£é’±
        await supabaseClient.from('profiles').update({ gold_gp: userProfile.gold_gp - price }).eq('id', userProfile.id);
        // å‡åº“å­˜
        const { data: item } = await supabaseClient.from('shop_items').select('stock').eq('id', id).single();
        await supabaseClient.from('shop_items').update({ stock: item.stock - 1 }).eq('id', id);
        // è¿›èƒŒåŒ…
        const { data: exist } = await supabaseClient.from('user_inventory').select('*').eq('user_id', userProfile.id).eq('item_name', name).maybeSingle();
        if (exist) await supabaseClient.from('user_inventory').update({ quantity: exist.quantity + 1 }).eq('id', exist.id);
        else await supabaseClient.from('user_inventory').insert([{ user_id: userProfile.id, item_name: name, quantity: 1, category: cat || 'é­”æ³•ç‰©å“' }]);
        
        loadGold(); loadShop(); loadInventory();
    }

    // æ—¶é—´ç³»ç»Ÿ
    async function loadGlobalDate() {
        const { data } = await supabaseClient.from('global_settings').select('value').eq('key', 'current_date').single();
        if (data) {
            currentDate = data.value;
            document.getElementById('date-text').innerText = `FR${currentDate.year} ${currentDate.month}æœˆ${currentDate.day}æ—¥`;
        }
    }

    async function advanceTime() {
        let { year, month, day } = currentDate;
        day++; if (day > 30) { day = 1; month++; } if (month > 12) { month = 1; year++; }
        await supabaseClient.from('global_settings').update({ value: { year, month, day } }).eq('key', 'current_date');
        if (day === 1) {
            const { data: emps } = await supabaseClient.from('employees').select('salary').eq('status', 'åœ¨èŒ');
            const total = emps.reduce((s, e) => s + e.salary, 0);
            const { data: prof } = await supabaseClient.from('profiles').select('gold_gp, id').eq('email', 'master@almorel.com').single();
            if (prof) await supabaseClient.from('profiles').update({ gold_gp: prof.gold_gp - total }).eq('id', prof.id);
        }
        location.reload();
    }

    // ä¿®æ”¹åçš„ä¸Šå¸æ¨¡å¼æ•°æ®åŠ è½½
    async function loadAdminData() {
        // 1. åŠ è½½ç©å®¶åˆ—è¡¨
        const { data: users, error } = await supabaseClient.from('profiles').select('email, id');
        const ulist = document.getElementById('adm-user-list');
        
        if (users) {
            ulist.innerHTML = '<option value="">é€‰æ‹©ç©å®¶...</option>';
            users.forEach(u => {
                ulist.innerHTML += `<option value="${u.id}">${u.email}</option>`;
            });
            console.log("å·²åŠ è½½ç©å®¶åˆ—è¡¨:", users);
        }

        // 2. åŠ è½½é›‡å‘˜åˆ—è¡¨
        const { data: emps } = await supabaseClient.from('employees').select('id, name');
        const elist = document.getElementById('adm-emp-list');
        if (emps) {
            elist.innerHTML = '';
            emps.forEach(e => elist.innerHTML += `<option value="${e.id}">${e.name}</option>`);
        }

        // 3. åŠ è½½å®¡æ‰¹è¯·æ±‚
        const { data: reqs } = await supabaseClient.from('employees').select('*').eq('status', 'ç”³è¯·è§£é›‡');
        const rbox = document.getElementById('request-list');
        if (reqs && reqs.length > 0) {
            rbox.innerHTML = reqs.map(r => `<div>${r.name} ç”³è¯·è§£é›‡ <button onclick="approveFire(${r.id}, true)">æ‰¹å‡†</button></div>`).join('');
        } else {
            rbox.innerHTML = 'æš‚æ— å¾…å¤„ç†è¯·æ±‚';
        }
    }

    let selectedUserId = null;
    async function loadUserDetail() {
        selectedUserId = document.getElementById('adm-user-list').value;
        if (!selectedUserId) return;
        document.getElementById('user-detail').style.display = 'block';
        const { data: p } = await supabaseClient.from('profiles').select('*').eq('id', selectedUserId).single();
        document.getElementById('adm-user-gold').value = p.gold_gp;
        const { data: inv } = await supabaseClient.from('user_inventory').select('*').eq('user_id', selectedUserId);
        document.getElementById('adm-user-inv').innerText = inv.map(i => `${i.item_name} x${i.quantity}`).join(' | ');
    }

    async function updateUserGold() {
        await supabaseClient.from('profiles').update({ gold_gp: document.getElementById('adm-user-gold').value }).eq('id', selectedUserId);
        alert('é‡‘å¸å·²ä¿®æ”¹'); loadGold();
    }

    async function admAddInv() {
        const name = document.getElementById('adm-new-item').value;
        if (!name || !selectedUserId) return;
        await supabaseClient.from('user_inventory').insert([{ user_id: selectedUserId, item_name: name, quantity: 1, category: 'é­”æ³•ç‰©å“' }]);
        alert('å·²å­˜å…¥è¯¥ç©å®¶èƒŒåŒ…'); loadUserDetail();
    }

 // ä¿®å¤åçš„ä¸Šä¼ å‡½æ•°ï¼šå¢åŠ äº†æŠ¥é”™è¯¦æƒ…
    async function uploadAvatar() {
        const file = document.getElementById('adm-emp-avatar').files[0];
        const empId = document.getElementById('adm-emp-list').value;
        if (!file || !empId) return alert('è¯·é€‰æ‹©é›‡å‘˜å’Œå›¾ç‰‡');

        // ç”Ÿæˆå”¯ä¸€æ–‡ä»¶åé˜²æ­¢è¦†ç›–
        const fileExt = file.name.split('.').pop();
        const fileName = `avatar_${empId}_${Date.now()}.${fileExt}`;

        const { data, error } = await supabaseClient.storage
            .from('avatars')
            .upload(fileName, file);

        if (error) {
            console.error("ä¸Šä¼ å¤±è´¥è¯¦æƒ…:", error);
            alert('ä¸Šä¼ å¤±è´¥ï¼š' + error.message);
            return;
        }

        if (data) {
            const { data: urlData } = supabaseClient.storage.from('avatars').getPublicUrl(fileName);
            await supabaseClient.from('employees').update({ avatar_url: urlData.publicUrl }).eq('id', empId);
            alert('å¤´åƒå·²æˆåŠŸä¸Šä¼ å¹¶å…³è”ï¼');
            loadEmployees(); // åˆ·æ–°é›‡å‘˜åˆ—è¡¨çœ‹æ•ˆæœ
        }
    }

    // åŸºç¡€åŠŸèƒ½
    function switchTab(tab) {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        document.querySelector(`.tab-btn[onclick*="${tab}"]`).classList.add('active');
        document.getElementById(`${tab}-section`).classList.add('active');
        if (tab === 'employees') loadEmployees();
    }
    function toggleAdmin() { const p = document.getElementById('admin-panel'); p.style.display = p.style.display === 'block' ? 'none' : 'block'; }
    
    async function loadEmployees() {
        const { data } = await supabaseClient.from('employees').select('*');
        const grid = document.getElementById('emp-grid');
        grid.innerHTML = '';
        let total = 0;
        data.forEach(e => {
            if (e.status === 'åœ¨èŒ') total += e.salary;
            grid.innerHTML += `<div class="emp-card">
                <img src="${e.avatar_url || ''}" class="emp-avatar">
                <div style="font-weight:bold">${e.name}</div>
                <div style="color:#d35400">${e.salary} GP/æœˆ</div>
                <div style="font-size:0.8em; color:#999">${e.status}</div>
            </div>`;
        });
        document.getElementById('salary-info').innerText = `å½“å‰æ¯æœˆæ€»æ”¯å‡ºï¼š${total} GP`;
    }

    checkUser();
</script>
</body>
</html>

