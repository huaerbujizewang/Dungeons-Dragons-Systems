<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>D&D å°é˜Ÿç®¡ç†ç³»ç»Ÿ</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --border: #e0e0e0; --bg: #f8f9fa; --active: #333; }
        body { font-family: "PingFang SC", "Microsoft YaHei", sans-serif; background: #fff; color: #333; margin: 0; padding: 0; height: 100vh; }
    
        #login-section {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 100%;
            max-width: 360px;
            padding: 40px;
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            text-align: center;
            border: 1px solid #eee;
            z-index: 100;
        }
        #login-section h2 { margin-top: 0; color: #2c3e50; font-weight: 300; margin-bottom: 25px; letter-spacing: 1px; }
        #login-section input { width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; font-size: 14px; transition: 0.2s; }
        #login-section input:focus { border-color: #333; outline: none; }
        #login-section button { width: 100%; padding: 12px; background: #2c3e50; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 16px; font-weight: bold; transition: 0.2s; }
        #login-section button:hover { background: #34495e; transform: translateY(-1px); }

        /* --- ä¸»ç•Œé¢å¸ƒå±€ --- */
        .container { max-width: 1100px; margin: 0 auto; padding: 20px; }
        
        /* å¯¼èˆª */
        .nav { display: flex; gap: 15px; border-bottom: 2px solid #333; padding-bottom: 15px; margin-bottom: 30px; align-items: center; }
        .tab-btn { padding: 8px 16px; border: none; background: none; cursor: pointer; font-size: 1em; color: #7f8c8d; border-radius: 4px; font-weight: 500; transition: 0.2s; }
        .tab-btn.active { background: #333; color: #fff; }
        .tab-btn:hover:not(.active) { color: #333; background: #f0f0f0; }
        
        .info-bar { margin-left: auto; text-align: right; font-size: 0.9em; display: flex; flex-direction: column; align-items: flex-end; gap: 4px; }
        
        /* å†…å®¹åŒº */
        .section { display: none; animation: fadeIn 0.3s ease; }
        .section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        /* æ ‡é¢˜åˆ†å‰²çº¿ */
        .section-title { margin: 35px 0 20px 0; border-left: 5px solid #333; padding-left: 12px; font-weight: bold; font-size: 1.1em; color: #444; background: linear-gradient(90deg, #f9f9f9, #fff); padding-top: 8px; padding-bottom: 8px; }
        
        /* ç½‘æ ¼å¸ƒå±€ */
        .team-grid, .shop-grid, .inventory-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(230px, 1fr)); gap: 20px; }
        
        /* å¡ç‰‡é€šç”¨ */
        .card, .team-card, .inv-card { background: #fff; border: 1px solid var(--border); border-radius: 8px; padding: 15px; position: relative; transition: 0.2s; box-shadow: 0 2px 5px rgba(0,0,0,0.02); }
        .card:hover, .team-card:hover { box-shadow: 0 5px 15px rgba(0,0,0,0.08); border-color: #bbb; transform: translateY(-2px); }
        
        /* é˜Ÿä¼å¡ç‰‡ç‰¹æœ‰ */
        .team-header { display: flex; align-items: center; gap: 15px; margin-bottom: 15px; }
        .team-avatar { width: 60px; height: 60px; border-radius: 50%; object-fit: cover; background: #eee; border: 1px solid #ddd; }
        .team-info h3 { margin: 0; font-size: 1.1em; }
        .team-info p { margin: 4px 0 0; font-size: 0.8em; color: #666; }
        .btn-leave { position: absolute; top: 10px; right: 10px; font-size: 0.7em; color: #999; cursor: pointer; border: 1px solid #eee; padding: 2px 8px; border-radius: 4px; background: #fff; }
        .btn-leave:hover { background: #fee; color: #e74c3c; border-color: #e74c3c; }

        /* è£…å¤‡æ§½ */
        .slots-container { display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; }
        .slot { aspect-ratio: 1; border: 1px dashed #ccc; border-radius: 4px; display: flex; align-items: center; justify-content: center; font-size: 0.7em; text-align: center; cursor: pointer; background: #fafafa; padding: 2px; overflow: hidden; transition: 0.2s; color: #aaa; }
        .slot:hover { border-color: #333; background: #fff; color: #333; }
        .slot.filled { border: 1px solid #bbb; background: #fff; border-style: solid; color: #333; font-weight: 600; box-shadow: inset 0 0 5px rgba(0,0,0,0.05); }
        .slot-name { word-break: break-all; pointer-events: none; transform: scale(0.9); line-height: 1.1; }
        
        /* é›‡å‘˜ä¸­å¿ƒå¡ç‰‡ */
        .emp-card-content { text-align: center; }
        .emp-card-content img { width: 70px; height: 70px; border-radius: 50%; object-fit: cover; margin-bottom: 10px; border: 1px solid #eee; }
        
        /* å¼¹çª— & Loading */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 2000; align-items: center; justify-content: center; backdrop-filter: blur(2px); }
        .modal-box { background: #fff; padding: 25px; border-radius: 12px; width: 400px; max-height: 80vh; overflow-y: auto; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        .item-select-list div { padding: 12px; border-bottom: 1px solid #f0f0f0; cursor: pointer; display: flex; justify-content: space-between; transition: 0.1s; }
        .item-select-list div:hover { background: #f8f9fa; padding-left: 15px; }
        
        #loading-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.8); z-index: 5000; align-items: center; justify-content: center; flex-direction: column; }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #333; border-radius: 50%; width: 40px; height: 40px; animation: spin 0.8s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* æŒ‰é’®ä¸è¾“å…¥ */
        button { cursor: pointer; font-family: inherit; }
        input, select, textarea { font-family: inherit; border: 1px solid #ddd; border-radius: 4px; padding: 6px; }
        .btn-buy { width: 100%; margin-top: 10px; padding: 8px; background: #fff; border: 1px solid #333; color: #333; border-radius: 4px; transition: 0.2s; }
        .btn-buy:hover { background: #333; color: #fff; }
        .btn-buy:disabled { border-color: #eee; color: #ccc; background: #fafafa; cursor: not-allowed; }
        
        .danger-btn { color: #e74c3c; border-color: #e74c3c; margin-top: 8px; width: 100%; padding: 5px; background: none; border: 1px solid; border-radius: 4px; font-size: 0.85em; transition: 0.2s; }
        .danger-btn:hover { background: #e74c3c; color: white; }
        
        .add-member-card { border: 2px dashed #ddd; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #999; cursor: pointer; min-height: 200px; background: #fafafa; }
        .add-member-card:hover { border-color: #333; color: #333; background: #fff; }

        /* èƒŒåŒ…æ ·å¼ */
        .inventory-category { margin-bottom: 25px; }
        .inventory-category h3 { border-left: 4px solid #333; padding-left: 10px; margin-bottom: 15px; font-size: 1.1em; background: #f9f9f9; padding: 8px 10px; border-radius: 0 4px 4px 0; }
        .inventory-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 12px; }
        .inv-card { background: #fff; border: 1px solid #eee; padding: 12px; border-radius: 6px; display: flex; justify-content: space-between; align-items: center; font-size: 0.95em; }

        /* DM ç®¡ç†é¢æ¿ */
        #admin-panel { display: none; position: fixed; top: 5%; left: 5%; width: 90%; height: 90%; background: #fff; border: 2px solid #333; z-index: 3000; padding: 25px; overflow-y: auto; border-radius: 8px; box-shadow: 0 20px 50px rgba(0,0,0,0.3); box-sizing: border-box; }
        .admin-box { margin-bottom: 0; } /* Reset margin for grid */
    </style>
</head>
<body>

<!-- Loading é®ç½© -->
<div id="loading-overlay">
    <div class="spinner"></div>
    <div style="margin-top:15px; color:#555; font-weight:bold;">æ­£åœ¨åŒæ­¥ä½é¢æ•°æ®...</div>
</div>

<!-- ç™»å½•ç•Œé¢ (ç‹¬ç«‹å±…ä¸­) -->
<div id="login-section">
    <h2>å†’é™©è€…å·¥ä¼šç»ˆç«¯</h2>
    <input type="email" id="login-email" placeholder="é‚®ç®±åœ°å€">
    <input type="password" id="login-password" placeholder="é€šè¡Œå¯†ç ">
    <button onclick="login()">è¿æ¥èŠ‚ç‚¹</button>
</div>

<!-- ä¸»ç•Œé¢ -->
<div id="main-section" class="container" style="display:none;">
    <div class="nav">
        <button class="tab-btn active" onclick="switchTab('shop')">å•†åŸ</button>
    <button class="tab-btn" onclick="switchTab('team')">é˜Ÿä¼</button>
    <button class="tab-btn" onclick="switchTab('inventory')">èƒŒåŒ…</button>
    <button class="tab-btn" onclick="switchTab('employees')">é›‡å‘˜ä¸­å¿ƒ</button>
    <button class="tab-btn" onclick="switchTab('others')">å…¶ä»–å†…å®¹</button>
    <button id="security-tab-btn" class="tab-btn" onclick="switchTab('security')" style="display:none; color:#e74c3c; border:1px solid #ff000033;">ğŸ›¡ï¸ å®‰å…¨ä¸æƒé™</button>
    <span id="admin-link" style="display:none; color:#3498db; cursor:pointer; font-weight:bold; margin-left: 10px;" onclick="toggleAdmin()">âš™ï¸ DM æ§åˆ¶å°</span>
        
        <div class="info-bar">
            <div id="date-text" style="font-weight:bold; background:#f1c40f; color:#333; padding:4px 10px; border-radius:4px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">æ—¥æœŸåŠ è½½ä¸­...</div>
            <div style="color:#d35400; font-weight:bold; margin-top:4px;">ğŸ’° <span id="gold-amount">0</span> GP</div>
            <a href="#" onclick="logout()" style="color:#999; font-size:0.8em; text-decoration: underline;">é€€å‡ºç™»å½•</a>
        </div>
    </div>

    <!-- é›†å¸‚ -->
     <div id="shop-section" class="section active">
        <div style="margin-bottom:20px; display:flex; gap:10px; align-items:center; background:#f8f9fa; padding:10px; border-radius:8px;">
            <button id="shop-mode-btn" onclick="toggleShopMode()" style="padding:10px 20px; background:#333; color:#fff; border:none; border-radius:4px; white-space:nowrap;">ğŸ”„ åˆ‡æ¢ï¼šæˆ‘è¦å‡ºå”®</button>
            <input type="text" id="shop-search-input" placeholder="ğŸ” æœç´¢..." oninput="refreshShopView()" style="width:100%; padding:10px; font-size:1em; border:1px solid #ccc; border-radius:6px;">
        </div>
        <div id="shop-grid" class="shop-grid"></div>
    </div>

    <!-- é˜Ÿä¼é¢æ¿ -->
    <div id="team-section" class="section">
        <div id="team-container"></div>
    </div>

    <!-- èƒŒåŒ… -->
    <div id="inventory-section" class="section">
        <div id="inventory-container"></div>
    </div>
    
    <!-- é›‡å‘˜ä¸­å¿ƒ -->
    <div id="employees-section" class="section">
        <div id="emp-container"></div>
    </div>

    <!-- å…¶ä»–å†…å®¹æ¿å— -->
    <div id="others-section" class="section">
        <div class="section-title">ğŸŒ ä¸–ç•Œè§‚ä¸è®°å½•</div>
        <div class="shop-grid"> <!-- å¤ç”¨é›†å¸‚ç½‘æ ¼æ ·å¼ -->
        
        <!-- å¡ç‰‡ 1ï¼šæ—¶é—´çº¿ -->
        <div class="card emp-card-content" onclick="window.location.href='timeline.html?uid=' + viewingUserId" style="cursor:pointer;">
            <div style="font-size: 2.5em; margin-bottom:10px;">â³</div>
            <div style="font-weight:bold; font-size:1.1em;">ç¼–å¹´å² / æ—¶é—´çº¿</div>
            <p style="font-size:0.8em; color:#666;">è®°å½•è´¹ä¼¦å¤§é™†åŠå›¢é˜Ÿå¤§äº‹ä»¶</p>
        </div>

        <!-- å¡ç‰‡ 2ï¼šå›½å®¶ä¸ç»„ç»‡ -->
        <div class="card emp-card-content" onclick="window.location.href='world.html?uid=' + viewingUserId" style="cursor:pointer;">
            <div style="font-size: 2.5em; margin-bottom:10px;">ğŸ°</div>
            <div style="font-weight:bold; font-size:1.1em;">åœ°ç† / ç»„ç»‡</div>
            <p style="font-size:0.8em; color:#666;">å›½å®¶èƒŒæ™¯ã€åŠ¿åŠ›èŒƒå›´ä¸å…³ç³»å›¾</p>
        </div>

        <!-- å¡ç‰‡ 3ï¼šä¼ è®°ä¸é—´ç«  -->
        <div class="card emp-card-content" onclick="window.location.href='lore.html?uid=' + viewingUserId" style="cursor:pointer;">
            <div style="font-size: 2.5em; margin-bottom:10px;">ğŸ“œ</div>
            <div style="font-weight:bold; font-size:1.1em;">äººç‰©å¿— / é—´ç« </div>
            <p style="font-size:0.8em; color:#666;">NPC å¯¹è¯ã€èƒŒæ™¯æ•…äº‹ä¸äº¤æµè®°å½•</p>
        </div>

        <!-- å¡ç‰‡ 4ï¼šé¢†åœ°ç®¡ç† -->
        <div class="card emp-card-content" onclick="window.location.href='territory.html?uid=' + viewingUserId" style="cursor:pointer; ;">
            <div style="font-size: 2.5em; margin-bottom:10px;">ğŸ‘‘</div>
            <div style="font-weight:bold; font-size:1.1em;">é¢†åœ°æ²»ç†</div>
            <p style="font-size:0.8em; color:#666;">ç¨æ”¶ã€æ”¿ç­–ä¸åŸå¸‚æ¦‚å†µ</p>
        </div>

        <!-- å¡ç‰‡ 5ï¼šæ”¿åŠ¡å… -->
        <div class="card emp-card-content" onclick="window.location.href='proposals.html?uid=' + viewingUserId" style="cursor:pointer; ">
            <div style="font-size: 2.5em; margin-bottom:10px;">ğŸ’¼</div>
            <div style="font-weight:bold; font-size:1.1em;">æ”¿åŠ¡å…</div>
            <p style="font-size:0.8em; color:#666;">å®¡æ‰¹æ ¸å¿ƒæˆå‘˜ææ¡ˆ</p>
        </div>

        <!-- å¡ç‰‡ 6ï¼šæ‚¬èµåå• -->
        <div class="card emp-card-content" onclick="window.location.href='bounties.html?uid=' + viewingUserId" style="cursor:pointer; ">
            <div style="font-size: 2.5em; margin-bottom:10px;">ğŸ’€</div>
            <div style="font-weight:bold; font-size:1.1em;">èµé‡‘åå½•</div>
            <p style="font-size:0.8em; color:#666;">ä½é¢é€šç¼‰åå•</p>
        </div>

        <!-- å¡ç‰‡ 7ï¼šé€€è´§ä¸­å¿ƒ -->
        <div class="card emp-card-content" onclick="window.location.href='refunds.html?uid=' + viewingUserId" style="cursor:pointer; ">
            <div style="font-size: 2.5em; margin-bottom:10px;">ğŸ˜­</div>
            <div style="font-weight:bold; font-size:1.1em;">é€€è´§ä¸­å¿ƒ</div>
            <p style="font-size:0.8em; color:#666;">30åˆ†é’Ÿå†…è¯¯è´­æ’¤å›</p>
        </div>

        <!-- å¯ä»¥æ ¹æ®éœ€è¦ç»§ç»­æ·»åŠ å¡ç‰‡ -->
        </div>
    </div>

     <!-- ï¼šå®‰å…¨ä¸æƒé™ Section (Root ä¸“ç”¨) -->
    <div id="security-section" class="section">
        <div style="display:grid; grid-template-columns: 350px 1fr; gap:20px;">
            <!-- å·¦ä¾§ï¼šè´¦å·ç®¡ç† -->
            <div style="display:flex; flex-direction:column; gap:20px;">
                <div class="admin-box" style="border:1px solid #3498db; padding:15px; border-radius:8px; background:#f0f9ff;">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                        <h3 style="margin:0; color:#2980b9;">ğŸ”‘ è´¦å·æƒé™ç®¡ç†</h3>
                        <button onclick="loadAllAccounts()" style="font-size:0.8em;">åˆ·æ–°</button>
                    </div>
                    <div id="account-list-container" style="max-height:600px; overflow-y:auto; background:#fff; padding:10px; border-radius:4px; font-size:0.9em;"></div>
                </div>
            </div>
            <!-- åœ¨çº¿çŠ¶æ€ç›‘æ§ -->
            <div class="admin-box" style="border:1px solid #2ecc71; padding:15px; border-radius:8px; background:#f0fff4;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                    <h3 style="margin:0; color:#27ae60;">ğŸ“¡ åœ¨çº¿çŠ¶æ€ç›‘æ§</h3>
                </div>
                <div id="online-users-container" style="max-height:600px; overflow-y:auto; background:#fff; padding:10px; border-radius:4px; font-size:0.9em;">
                    æ­£åœ¨è¿æ¥...
                </div>
            </div>
            
            <!-- å³ä¾§ï¼šåŒæ—¥å¿— -->
            <div style="display:flex; flex-direction:column; gap:20px;">
                <div class="admin-box" style="border:1px solid #ddd; padding:15px; border-radius:8px; background:#f9f9f9; flex:1;">
                    <h3 style="margin-top:0;">ğŸ“œ å…¨æœæ“ä½œå®¡è®¡</h3>
                    <div id="audit-log-container" style="height:300px; overflow-y:auto; background:#fff; padding:10px; border:1px solid #eee;"></div>
                </div>
                <div class="admin-box" style="border:1px solid #e74c3c; padding:15px; border-radius:8px; background:#fff0f0; flex:1;">
                    <h3 style="margin-top:0; color:#c0392b;">ğŸš¨ ç™»å½•ç›‘æ§æ—¥å¿—</h3>
                    <div id="login-log-container" style="height:300px; overflow-y:auto; background:#fff; padding:10px; border:1px solid #eee;"></div>
                </div>
            </div>
        </div>
    </div>


</div>

<!-- å¼¹çª—ï¼šè£…å¤‡é€‰æ‹© -->
<div id="equip-modal" class="modal">
    <div class="modal-box">
        <h3>é€‰æ‹©è¦è£…å¤‡çš„ç‰©å“</h3>
        <div id="equip-list" class="item-select-list"></div>
        <button onclick="closeModal('equip-modal')" style="width:100%; margin-top:15px; padding:10px; background:#f5f5f5; border:1px solid #ddd; border-radius:4px;">å–æ¶ˆ</button>
    </div>
</div>

<!-- å¼¹çª—ï¼šæˆå‘˜é€‰æ‹© -->
<div id="member-modal" class="modal">
    <div class="modal-box">
        <h3>é€‰æ‹©åŠ å…¥é˜Ÿä¼çš„æˆå‘˜</h3>
        <p style="font-size:0.8em;color:#999; margin-bottom:10px;">ä»…æ˜¾ç¤ºåœ¨èŒä¸”æœªå…¥é˜Ÿçš„äººå‘˜</p>
        <div id="member-select-list" class="item-select-list"></div>
        <button onclick="closeModal('member-modal')" style="width:100%; margin-top:15px; padding:10px; background:#f5f5f5; border:1px solid #ddd; border-radius:4px;">å–æ¶ˆ</button>
    </div>
</div>

<!-- DM ä¸Šå¸æ§åˆ¶å° -->
<div id="admin-panel">
    <div style="display:flex; justify-content:space-between; margin-bottom:20px; border-bottom:1px solid #eee; padding-bottom:15px;">
        <h2 style="margin:0;">DM æ§åˆ¶å° <span id="role-badge" style="font-size:0.5em; background:#333; color:white; padding:2px 8px; border-radius:12px; font-weight:normal;"></span></h2>
        <button onclick="toggleAdmin()" style="background:#e74c3c; color:white; border:none; padding:8px 20px; border-radius:6px; font-weight:bold;">å…³é—­</button>
    </div>
    
    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:25px; overflow-y:auto;">
        
        <!-- å·¦ä¾§åˆ— -->
        <div style="display:flex; flex-direction:column; gap:20px;">

            <!-- äº‹åŠ¡å®¡æ‰¹ä¸­å¿ƒ -->
            <div id="approval-box" class="admin-box" style="border:1px solid #e67e22; padding:15px; border-radius:8px; background:#fffcf0; display:none;">
                <h3 style="margin-top:0; color:#d35400;">âš–ï¸ å¾…åŠå®¡æ‰¹</h3>
                <div id="approval-list" style="font-size:0.9em;">
                    æ­£åœ¨åŠ è½½è¯·æ±‚...
                </div>
            </div>

            <!-- æ—¶é—´æ§åˆ¶ -->
            <div class="admin-box" style="border:1px solid #ddd; padding:15px; border-radius:8px;">
                <h3 style="margin-top:0">â³ æ—¶é—´çº¿æ“æ§</h3>
                <div style="display:flex; gap:5px; margin-bottom:10px;">
                    <input type="number" id="time-year" style="width:70px"> å¹´ 
                    <input type="number" id="time-month" style="width:50px"> æœˆ 
                    <input type="number" id="time-day" style="width:50px"> æ—¥
                </div>
                <button onclick="updateTimeManual()" style="width:100%; padding:10px; background:#34495e; color:white; border:none;">åŒæ­¥æ—¶ç©º</button>
            </div>

            <!-- é›†å¸‚è¿›è´§ -->
            <div class="admin-box" style="border:1px solid #ddd; padding:15px; border-radius:8px;">
                <h3 style="margin-top:0">ğŸ¬ ç‰©èµ„ä¸Šæ¶</h3>
            <!-- æŸ¥åº“åŒºåŸŸ -->
                <div style="background:#f0f8ff; padding:10px; border-radius:4px; margin-bottom:15px; border:1px dashed #3498db;">
                    <div style="display:flex; gap:5px;">
                        <input type="text" id="compendium-search" placeholder="ğŸ” æœç´¢å›¾é‰´åº“..." style="flex:1; padding:6px;">
                        <button onclick="searchCompendium()" style="padding:6px 12px;">æŸ¥æ‰¾</button>
                    </div>
                    <div id="compendium-results" style="max-height:100px; overflow-y:auto; margin-top:5px; background:#fff; border:1px solid #eee;"></div>
                </div>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:8px;">
                    <input type="text" id="adm-shop-name" placeholder="å•†å“åç§°" style="grid-column: 1/3;">
                    <select id="adm-shop-rarity"><option>æ™®é€š</option><option>éæ™®é€š</option><option>çç¨€</option><option>æçç¨€</option><option>ä¼ è¯´</option><option>ç¥å™¨</option></select>
                    <select id="adm-shop-cat"><option>é­”æ³•ç‰©å“</option><option>è£…å¤‡</option><option>å·è½´</option><option>è¯æ°´</option><option>ææ–™</option></select>
                    <input type="number" id="adm-shop-price" placeholder="ä»·æ ¼">
                    <input type="number" id="adm-shop-stock" placeholder="åº“å­˜">
                    <select id="adm-shop-target" style="grid-column: 1/3;"><option value="public">ğŸŒ å…¨æœå…¬å…±</option><option value="private">ğŸ‘¤ ä»…å½“å‰é€‰ä¸­çš„ç©å®¶</option></select>
                    <textarea id="adm-shop-desc" placeholder="æè¿°..." style="grid-column: 1/3; height:50px;"></textarea>
                </div>
                <button onclick="adminAddItem()" style="width:100%; margin-top:10px; background:#2ecc71; color:white; border:none; padding:10px;">ç¡®è®¤ä¸Šæ¶</button>
                <!-- éšæœºè¿›è´§æŒ‰é’® -->
                <button onclick="randomRestock()" style="width:100%; margin-top:10px; background:#8e44ad; color:white; border:none; padding:10px; border-radius:4px; font-weight:bold;">ğŸ² éšæœºè¿›è´§ (æ ‡å‡†åŒ…)</button>
                <div style="font-size:0.8em; color:#666; text-align:center; margin-top:5px;">åŒ…å«: 2ä¼ è¯´, 12æçç¨€, 20çç¨€, 30éæ™®é€š, 10æ™®é€š</div>
            </div>
        </div>

        <!-- å³ä¾§åˆ— -->
        <div style="display:flex; flex-direction:column; gap:20px;">
            <!-- ç©å®¶èµ„äº§æ§åˆ¶ -->
            <div class="admin-box" style="border:1px solid #333; padding:15px; border-radius:8px; background:#fafafa;">
                <h3 style="margin-top:0">ğŸ‘¤ ç©å®¶èµ„äº§æ“æ§ (è§†è§’åˆ‡æ¢)</h3>
                <select id="adm-user-list" onchange="loadUserDetail()" style="width:100%; padding:10px; margin-bottom:10px; border:2px solid #333;"></select>
                
                <div id="user-detail" style="display:none;">
                    <div style="margin-bottom:10px;">
                        ğŸ’° é‡‘å¸: <input type="number" id="adm-user-gold" style="width:80px"> <button onclick="updateUserGold()">ä¿®æ”¹</button>
                    </div>
                    <!-- Root ä¸“ç”¨ï¼šåˆ†é…è´Ÿè´£ DM -->
                    <div id="root-assign-dm" style="display:none; margin-bottom:10px; padding:10px; border:1px dashed #3498db;">
                        ğŸ”— æŒ‡æ´¾è´Ÿè´£ DM: <select id="adm-assign-dm-list"></select> <button onclick="assignDM()">ä¿å­˜</button>
                    </div>
                    <div style="margin-bottom:10px;">
                        ğŸ å‘æ”¾: <input type="text" id="adm-new-item" style="width:100px"> 
                        <select id="adm-new-item-cat"><option>é­”æ³•ç‰©å“</option><option>è£…å¤‡</option><option>å·è½´</option><option>è¯æ°´</option></select>
                        <button onclick="admAddInv()">å‘æ”¾</button>
                    </div>
                    <div style="font-size:0.8em; color:#666;">èƒŒåŒ…é¢„è§ˆ:</div>
                    <div id="adm-user-inv" style="max-height:150px; overflow-y:auto; background:#fff; padding:5px; border:1px solid #ddd; margin-top:5px;"></div>
                </div>
            </div>

            <!-- é›‡å‘˜å¤´åƒ -->
            <div class="admin-box" style="border:1px solid #ddd; padding:15px; border-radius:8px;">
                <h3 style="margin-top:0">ğŸ‘· é›‡å‘˜å¤´åƒæ›´æ–°</h3>
                <select id="adm-emp-list" style="width:100%; margin-bottom:10px;"></select>
                <div style="display:flex; gap:10px;"><input type="file" id="adm-emp-avatar" style="flex:1"><button onclick="uploadAvatar()">ä¸Šä¼ </button></div>
            </div>

            
            <div class="admin-box" style="border:1px solid #c0392b; padding:15px; border-radius:8px; background:#fff;">
                <h3 style="margin-top:0; color:#c0392b;">â˜ ï¸ ç­¾å‘é€šç¼‰ä»¤</h3>
    
                <!-- å•ä¸ªæ·»åŠ  -->
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:5px; margin-bottom:10px;">
                    <input type="text" id="adm-wanted-name" placeholder="å§“å" style="grid-column: 1/3;">
                    <input type="number" id="adm-wanted-amount" placeholder="èµé‡‘ GP">
                    <input type="text" id="adm-wanted-source" placeholder="æ‚¬èµç»„ç»‡">
                </div>
                <button onclick="addWantedPoster()" style="width:100%; background:#c0392b; color:white; border:none; padding:8px; border-radius:4px; font-weight:bold;">å•ä»½ç­¾å‘</button>
    
                <hr style="margin:15px 0;">

                <!-- æ‰¹é‡å¯¼å…¥ -->
                <h4 style="margin:0 0 5px 0;">æ‰¹é‡å¯¼å…¥ (æ¯è¡Œä¸€ä¸ªï¼šåå­—,é‡‘é¢,ç»„ç»‡)</h4>
                <textarea id="adm-wanted-bulk" placeholder="ç›å°”ä½æ‹‰,34500,é¾™å·«æ•™&#10;è·¯äººç”²,500,é¢†ä¸»è”ç›Ÿ" style="width:100%; height:60px; font-size:0.8em;"></textarea>
                <button onclick="bulkAddWanted()" style="width:100%; margin-top:5px; border:1px solid #c0392b; color:#c0392b; background:none; padding:5px;">å¼€å§‹æ‰¹é‡ç­¾å‘ (æ— å¤´åƒ)</button>
           </div>
        </div>
    </div>
</div>

<script>
    let mainRealtimeChannel = null;
    let viewingUserId = null; // å½“å‰æ­£åœ¨æŸ¥çœ‹è°çš„åœºæ™¯
    let myId = null; // ç™»å½•è€…è‡ªå·±çš„ ID
    let presenceChannel = null;
    let currentUserRole = 'player'; //æƒé™åˆ’åˆ†
    let currentUserEmail = ''; 
    let isSellMode = false;
    const SUPABASE_URL = 'https://vbzfpgucpciqgaakqndz.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZiemZwZ3VjcGNpcWdhYWtxbmR6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc1OTc2MzMsImV4cCI6MjA4MzE3MzYzM30.fBVDirEJ52bvrYJZ5DNv7fVDLNgCwITKwdKqT6YJDYw';
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    const DM_EMAIL = '739477825@qq.com';
    // --- ã€è¡¥å›ã€‘ç¨€æœ‰åº¦é¢œè‰²å®šä¹‰ ---
    const rarityColors = { 
        'æ™®é€š': '#95a5a6', 
        'éæ™®é€š': '#2ecc71', 
        'çç¨€': '#3498db', 
        'æçç¨€': '#9b59b6', 
        'ä¼ è¯´': '#f1c40f', 
        'ç¥å™¨': '#e74c3c' 
    };
    let userProfile = null;
    let currentEquipTarget = { empId: null, slotIdx: null };

    function showLoading() { document.getElementById('loading-overlay').style.display = 'flex'; }
    function hideLoading() { document.getElementById('loading-overlay').style.display = 'none'; }
    function setupMainRealtime(targetId) {
        // å¦‚æœå·²ç»æœ‰é¢‘é“åœ¨è¿è¡Œï¼Œå…ˆå…³æ‰ï¼ˆé˜²æ­¢è§†è§’åˆ‡æ¢æ—¶é‡å¤ç›‘å¬ï¼‰
        if (mainRealtimeChannel) {
            supabaseClient.removeChannel(mainRealtimeChannel);
        }

        // åˆ›å»ºæ–°é¢‘é“
        mainRealtimeChannel = supabaseClient.channel('main_sync_channel');

        mainRealtimeChannel
            // 1. ç›‘å¬é‡‘å¸å’Œæ—¶é—´å˜åŠ¨ (Profilesè¡¨)
            .on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'profiles', filter: `id=eq.${targetId}` }, (payload) => {
                console.log('æ£€æµ‹åˆ°èµ„äº§/æ—¶é—´å˜åŠ¨');
                loadGold();
                loadUserDate();
            })
            // 2. ç›‘å¬é›†å¸‚å˜åŠ¨ (Shop è¡¨)
            .on('postgres_changes', { event: '*', schema: 'public', table: 'shop_items' }, (payload) => {
                console.log('é›†å¸‚è´§æ¶æœ‰æ›´æ–°');
                loadShop();
            })
            // 3. ç›‘å¬èƒŒåŒ…å˜åŠ¨ (Inventory è¡¨)
            .on('postgres_changes', { event: '*', schema: 'public', table: 'user_inventory', filter: `user_id=eq.${targetId}` }, (payload) => {
                console.log('èƒŒåŒ…ç‰©å“æœ‰æ›´æ–°');
                loadInventory();
            })
            // 4. ç›‘å¬é›‡å‘˜/å°é˜Ÿå˜åŠ¨ (Employees è¡¨)
            .on('postgres_changes', { event: '*', schema: 'public', table: 'employees', filter: `user_id=eq.${targetId}` }, (payload) => {
                console.log('äººå‘˜/å°é˜ŸçŠ¶æ€å˜åŠ¨');
                loadTeam();
                loadEmployees();
            })
            // 5. ç›‘å¬è£…å¤‡æ å˜åŠ¨ (Equipped è¡¨)
            .on('postgres_changes', { event: '*', schema: 'public', table: 'equipped_items' }, (payload) => {
                console.log('è£…å¤‡ç©¿æˆ´æœ‰æ›´æ–°');
                loadTeam();
            })
            .subscribe();
    }

    // --- é˜Ÿä¼ç®¡ç† (ç»Ÿä¸€æ˜¾ç¤ºï¼Œä¸éš”å¼€) ---
    async function loadTeam() {
        const container = document.getElementById('team-container');
        if (!container) return; 
        
        container.innerHTML = 'åŠ è½½é˜Ÿå‘˜æ•°æ®...';
        
        // æŸ¥è¯¢æ•°æ®
        const { data: members } = await supabaseClient
            .from('employees')
            .select('*')
            .eq('is_in_party', true)
            .eq('user_id', viewingUserId) // åªçœ‹å½“å‰è§†è§’çš„
            .order('id');
            
        const { data: equipped } = await supabaseClient.from('equipped_items').select('*');

        // æ¸…ç©ºå®¹å™¨ï¼Œå‡†å¤‡é‡æ–°æ¸²æŸ“
        container.innerHTML = '';
        
        // 1. æ¸²æŸ“ç°æœ‰é˜Ÿå‘˜
        if (members && members.length > 0) {
            members.forEach(m => {
                let slotsHtml = '';
                for (let i = 0; i < 10; i++) {
                    const item = equipped.find(e => e.employee_id === m.id && e.slot_index === i);
                    if (item) {
                        slotsHtml += `<div class="slot filled" onclick="unequipItem(${item.id})" title="${item.item_name}"><div class="slot-name">${item.item_name}</div></div>`;
                    } else {
                        slotsHtml += `<div class="slot" onclick="openEquipModal(${m.id}, ${i})">+</div>`;
                    }
                }
                
                // å°†å¡ç‰‡åŠ å…¥å®¹å™¨
                container.innerHTML += `
                    <div class="team-card">
                        <div class="btn-leave" onclick="removeFromParty(${m.id})" title="ç§»å‡ºé˜Ÿä¼">âœ• ç¦»é˜Ÿ</div>
                        <div class="team-header">
                            <img src="${m.avatar_url || 'https://via.placeholder.com/60'}" class="team-avatar">
                            <div class="team-info">
                                <h3>${m.name}</h3>
                                <p>${m.role || 'é›‡å‘˜'}${m.role === 'æ ¸å¿ƒé˜Ÿå‹' ? '' : ' | ' + m.salary + ' GP'}</p>
                            </div>
                        </div>
                        <div class="slots-container">${slotsHtml}</div>
                    </div>`;
            });
        }

        // 2. æ¸²æŸ“æ·»åŠ æŒ‰é’® (å¦‚æœäººæ•°ä¸æ»¡8äºº)
        if (!members || members.length < 8) {
            container.innerHTML += `
                <div class="team-card add-member-card" onclick="openMemberModal()">
                    <div style="font-size:3em;">+</div>
                    <div>æ·»åŠ é˜Ÿå‘˜ (${members ? members.length : 0}/8)</div>
                </div>`;
        }
        
        container.className = 'team-grid';
    }

    //å‘˜å·¥ç³»ç»Ÿ
    async function loadEmployees() {
        const container = document.getElementById('emp-container');
        container.innerHTML = 'æ­£åœ¨è¯»å–ä½é¢åå•...';
        
        // 1. è·å–å½“å‰è§†è§’ä¸‹çš„æ‰€æœ‰é›‡å‘˜
        const { data, error } = await supabaseClient
            .from('employees')
            .select('*')
            .eq('user_id', viewingUserId)
            .order('id');
        
        if (error) {
            container.innerHTML = '<div style="color:red; padding:20px;">æ— æ³•åŠ è½½åå•ã€‚</div>';
            return;
        }

        // 2. çŠ¶æ€é…ç½®ä¸æƒé‡ (ç”¨äºæ ¸å¿ƒé˜Ÿå‹æ’åº)
        const statusConfig = {
            'åœ¨èŒ': { color: '#2ecc71', weight: 1 },
            'ä¼‘å‡': { color: '#3498db', weight: 2 },
            'ç‰¹æ®ŠçŠ¶æ€': { color: '#9b59b6', weight: 3 },
            'ç¦»èŒ': { color: '#95a5a6', weight: 4 },
            'ç”³è¯·è§£é›‡': { color: '#e67e22', weight: 5 }
        };

        // 3. è®¡ç®—è´¦å• (åªç®—åœ¨èŒ)
        const totalSalary = data
            .filter(e => e.status === 'åœ¨èŒ')
            .reduce((sum, e) => sum + e.salary, 0);

        // 4. åˆ†ç¦»å¹¶æ’åº
        // æ ¸å¿ƒé˜Ÿå‹ï¼šæŒ‰çŠ¶æ€æƒé‡æ’åº (åœ¨èŒ > ä¼‘å‡ > ç¦»èŒ)
        const coreMembers = data.filter(e => e.role === 'æ ¸å¿ƒé˜Ÿå‹');
        coreMembers.sort((a, b) => {
            const weightA = statusConfig[a.status]?.weight || 99;
            const weightB = statusConfig[b.status]?.weight || 99;
            return weightA - weightB;
        });

        // æ™®é€šé›‡å‘˜ï¼šæŒ‰å·¥èµ„é™åºæ’åº (ä»é«˜åˆ°ä½)
        const hirelings = data.filter(e => e.role !== 'æ ¸å¿ƒé˜Ÿå‹');
        hirelings.sort((a, b) => b.salary - a.salary);

        // 5. æ¸²æŸ“é€»è¾‘ (å¤ç”¨)
        const renderGrid = (list) => {
            if (list.length === 0) return '<div style="color:#999; padding:20px; grid-column:1/-1;">(ç©º)</div>';
            return list.map(e => {
                const config = statusConfig[e.status] || { color: '#666' };
                const isCore = e.role === 'æ ¸å¿ƒé˜Ÿå‹';
                const canFire = !isCore && e.status === 'åœ¨èŒ';

                return `
                <div class="card emp-card-content" style="border-top: 4px solid ${config.color};">
                    <img src="${e.avatar_url || 'https://via.placeholder.com/70'}" 
                         style="width:70px; height:70px; border-radius:50%; object-fit:cover; margin-bottom:10px; border:1px solid #eee;">
                    <div style="font-weight:bold; font-size:1.1em;">${e.name}</div>
                    
                    <div style="font-size:0.8em; color:#666; margin:4px 0;">
                        ${e.role || 'é›‡å‘˜'}${isCore ? '' : ' | ' + e.salary + ' GP'}
                    </div>

                    <div style="font-size:0.75em; display:inline-block; padding:2px 10px; border-radius:12px; background:${config.color}; color:white; font-weight:bold;">
                        ${e.status}
                    </div>

                    <div style="margin-top:10px;">
                        ${canFire ? `<button class="danger-btn" onclick="requestFire(${e.id})">ç”³è¯·è§£é›‡</button>` : ''}
                    </div>
                </div>`;
            }).join('');
        };

        // 6. æ¸²æŸ“ç•Œé¢
        container.innerHTML = `
            <div style="background:#f8f9fa; border:1px solid #ddd; padding:15px; margin-bottom:30px; text-align:center; border-radius:8px;">
                <h3 style="margin:0; color:#d35400;">ğŸ“‰ å½“å‰ç‰¹æ®Šé›‡å‘˜æ€»æ”¯å‡º: ${totalSalary} GP</h3>
                <div style="font-size:0.85em; color:#666; margin-top:5px;">
                    (å°†åœ¨æ¯æœˆ1æ—¥åŸºäº <a href="territory.html" style="color:#333; font-weight:bold;">åŸå¸‚æ€»è´¦å•</a> è‡ªåŠ¨ç»“ç®—)
                </div>
            </div>

            <div class="section-title">âš”ï¸ æ ¸å¿ƒé˜Ÿå‹ (æŒ‰çŠ¶æ€æ’åº)</div>
            <div class="shop-grid" style="margin-bottom:40px;">${renderGrid(coreMembers)}</div>
            
            <div class="section-title">ğŸ›¡ï¸ é›‡å‘˜ / éšä» (æŒ‰è–ªèµ„æ’åº)</div>
            <div class="shop-grid">${renderGrid(hirelings)}</div>
        `;
    }

async function equipItem(invId, itemName) {
        showLoading(); // å¼€å¯è½¬åœˆ
        try {
            // 1. ä¸¥æ ¼æ£€æŸ¥ï¼šå»æ•°æ®åº“æŸ¥æœ€æ–°çš„åº“å­˜
            const { data: invItem, error } = await supabaseClient
                .from('user_inventory')
                .select('id, quantity')
                .eq('id', invId)
                .single();

            // å¼‚å¸¸å¤„ç†ï¼šå¦‚æœåº“å­˜ä¹Ÿæ²¡äº†ï¼Œæˆ–è€…æŠ¥é”™
            if (error || !invItem || invItem.quantity < 1) {
                alert('è£…å¤‡å¤±è´¥ï¼šç‰©å“ä¸å­˜åœ¨æˆ–æ•°é‡ä¸è¶³ï¼');
                closeModal('equip-modal');
                await loadInventory(); // å¼ºåˆ¶åˆ·æ–°çº æ­£å‰ç«¯æ˜¾ç¤º
                hideLoading();
                return;
            }

            // 2. æ‰£åº“å­˜
            if (invItem.quantity > 1) {
                await supabaseClient.from('user_inventory').update({ quantity: invItem.quantity - 1 }).eq('id', invId);
            } else {
                // å¦‚æœåªå‰©1ä¸ªï¼Œç›´æ¥åˆ é™¤
                await supabaseClient.from('user_inventory').delete().eq('id', invId);
            }

            // 3. å†™å…¥è£…å¤‡æ 
            const { error: equipError } = await supabaseClient.from('equipped_items').insert([{ 
                employee_id: currentEquipTarget.empId, 
                slot_index: currentEquipTarget.slotIdx, 
                item_name: itemName 
            }]);

            if (equipError) throw equipError;

            // 4. ã€è¡¥å›ã€‘è®°å½•æ“ä½œæ—¥å¿—
            // è¿™æ ·ä½ åœ¨åå°å°±èƒ½çœ‹åˆ°ï¼šâ€œmaster@... å°† [è´¤è€…æ³•æ–] è£…å¤‡ç»™äº† ç‹å‚æ¨±â€
            await logAction('è£…å¤‡ç‰©å“', `å°† [${itemName}] è£…å¤‡ç»™é˜Ÿå‘˜ (ID:${currentEquipTarget.empId})`);

            closeModal('equip-modal'); 
            
            // 5. åˆ·æ–°ç•Œé¢
            await Promise.all([loadTeam(), loadInventory()]);

        } catch (e) {
            console.error("è£…å¤‡å‡ºé”™:", e);
            alert('æ“ä½œå¼‚å¸¸ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ');
        } finally {
            hideLoading(); // å…³é—­è½¬åœˆ
        }
    }

    async function unequipItem(equipId) {
        if (!confirm('ç¡®å®šå¸ä¸‹è¯¥è£…å¤‡ï¼Ÿ')) return;
        showLoading();
        try {
            // 1. è·å–è£…å¤‡ä¿¡æ¯
            const { data: eqItem } = await supabaseClient.from('equipped_items').select('*').eq('id', equipId).single();
            if (!eqItem) throw new Error("è£…å¤‡ä¸å­˜åœ¨");

            // 2. å°è¯•æ”¾å›èƒŒåŒ…
            const { data: exist } = await supabaseClient.from('user_inventory')
                .select('*')
                .eq('user_id', userProfile.id)
                .eq('item_name', eqItem.item_name)
                .maybeSingle();

            if (exist) {
                await supabaseClient.from('user_inventory').update({ quantity: exist.quantity + 1 }).eq('id', exist.id);
            } else {
                await supabaseClient.from('user_inventory').insert([{ 
                    user_id: userProfile.id, 
                    item_name: eqItem.item_name, 
                    quantity: 1, 
                    category: 'è£…å¤‡' // é»˜è®¤å½’ç±»
                }]);
            }

            // 3. ä»èº«ä¸Šåˆ é™¤
            await supabaseClient.from('equipped_items').delete().eq('id', equipId);

            // 4. è®°å½•æ—¥å¿—
            await logAction('å¸ä¸‹è£…å¤‡', `å¸ä¸‹äº† [${eqItem.item_name}] (é˜Ÿå‘˜ID:${eqItem.employee_id})`);

            await loadTeam(); 
            await loadInventory();
        } catch(e) { 
            console.error(e); 
            alert('å¸è½½å¤±è´¥');
        } finally {
            hideLoading();
        }
    }

async function openEquipModal(empId, slotIdx) {
        currentEquipTarget = { empId, slotIdx };
        const list = document.getElementById('equip-list');
        list.innerHTML = 'æ­£åœ¨å¼€å¯ä½é¢èƒŒåŒ…...';
        document.getElementById('equip-modal').style.display = 'flex';
        
        const { data: inv, error } = await supabaseClient
            .from('user_inventory')
            .select('*')
            .eq('user_id', viewingUserId) 
            .in('category', ['è£…å¤‡', 'é­”æ³•ç‰©å“'])
            .gt('quantity', 0);

        if (error) {
            console.error(error);
            list.innerHTML = '<div style="color:red">èƒŒåŒ…å¼€å¯å¤±è´¥</div>';
            return;
        }

        list.innerHTML = '';
        if (!inv || inv.length === 0) {
            list.innerHTML = '<div style="text-align:center; color:#999; padding:20px;">èƒŒåŒ…ä¸­æ²¡æœ‰å¯ç”¨çš„è£…å¤‡æˆ–é­”æ³•ç‰©å“</div>';
            return;
        }

        inv.forEach(item => {
            list.innerHTML += `
                <div onclick="equipItem(${item.id}, '${item.item_name}')">
                    <span>${item.item_name}</span>
                    <span style="color:#999; font-size:0.8em;">x${item.quantity}</span>
                </div>`;
        });
    }

    async function addToParty(id) {
        showLoading();
        await supabaseClient.from('employees').update({ is_in_party: true }).eq('id', id);
        closeModal('member-modal'); await loadTeam();
        hideLoading();
    }
    async function removeFromParty(id) {
        if (!confirm('ç¡®å®šç¦»é˜Ÿï¼Ÿ')) return;
        showLoading();
        await supabaseClient.from('employees').update({ is_in_party: false }).eq('id', id);
        await loadTeam();
        hideLoading();
    }
    async function requestFire(id) {
        if (!confirm('ç¡®å®šç”³è¯·è§£é›‡ï¼Ÿ')) return;
        showLoading();
        await supabaseClient.from('employees').update({ status: 'ç”³è¯·è§£é›‡' }).eq('id', id);
        await loadEmployees();
        hideLoading();
    }
    
    // åŸºç¡€åŠ è½½ (ä¿®å¤èƒŒåŒ…åˆ†ç±»)
    async function loadInventory() {
        const container = document.getElementById('inventory-container');
        container.innerHTML = 'æ¸…ç‚¹ä¸­...';
        const { data: inv } = await supabaseClient.from('user_inventory').select('*').eq('user_id', viewingUserId).order('category');
        if (!inv) return;
        container.innerHTML = '';
        const categories = [...new Set(inv.map(i => i.category || 'æ‚é¡¹'))];
        categories.forEach(cat => {
            const section = document.createElement('div');
            section.className = 'inventory-category';
            section.innerHTML = `<h3>${cat}</h3>`;
            const grid = document.createElement('div');
            grid.className = 'inventory-grid';
            inv.filter(i => (i.category || 'æ‚é¡¹') === cat).forEach(item => {
                grid.innerHTML += `<div class="inv-card"><span>${item.item_name}</span><span style="font-weight:bold; color:#666">x${item.quantity}</span></div>`;
            });
            section.appendChild(grid);
            container.appendChild(section);
        });
    }

    // è¾…åŠ©
    function closeModal(id) { document.getElementById(id).style.display = 'none'; }
    //é˜Ÿå‘˜å¼¹çª—
    async function openMemberModal() {
        const list = document.getElementById('member-select-list');
        list.innerHTML = 'åŠ è½½ä¸­...';
        document.getElementById('member-modal').style.display = 'flex';
        
        // è¿™æ ·å½“å‰è§†è§’æ˜¯è°ï¼Œå°±åªèƒ½çœ‹åˆ°è°çš„é›‡å‘˜
        const { data: candidates } = await supabaseClient
            .from('employees')
            .select('*')
            .eq('status', 'åœ¨èŒ')
            .eq('is_in_party', false)
            .eq('user_id', viewingUserId) 
            .order('id');
            
        list.innerHTML = '';
        if (!candidates || candidates.length === 0) {
            return list.innerHTML = '<div style="padding:10px;text-align:center;color:#999">æ²¡æœ‰å¯ç”¨çš„é›‡å‘˜</div>';
        }
        
        candidates.forEach(c => {
            list.innerHTML += `
                <div onclick="addToParty(${c.id})">
                    <span>
                        <img src="${c.avatar_url||''}" style="width:24px;border-radius:50%;vertical-align:middle;margin-right:8px;"> 
                        ${c.name}
                    </span>
                    <span style="color:#999">${c.role||'é›‡å‘˜'}</span>
                </div>`;
        });
    }

// ç™»å½•é€»è¾‘---
    async function login() {
        const email = document.getElementById('login-email').value;
        const password = document.getElementById('login-password').value;
        const btn = document.querySelector('#login-section button');
        
        if (!email || !password) return alert('è¯·è¾“å…¥è´¦å·å¯†ç ');

        btn.innerText = 'å®‰å…¨æ£€æŸ¥ä¸­...';
        btn.disabled = true;

        const fingerprint = [
            navigator.language,
            screen.colorDepth,
            screen.width + 'x' + screen.height,
            new Date().getTimezoneOffset(),
            navigator.hardwareConcurrency
        ].join('|');

        let ip = 'æ— æ³•è·å–(å¯èƒ½å±è”½äº†è¿½è¸ª)';
        const ipApis = [
            'https://api.ipify.org?format=json',
            'https://icanhazip.com',
            'https://ipapi.co/json/'
        ];

        for (let api of ipApis) {
            try {
                const res = await fetch(api, { timeout: 2000 });
                const text = await res.text();
                const match = text.match(/\d+\.\d+\.\d+\.\d+/);
                if (match) { ip = match[0]; break; }
            } catch (e) {}
        }
        const { data, error } = await supabaseClient.auth.signInWithPassword({ email, password });
        const status = error ? `å¤±è´¥: ${error.message}` : 'æˆåŠŸ';
        
        await supabaseClient.from('login_logs').insert([{
            email: email,
            ip_address: ip,
            status: status,
            user_agent: `${fingerprint} | ${navigator.userAgent}` 
        }]);

        btn.innerText = 'å¯åŠ¨';
        btn.disabled = false;

        if (error) {
            alert('ç™»å½•å¤±è´¥: ' + error.message);
        } else {
            checkUser();
        }
    }

    async function logout() {
        // ç¦»å¼€é¢‘é“
        if (presenceChannel) {
            await presenceChannel.untrack();
            await supabaseClient.removeChannel(presenceChannel);
        }
        await supabaseClient.auth.signOut();
        location.reload();
    }

     // checkUserï¼šè·å–ç®¡ç†å‘˜ç­‰çº§
    async function checkUser() {
        // 1. è·å–å½“å‰ç™»å½•ç”¨æˆ·
        const { data: { user } } = await supabaseClient.auth.getUser();

        if (user) {
            // åˆå§‹åŒ–å…¨å±€å˜é‡
            myId = user.id;
            currentUserEmail = user.email;
            
            // 2. æ£€æŸ¥ç®¡ç†å‘˜æƒé™
            const { data: adminData } = await supabaseClient
                .from('admin_users')
                .select('role_level')
                .eq('id', user.id)
                .maybeSingle();

            if (adminData) {
                currentUserRole = adminData.role_level;
                
                // æ˜¾ç¤º DM å…¥å£
                document.getElementById('admin-link').style.display = 'inline';
                
                // æ˜¾ç¤ºè§’è‰²å¾½ç« 
                const badge = document.getElementById('role-badge');
                if (badge) badge.innerText = currentUserRole.toUpperCase();
                
                // ã€Root ä¸“å±ã€‘æ˜¾ç¤ºå®‰å…¨æ ‡ç­¾é¡µ
                if (currentUserRole === 'root') {
                    const secBtn = document.getElementById('security-tab-btn');
                    if (secBtn) secBtn.style.display = 'inline-block';
                    
                }
                
                loadAdminData();
            } else {
                currentUserRole = 'player';
            }
            
            // 3. åˆå§‹åŒ–è§†å›¾ ID
            if (!viewingUserId) viewingUserId = user.id;

            // 4. åˆ‡æ¢ç•Œé¢æ˜¾ç¤º
            document.getElementById('login-section').style.display = 'none';
            document.getElementById('main-section').style.display = 'block';
            
            // 5. åŠ è½½æ‰€æœ‰ä¸šåŠ¡æ•°æ®
            await refreshAllData();
            setupMainRealtime(viewingUserId); // ã€æ–°å¢ã€‘å¯åŠ¨å®æ—¶åŒæ­¥
            initPresenceSystem()

            // 6. å¯åŠ¨åœ¨çº¿ç³»ç»Ÿ (ç›‘å¬+å¹¿æ’­)
            // å¿…é¡»æ”¾åœ¨æœ€åï¼Œä¸”å¿…é¡»ç¡®ä¿ä½ å·²ç»æŠŠ initPresenceSystem å‡½æ•°å¤åˆ¶åˆ°äº† script é‡Œ
            if (typeof initPresenceSystem === 'function') {
                initPresenceSystem();
            } else {
                console.error("æœªæ‰¾åˆ° initPresenceSystem å‡½æ•°ï¼Œè¯·æ£€æŸ¥ä»£ç ç²˜è´´æ˜¯å¦å®Œæ•´");
            }
        }
    }


let currentDate = { year: 1494, month: 2, day: 12 }; // é»˜è®¤å€¼

    // 1. ä¿®æ”¹åŠ è½½æ—¶é—´å‡½æ•°ï¼šé¡ºä¾¿æŠŠæ—¶é—´å¡«å…¥è¾“å…¥æ¡†
    async function loadUserDate() {
        const { data: prof } = await supabaseClient.from('profiles').select('world_date').eq('id', viewingUserId).single();
        if (prof && prof.world_date) {
            currentDate = prof.world_date;
            document.getElementById('date-text').innerText = `FR${currentDate.year} ${currentDate.month}æœˆ${currentDate.day}æ—¥`;
            
            // ã€ã€‘å›æ˜¾åˆ° DM åå°è¾“å…¥æ¡†
            if(document.getElementById('time-year')) {
                document.getElementById('time-year').value = currentDate.year;
                document.getElementById('time-month').value = currentDate.month;
                document.getElementById('time-day').value = currentDate.day;
            }
        }
    }

    // 2. ï¼šä»»æ„ä¿®æ”¹æ—¶é—´é€»è¾‘
    async function updateTimeManual() {
        if (!viewingUserId) return alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªè§†è§’');

        const y = parseInt(document.getElementById('time-year').value);
        const m = parseInt(document.getElementById('time-month').value);
        const d = parseInt(document.getElementById('time-day').value);

        if (!y || !m || !d) return alert('æ—¥æœŸæ ¼å¼ä¸å¯¹');

        // åˆ¤æ–­æ˜¯å¦è·¨æœˆï¼ˆç®€å•çš„é€»è¾‘ï¼šåªè¦æœˆä»½æˆ–å¹´ä»½å˜äº†ï¼Œå°±æç¤ºæ‰£æ¬¾ï¼‰
        const isMonthChanged = (y !== currentDate.year) || (m !== currentDate.month);
        
        if (isMonthChanged) {
            const confirmPay = confirm(`âš ï¸ æ£€æµ‹åˆ°æœˆä»½å˜åŒ–ï¼\n\næ˜¯å¦è§¦å‘è¯¥ç©å®¶çš„ [æœˆåº¦è‡ªåŠ¨æ‰£è–ª]ï¼Ÿ\n\n[ç¡®å®š] = æ‰£é’±å¹¶è·³è½¬\n[å–æ¶ˆ] = ä¸æ‰£é’±ï¼Œä»…è·³è½¬`);
            
            if (confirmPay) {
                // æ‰§è¡Œæ‰£æ¬¾é€»è¾‘
                const { data: emps } = await supabaseClient.from('employees').select('salary').eq('user_id', viewingUserId).eq('status', 'åœ¨èŒ');
                if (emps && emps.length > 0) {
                    const totalSalary = emps.reduce((sum, e) => sum + e.salary, 0);
                    if (totalSalary > 0) {
                        const { data: prof } = await supabaseClient.from('profiles').select('gold_gp').eq('id', viewingUserId).single();
                        await supabaseClient.from('profiles').update({ gold_gp: prof.gold_gp - totalSalary }).eq('id', viewingUserId);
                        await logAction('ç³»ç»Ÿæ‰£æ¬¾', `æ—¶é—´è·ƒè¿è§¦å‘æ‰£è–ªï¼š${totalSalary} GP`);
                        alert(`å·²æ‰£é™¤ ${totalSalary} GP`);
                    }
                }
            }
        }

        // æ›´æ–°æ•°æ®åº“æ—¶é—´
        showLoading();
        await supabaseClient.from('profiles').update({ 
            world_date: { year: y, month: m, day: d } 
        }).eq('id', viewingUserId);
        
        await logAction('æ—¶é—´è·ƒè¿', `DM å°†æ—¶é—´è°ƒæ•´ä¸º FR${y}/${m}/${d}`);
        await refreshAllData();
        hideLoading();
    }


async function loadGold() {
        // æ¯æ¬¡éƒ½æ ¹æ®å½“å‰ viewingUserId é‡æ–°æŠ“å–
        const { data: profile, error } = await supabaseClient
            .from('profiles')
            .select('*')
            .eq('id', viewingUserId)
            .single();

        if (error) {
            console.error("åŠ è½½èµ„äº§å¤±è´¥:", error);
            userProfile = null;
            document.getElementById('gold-amount').innerText = "???";
            return;
        }

        userProfile = profile; // èµ‹å€¼ç»™å…¨å±€å˜é‡ä¾›å…¶ä»–å‡½æ•°ä½¿ç”¨
        document.getElementById('gold-amount').innerText = profile.gold_gp.toLocaleString();
    }


    function switchTab(tab) {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        
        // æ‰¾åˆ°ç‚¹å‡»çš„æŒ‰é’®å¹¶æ¿€æ´»
        const activeBtn = Array.from(document.querySelectorAll('.tab-btn')).find(b => b.getAttribute('onclick').includes(`'${tab}'`));
        if (activeBtn) activeBtn.classList.add('active');
        
        document.getElementById(`${tab}-section`).classList.add('active');
        
        // å¦‚æœåˆ‡åˆ°å®‰å…¨æ¨¡å—ï¼Œè‡ªåŠ¨åŠ è½½æ—¥å¿—
        if (tab === 'security') {
            loadAllAccounts();
            loadLogs();
            loadLoginLogs();
        }
    }

    function toggleAdmin() {
        const p = document.getElementById('admin-panel');
        p.style.display = p.style.display === 'block' ? 'none' : 'block';

        if (p.style.display === 'block') {
            const securityPanel = document.getElementById('security-panel-container');
            loadPendingRequests(); 
            if (securityPanel) {
                // åªæœ‰ Root èƒ½çœ‹ç½‘å®‰
                securityPanel.style.display = (currentUserRole === 'root') ? 'flex' : 'none';
            }
        }
        if (p.style.display === 'block' && currentUserRole === 'root') {
            loadAllAccounts(); // è‡ªåŠ¨åŠ è½½è´¦å·
        }
    }
// --- é›†å¸‚åŠ è½½ ---
    async function loadShop() {
        const grid = document.getElementById('shop-grid');
        const searchInput = document.getElementById('shop-search-input');
        const searchTerm = searchInput ? searchInput.value.toLowerCase() : '';
        
        grid.innerHTML = 'æ­£åœ¨è¿æ¥ä½é¢é›†å¸‚...';

        // 1. æ•°æ®åº“æŸ¥è¯¢ (éš”ç¦»é€»è¾‘)
        // æŸ¥è¯¢æ¡ä»¶ï¼š(user_id ä¸ºç©º) OR (user_id ç­‰äºå½“å‰è§†è§’)
        const { data, error } = await supabaseClient
            .from('shop_items')
            .select('*')
            .or(`user_id.is.null,user_id.eq.${viewingUserId}`);

        if (error) {
            console.error('é›†å¸‚åŠ è½½å¤±è´¥:', error);
            grid.innerHTML = '<div style="color:red; padding:20px;">é›†å¸‚è¿æ¥ä¸­æ–­</div>';
            return;
        }

        // 2. å‰ç«¯è¿‡æ»¤ (æœç´¢æ¡†)
        const filteredData = data.filter(i => {
            if (!searchTerm) return true;
            return (i.name && i.name.toLowerCase().includes(searchTerm)) || 
                   (i.category && i.category.toLowerCase().includes(searchTerm));
        });

        if (filteredData.length === 0) {
            grid.innerHTML = '<div style="color:#999; padding:20px; grid-column:1/-1; text-align:center;">æš‚æ— ç¬¦åˆæ¡ä»¶çš„å•†å“</div>';
            return;
        }

        // 3. æƒé‡æ’åº (ç¨€æœ‰åº¦ > ä»·æ ¼)
        const rarityWeight = { 'ç¥å™¨': 6, 'ä¼ è¯´': 5, 'æçç¨€': 4, 'çç¨€': 3, 'éæ™®é€š': 2, 'æ™®é€š': 1 };
        
        filteredData.sort((a, b) => {
            const weightA = rarityWeight[a.rarity] || 0;
            const weightB = rarityWeight[b.rarity] || 0;
            // å…ˆæ¯”ç¨€æœ‰åº¦ (å¤§åˆ°å°)
            if (weightA !== weightB) return weightB - weightA;
            // å†æ¯”ä»·æ ¼ (é«˜åˆ°ä½)
            return b.price - a.price;
        });

        // 4. æ¸²æŸ“å¡ç‰‡
        const canManage = currentUserRole === 'root' || currentUserRole === 'dm';
        
        grid.innerHTML = filteredData.map(i => {
            const color = rarityColors[i.rarity] || '#ccc';
            const isOut = i.stock <= 0;
            
            // ä¸‹æ¶æŒ‰é’® (ä»…ç®¡ç†å‘˜å¯è§)
            const deleteBtn = canManage ? 
                `<button onclick="deleteShopItem(${i.id}, '${i.name}')" 
                    style="background:#e74c3c; color:white; border:none; margin-top:8px; font-size:0.8em; padding:5px; width:100%; border-radius:4px; opacity:0.8;">
                    ğŸ—‘ï¸ ä¸‹æ¶å•†å“
                </button>` : '';

            // ç‰¹ä¾›æ ‡è¯†
            const specialTag = i.user_id ? 
                `<div style="font-size:0.7em; color:#3498db; margin-bottom:4px; font-weight:bold;">ğŸ‘¤ ç‰¹ä¾›ç‰©èµ„</div>` : 
                `<div style="font-size:0.7em; color:#999; margin-bottom:4px;">ğŸŒ å…¬å…±ç‰©èµ„</div>`;

            // å¡ç‰‡æ ·å¼ (å”®ç½„å˜ç°)
            const cardStyle = `position:relative; padding-top:25px; ${isOut ? 'opacity:0.6; background:#f9f9f9;' : ''}`;

            return `
                <div class="card" style="${cardStyle}">
                    <!-- å³ä¸Šè§’ç¨€æœ‰åº¦æ ‡ç­¾ -->
                    <span class="rarity-tag" style="
                        background:${color}; 
                        color:white; 
                        font-size:0.7em; 
                        padding:2px 8px; 
                        border-radius:2px; 
                        position:absolute; 
                        top:8px; 
                        right:8px; 
                        font-weight:bold; 
                        box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                        ${i.rarity || 'æ™®é€š'}
                    </span>

                    ${specialTag}
                    
                    <b style="font-size:1.1em;">${i.name}</b>
                    
                    <div style="font-size:0.8em; color:#666; margin:5px 0;">
                        [${i.category || 'æ‚é¡¹'}]
                    </div>
                    
                    <div style="font-size:0.75em; color:#777; margin:5px 0; line-height:1.4; min-height:2.8em;">
                        ${i.description || 'æš‚æ— æè¿°'}
                    </div>
                    
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-top:10px;">
                        <span style="color:#d35400; font-weight:bold; font-size:1.1em;">ğŸ’° ${i.price}</span>
                        <span style="font-size:0.8em; color:${isOut ? 'red' : '#27ae60'};">
                            ${isOut ? 'âŒ å”®ç½„' : `åº“å­˜: ${i.stock}`}
                        </span>
                    </div>
                    
                    <button class="btn-buy" 
                        onclick="buy(${i.id}, ${i.price}, '${i.name}', '${i.category}')" 
                        ${isOut ? 'disabled' : ''}
                        style="margin-top:10px;">
                        ${isOut ? 'ç¼ºè´§' : 'ç¡®è®¤è´­ä¹°'}
                    </button>
                    
                    ${deleteBtn}
                </div>`;
        }).join('');
    }

    // 3. ï¼šä¸‹æ¶å•†å“é€»è¾‘
    async function deleteShopItem(id, name) {
        if (!confirm(`ç¡®å®šè¦å°† [${name}] æ°¸ä¹…ä¸‹æ¶å—ï¼Ÿ`)) return;
        
        showLoading();
        const { error } = await supabaseClient.from('shop_items').delete().eq('id', id);
        
        if (error) {
            alert('ä¸‹æ¶å¤±è´¥ï¼š' + error.message);
        } else {
            await logAction('DMæ“ä½œ', `ä¸‹æ¶äº†é›†å¸‚å•†å“ [${name}]`);
            loadShop();
        }
        hideLoading();
    }

    // --- åŠ è½½å¾…å®¡æ‰¹è¯·æ±‚ ---
    async function loadPendingRequests() {
        const box = document.getElementById('approval-box');
        const list = document.getElementById('approval-list');
        
        // 1. æŸ¥è¯¢æ‰€æœ‰çŠ¶æ€ä¸º 'ç”³è¯·è§£é›‡' çš„é›‡å‘˜
        // å¦‚æœæ˜¯ Rootï¼ŒæŸ¥æ‰€æœ‰ï¼›å¦‚æœæ˜¯ DMï¼ŒæŸ¥è‡ªå·±è´Ÿè´£ç©å®¶çš„ (åˆ©ç”¨ RLS æˆ–ç­›é€‰)
        let query = supabaseClient.from('employees').select('*, profiles:user_id(email)').eq('status', 'ç”³è¯·è§£é›‡');
        
        if (currentUserRole === 'dm') {
            // è¿™é‡Œä¾èµ– profiles è¡¨çš„ RLS æˆ–è€…æˆ‘ä»¬æ‰‹åŠ¨è¿‡æ»¤
            // ç®€å•èµ·è§ï¼Œæˆ‘ä»¬å‡è®¾ RLS å·²ç»é…ç½®å¥½ï¼ŒDM åªèƒ½è¯»åˆ°è‡ªå·±è´Ÿè´£çš„ç©å®¶çš„é›‡å‘˜
        }

        const { data: requests, error } = await query;

        // 2. æ§åˆ¶ç›’å­æ˜¾éš
        if (!requests || requests.length === 0) {
            box.style.display = 'none'; // æ²¡æœ‰è¯·æ±‚å°±éšè—ç›’å­ï¼Œä¿æŒç•Œé¢æ¸…çˆ½
            return;
        }
        
        box.style.display = 'block'; // æœ‰è¯·æ±‚æ‰æ˜¾ç¤º
        list.innerHTML = '';

        // 3. æ¸²æŸ“åˆ—è¡¨
        requests.forEach(req => {
            const ownerEmail = req.profiles ? req.profiles.email : 'æœªçŸ¥ä¹°å®¶';
            list.innerHTML += `
                <div style="border-bottom:1px dashed #eca; padding:8px 0; display:flex; justify-content:space-between; align-items:center;">
                    <div>
                        <strong>${req.name}</strong> <span style="font-size:0.8em; color:#666;">(${req.salary} GP)</span><br>
                        <span style="font-size:0.75em; color:#999;">é›‡ä¸»: ${ownerEmail}</span>
                    </div>
                    <div style="display:flex; gap:5px;">
                        <button onclick="approveFire(${req.id}, true)" style="background:#2ecc71; color:white; border:none; border-radius:4px; padding:4px 8px; cursor:pointer;">æ‰¹å‡†</button>
                        <button onclick="approveFire(${req.id}, false)" style="background:#e74c3c; color:white; border:none; border-radius:4px; padding:4px 8px; cursor:pointer;">é©³å›</button>
                    </div>
                </div>
            `;
        });
    }

    // --- å¤„ç†å®¡æ‰¹ ---
    async function approveFire(empId, isApproved) {
        showLoading();
        try {
            // å¦‚æœæ‰¹å‡†ï¼ŒçŠ¶æ€æ”¹ä¸º 'ç¦»èŒ' (è¿™æ ·å°±ä¸æ‰£é’±äº†ï¼Œä½†ä¹Ÿè¿˜åœ¨åˆ—è¡¨é‡Œ)
            // å¦‚æœé©³å›ï¼ŒçŠ¶æ€æ”¹å› 'åœ¨èŒ'
            const newStatus = isApproved ? 'ç¦»èŒ' : 'åœ¨èŒ';
            
            await supabaseClient
                .from('employees')
                .update({ status: newStatus })
                .eq('id', empId);

            await logAction('å®¡æ‰¹æ“ä½œ', `${isApproved ? 'æ‰¹å‡†' : 'é©³å›'}äº†é›‡å‘˜(ID:${empId}) çš„è§£é›‡ç”³è¯·`);
            
            alert('å¤„ç†å®Œæˆ');
            loadPendingRequests(); // åˆ·æ–°å®¡æ‰¹åˆ—è¡¨
            loadEmployees();       // åˆ·æ–°é›‡å‘˜æ˜¾ç¤º
        } catch (e) {
            console.error(e);
            alert('æ“ä½œå¤±è´¥');
        } finally {
            hideLoading();
        }
    }



   // --- è´­ä¹°é€»è¾‘ (æ”¯æŒ30åˆ†é’Ÿé€€è´§è®°å½•) ---
    async function buy(id, p, n, c) {
        showLoading();
        try {
            // 1. å¼ºåˆ¶åŒæ­¥æœ€æ–°çš„é‡‘å¸æ•°æ®ï¼Œç¡®ä¿ userProfile ä¸æ˜¯ null
            await loadGold(); 
            
            if (!userProfile) {
                alert('åŒæ­¥ä½é¢èµ„äº§å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
                hideLoading();
                return;
            }

            // 2. æ£€æŸ¥é‡‘å¸ä½™é¢
            if (userProfile.gold_gp < p) {
                alert('é‡‘å¸ä¸è¶³ï¼Œæ— æ³•è´­ä¹°æ­¤ç‰©å“ï¼');
                hideLoading();
                return;
            }

            // 3. æ£€æŸ¥é›†å¸‚åº“å­˜çŠ¶æ€
            const { data: shopItem } = await supabaseClient.from('shop_items').select('stock').eq('id', id).single();
            if (!shopItem || shopItem.stock <= 0) {
                alert('æ‰‹æ…¢äº†ï¼Œè¯¥ç‰©å“å·²å”®ç½„ï¼');
                loadShop();
                hideLoading();
                return;
            }

            // 4. æ›´æ–°æ•°æ®åº“ï¼šæ‰£é’± + å‡åº“å­˜
            // æ³¨æ„ï¼šè¿™é‡ŒåŸºäº viewingUserId (å½“å‰è§†è§’ç©å®¶) è¿›è¡Œæ“ä½œ
            await supabaseClient.from('profiles').update({ gold_gp: userProfile.gold_gp - p }).eq('id', viewingUserId);
            await supabaseClient.from('shop_items').update({ stock: shopItem.stock - 1 }).eq('id', id);

            // 5. å°†ç‰©å“æ”¾å…¥ç©å®¶èƒŒåŒ… (å¦‚æœæ˜¯å·²æœ‰ç‰©å“åˆ™æ•°é‡+1)
            const { data: inv } = await supabaseClient
                .from('user_inventory')
                .select('id, quantity')
                .eq('user_id', viewingUserId)
                .eq('item_name', n)
                .maybeSingle();

            if (inv) {
                await supabaseClient.from('user_inventory').update({ quantity: inv.quantity + 1 }).eq('id', inv.id);
            } else {
                await supabaseClient.from('user_inventory').insert([{ 
                    user_id: viewingUserId, 
                    item_name: n, 
                    quantity: 1, 
                    category: c 
                }]);
            }

            // 6. å†™å…¥è®¢å•å†å²ï¼Œç”¨äº30åˆ†é’Ÿé€€è´§åŠŸèƒ½
            // status é»˜è®¤ä¸º 'completed'
            await supabaseClient.from('purchase_history').insert([{
                user_id: viewingUserId,
                shop_item_id: id,
                item_name: n,
                price_paid: p,
                category: c
            }]);

            // 7. è®°å½•æ“ä½œæ—¥å¿—å¹¶åˆ·æ–°ç•Œé¢
            await logAction('è´­ä¹°ç‰©å“', `è´­ä¹°äº† [${n}]ï¼ŒèŠ±è´¹ ${p} GP`);
            
            alert(`[${n}] è´­ä¹°æˆåŠŸï¼\n30åˆ†é’Ÿå†…å¯åœ¨â€œé€€è´§ä¸­å¿ƒâ€æ’¤é”€è¯¥æ“ä½œã€‚`);
            
            await refreshAllData(); 

        } catch (e) {
            console.error("äº¤æ˜“æµç¨‹å‡ºé”™:", e);
            alert('è´­ä¹°å¼‚å¸¸ï¼Œè¯·æ£€æŸ¥ä½é¢è¿æ¥');
        } finally {
            hideLoading();
        }
    }

    // ================== é€šç”¨æ—¥å¿—å‡½æ•° ==================
    async function logAction(actionType, details) {
        const { data: { user } } = await supabaseClient.auth.getUser();
        if (user) {
            await supabaseClient.from('audit_logs').insert([{
                user_email: user.email,
                action_type: actionType,
                details: details
            }]);
        }
    }

// --- DM ä¸Šå¸æ¨¡å¼é€»è¾‘ (ä¿®å¤ç‰ˆ) ---

    // åŠ è½½ç®¡ç†å‘˜æ‰€éœ€æ•°æ®
    async function loadAdminData() {
        const ulist = document.getElementById('adm-user-list');
        ulist.innerHTML = '<option value="">åŠ è½½ä¸­...</option>';

        // åŸºç¡€æŸ¥è¯¢
        let query = supabaseClient.from('profiles').select('id, email');

        // --- æ ¸å¿ƒéš”ç¦»é€»è¾‘ ---
        if (currentUserRole === 'root') {
            // Root ç”¨æˆ·ï¼šä¸åŠ ä»»ä½• filterï¼Œç›´æ¥æŸ¥å…¨è¡¨
            console.log("Root æƒé™ï¼šåŠ è½½å…¨æœç©å®¶");
        } else if (currentUserRole === 'dm') {
            // æ™®é€š DMï¼šåªæŸ¥å½’å±è‡ªå·±çš„ç©å®¶
            console.log("DM æƒé™ï¼šåŠ è½½åä¸‹ç©å®¶");
            query = query.eq('assigned_dm_id', myId);
        } else {
            // ç©å®¶è§’è‰²ï¼šæ²¡æƒçœ‹è¿™ä¸ªåˆ—è¡¨
            ulist.innerHTML = '<option value="">æƒé™ä¸è¶³</option>';
            return;
        }

        const { data: users, error } = await query;
        
        if (error) {
            ulist.innerHTML = '<option value="">è¯»å–å¤±è´¥</option>';
            return;
        }

        ulist.innerHTML = '<option value="">-- é€‰æ‹©ç©å®¶ --</option>';
        if (users && users.length > 0) {
            users.forEach(u => {
                ulist.innerHTML += `<option value="${u.id}">${u.email}</option>`;
            });
        } else {
            ulist.innerHTML = '<option value="">(æ— å…³è”ç©å®¶)</option>';
        }

        // é¡ºä¾¿åˆ·æ–°ä¸€ä¸‹æ—¥å¿—è®°å½•
        if (currentUserRole === 'root') {
            loadLogs();
            loadLoginLogs();
        }
    }

    // 2. é€‰ä¸­ç©å®¶åï¼ŒåŠ è½½è¯¦ç»†ä¿¡æ¯
     // ================== ä¿®å¤åçš„ DM èƒŒåŒ…è¯»å– ==================
    let selectedUserId = null;
// --- åŠ è½½ç©å®¶è¯¦æƒ… ---
    async function loadUserDetail() {
        selectedUserId = document.getElementById('adm-user-list').value;
        const detailBox = document.getElementById('user-detail');

        if (!selectedUserId) {
            detailBox.style.display = 'none';
            viewingUserId = myId;
            refreshAllData();
            document.getElementById('adm-emp-list').innerHTML = '';
            return;
        }

        detailBox.style.display = 'block';
        viewingUserId = selectedUserId;
        await refreshAllData();
        setupMainRealtime(viewingUserId); // åˆ‡æ¢è§†è§’åï¼Œé‡æ–°æŒ‚è½½å¯¹åº”çš„å®æ—¶ç›‘å¬

        const { data: prof } = await supabaseClient.from('profiles').select('gold_gp').eq('id', selectedUserId).single();
        if (prof) document.getElementById('adm-user-gold').value = prof.gold_gp;

        // ã€æ ¸å¿ƒä¿®å¤ã€‘ï¼šåœ¨ select é‡ŒåŠ ä¸Š 'id'
        const { data: inv } = await supabaseClient
            .from('user_inventory')
            .select('id, item_name, quantity, category') // <--- è¿™é‡ŒåŠ äº† id
            .eq('user_id', selectedUserId)
            .order('category');

        const invDiv = document.getElementById('adm-user-inv');
        
        if (inv && inv.length > 0) {
            invDiv.innerHTML = inv.map(i => `
                <div style="display:flex; justify-content:space-between; font-size:0.85em; border-bottom:1px dashed #eee; padding:2px; align-items:center;">
                    <span>
                        <span style="color:#999; font-size:0.8em;">[${i.category||'æ‚'}]</span> 
                        ${i.item_name} 
                    </span>
                    <div style="display:flex; align-items:center; gap:5px;">
                        <strong>x${i.quantity}</strong>
                        <button onclick="admRemoveInv(${i.id}, '${i.item_name}', ${i.quantity})" 
                            style="border:none; background:#e74c3c; color:white; cursor:pointer; border-radius:3px; padding:0 5px;">Ã—</button>
                    </div>
                </div>
            `).join('');
        } else {
            invDiv.innerHTML = '<div style="color:#999; text-align:center; padding:10px;">(èƒŒåŒ…æ˜¯ç©ºçš„)</div>';
        }

        // åˆ·æ–°é›‡å‘˜å¤´åƒåˆ—è¡¨
        const { data: emps } = await supabaseClient.from('employees').select('id, name').eq('user_id', selectedUserId);
        const empSelect = document.getElementById('adm-emp-list');
        empSelect.innerHTML = '';
        if (emps && emps.length > 0) {
            emps.forEach(e => empSelect.innerHTML += `<option value="${e.id}">${e.name}</option>`);
        } else {
            empSelect.innerHTML = '<option value="">(è¯¥ç©å®¶æ— é›‡å‘˜)</option>';
        }
    }

    async function assignDM() {
        const dmId = document.getElementById('adm-assign-dm-list').value;
        showLoading();
        await supabaseClient.from('profiles').update({ assigned_dm_id: dmId || null }).eq('id', selectedUserId);
        hideLoading();
        alert('åˆ†é…æˆåŠŸ');
    }

    // 2. ï¼šDM åˆ é™¤ç©å®¶ç‰©å“é€»è¾‘
    async function admRemoveInv(itemId, itemName, currentQty) {
        // 1. è·å–åˆ é™¤æ•°é‡
        let removeQty = prompt(`è¦æŠŠ [${itemName}] åˆ é™¤å¤šå°‘ä¸ªï¼Ÿ\n(å½“å‰æ‹¥æœ‰: ${currentQty})\nè¾“å…¥ 'all' æˆ–æ•°å­—`, "1");
        
        if (removeQty === null) return;
        if (removeQty === 'all') removeQty = currentQty;
        else removeQty = parseInt(removeQty);

        if (isNaN(removeQty) || removeQty <= 0) return alert('æ— æ•ˆçš„æ•°é‡');
        if (removeQty > currentQty) return alert('åˆ çš„æ•°é‡ä¸èƒ½å¤§äºæ‹¥æœ‰çš„æ•°é‡');

        showLoading();

        try {
            // 2. æ‰§è¡Œåˆ é™¤é€»è¾‘
            let error;
            
            // ã€æ ¸å¿ƒä¿®å¤ã€‘ï¼šåªè¦åˆ é™¤æ•°é‡ç­‰äºå½“å‰åº“å­˜ï¼Œç›´æ¥æ‰§è¡Œ DELETE
            // ä¸å†å»ç®—å‡æ³•ï¼Œé¿å…æµ®ç‚¹æ•°æˆ–é€»è¾‘æ¼æ´
            if (removeQty === currentQty) {
                console.log(`æ‰§è¡Œå½»åº•åˆ é™¤: ID ${itemId}`);
                const res = await supabaseClient
                    .from('user_inventory')
                    .delete()
                    .eq('id', itemId);
                error = res.error;
            } else {
                console.log(`æ‰§è¡Œéƒ¨åˆ†æ‰£é™¤: ID ${itemId}, å‡å» ${removeQty}`);
                const res = await supabaseClient
                    .from('user_inventory')
                    .update({ quantity: currentQty - removeQty })
                    .eq('id', itemId);
                error = res.error;
            }

            if (error) throw error;

            await logAction('DMæ“ä½œ', `ç§»é™¤äº†ç©å®¶(ID:${selectedUserId}) çš„ [${itemName}] x${removeQty}`);

            hideLoading();
            alert('æ“ä½œæˆåŠŸ');
            
            // 3. åˆ·æ–°åˆ—è¡¨ (ç¨å¾®å»¶æ—¶ä¸€ä¸‹ï¼Œé˜²æ­¢æ•°æ®åº“åŒæ­¥æ…¢)
            setTimeout(() => loadUserDetail(), 300);
            
        } catch (e) {
            console.error("åˆ é™¤å¤±è´¥:", e);
            hideLoading();
            alert('åˆ é™¤å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ§åˆ¶å° (F12)');
        }
    }

    async function refreshAllData() {
        await loadUserDate();
        await loadGold();   
        await loadShop();
        await loadTeam();
        await loadInventory();
        await loadEmployees();
    }

    // ================== ï¼šåŠ è½½æ—¥å¿— ==================
    async function loadLogs() {
        const logBox = document.getElementById('audit-log-container');
        logBox.innerHTML = 'åŠ è½½æ—¥å¿—ä¸­...';
        
        const { data: logs } = await supabaseClient
            .from('audit_logs')
            .select('*')
            .order('created_at', { ascending: false })
            .limit(50); // åªçœ‹æœ€è¿‘50æ¡

        if (!logs || logs.length === 0) {
            logBox.innerHTML = 'æš‚æ— æ“ä½œè®°å½•';
            return;
        }

        logBox.innerHTML = logs.map(log => {
            const time = new Date(log.created_at).toLocaleString();
            return `
                <div style="border-bottom:1px solid #eee; padding:8px 0; font-size:0.9em;">
                    <div style="color:#999; font-size:0.8em;">${time} - ${log.user_email}</div>
                    <div><span style="font-weight:bold; color:#333">[${log.action_type}]</span> ${log.details}</div>
                </div>`;
        }).join('');
    }

    // 3. ä¿®æ”¹é‡‘å¸
async function updateUserGold() {
        if (!selectedUserId) return;
        const newGold = document.getElementById('adm-user-gold').value;
        showLoading();
        await supabaseClient.from('profiles').update({ gold_gp: newGold }).eq('id', selectedUserId);
        
        // è®°å½•æ—¥å¿—
        await logAction('DMæ“ä½œ', `ä¿®æ”¹äº†ç©å®¶(ID:${selectedUserId})çš„é‡‘å¸ä¸º ${newGold}`);
        
        hideLoading(); alert('é‡‘å¸å·²ä¿®æ”¹');
    }

    // 4. ä¸Šå¸å‘è£…å¤‡
    async function admAddInv() {
        if (!selectedUserId) return alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªç©å®¶');
        
        const itemName = document.getElementById('adm-new-item').value;
        const itemCat = document.getElementById('adm-new-item-cat').value; // è·å–é€‰ä¸­çš„åˆ†ç±»
        
        if (!itemName) return alert('è¯·è¾“å…¥ç‰©å“å');

        showLoading();
        try {
            // æ£€æŸ¥ç©å®¶èƒŒåŒ…æ˜¯å¦å·²æœ‰ (åŒåä¸”åŒç±»)
            const { data: exist } = await supabaseClient
                .from('user_inventory')
                .select('*')
                .eq('user_id', selectedUserId)
                .eq('item_name', itemName)
                .maybeSingle();

            if (exist) {
                // å·²æœ‰åˆ™æ•°é‡+1
                await supabaseClient.from('user_inventory').update({ quantity: exist.quantity + 1 }).eq('id', exist.id);
            } else {
                // æ²¡æœ‰åˆ™
                await supabaseClient.from('user_inventory').insert([{ 
                    user_id: selectedUserId, 
                    item_name: itemName, 
                    quantity: 1, 
                    category: itemCat 
                }]);
            }

            // è®°å½•æ—¥å¿—
            await logAction('DMæ“ä½œ', `ç»™ç©å®¶(ID:${selectedUserId}) å‘æ”¾äº† [${itemName}] (${itemCat})`);

            hideLoading();
            alert(`[${itemName}] å·²æˆåŠŸå¡å…¥èƒŒåŒ…`);
            document.getElementById('adm-new-item').value = ''; // æ¸…ç©ºè¾“å…¥æ¡†
            loadUserDetail(); // åˆ·æ–°è¯¦æƒ…
        } catch (e) {
            console.error(e);
            hideLoading();
            alert('å‘æ”¾å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ•°æ®åº“è¿æ¥');
        }
    }

    async function uploadAvatar() {
        const f = document.getElementById('adm-emp-avatar').files[0];
        const id = document.getElementById('adm-emp-list').value;
        showLoading();
        const { data } = await supabaseClient.storage.from('avatars').upload(`ava_${Date.now()}`, f);
        if(data) {
            const { data: u } = supabaseClient.storage.from('avatars').getPublicUrl(data.path);
            await supabaseClient.from('employees').update({avatar_url: u.publicUrl}).eq('id', id);
            alert('OK');
        }
        hideLoading();
    }
// --- çœŸæ­£çš„æ¨è¿›æ—¶é—´é€»è¾‘ ---
async function advanceTime() {
        if (!confirm(`ç¡®å®šæ¨è¿› [å½“å‰è§†è§’] çš„æ—¶é—´å—ï¼Ÿ\n(1å·å°†è‡ªåŠ¨æ‰£é™¤è¯¥ç©å®¶çš„è–ªèµ„)`)) return;

        showLoading();
        try {
            // 1. é€»è¾‘è®¡ç®—
            let { year, month, day } = currentDate;
            day++;
            if (day > 30) { day = 1; month++; }
            if (month > 12) { month = 1; year++; }
            
            const nextDate = { year, month, day };

            // 2. è‡ªåŠ¨æ‰£æ¬¾é€»è¾‘ (åªé’ˆå¯¹ viewingUserId)
            if (day === 1) {
                // ã€æ ¸å¿ƒä¿®æ”¹ã€‘è°ƒç”¨é€šç”¨ç®—è´¦å‡½æ•°
                const netIncome = await calculateCityNetIncome(viewingUserId);
                

                if (netIncome !== 0) {
                    const { data: prof } = await supabaseClient.from('profiles').select('gold_gp').eq('id', viewingUserId).single();
                    const newGold = prof.gold_gp + netIncome; 
                    
                    await supabaseClient.from('profiles').update({ gold_gp: newGold }).eq('id', viewingUserId);
                    
                    const logMsg = netIncome > 0 
                        ? `æ–°æœˆç»“ç®—ï¼šåŸå¸‚ç›ˆåˆ©ï¼Œå›½åº“å¢åŠ  ${netIncome} GP` 
                        : `æ–°æœˆç»“ç®—ï¼šåŸå¸‚èµ¤å­—ï¼Œå›½åº“æ‰£é™¤ ${Math.abs(netIncome)} GP`;
                        
                    await logAction('ç³»ç»Ÿç»“ç®—', logMsg);
                    alert(logMsg);
                }
            }

            // 3. æ›´æ–°æ•°æ®åº“ (åªæ›´æ–° viewingUserId çš„æ—¶é—´)
            await supabaseClient
                .from('profiles')
                .update({ world_date: nextDate })
                .eq('id', viewingUserId);

            // 4. åˆ·æ–°
            await logAction('æ—¶é—´æ¨è¿›', `æ—¶é—´å˜æ›´ä¸º FR${year}/${month}/${day} (User:${viewingUserId})`);
            
            // å±€éƒ¨åˆ·æ–°å³å¯ï¼Œä¸éœ€è¦ reload æ•´ä¸ªé¡µé¢
            await refreshAllData(); 
            
        } catch (e) {
            console.error(e);
            alert('æ“ä½œå¤±è´¥');
        } finally {
            hideLoading();
        }
    }

    // --- è®¡ç®—åŸå¸‚æœˆåº¦å‡€æ”¶æ”¯ ---
    async function calculateCityNetIncome(targetUserId) {
        // 1. è·å–æ‰€æœ‰æ•°æ®
        const [statsRes, expensesRes, incomeRes, empRes] = await Promise.all([
            supabaseClient.from('city_stats').select('*').eq('user_id', targetUserId).maybeSingle(),
            supabaseClient.from('city_expenses').select('*').eq('user_id', targetUserId),
            supabaseClient.from('city_incomes').select('*').eq('user_id', targetUserId),
            supabaseClient.from('employees').select('salary').eq('user_id', targetUserId).eq('status', 'åœ¨èŒ')
        ]);

        const stats = statsRes.data || { population: 0, subsidy: 0, tax_rate: 1.2 };
        const expenses = expensesRes.data || [];
        const incomes = incomeRes.data || [];
        const employees = empRes.data || [];

        // --- æ”¶å…¥è®¡ç®— ---
        const taxIncome = Math.ceil(stats.population * stats.tax_rate);
        
        // è´¸æ˜“æ”¶å…¥ (count * unit_price)
        const tradeIncome = incomes.reduce((sum, item) => {
            const count = item.count || 1;
            const price = item.unit_price || item.amount;
            return sum + (count * price);
        }, 0);
        
        const totalIncome = taxIncome + stats.subsidy + tradeIncome;

        // --- æ”¯å‡ºè®¡ç®— ---
        let totalExpense = 0;
        
        // å›ºå®šæ”¯å‡º (å« staff, building, trade_cost)
        if (expenses) {
            expenses.forEach(e => totalExpense += (e.count * e.unit_cost));
        }
        
        // ç‰¹æ®Šé›‡å‘˜æ”¯å‡º
        if (employees) {
            totalExpense += employees.reduce((sum, e) => sum + e.salary, 0);
        }

        const netIncome = totalIncome - totalExpense;
        console.log(`[è´¢åŠ¡æ ¸ç®—] User:${targetUserId} | æ”¶å…¥:${totalIncome} - æ”¯å‡º:${totalExpense} = å‡€åˆ©:${netIncome}`);
        
        return netIncome;
    }


    async function adminAddItem() {
        const name = document.getElementById('adm-shop-name').value;
        const rarity = document.getElementById('adm-shop-rarity').value;
        const category = document.getElementById('adm-shop-cat').value;
        const price = parseInt(document.getElementById('adm-shop-price').value);
        const stock = parseInt(document.getElementById('adm-shop-stock').value);
        const description = document.getElementById('adm-shop-desc').value;
        const targetType = document.getElementById('adm-shop-target').value;

        if (!name || isNaN(price)) return alert('åç§°å’Œä»·æ ¼å¿…å¡«');

        // ã€æ ¸å¿ƒä¿®å¤ã€‘åŒé‡ä¿é™©è·å–ç›®æ ‡ç©å®¶ID
        // å¦‚æœ selectedUserId ä¸ºç©ºï¼Œå°è¯•ç›´æ¥ä»ä¸‹æ‹‰æ¡†å†å–ä¸€æ¬¡
        let targetUserId = selectedUserId;
        if (!targetUserId) {
            targetUserId = document.getElementById('adm-user-list').value;
        }

        // å¦‚æœé€‰äº† private ä½†æ²¡ IDï¼ŒæŠ¥é”™
        if (targetType === 'private') {
            if (!targetUserId) return alert('è¯·å…ˆåœ¨ä¸Šæ–¹ [ç©å®¶èµ„äº§æ“æ§] åˆ—è¡¨é€‰æ‹©ä¸€ä¸ªç©å®¶ï¼');
        } else {
            targetUserId = null; // å…¬å…±å•†å“ user_id ä¸ºç©º
        }

        showLoading();
        try {
            const { error } = await supabaseClient.from('shop_items').insert([{
                name, rarity, category, price, stock, description,
                user_id: targetUserId // å†™å…¥å½’å±
            }]);

            if (error) throw error;

            await logAction('DMè¿›è´§', `ä¸Šæ¶äº† [${name}] (${targetType === 'private' ? 'ç‰¹ä¾›' : 'å…¬å¼€'})`);
            alert('ä¸Šæ¶æˆåŠŸ');
            
            // æ¸…ç©ºè¾“å…¥
            document.getElementById('adm-shop-name').value = '';
            document.getElementById('adm-shop-price').value = '';
            document.getElementById('adm-shop-desc').value = '';
            loadShop();
        } catch (e) {
            console.error(e);
            alert('å¤±è´¥ï¼š' + e.message);
        } finally {
            hideLoading();
        }
    }


async function loadLoginLogs() {
        const container = document.getElementById('login-log-container');
        container.innerHTML = 'åŠ è½½ä¸­...';

        const { data: logs } = await supabaseClient
            .from('login_logs')
            .select('*')
            .order('created_at', { ascending: false })
            .limit(50);

        if (!logs) return;

        container.innerHTML = logs.map(log => {
            const time = new Date(log.created_at).toLocaleString();
            const isFail = log.status.indexOf('å¤±è´¥') !== -1;
            const color = isFail ? '#e74c3c' : '#2ecc71';
            const bgColor = isFail ? '#fff0f0' : '#f0fff0';
            const uaParts = log.user_agent.split(' | ');
            const deviceId = uaParts[0]; 

            return `
                <div style="border-bottom:1px solid #eee; padding:8px; background:${bgColor}; margin-bottom:2px; border-radius:4px;">
                    <div style="display:flex; justify-content:space-between; font-size:0.8em;">
                        <span style="color:#666;">${time}</span>
                        <span style="font-weight:bold; color:${color}">${isFail ? 'æ‹’ç»è®¿é—®' : 'éªŒè¯é€šè¿‡'}</span>
                    </div>
                    <div style="font-weight:bold; margin:3px 0;">ç”¨æˆ·: ${log.email}</div>
                    <div style="font-size:0.8em; color:#444;">IP: ${log.ip_address}</div>
                    <div style="font-size:0.7em; color:#999; word-break:break-all;">è®¾å¤‡æŒ‡çº¹: ${deviceId}</div>
                    ${isFail ? `<div style="color:red; font-size:0.8em; font-weight:bold;">${log.status}</div>` : ''}
                </div>`;
        }).join('');
    }
    // --- åŠ è½½æ‰€æœ‰è´¦å· (æŸ¥ profiles è¡¨) ---
    async function loadAllAccounts() {
        const container = document.getElementById('account-list-container');
        container.innerHTML = 'æ­£åœ¨æ‹‰å–å…¨æœåå•...';

        // profiles è¡¨é‡Œæœ‰ id, email, assigned_dm_id 
        const { data: users, error } = await supabaseClient
            .from('profiles')
            .select('*')
            .order('email'); 
        
        if (error) {
            container.innerHTML = `<span style="color:red">åŠ è½½å¤±è´¥: ${error.message}</span>`;
            return;
        }

        // è·å–æƒé™è¡¨
        const { data: roles } = await supabaseClient.from('admin_users').select('*');
        
        const getRole = (id) => {
            const r = roles.find(x => x.id === id);
            return r ? r.role_level : 'player';
        };

        // æ¸²æŸ“åˆ—è¡¨
        container.innerHTML = users.map(u => {
            const role = getRole(u.id);
            const roleColor = role === 'root' ? 'red' : (role === 'dm' ? 'blue' : 'green');
            const isMe = u.id === myId;
            // å› ä¸º profiles è¡¨å¯èƒ½æ²¡æœ‰ created_atï¼Œæˆ‘ä»¬æš‚æ—¶ä¸æ˜¾ç¤ºæ³¨å†Œæ—¶é—´ï¼Œæˆ–è€…æ˜¾ç¤º "å·²æ¿€æ´»"
            const statusText = u.assigned_dm_id ? "å·²åˆ†é…DM" : "æœªåˆ†é…";

            return `
                <div style="border-bottom:1px solid #eee; padding:8px 4px; display:flex; justify-content:space-between; align-items:center;">
                    <div style="overflow:hidden; text-overflow:ellipsis;">
                        <div style="font-weight:bold;">${u.email}</div>
                        <div style="font-size:0.8em; color:#999;">${statusText}</div>
                    </div>
                    <div style="text-align:right;">
                        <span style="font-size:0.8em; color:${roleColor}; font-weight:bold; margin-right:5px;">${role.toUpperCase()}</span>
                        ${!isMe ? `
                        <select onchange="changeUserRole('${u.id}', this.value)" style="font-size:0.8em; padding:2px;">
                            <option value="">-- æ”¹æƒé™ --</option>
                            <option value="player">è®¾ä¸º Player</option>
                            <option value="dm">è®¾ä¸º DM</option>
                        </select>` : '<span style="font-size:0.8em; color:#ccc;">(è‡ªå·±)</span>'}
                    </div>
                </div>`;
        }).join('');
    }

    // --- ä¿®æ”¹ç”¨æˆ·æƒé™ ---
    async function changeUserRole(targetId, newRole) {
        if (!newRole) return;
        if (!confirm(`ç¡®å®šè¦å°†è¯¥ç”¨æˆ·çš„æƒé™ä¿®æ”¹ä¸º [${newRole.toUpperCase()}] å—ï¼Ÿ`)) return;

        showLoading();
        try {
            const { error } = await supabaseClient.rpc('update_user_role', { 
                target_id: targetId, 
                new_role: newRole 
            });

            if (error) throw error;

            await logAction('æƒé™ä¿®æ”¹', `å°†ç”¨æˆ·(ID:${targetId}) æƒé™è®¾ä¸º ${newRole}`);
            alert('ä¿®æ”¹æˆåŠŸ');
            loadAllAccounts(); // åˆ·æ–°åˆ—è¡¨
        } catch (e) {
            console.error(e);
            alert('ä¿®æ”¹å¤±è´¥: ' + e.message);
        } finally {
            hideLoading();
        }
    }
    // --- å›¾é‰´æœç´¢åŠŸèƒ½ ---
    async function searchCompendium() {
        const query = document.getElementById('compendium-search').value;
        const resultBox = document.getElementById('compendium-results');
        
        if (!query) return;
        resultBox.innerHTML = 'æŸ¥æ‰¾ä¸­...';

        // ä½¿ç”¨ ilike è¿›è¡Œæ¨¡ç³Šæœç´¢
        const { data } = await supabaseClient
            .from('compendium_items')
            .select('*')
            .ilike('name', `%${query}%`)
            .limit(10);

        if (!data || data.length === 0) {
            resultBox.innerHTML = '<div style="padding:5px; color:#999">æœªæ‰¾åˆ°ç›¸å…³ç‰©å“</div>';
            return;
        }

        resultBox.innerHTML = data.map(item => `
            <div onclick='fillShopForm(${JSON.stringify(item)})' 
                 style="padding:5px; border-bottom:1px solid #eee; cursor:pointer; font-size:0.9em; display:flex; justify-content:space-between;">
                <span>${item.name}</span>
                <span style="color:#666">${item.price} GP</span>
            </div>
        `).join('');
    }

    // é€‰ä¸­åè‡ªåŠ¨å¡«è¡¨
    function fillShopForm(item) {
        document.getElementById('adm-shop-name').value = item.name;
        document.getElementById('adm-shop-price').value = item.price;
        document.getElementById('adm-shop-desc').value = item.description || '';
        
        // å°è¯•è‡ªåŠ¨åŒ¹é…ä¸‹æ‹‰æ¡†
        setSelect('adm-shop-rarity', item.rarity);
        setSelect('adm-shop-cat', item.category);
        
        document.getElementById('compendium-results').innerHTML = ''; // æ¸…ç©ºç»“æœ
    }
    // --- ã€ä¿®å¤ç‰ˆã€‘åœ¨çº¿çŠ¶æ€ç³»ç»Ÿ (åˆå¹¶é€»è¾‘) ---//
    function initPresenceSystem() {
        // é˜²æ­¢é‡å¤è¿æ¥
        if (presenceChannel) {
            supabaseClient.removeChannel(presenceChannel);
        }

        // 1. åˆ›å»ºé¢‘é“
        presenceChannel = supabaseClient.channel('online-users', {
            config: {
                presence: {
                    key: currentUserEmail, // å”¯ä¸€æ ‡è¯†
                },
            },
        });

        // 2. ã€å…³é”®ã€‘å¦‚æœæ˜¯ Rootï¼Œå…ˆæŒ‚è½½ç›‘å¬å™¨ (å¿…é¡»åœ¨ subscribe ä¹‹å‰ï¼)
        if (currentUserRole === 'root') {
            presenceChannel
                .on('presence', { event: 'sync' }, () => {
                    const newState = presenceChannel.presenceState();
                    renderOnlineList(newState);
                })
                .on('presence', { event: 'join' }, ({ key, newPresences }) => {
                    const newState = presenceChannel.presenceState();
                    renderOnlineList(newState);
                })
                .on('presence', { event: 'leave' }, ({ key, leftPresences }) => {
                    const newState = presenceChannel.presenceState();
                    renderOnlineList(newState);
                });
        }

        // 3. å¼€å§‹è®¢é˜…
        presenceChannel.subscribe(async (status) => {
            if (status === 'SUBSCRIBED') {
                // 4. è®¢é˜…æˆåŠŸåï¼Œå¹¿æ’­è‡ªå·±çš„å­˜åœ¨
                const trackStatus = await presenceChannel.track({ 
                    email: currentUserEmail,
                    role: currentUserRole,
                    online_at: new Date().toISOString()
                });
                
                if (trackStatus !== 'ok') {
                    console.error("åœ¨çº¿çŠ¶æ€å¹¿æ’­å¤±è´¥");
                }
            }
        });
    }

    // --- æ¸²æŸ“åœ¨çº¿åˆ—è¡¨ ---
    function renderOnlineList(presences) {
        const container = document.getElementById('online-users-container');
        if (!container) return;

        // å°† Presence å¯¹è±¡è½¬æ¢ä¸ºæ•°ç»„
        const onlineUsers = [];
        for (const key in presences) {
            // æ¯ä¸ª key å¯èƒ½å¯¹åº”å¤šä¸ªè¿æ¥ï¼ˆå¤šè®¾å¤‡ç™»å½•ï¼‰ï¼Œæˆ‘ä»¬å–ç¬¬ä¸€ä¸ª
            const userState = presences[key][0]; 
            onlineUsers.push({
                email: key, // key å°±æ˜¯æˆ‘ä»¬è®¾ç½®çš„ email
                ...userState // å±•å¼€ role å’Œ online_at
            });
        }

        if (onlineUsers.length === 0) {
            container.innerHTML = '<div style="color:#999; text-align:center; padding:10px;">å½“å‰ä½é¢ç©ºæ— ä¸€äºº...</div>';
            return;
        }

        container.innerHTML = onlineUsers.map(user => {
            const roleColor = user.role === 'root' ? '#e74c3c' : (user.role === 'dm' ? '#3498db' : '#2ecc71');
            const roleName = user.role ? user.role.toUpperCase() : 'PLAYER';
            
            return `
            <div style="border-bottom:1px solid #eee; padding:8px 4px; display:flex; justify-content:space-between; align-items:center;">
                <div style="display:flex; align-items:center; gap:8px;">
                    <span style="display:inline-block; width:8px; height:8px; background-color:${roleColor}; border-radius:50%; box-shadow: 0 0 5px ${roleColor};"></span>
                    <span style="font-weight:bold; font-size:0.9em;">${user.email}</span>
                </div>
                <span style="font-size:0.75em; color:${roleColor}; font-weight:bold; border:1px solid ${roleColor}; padding:1px 4px; border-radius:4px;">${roleName}</span>
            </div>
            `;
        }).join('');
    }

    // è¾…åŠ©å‡½æ•°ï¼šè®¾ç½®ä¸‹æ‹‰æ¡†çš„å€¼
    function setSelect(id, value) {
        const select = document.getElementById(id);
        if(!value) return;
        for (let i = 0; i < select.options.length; i++) {
            if (select.options[i].value === value) {
                select.selectedIndex = i;
                break;
            }
        }
    }
    // --- éšæœºè¿›è´§åŠŸèƒ½ ---
    async function randomRestock() {
        // 1. ç¡®å®šè¿›è´§ç›®æ ‡
        // å¦‚æœ selectedUserId æœ‰å€¼ï¼Œè¯´æ˜ DM é€‰ä¸­äº†æŸä¸ªç©å®¶ï¼Œè¿›è´§ç»™ä»–
        // å¦‚æœæ²¡å€¼ (null)ï¼Œè¯´æ˜æ˜¯å…¬å…±è¿›è´§
        let targetId = selectedUserId || null;
        let targetName = targetId ? 'æŒ‡å®šç©å®¶ç‰¹ä¾›' : 'å…¨æœå…¬å…±';

        if (!confirm(`ç¡®å®šè¦æ‰§è¡Œ [æ ‡å‡†éšæœºåŒ…] è¿›è´§å—ï¼Ÿ\n\nç›®æ ‡: ${targetName}\nå†…å®¹: 2ä¼ è¯´ + 12æçç¨€ + 20çç¨€ + 30éæ™®é€š + 10æ™®é€š\n\n(æ³¨æ„ï¼šè¿™ä¼šç›´æ¥æ·»åŠ åˆ°é›†å¸‚ï¼Œä¸ä¼šè¦†ç›–å·²æœ‰å•†å“)`)) return;

        showLoading();
        try {
            // 2. è°ƒç”¨æ•°æ®åº“å‡½æ•°
            const { error } = await supabaseClient.rpc('admin_random_restock', { 
                target_user_id: targetId 
            });

            if (error) throw error;

            // 3. è®°å½•æ—¥å¿—
            await logAction('DMéšæœºè¿›è´§', `æ‰§è¡Œäº†æ ‡å‡†éšæœºåŒ…è¿›è´§ (ç›®æ ‡: ${targetName})`);

            alert('è¿›è´§å®Œæˆï¼å…±è®¡ä¸Šæ¶ 37 ä»¶ç‰©å“ã€‚');
            loadShop(); // åˆ·æ–°é›†å¸‚æ˜¾ç¤º
        } catch (e) {
            console.error(e);
            alert('è¿›è´§å¤±è´¥: ' + e.message);
        } finally {
            hideLoading();
        }
    }
    

    // è¾…åŠ©å‡½æ•°ï¼šæ¸²æŸ“åœ¨çº¿åˆ—è¡¨
    function renderOnlineList(presences) {
        const container = document.getElementById('online-users-container');
        if (!container) return;

        const onlineUsers = Object.keys(presences).map(key => {
            const user = presences[key][0]; // presenceState è¿”å›çš„æ˜¯ä¸€ä¸ªæ•°ç»„
            return {
                email: key,
                role: user.role,
                online_at: user.online_at
            };
        });

        if (onlineUsers.length === 0) {
            container.innerHTML = '<div style="color:#999; text-align:center;">å½“å‰ä½é¢ç©ºæ— ä¸€äºº...</div>';
            return;
        }

        container.innerHTML = onlineUsers.map(user => {
            const roleColor = user.role === 'root' ? 'red' : (user.role === 'dm' ? 'blue' : 'green');
            return `
            <div style="border-bottom:1px solid #eee; padding:8px 4px; display:flex; justify-content:space-between; align-items:center;">
                <div>
                    <div style="font-weight:bold; display:flex; align-items:center; gap:8px;">
                        <span style="display:inline-block; width:8px; height:8px; background-color:${roleColor}; border-radius:50%;"></span>
                        ${user.email}
                    </div>
                </div>
                <span style="font-size:0.8em; color:${roleColor}; font-weight:bold;">${user.role.toUpperCase()}</span>
            </div>
            `;
        }).join('');
    }

    // --- æ ¹æ®æ—¥æœŸå’Œç‰©å“åç”Ÿæˆå›ºå®šçš„éšæœºæŠ˜æ‰£ ---
    function getDailySellRatio(itemName) {
        // 1. è·å–æ¸¸æˆå†…æ—¥æœŸå­—ç¬¦ä¸² (å¦‚ "1494-2-12")
        const dateStr = `${currentDate.year}-${currentDate.month}-${currentDate.day}`;
        
        // 2. ç»„åˆç§å­ï¼šæ—¥æœŸ + ç©å®¶ID + ç‰©å“å
        // è¿™æ ·æ¯ä¸ªäººã€æ¯å¤©ã€æ¯ä»¶ç‰©å“çš„æŠ˜æ‰£éƒ½æ˜¯ç‹¬ç«‹çš„ï¼Œä¸”å…¨å¤©å›ºå®š
        const seedString = `${dateStr}-${viewingUserId}-${itemName}`;

        // 3. ç®€å•çš„å“ˆå¸Œç®—æ³• (å°†å­—ç¬¦ä¸²è½¬ä¸ºæ•°å­—)
        let hash = 0;
        for (let i = 0; i < seedString.length; i++) {
            const char = seedString.charCodeAt(i);
            hash = ((hash << 5) - hash) + char;
            hash = hash & hash; 
        }

        // 4. å½’ä¸€åŒ–åˆ° 0 ~ 1 ä¹‹é—´
        const random = Math.abs(hash) / 2147483647;

        // 5. æ˜ å°„åˆ° 0.6 ~ 0.9 ä¹‹é—´
        return 0.6 + (random * 0.3);
    }

    async function bulkAddWanted() {
        if (!selectedUserId) return alert('è¯·å…ˆé€‰æ‹©ç›®æ ‡ç©å®¶çš„ä½é¢');
        const text = document.getElementById('adm-wanted-bulk').value;
        if (!text) return;

        const lines = text.split('\n');
        const posters = lines.map(line => {
            const [name, amount, source] = line.split(',');
            return {
                user_id: selectedUserId,
                target_name: name.trim(),
                bounty_amount: parseInt(amount) || 0,
                source_org: source ? source.trim() : 'UNKNOWN',
                status_text: 'DEAD OR ALIVE'
            };
        });

        showLoading();
        const { error } = await supabaseClient.from('wanted_posters').insert(posters);
        if (error) alert(error.message);
        else {
            alert(`æˆåŠŸç­¾å‘ ${posters.length} ä»½æ‚¬èµä»¤ï¼`);
            document.getElementById('adm-wanted-bulk').value = '';
        }
        hideLoading();
    }

    async function addWantedPoster() {
        if (!selectedUserId) return alert('è¯·å…ˆé€‰æ‹©ç©å®¶');
        const name = document.getElementById('adm-wanted-name').value;
        const amount = document.getElementById('adm-wanted-amount').value;
        const status = document.getElementById('adm-wanted-status').value || 'DEAD OR ALIVE';
        const source = document.getElementById('adm-wanted-source').value;
        const avatar = document.getElementById('adm-wanted-avatar').value;

        if(!name || !amount) return alert('å§“åå’Œé‡‘é¢å¿…å¡«');

        showLoading();
        const { error } = await supabaseClient.from('wanted_posters').insert([{
            user_id: selectedUserId,
            target_name: name,
            bounty_amount: amount,
            status_text: status,
            source_org: source,
            avatar_url: avatar
        }]);

        if (error) alert(error.message);
        else {
            alert('æ‚¬èµä»¤å·²ç­¾å‘');
            // æ¸…ç©º
            document.getElementById('adm-wanted-name').value = '';
        }
        hideLoading();
    }

    function toggleShopMode() {
        isSellMode = !isSellMode;
        const btn = document.getElementById('shop-mode-btn');
        const input = document.getElementById('shop-search-input');
        
        if (isSellMode) {
            btn.innerText = "ğŸ”™ è¿”å›ï¼šæˆ‘è¦è´­ä¹°";
            btn.style.background = "#e67e22"; // æ©™è‰²è¡¨ç¤ºå‡ºå”®çŠ¶æ€
            input.placeholder = "ğŸ” æœç´¢èƒŒåŒ…é‡Œçš„ç‰©å“...";
        } else {
            btn.innerText = "ğŸ”„ åˆ‡æ¢ï¼šæˆ‘è¦å‡ºå”®";
            btn.style.background = "#333";
            input.placeholder = "ğŸ” æœç´¢é›†å¸‚å•†å“...";
        }
        refreshShopView(); // åˆ·æ–°æ˜¾ç¤º
    }

    // ç»Ÿä¸€çš„åˆ·æ–°å…¥å£
    function refreshShopView() {
        if (isSellMode) {
            loadSellShop();
        } else {
            loadShop();
        }
    }

    // --- åŠ è½½å‡ºå”®ç•Œé¢ ---
    async function loadSellShop() {
        const grid = document.getElementById('shop-grid');
        const searchTerm = document.getElementById('shop-search-input').value.toLowerCase();
        grid.innerHTML = 'æ­£åœ¨ä¼°ä»·ä¸­...';

        // 1. è·å–ç©å®¶èƒŒåŒ…
        const { data: inventory } = await supabaseClient
            .from('user_inventory')
            .select('*')
            .eq('user_id', viewingUserId);

        if (!inventory || inventory.length === 0) {
            grid.innerHTML = '<div style="color:#999; padding:20px;">èƒŒåŒ…é‡Œç©ºç©ºå¦‚ä¹Ÿï¼Œæ²¡ä¸œè¥¿å¯å–ã€‚</div>';
            return;
        }

        // 2. æå–ç‰©å“åå­—åˆ—è¡¨ï¼Œå» compendium_items (å›¾é‰´) æŸ¥åŸºç¡€ä»·æ ¼
        const itemNames = inventory.map(i => i.item_name);
        const { data: prices } = await supabaseClient
            .from('compendium_items')
            .select('name, price, rarity')
            .in('name', itemNames);

        // 3. æ„å»ºä»·æ ¼å­—å…¸ (åå­— -> ä»·æ ¼å¯¹è±¡)
        const priceMap = {};
        if (prices) {
            prices.forEach(p => priceMap[p.name] = p);
        }

        grid.innerHTML = '';

        // 4. æ¸²æŸ“å¡ç‰‡
        inventory.forEach(item => {
            // æœç´¢è¿‡æ»¤
            if (searchTerm && !item.item_name.toLowerCase().includes(searchTerm)) return;

            const baseInfo = priceMap[item.item_name];
            let sellHtml = '';
            let cardStyle = '';

            if (baseInfo && baseInfo.price) {
                // --- æœ‰å›¾é‰´æ•°æ®ï¼Œå¯ä»¥å– ---
                const ratio = getDailySellRatio(item.item_name); // è·å–ä»Šæ—¥æŠ˜æ‰£
                const sellPrice = Math.floor(baseInfo.price * ratio); // æœ€ç»ˆå›æ”¶ä»·
                const discount = Math.round(ratio * 100); // æ˜¾ç¤ºç™¾åˆ†æ¯”

                sellHtml = `
                    <div style="font-size:0.8em; color:#999;">åŸä»·: ${baseInfo.price} GP</div>
                    <div style="color:#e67e22; font-weight:bold; font-size:1.1em; margin:5px 0;">
                        å›æ”¶ä»·: ${sellPrice} GP <span style="font-size:0.7em; color:#666;">(${discount}%)</span>
                    </div>
                    <div style="font-size:0.75em; color:#aaa; margin-bottom:5px;">ä»Šæ—¥æ±‡ç‡å·²é”å®š</div>
                    <button class="btn-buy" onclick="sellItem(${item.id}, '${item.item_name}', ${sellPrice}, ${item.quantity})" style="border-color:#e67e22; color:#e67e22;">
                        å‡ºå”®
                    </button>
                `;
            } else {
                // --- æ— å›¾é‰´æ•°æ®ï¼Œä¸å¯å– ---
                cardStyle = 'opacity: 0.6; background:#f9f9f9;';
                sellHtml = `
                    <div style="color:#999; margin:10px 0; font-size:0.9em;">
                        æ— æ³•ä¼°ä»·<br>
                        <span style="font-size:0.8em">(å›¾é‰´ä¸­æœªæ”¶å½•æ­¤ç‰©å“)</span>
                    </div>
                    <button disabled style="width:100%; padding:8px; border:1px solid #ddd; background:#eee; color:#aaa; border-radius:4px; cursor:not-allowed;">
                        ä¸å¯å‡ºå”®
                    </button>
                `;
            }

            // æ¸²æŸ“
            grid.innerHTML += `
                <div class="card" style="text-align:center; ${cardStyle}">
                    <div style="font-weight:bold; font-size:1.1em;">${item.item_name}</div>
                    <div style="color:#666; font-size:0.9em;">åº“å­˜: ${item.quantity}</div>
                    <hr style="margin:10px 0; border:0; border-top:1px dashed #eee;">
                    ${sellHtml}
                </div>
            `;
        });
    }

    // --- æ‰§è¡Œå‡ºå”® ---
    async function sellItem(invId, itemName, unitPrice, maxQty) {
        const qtyStr = prompt(`å‡ºå”® [${itemName}] (å•ä»·: ${unitPrice} GP)\nå½“å‰æ‹¥æœ‰: ${maxQty}\n\nè¯·è¾“å…¥å‡ºå”®æ•°é‡:`, "1");
        if (qtyStr === null) return;
        const qty = parseInt(qtyStr);

        if (isNaN(qty) || qty <= 0) return alert("æ•°é‡æ— æ•ˆ");
        if (qty > maxQty) return alert("åº“å­˜ä¸è¶³");

        showLoading();
        try {
            // 1. å†æ¬¡ç¡®è®¤é‡‘å¸ (é˜²æ­¢ userProfile æ²¡åŠ è½½)
            if (!userProfile) await loadGold();

            const totalPrice = unitPrice * qty;

            // 2. æ‰£é™¤èƒŒåŒ…ç‰©å“
            if (qty === maxQty) {
                await supabaseClient.from('user_inventory').delete().eq('id', invId);
            } else {
                await supabaseClient.from('user_inventory').update({ quantity: maxQty - qty }).eq('id', invId);
            }

            // 3. å¢åŠ ç©å®¶é‡‘å¸
            const newGold = userProfile.gold_gp + totalPrice;
            await supabaseClient.from('profiles').update({ gold_gp: newGold }).eq('id', viewingUserId);

            // 4. è®°å½•æ—¥å¿—
            await logAction('å‡ºå”®ç‰©å“', `ä»¥ ${unitPrice} GP çš„å•ä»·å‡ºå”®äº† [${itemName}] x${qty}ï¼Œè·åˆ© ${totalPrice} GP`);

            alert(`å‡ºå”®æˆåŠŸï¼è·å¾— ${totalPrice} GP`);
            
            // åˆ·æ–°
            await loadGold(); // æ›´æ–°å³ä¸Šè§’é‡‘å¸
            loadSellShop();   // åˆ·æ–°åˆ—è¡¨çŠ¶æ€
        } catch (e) {
            console.error(e);
            alert("äº¤æ˜“å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•");
        } finally {
            hideLoading();
        }
    }


    
    checkUser();
</script>
</body>
</html>



