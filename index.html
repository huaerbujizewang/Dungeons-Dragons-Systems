<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Content-Security-Policy" content="
    default-src 'self' 'unsafe-inline' 'unsafe-eval' https:;
    script-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdn.jsdelivr.net https://challenges.cloudflare.com;
    connect-src 'self' https://vbzfpgucpciqgaakqndz.supabase.co wss://vbzfpgucpciqgaakqndz.supabase.co https://challenges.cloudflare.com https://www.cloudflare.com https://api.ipify.org https://myip.ipip.net;
    img-src 'self' data: https: blob:;
    style-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net;
">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>D&D å°é˜Ÿç®¡ç†ç³»ç»Ÿ</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>
    <style>
        :root { --border: #e0e0e0; --bg: #f8f9fa; --active: #333; }
        body { font-family: "PingFang SC", "Microsoft YaHei", sans-serif; background: #fff; color: #333; margin: 0; padding: 0; height: 100vh; }
    
        #login-section {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 100%;
            max-width: 360px;
            padding: 40px;
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            text-align: center;
            border: 1px solid #eee;
            z-index: 100;
        }
        #login-section h2 { margin-top: 0; color: #2c3e50; font-weight: 300; margin-bottom: 25px; letter-spacing: 1px; }
        #login-section input { width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; font-size: 14px; transition: 0.2s; }
        #login-section input:focus { border-color: #333; outline: none; }
        #login-section button { width: 100%; padding: 12px; background: #2c3e50; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 16px; font-weight: bold; transition: 0.2s; }
        #login-section button:hover { background: #34495e; transform: translateY(-1px); }

        /* --- ä¸»ç•Œé¢å¸ƒå±€ --- */
        .container { max-width: 1100px; margin: 0 auto; padding: 20px; }
        
        /* å¯¼èˆª */
        .nav { display: flex; gap: 15px; border-bottom: 2px solid #333; padding-bottom: 15px; margin-bottom: 30px; align-items: center; }
        .tab-btn { padding: 8px 16px; border: none; background: none; cursor: pointer; font-size: 1em; color: #7f8c8d; border-radius: 4px; font-weight: 500; transition: 0.2s; }
        .tab-btn.active { background: #333; color: #fff; }
        .tab-btn:hover:not(.active) { color: #333; background: #f0f0f0; }
        
        .info-bar { margin-left: auto; text-align: right; font-size: 0.9em; display: flex; flex-direction: column; align-items: flex-end; gap: 4px; }
        
        /* å†…å®¹åŒº */
        .section { display: none; animation: fadeIn 0.3s ease; }
        .section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        /* æ ‡é¢˜åˆ†å‰²çº¿ */
        .section-title { margin: 35px 0 20px 0; border-left: 5px solid #333; padding-left: 12px; font-weight: bold; font-size: 1.1em; color: #444; background: linear-gradient(90deg, #f9f9f9, #fff); padding-top: 8px; padding-bottom: 8px; }
        
        /* ç½‘æ ¼å¸ƒå±€ */
        .team-grid, .shop-grid, .inventory-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(230px, 1fr)); gap: 20px; }
        
        /* å¡ç‰‡é€šç”¨ */
        .card, .team-card, .inv-card { background: #fff; border: 1px solid var(--border); border-radius: 8px; padding: 15px; position: relative; transition: 0.2s; box-shadow: 0 2px 5px rgba(0,0,0,0.02); }
        .card:hover, .team-card:hover { box-shadow: 0 5px 15px rgba(0,0,0,0.08); border-color: #bbb; transform: translateY(-2px); }
        
        /* é˜Ÿä¼å¡ç‰‡ç‰¹æœ‰ */
        .team-header { display: flex; align-items: center; gap: 15px; margin-bottom: 15px; }
        .team-avatar { width: 60px; height: 60px; border-radius: 50%; object-fit: cover; background: #eee; border: 1px solid #ddd; }
        .team-info h3 { margin: 0; font-size: 1.1em; }
        .team-info p { margin: 4px 0 0; font-size: 0.8em; color: #666; }
        .btn-leave { position: absolute; top: 10px; right: 10px; font-size: 0.7em; color: #999; cursor: pointer; border: 1px solid #eee; padding: 2px 8px; border-radius: 4px; background: #fff; }
        .btn-leave:hover { background: #fee; color: #e74c3c; border-color: #e74c3c; }

        /* è£…å¤‡æ§½ */
        .slots-container { display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; }
        .slot { aspect-ratio: 1; border: 1px dashed #ccc; border-radius: 4px; display: flex; align-items: center; justify-content: center; font-size: 0.7em; text-align: center; cursor: pointer; background: #fafafa; padding: 2px; overflow: hidden; transition: 0.2s; color: #aaa; }
        .slot:hover { border-color: #333; background: #fff; color: #333; }
        .slot.filled { border: 1px solid #bbb; background: #fff; border-style: solid; color: #333; font-weight: 600; box-shadow: inset 0 0 5px rgba(0,0,0,0.05); }
        .slot-name { word-break: break-all; pointer-events: none; transform: scale(0.9); line-height: 1.1; }
        
        /* é›‡å‘˜ä¸­å¿ƒå¡ç‰‡ */
        .emp-card-content { text-align: center; }
        .emp-card-content img { width: 70px; height: 70px; border-radius: 50%; object-fit: cover; margin-bottom: 10px; border: 1px solid #eee; }
        
        /* å¼¹çª— & Loading */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 2000; align-items: center; justify-content: center; backdrop-filter: blur(2px); }
        .modal-box { background: #fff; padding: 25px; border-radius: 12px; width: 400px; max-height: 80vh; overflow-y: auto; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        .item-select-list div { padding: 12px; border-bottom: 1px solid #f0f0f0; cursor: pointer; display: flex; justify-content: space-between; transition: 0.1s; }
        .item-select-list div:hover { background: #f8f9fa; padding-left: 15px; }
        
        #loading-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.8); z-index: 5000; align-items: center; justify-content: center; flex-direction: column; }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #333; border-radius: 50%; width: 40px; height: 40px; animation: spin 0.8s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* æŒ‰é’®ä¸è¾“å…¥ */
        button { cursor: pointer; font-family: inherit; }
        input, select, textarea { font-family: inherit; border: 1px solid #ddd; border-radius: 4px; padding: 6px; }
        .btn-buy { width: 100%; margin-top: 10px; padding: 8px; background: #fff; border: 1px solid #333; color: #333; border-radius: 4px; transition: 0.2s; }
        .btn-buy:hover { background: #333; color: #fff; }
        .btn-buy:disabled { border-color: #eee; color: #ccc; background: #fafafa; cursor: not-allowed; }
        
        .danger-btn { color: #e74c3c; border-color: #e74c3c; margin-top: 8px; width: 100%; padding: 5px; background: none; border: 1px solid; border-radius: 4px; font-size: 0.85em; transition: 0.2s; }
        .danger-btn:hover { background: #e74c3c; color: white; }
        
        .add-member-card { border: 2px dashed #ddd; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #999; cursor: pointer; min-height: 200px; background: #fafafa; }
        .add-member-card:hover { border-color: #333; color: #333; background: #fff; }

        /* èƒŒåŒ…æ ·å¼ */
        .inventory-category { margin-bottom: 25px; }
        .inventory-category h3 { border-left: 4px solid #333; padding-left: 10px; margin-bottom: 15px; font-size: 1.1em; background: #f9f9f9; padding: 8px 10px; border-radius: 0 4px 4px 0; }
        .inventory-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 12px; }
        .inv-card { background: #fff; border: 1px solid #eee; padding: 12px; border-radius: 6px; display: flex; justify-content: space-between; align-items: center; font-size: 0.95em; }

        /* DM ç®¡ç†é¢æ¿ */
        #admin-panel { display: none; position: fixed; top: 5%; left: 5%; width: 90%; height: 90%; background: #fff; border: 2px solid #333; z-index: 3000; padding: 25px; overflow-y: auto; border-radius: 8px; box-shadow: 0 20px 50px rgba(0,0,0,0.3); box-sizing: border-box; }
        .admin-box { margin-bottom: 0; } 

        /* --- D&D å±æ€§é¢æ¿æ ·å¼ (Stat Block) --- */
        .stat-block-container {
            padding: 20px;
            font-family: 'Georgia', 'Times New Roman', serif;
            color: #58180d;
        }
        .stat-header h2 { margin: 0; font-size: 1.8em; color: #822000; font-variant: small-caps; }
        .stat-header i { font-style: italic; font-size: 0.9em; color: #333; }
        .tapered-rule {
            display: block; height: 2px; border: none; margin: 10px 0;
            background: #822000;
            background: linear-gradient(to right, transparent, #822000, transparent);
        }
        .red-rule { display: block; height: 2px; background: #822000; margin: 8px 0; border: none; }
        .stat-grid { display: grid; grid-template-columns: repeat(6, 1fr); gap: 5px; text-align: center; margin: 15px 0; color: #822000;}
        .stat-box { display: flex; flex-direction: column; align-items: center; }
        .stat-box strong { font-size: 0.9em; text-transform: uppercase; }
        .stat-box span { font-size: 1.1em; }
        .property-line { margin: 4px 0; color: #822000; }
        .property-line strong { color: #58180d; }
        .trait-section { margin-top: 15px; }
        .trait-name { font-weight: bold; font-style: italic; color: #333; }
        .action-header { 
            font-size: 1.4em; border-bottom: 1px solid #822000; 
            color: #822000; margin-top: 20px; margin-bottom: 5px; font-variant: small-caps;
        }

/* --- Arknights é£æ ¼å¯»è®¿ç•Œé¢ --- */
    .ak-gacha-panel {
        position: relative;
        height: 500px;
        background: #1a1a1a;
        overflow: hidden;
        font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
        color: #fff;
        border: 1px solid #333;
        box-shadow: 0 10px 30px rgba(0,0,0,0.5);
    }
    
    /* èƒŒæ™¯è£…é¥°ï¼šæ–œæ¡çº¹ */
    .ak-bg-pattern {
        position: absolute; top:0; left:0; width:120%; height:100%;
        background: repeating-linear-gradient(45deg, #222, #222 10px, #1a1a1a 10px, #1a1a1a 20px);
        opacity: 0.5; z-index: 0;
    }
    
    /* å·¦ä¾§ï¼šæ ‡é¢˜ä¸ä¿¡æ¯ */
    .ak-info-layer {
        position: absolute; top: 30px; left: 30px; z-index: 2;
        display: flex; flex-direction: column; gap: 5px;
    }
    .ak-banner-title {
        font-size: 2.5em; font-weight: 900; letter-spacing: -1px; line-height: 1;
        background: linear-gradient(to right, #fff, #999); 
        -webkit-background-clip: text; 
        background-clip: text;         
        
        color: transparent;
        text-transform: uppercase; font-style: italic;
    }
    .ak-banner-subtitle {
        font-size: 1.2em; font-weight: bold; color: #f1c40f; 
        background: #000; display: inline-block; padding: 2px 8px; transform: skewX(-15deg);
    }
    
    /* ä¸­é—´ï¼šç«‹ç»˜å±•ç¤ºåŒº */
    .ak-char-stand {
        position: absolute; right: -50px; bottom: 0; height: 110%; 
        width: 60%; object-fit: cover; z-index: 1;
        mask-image: linear-gradient(to left, rgba(0,0,0,1) 50%, transparent 100%);
        -webkit-mask-image: linear-gradient(to left, rgba(0,0,0,1) 50%, transparent 100%);
        transition: transform 0.3s;
    }
    .ak-char-stand:hover { transform: scale(1.02); }

    /* å³ä¸Šè§’ï¼šèµ„æº */
    .ak-resources {
        position: absolute; top: 20px; right: 20px; z-index: 3;
        display: flex; gap: 15px; align-items: center;
    }
    .ak-res-box {
        background: rgba(0,0,0,0.6); padding: 5px 15px; border-radius: 20px;
        border: 1px solid #444; font-size: 0.9em; display: flex; align-items: center; gap: 5px;
    }

    /* åº•éƒ¨ï¼šæ§åˆ¶æ  */
    .ak-bottom-bar {
        position: absolute; bottom: 0; left: 0; width: 100%; height: 90px;
        background: linear-gradient(to top, rgba(0,0,0,0.9), transparent);
        z-index: 5; display: flex; align-items: center; justify-content: space-between;
        padding: 0 40px; box-sizing: border-box;
    }

    /* æŠ½å¡å¤§æŒ‰é’® */
    .ak-pull-btn {
        width: 220px; height: 60px;
        background: #f1c40f; color: #000;
        border: none; transform: skewX(-15deg);
        font-weight: 900; font-size: 1.4em; letter-spacing: 1px;
        cursor: pointer; position: relative; overflow: hidden;
        display: flex; align-items: center; justify-content: center;
        box-shadow: 0 0 15px rgba(241, 196, 15, 0.3);
        transition: 0.2s;
    }
    .ak-pull-btn:hover { background: #fff; box-shadow: 0 0 25px rgba(255,255,255,0.5); }
    .ak-pull-btn:active { transform: skewX(-15deg) scale(0.95); }
    .ak-pull-btn span { transform: skewX(15deg); } /* æ–‡å­—åæ–œå›æ¥ */

    /* è¯¦æƒ…ä¸å•†åº—æŒ‰é’® */
    .ak-sub-btn {
        background: transparent; color: #fff; border: 1px solid #fff;
        padding: 8px 15px; cursor: pointer; font-size: 0.9em;
        transition: 0.2s; text-transform: uppercase;
    }
    .ak-sub-btn:hover { background: #fff; color: #000; }

    /* æŠ½å¡ç»“æœå¼¹çª— (å…¨å±é®ç½©) */
    .ak-result-overlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.95); z-index: 9000;
        display: none; align-items: center; justify-content: center; flex-direction: column;
        animation: fadeIn 0.3s;
    }
    .ak-light-beam {
        width: 10px; height: 0; background: #fff;
        box-shadow: 0 0 50px 20px #fff;
        animation: beamExpand 0.5s forwards;
    }
    @keyframes beamExpand { to { height: 100vh; width: 100%; opacity: 0; } }
    /* --- åè¿æŠ½æŒ‰é’® (çº¢è‰²) --- */
    .ak-pull-btn.ten {
        background: #e74c3c; color: #fff;
    }
    .ak-pull-btn.ten:hover {
        background: #fff; color: #e74c3c;
        box-shadow: 0 0 25px rgba(231, 76, 60, 0.5);
    }

    /* --- åè¿ç»“æœç½‘æ ¼å¸ƒå±€ --- */
    .ak-ten-grid {
        display: grid;
        grid-template-columns: repeat(5, 1fr); /* 5åˆ— */
        gap: 15px;
        width: 100%;
        max-width: 900px;
        margin-top: 20px;
        transform: scale(0.9); /* ç¨å¾®ç¼©å°ä¸€ç‚¹ä»¥å…çˆ†å± */
    }

    /* åè¿é‡Œçš„å°å¡ç‰‡ */
    .ak-mini-card {
        background: #fff;
        border: 2px solid #444;
        border-radius: 4px;
        overflow: hidden;
        position: relative;
        text-align: center;
        transition: transform 0.2s;
        box-shadow: 0 4px 10px rgba(0,0,0,0.5);
    }
    .ak-mini-card:hover { transform: scale(1.1) z-index(10); border-color: #fff; }
    
    .ak-mini-card img {
        width: 100%;
        height: 160px;
        object-fit: contain;
        background: #333;
    }
    .ak-mini-bar {
        padding: 5px;
        font-size: 0.8em;
        font-weight: bold;
        color: #fff;
        text-shadow: 0 1px 2px rgba(0,0,0,0.8);
    }


@keyframes bagShake {
    0% { transform: rotate(0deg); }
    25% { transform: rotate(5deg); }
    75% { transform: rotate(-5deg); }
    100% { transform: rotate(0deg); }
}

/* æŠ½å¡ç»“æœ */
.gacha-result {
    display: none; animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}
@keyframes popIn { from { transform: scale(0.5); opacity: 0; } to { transform: scale(1); opacity: 1; } }

/* æ˜Ÿçº§é¢œè‰² */
.rarity-6 { background: linear-gradient(45deg, #ff4e50, #f9d423); box-shadow: 0 0 20px #ff4e50; } /* çº¢/é‡‘ */
.rarity-5 { background: linear-gradient(45deg, #f1c40f, #fff); box-shadow: 0 0 15px #f1c40f; } /* é»„ */
.rarity-4 { background: linear-gradient(45deg, #9b59b6, #fff); } /* ç´« */
.rarity-3 { background: #3498db; } /* è“ */

/* è½¬ç›˜æ ·å¼ */
.wheel-container {
    position: relative; width: 300px; height: 300px; margin: 30px auto;
    border-radius: 50%; border: 10px solid #333; overflow: hidden;
    background: #fff;
}
.wheel-sector {
    position: absolute; width: 50%; height: 50%; top: 0; right: 0;
    transform-origin: 0% 100%; border: 1px solid #eee; box-sizing: border-box;
}
.wheel-pointer {
    position: absolute; top: -20px; left: 50%; transform: translateX(-50%);
    width: 0; height: 0; border-left: 15px solid transparent;
    border-right: 15px solid transparent; border-top: 30px solid red; z-index: 10;
}
.wheel-btn {
    margin-top: 20px; padding: 15px 40px; font-size: 1.2em; font-weight: bold;
    background: #e67e22; color: white; border: none; border-radius: 50px;
    box-shadow: 0 5px 15px rgba(230, 126, 34, 0.4); transition: 0.2s;
}
.wheel-btn:disabled { background: #95a5a6; cursor: not-allowed; }

/* å†å²è®°å½•å°å­— */
.pity-counter { font-size: 0.8em; color: #999; margin-top: 10px; }

/* --- æ˜Ÿçº§è¾¹æ¡†é¢œè‰² --- */
    /* 6æ˜Ÿï¼šçº¢é‡‘æµå…‰ */
    .rarity-border-6 { border-top: 5px solid #e74c3c; border-image: linear-gradient(to right, #f1c40f, #e74c3c, #f1c40f) 1; box-shadow: 0 -2px 10px rgba(231, 76, 60, 0.2); }
    /* 5æ˜Ÿï¼šçº¯é‡‘ */
    .rarity-border-5 { border-top: 5px solid #f1c40f; }
    /* 4æ˜Ÿï¼šç´« */
    .rarity-border-4 { border-top: 5px solid #9b59b6; }
    /* 3æ˜Ÿï¼šè“ */
    .rarity-border-3 { border-top: 5px solid #3498db; }
    /* 2æ˜Ÿï¼šç»¿ */
    .rarity-border-2 { border-top: 5px solid #2ecc71; }
    /* 1æ˜Ÿï¼šç° */
    .rarity-border-1 { border-top: 5px solid #95a5a6; }

    /* --- Arknights é£æ ¼ï¼šå¹²å‘˜æ¡£æ¡ˆ (Dossier) --- */
    #dossier-modal .modal-box {
        width: 900px; max-width: 95%; height: 600px;
        background: #1a1a1a; color: #ecf0f1;
        padding: 0; overflow: hidden; display: flex;
        border: 1px solid #444; box-shadow: 0 20px 50px rgba(0,0,0,0.5);
    }

    /* å·¦ä¾§ç«‹ç»˜åŒº */
    .dossier-left {
        width: 350px; position: relative; background: #111;
        overflow: hidden; flex-shrink: 0;
        border-right: 1px solid #333;
    }
    .dossier-stand-img {
        width: 100%; height: 100%; object-fit: cover;
        mask-image: linear-gradient(to bottom, black 80%, transparent 100%);
        -webkit-mask-image: linear-gradient(to bottom, black 80%, transparent 100%);
        transition: transform 0.3s;
    }
    .dossier-stand-img:hover { transform: scale(1.02); }
    .dossier-bg-blur {
        position: absolute; top:0; left:0; width:100%; height:100%;
        background-size: cover; background-position: center;
        filter: blur(20px) brightness(0.4); z-index: 0;
    }
    .dossier-watermark {
        position: absolute; bottom: -20px; left: -20px;
        font-size: 8em; font-weight: 900; color: rgba(255,255,255,0.03);
        z-index: 1; pointer-events: none; white-space: nowrap;
        font-family: Impact, sans-serif;
    }

    /* å³ä¾§ä¿¡æ¯åŒº */
    .dossier-right {
        flex: 1; display: flex; flex-direction: column;
        background: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0IiBoZWlnaHQ9IjQiPgo8cmVjdCB3aWR0aD0iNCIgaGVpZ2h0PSI0IiBmaWxsPSIjMWExYTFhIi8+CjxwYXRoIGQ9Ik0wIDBoNHYxSDB6IiBmaWxsPSIjMjIyIi8+Cjwvc3ZnPg==');
    }

    /* å¤´éƒ¨ */
    .dossier-header {
        padding: 20px 30px; border-bottom: 2px solid #f1c40f;
        background: linear-gradient(to right, rgba(241, 196, 15, 0.1), transparent);
        display: flex; justify-content: space-between; align-items: flex-end;
    }
    .dossier-name { font-size: 2.5em; font-weight: 900; line-height: 1; color: #fff; text-transform: uppercase; letter-spacing: 1px; }
    .dossier-meta { color: #f1c40f; font-weight: bold; font-size: 0.9em; background: #000; padding: 2px 8px; display: inline-block; transform: skewX(-15deg); margin-top: 5px; }
    .dossier-meta span { display: block; transform: skewX(15deg); }

    /* æ ‡ç­¾é¡µå¯¼èˆª */
    .dossier-tabs {
        display: flex; background: #000; padding-left: 20px; border-bottom: 1px solid #333;
    }
    .dossier-tab-btn {
        padding: 12px 25px; background: transparent; color: #666;
        border: none; cursor: pointer; font-weight: bold; font-size: 0.9em;
        transition: 0.2s; border-bottom: 3px solid transparent;
    }
    .dossier-tab-btn:hover { color: #fff; background: #222; }
    .dossier-tab-btn.active { color: #f1c40f; border-bottom-color: #f1c40f; background: #1a1a1a; }

    /* å†…å®¹æ»šåŠ¨åŒº */
    .dossier-content {
        flex: 1; overflow-y: auto; padding: 25px 30px; position: relative;
    }
    .dossier-pane { display: none; animation: fadeIn 0.3s; }
    .dossier-pane.active { display: block; }

    /* --- æ¨¡å—ï¼šåŸºç¡€æ¡£æ¡ˆ --- */
    .info-grid {
        display: grid; grid-template-columns: 1fr 1fr; gap: 20px;
    }
    .info-item {
        border-bottom: 1px solid #333; padding-bottom: 5px;
    }
    .info-label { font-size: 0.8em; color: #7f8c8d; display: block; margin-bottom: 2px; }
    .info-val { font-size: 1.1em; color: #fff; font-weight: 500; }
    .tag-box {
        display: inline-block; background: #333; color: #ccc; 
        font-size: 0.75em; padding: 2px 6px; border-radius: 2px; margin-right: 5px;
    }

    /* --- æ¨¡å—ï¼šæˆ˜æ–—å±æ€§ --- */
    .combat-top-bar {
        display: flex; gap: 15px; margin-bottom: 25px;
    }
    .combat-stat-box {
        flex: 1; background: #222; border-left: 4px solid #555;
        padding: 8px 12px; 
        display: flex; flex-direction: column; justify-content: space-between;
        min-height: 80px; 
        position: relative;
    }
    .combat-stat-box.hp { border-color: #e74c3c; background: linear-gradient(to bottom, #2c2c2c, #222); }
    .combat-stat-box.ac { border-color: #3498db; background: linear-gradient(to bottom, #2c2c2c, #222); }
    .combat-stat-box.spd .stat-val-top {
        font-size: 1.8em; 
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        align-self: flex-start;
        width: 100%;
    }

    /* å¤‡æ³¨åŒº  */
    .combat-stat-box.spd .stat-note-top {
        color: #f1c40f; 
        font-size: 0.8em;
        opacity: 0.9;
        text-align: right;
        width: 100%;
        line-height: 1.2;
        white-space: pre-wrap; 
    }
    
    .stat-label-top { 
        font-size: 0.7em; color: #aaa; text-transform: uppercase; letter-spacing: 1px; 
        align-self: flex-start;
    }
    
    .stat-val-top { 
        font-size: 2.2em; font-weight: 900; color: #fff; 
        font-family: 'Arial Black', sans-serif;
        line-height: 1.1; margin-top: 2px;
    }
    
    /* æ ¸å¿ƒä¿®æ”¹ï¼šå…¬å¼æ˜¾ç¤ºåœ¨å³ä¸‹è§’ï¼Œä¸é®æŒ¡å¤§æ•°å­— */
    .stat-note-top { 
        font-size: 0.75em; color: #666; 
        align-self: flex-end; /* é å³å¯¹é½ */
        font-family: 'Consolas', monospace; /* ç­‰å®½å­—ä½“æ›´æœ‰æ•°æ®æ„Ÿ */
        margin-top: auto; /* æ¨åˆ°åº•éƒ¨ */
        text-align: right;
        max-width: 100%;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    /* å…­ç»´æ–¹å— */
    .ability-grid {
        display: grid; grid-template-columns: repeat(6, 1fr); gap: 5px; margin-bottom: 25px;
    }
    .ability-box {
        background: #2c3e50; color: #fff; text-align: center; padding: 8px 0;
        border-radius: 2px; position: relative;
    }
    .ability-title { font-size: 0.7em; color: #95a5a6; display: block; margin-bottom: 2px; }
    .ability-score { font-size: 0.9em; color: #bdc3c7; }
    .ability-mod { font-size: 1.4em; font-weight: bold; color: #fff; display: block; margin-top: -2px; }

    /* åˆ—è¡¨å±æ€§ */
    .props-list {
        font-size: 0.9em; color: #ccc; margin-bottom: 20px;
        background: rgba(0,0,0,0.3); padding: 10px; border-radius: 4px;
    }
    .props-row { margin-bottom: 5px; display: flex; }
    .props-key { color: #f39c12; width: 50px; flex-shrink: 0; font-weight: bold; }
    .props-val { color: #ecf0f1; }

    /* ç‰¹æ€§/åŠ¨ä½œå¡ç‰‡ */
    .trait-card {
        margin-bottom: 12px; background: #252525; padding: 10px 15px;
        border-left: 3px solid #666;
    }
    .trait-card.action { border-left-color: #e74c3c; } /* åŠ¨ä½œæ˜¯çº¢è‰² */
    .trait-card.bonus { border-left-color: #e67e22; } /* é™„èµ æ˜¯æ©™è‰² */
    .trait-card.reaction { border-left-color: #9b59b6; }/* ååº”æ˜¯ç´«è‰² */
    .trait-title { font-weight: bold; color: #fff; margin-bottom: 4px; font-size: 1.05em; }
    .trait-desc { font-size: 0.9em; color: #aaa; line-height: 1.6; }
    .trait-desc b { color: #ddd; } /* å°æ ‡é¢˜åŠ äº® */

    /* æ–½æ³•åˆ—è¡¨ */
    .spell-group { margin-bottom: 10px; font-size: 0.9em; }
    .spell-level { color: #3498db; font-weight: bold; display: inline-block; width: 120px; }
    .spell-items { color: #ccc; }

    /* --- æ¨¡å—ï¼šå®¢è§‚å±¥å† --- */
    .resume-text {
        font-family: 'Courier New', Courier, monospace;
        line-height: 1.8; color: #ccc; font-size: 0.95em;
        white-space: pre-wrap; /* ä¿ç•™æ¢è¡Œ */
    }

    /* --- æ–°å¢ï¼šæˆ˜æ–—æ¿å—çš„åˆ†éš”æ ‡é¢˜ --- */
    .combat-section-title {
        font-size: 0.85em;
        font-weight: bold;
        color: #7f8c8d; /* é»˜è®¤ç°è‰² */
        margin: 20px 0 8px 0; /* ä¸Šä¸‹ç•™ç™½ */
        padding-left: 10px;
        border-left: 4px solid #555; /* å·¦ä¾§è‰²å— */
        text-transform: uppercase;
        letter-spacing: 1px;
        display: flex; align-items: center;
        background: linear-gradient(to right, rgba(255,255,255,0.05), transparent);
    }

    /* ä¸åŒç±»å‹çš„æ ‡é¢˜è‰² */
    .combat-section-title.action { border-left-color: #e74c3c; color: #e74c3c; } /* çº¢ */
    .combat-section-title.bonus { border-left-color: #e67e22; color: #e67e22; }  /* æ©™ */
    .combat-section-title.reaction { border-left-color: #9b59b6; color: #9b59b6; } /* ç´« */
    .combat-section-title.legendary { border-left-color: #f1c40f; color: #f1c40f; } /* é‡‘ */
        
    </style>
</head>
<body>

<!-- Loading é®ç½© -->
<div id="loading-overlay">
    <div class="spinner"></div>
    <div style="margin-top:15px; color:#555; font-weight:bold;">æ­£åœ¨åŒæ­¥ä½é¢æ•°æ®...</div>
</div>

<!-- ç™»å½•ç•Œé¢ (ç‹¬ç«‹å±…ä¸­) -->
<div id="login-section">
    <h2>å†’é™©è€…å·¥ä¼šç»ˆç«¯</h2>
    <input type="email" id="login-email" placeholder="é‚®ç®±åœ°å€">
    <input type="password" id="login-password" placeholder="é€šè¡Œå¯†ç ">
    
    <div class="cf-turnstile" data-sitekey="0x4AAAAAACXd68RuHuvi3cAG" data-theme="light" style="margin-bottom: 15px; display: flex; justify-content: center;"></div>
    
    <button onclick="login()">è¿æ¥èŠ‚ç‚¹</button>
</div>

<!-- ä¸»ç•Œé¢ -->
<div id="main-section" class="container" style="display:none;">
    <div class="nav">
        <button class="tab-btn active" onclick="switchTab('shop')">å•†åŸ</button>
    <button class="tab-btn" onclick="switchTab('team')">é˜Ÿä¼</button>
    <button class="tab-btn" onclick="switchTab('inventory')">èƒŒåŒ…</button>
    <button class="tab-btn" onclick="switchTab('employees')">é›‡å‘˜ä¸­å¿ƒ</button>
    <button class="tab-btn" onclick="switchTab('gacha')">æŠ½å¡</button>
    <button class="tab-btn" onclick="switchTab('others')">å…¶ä»–å†…å®¹</button>
    <button id="security-tab-btn" class="tab-btn" onclick="switchTab('security')" style="display:none; color:#e74c3c; border:1px solid #ff000033;">ğŸ›¡ï¸ å®‰å…¨ä¸æƒé™</button>
    <span id="admin-link" style="display:none; color:#3498db; cursor:pointer; font-weight:bold; margin-left: 10px;" onclick="toggleAdmin()">âš™ï¸ DM æ§åˆ¶å°</span>
        
        <div class="info-bar">
            <div id="date-text" style="font-weight:bold; background:#f1c40f; color:#333; padding:4px 10px; border-radius:4px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">æ—¥æœŸåŠ è½½ä¸­...</div>
            <div style="color:#d35400; font-weight:bold; margin-top:4px;">ğŸ’° <span id="gold-amount">0</span> GP</div>
            <a href="#" onclick="logout()" style="color:#999; font-size:0.8em; text-decoration: underline;">é€€å‡ºç™»å½•</a>
        </div>
    </div>

    <!-- é›†å¸‚ -->
     <div id="shop-section" class="section active">
        <div style="margin-bottom:20px; display:flex; gap:10px; align-items:center; background:#f8f9fa; padding:10px; border-radius:8px;">
            <button id="shop-mode-btn" onclick="toggleShopMode()" style="padding:10px 20px; background:#333; color:#fff; border:none; border-radius:4px; white-space:nowrap;">ğŸ”„ åˆ‡æ¢ï¼šæˆ‘è¦å‡ºå”®</button>
            <input type="text" id="shop-search-input" placeholder="ğŸ” æœç´¢..." oninput="refreshShopView()" style="width:100%; padding:10px; font-size:1em; border:1px solid #ccc; border-radius:6px;">
        </div>
        <div id="shop-grid" class="shop-grid"></div>
    </div>

    <!-- é˜Ÿä¼é¢æ¿ -->
    <div id="team-section" class="section">
        <div id="team-container"></div>
    </div>

    <!-- èƒŒåŒ… -->
    <div id="inventory-section" class="section">
        <div id="inventory-container"></div>
    </div>
    
    <!-- é›‡å‘˜ä¸­å¿ƒ -->
    <div id="employees-section" class="section">
        <div id="emp-container"></div>
    </div>

    <!-- å…¶ä»–å†…å®¹æ¿å— -->
    <div id="others-section" class="section">
        <div class="section-title">ğŸŒ ä¸–ç•Œè§‚ä¸è®°å½•</div>
        <div class="shop-grid"> <!-- å¤ç”¨é›†å¸‚ç½‘æ ¼æ ·å¼ -->
        
        <!-- å¡ç‰‡ 1ï¼šæ—¶é—´çº¿ -->
        <div class="card emp-card-content" onclick="window.location.href='timeline.html?uid=' + viewingUserId" style="cursor:pointer;">
            <div style="font-size: 2.5em; margin-bottom:10px;">â³</div>
            <div style="font-weight:bold; font-size:1.1em;">ç¼–å¹´å² / æ—¶é—´çº¿</div>
            <p style="font-size:0.8em; color:#666;">è®°å½•è´¹ä¼¦å¤§é™†åŠå›¢é˜Ÿå¤§äº‹ä»¶</p>
        </div>

        <!-- å¡ç‰‡ 2ï¼šå›½å®¶ä¸ç»„ç»‡ -->
        <div class="card emp-card-content" onclick="window.location.href='world.html?uid=' + viewingUserId" style="cursor:pointer;">
            <div style="font-size: 2.5em; margin-bottom:10px;">ğŸ°</div>
            <div style="font-weight:bold; font-size:1.1em;">åœ°ç† / ç»„ç»‡</div>
            <p style="font-size:0.8em; color:#666;">å›½å®¶èƒŒæ™¯ã€åŠ¿åŠ›èŒƒå›´ä¸å…³ç³»å›¾</p>
        </div>

        <!-- å¡ç‰‡ 3ï¼šä¼ è®°ä¸é—´ç«  -->
        <div class="card emp-card-content" onclick="window.location.href='lore.html?uid=' + viewingUserId" style="cursor:pointer;">
            <div style="font-size: 2.5em; margin-bottom:10px;">ğŸ“œ</div>
            <div style="font-weight:bold; font-size:1.1em;">äººç‰©å¿— / é—´ç« </div>
            <p style="font-size:0.8em; color:#666;">NPC å¯¹è¯ã€èƒŒæ™¯æ•…äº‹ä¸äº¤æµè®°å½•</p>
        </div>

        <!-- å¡ç‰‡ 4ï¼šé¢†åœ°ç®¡ç† -->
        <div class="card emp-card-content" onclick="window.location.href='territory.html?uid=' + viewingUserId" style="cursor:pointer; ;">
            <div style="font-size: 2.5em; margin-bottom:10px;">ğŸ‘‘</div>
            <div style="font-weight:bold; font-size:1.1em;">é¢†åœ°æ²»ç†</div>
            <p style="font-size:0.8em; color:#666;">ç¨æ”¶ã€æ”¿ç­–ä¸åŸå¸‚æ¦‚å†µ</p>
        </div>

        <!-- å¡ç‰‡ 5ï¼šæ”¿åŠ¡å… -->
        <div class="card emp-card-content" onclick="window.location.href='proposals.html?uid=' + viewingUserId" style="cursor:pointer; ">
            <div style="font-size: 2.5em; margin-bottom:10px;">ğŸ’¼</div>
            <div style="font-weight:bold; font-size:1.1em;">æ”¿åŠ¡å…</div>
            <p style="font-size:0.8em; color:#666;">å®¡æ‰¹æ ¸å¿ƒæˆå‘˜ææ¡ˆ</p>
        </div>

        <!-- å¡ç‰‡ 6ï¼šæ‚¬èµåå• -->
        <div class="card emp-card-content" onclick="window.location.href='bounties.html?uid=' + viewingUserId" style="cursor:pointer; ">
            <div style="font-size: 2.5em; margin-bottom:10px;">ğŸ’€</div>
            <div style="font-weight:bold; font-size:1.1em;">èµé‡‘åå½•</div>
            <p style="font-size:0.8em; color:#666;">ä½é¢é€šç¼‰åå•</p>
        </div>

        <!-- å¡ç‰‡ 7ï¼šé€€è´§ä¸­å¿ƒ -->
        <div class="card emp-card-content" onclick="window.location.href='refunds.html?uid=' + viewingUserId" style="cursor:pointer; ">
            <div style="font-size: 2.5em; margin-bottom:10px;">ğŸ˜­</div>
            <div style="font-weight:bold; font-size:1.1em;">é€€è´§ä¸­å¿ƒ</div>
            <p style="font-size:0.8em; color:#666;">30åˆ†é’Ÿå†…è¯¯è´­æ’¤å›</p>
        </div>

        <!-- å¡ç‰‡ 8ï¼šçœ‹æŠ¥çº¸ -->
        <div class="card emp-card-content" onclick="window.location.href='newspapers.html?uid=' + viewingUserId" style="cursor:pointer;">
            <div style="font-size: 2.5em; margin-bottom:10px;">ğŸ“°</div>
            <div style="font-weight:bold; font-size:1.1em;">é˜…æŠ¥å®¤</div>
            <p style="font-size:0.8em; color:#666;">ä¸åŒæ´¾ç³» ç‹¬å®¶å¤´æ¡</p>
        </div>

        <!-- å¯ä»¥æ ¹æ®éœ€è¦ç»§ç»­æ·»åŠ å¡ç‰‡ -->
        </div>
    </div>

    <!-- æŠ½å¡æœºåˆ¶ -->

    <div id="gacha-section" class="section">
    <div style="display:flex; justify-content:center; gap:20px; margin-bottom:20px;">
        <button onclick="showGachaMode('operator')" class="tab-btn active" id="btn-mode-op">å¹²å‘˜å¯»è®¿</button>
        <button onclick="showGachaMode('weapon')" class="tab-btn" id="btn-mode-wp">æ­¦å™¨å¯»è®¿</button>
        <button onclick="loadGachaHistory()" class="tab-btn" style="color:#3498db;">ğŸ“œ å†å²è®°å½•</button>
    </div>

    <div id="gacha-operator-panel" class="ak-gacha-panel">
        <div class="ak-bg-pattern"></div>
        
        <div class="ak-info-layer">
            <div class="ak-banner-title">OPERATOR<br>RECRUITMENT</div>
            <div class="ak-banner-subtitle">å¹²å‘˜å¯»è®¿ / æ ‡å‡†æ± </div>
            <div style="margin-top:20px; font-size:0.8em; color:#aaa; max-width: 200px;">
                <div style="margin-bottom:5px;">â˜…6 æ¦‚ç‡: 0.8%</div>
                <div style="margin-bottom:5px;">â˜…5 æ¦‚ç‡: 3.2%</div>
                <div>é‡å¤è·å–å°†è‡ªåŠ¨è½¬åŒ–ä¸ºå‡­è¯</div>
            </div>
            <div style="margin-top:20px; font-size:0.8em; color:#ccc;">
                 å½“å‰å«åˆ€: <span id="pity-count-display" style="color:#f1c40f; font-weight:bold;">--</span> / 80
            </div>
        </div>

        <img id="gacha-stand-img" src="https://via.placeholder.com/400x600?text=UP+Operator" class="ak-char-stand">

        <div class="ak-resources">
            <div class="ak-res-box">
                <span style="color:#f1c40f;">ğŸ«</span>
                <span id="cert-count-display">0</span>
            </div>
            <div class="ak-res-box">
                <span style="color:#f1c40f;">ğŸ’°</span>
                <span id="gacha-gold-display">0</span>
            </div>
        </div>

        <div class="ak-bottom-bar">
                <div style="display:flex; gap:10px;">
                    <button class="ak-sub-btn" onclick="openGachaRates()">æ¦‚ç‡è¯¦æƒ…</button>
                    <button class="ak-sub-btn" onclick="openCertShop()">å‡­è¯å•†åº—</button>
                </div>
                
                <div style="display:flex; gap:15px; align-items:center;">
                    <div style="text-align:right; font-size:0.8em; color:#bbb; line-height:1.2;">
                        <span style="color:#f1c40f; font-weight:bold; font-size:1.1em;">600</span> GP<br>å¯»è®¿ä¸€æ¬¡
                    </div>
                    <button class="ak-pull-btn" onclick="pullOperator()">
                        <span>å¯»è®¿ä¸€æ¬¡</span>
                    </button>
                    
                    <div style="width:1px; height:40px; background:#555; margin:0 5px;"></div>

                    <div style="text-align:right; font-size:0.8em; color:#bbb; line-height:1.2;">
                        <span style="color:#f1c40f; font-weight:bold; font-size:1.1em;">6000</span> GP<br>å¯»è®¿åæ¬¡
                    </div>
                    <button class="ak-pull-btn ten" onclick="pullOperatorTen()">
                        <span>å¯»è®¿åæ¬¡</span>
                    </button>
                </div>
            </div>
    </div>

    <div id="gacha-result-overlay" class="ak-result-overlay" onclick="closeGachaResult()">
        <div id="gacha-beam" class="ak-light-beam"></div>
        
        <div id="gacha-card-container" style="text-align:center; transform: scale(0); transition: transform 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);">
            <div id="res-stars" style="color:#f1c40f; font-size:2em; letter-spacing:5px; margin-bottom:10px; text-shadow:0 0 10px orange;">â˜…â˜…â˜…â˜…â˜…â˜…</div>
            
            <img id="res-img" src="" style="height:400px; border: 4px solid #fff; box-shadow: 0 0 50px rgba(255,255,255,0.2);">
            
            <div style="background:#000; color:#fff; display:inline-block; padding:5px 30px; font-size:2em; font-weight:bold; transform:skewX(-15deg); margin-top:-20px; position:relative; border:2px solid #fff;">
                <span id="res-name" style="display:block; transform:skewX(15deg);">NAME</span>
            </div>

            <div id="res-type-tag" style="margin-top:20px; font-size:1.2em; color:#fff; font-weight:bold;"></div>
        </div>
        <div id="gacha-ten-container" style="display:none; flex-direction:column; align-items:center;">
            <h2 style="color:#fff; letter-spacing:5px; margin-bottom:10px; text-shadow:0 0 10px #f1c40f;">å¯»è®¿ç»“æœ</h2>
            <div id="gacha-ten-grid" class="ak-ten-grid"></div>
            <div style="margin-top:30px; color:#aaa; font-size:0.8em;">ç‚¹å‡»ä»»æ„å¤„å…³é—­</div>
        </div>
        
    </div>

    <div id="gacha-weapon-panel" class="gacha-container" style="display:none; background:linear-gradient(135deg, #2c3e50 0%, #000 100%);">
        <h2 style="margin:0; color:#e74c3c;">æ­¦å™¨å¯»è®¿</h2>
        
        <div id="wheel-setup" style="margin:20px 0;">
            <input type="text" id="wheel-search" placeholder="æœç´¢å›¾é‰´ä¸­çš„ç‰©å“..." style="padding:8px; width:200px;">
            <button onclick="searchWheelTarget()" style="padding:8px;">æ­¦å™¨å¯»è®¿</button>
            <div id="wheel-target-display" style="margin-top:10px; font-weight:bold; color:#f1c40f;">å½“å‰æ— ç›®æ ‡</div>
        </div>

        <div id="wheel-stage" style="display:none; text-align:center;">
            <div style="position:relative; width:300px; height:300px; margin:0 auto;">
                <canvas id="wheel-canvas" width="300" height="300"></canvas>
                <div style="position:absolute; top:-10px; left:140px; width:0; height:0; border-left:10px solid transparent; border-right:10px solid transparent; border-top:20px solid #e74c3c; z-index:5; filter: drop-shadow(0 2px 2px rgba(0,0,0,0.5));"></div>
            </div>
            
            <div style="margin:20px 0;">
                <div style="font-size:0.9em; color:#aaa;">å½“å‰é˜¶æ®µ: <span id="wheel-step">1</span> / 8</div>
                <div style="font-size:1.2em; font-weight:bold; margin-top:5px;">
                    æœ¬æ¬¡æ¶ˆè€—: <span id="wheel-cost" style="color:#f1c40f;">0</span> GP
                </div>
            </div>

            <button id="btn-spin" class="wheel-btn" onclick="spinWheel()">å¯åŠ¨è½¬ç›˜</button>
        </div>
    </div>

    <div id="gacha-history-panel" class="gacha-container" style="display:none; background:#fff; color:#333; text-align:left;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; border-bottom:2px solid #eee; padding-bottom:10px;">
            <h3 style="margin:0;">ğŸ“œ è¿‘æœŸå‡ºè´§è®°å½•</h3>
            <button onclick="showGachaMode('operator')" style="font-size:0.8em;">è¿”å›</button>
        </div>
        <div id="history-list" style="max-height:400px; overflow-y:auto; font-size:0.9em;">åŠ è½½ä¸­...</div>
    </div>
</div>

     <!-- ï¼šå®‰å…¨ä¸æƒé™ Section (Root ä¸“ç”¨) -->
    <div id="security-section" class="section">
        <div style="display:grid; grid-template-columns: 350px 1fr; gap:20px;">
            <!-- å·¦ä¾§ï¼šè´¦å·ç®¡ç† -->
            <div style="display:flex; flex-direction:column; gap:20px;">
                <div class="admin-box" style="border:1px solid #3498db; padding:15px; border-radius:8px; background:#f0f9ff;">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                        <h3 style="margin:0; color:#2980b9;">ğŸ”‘ è´¦å·æƒé™ç®¡ç†</h3>
                        <button onclick="loadAllAccounts()" style="font-size:0.8em;">åˆ·æ–°</button>
                    </div>
                    <div id="account-list-container" style="max-height:600px; overflow-y:auto; background:#fff; padding:10px; border-radius:4px; font-size:0.9em;"></div>
                </div>
            </div>
            <!-- åœ¨çº¿çŠ¶æ€ç›‘æ§ -->
            <div class="admin-box" style="border:1px solid #2ecc71; padding:15px; border-radius:8px; background:#f0fff4;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                    <h3 style="margin:0; color:#27ae60;">ğŸ“¡ åœ¨çº¿çŠ¶æ€ç›‘æ§</h3>
                </div>
                <div id="online-users-container" style="max-height:600px; overflow-y:auto; background:#fff; padding:10px; border-radius:4px; font-size:0.9em;">
                    æ­£åœ¨è¿æ¥...
                </div>
            </div>
            
            <!-- å³ä¾§ï¼šåŒæ—¥å¿— -->
            <div style="display:flex; flex-direction:column; gap:20px;">
                <div class="admin-box" style="border:1px solid #ddd; padding:15px; border-radius:8px; background:#f9f9f9; flex:1;">
                    <h3 style="margin-top:0;">ğŸ“œ å…¨æœæ“ä½œå®¡è®¡</h3>
                    <div id="audit-log-container" style="height:300px; overflow-y:auto; background:#fff; padding:10px; border:1px solid #eee;"></div>
                </div>
                <div class="admin-box" style="border:1px solid #e74c3c; padding:15px; border-radius:8px; background:#fff0f0; flex:1;">
                    <h3 style="margin-top:0; color:#c0392b;">ğŸš¨ ç™»å½•ç›‘æ§æ—¥å¿—</h3>
                    <div id="login-log-container" style="height:300px; overflow-y:auto; background:#fff; padding:10px; border:1px solid #eee;"></div>
                </div>
            </div>
        </div>
    </div>


</div>

<!-- å¼¹çª—ï¼šè£…å¤‡é€‰æ‹© -->
<div id="equip-modal" class="modal">
    <div class="modal-box">
        <h3>é€‰æ‹©è¦è£…å¤‡çš„ç‰©å“</h3>
        <div id="equip-list" class="item-select-list"></div>
        <button onclick="closeModal('equip-modal')" style="width:100%; margin-top:15px; padding:10px; background:#f5f5f5; border:1px solid #ddd; border-radius:4px;">å–æ¶ˆ</button>
    </div>
</div>

<!-- å¼¹çª—ï¼šæˆå‘˜é€‰æ‹© -->
<div id="member-modal" class="modal">
    <div class="modal-box">
        <h3>é€‰æ‹©åŠ å…¥é˜Ÿä¼çš„æˆå‘˜</h3>
        <p style="font-size:0.8em;color:#999; margin-bottom:10px;">ä»…æ˜¾ç¤ºåœ¨èŒä¸”æœªå…¥é˜Ÿçš„äººå‘˜</p>
        <div id="member-select-list" class="item-select-list"></div>
        <button onclick="closeModal('member-modal')" style="width:100%; margin-top:15px; padding:10px; background:#f5f5f5; border:1px solid #ddd; border-radius:4px;">å–æ¶ˆ</button>
    </div>
</div>

<div id="sheet-modal" class="modal">
    <div class="modal-box" style="width: 600px; max-width: 95%; height: 80vh; padding: 0; background: transparent; box-shadow: none; display: flex; flex-direction: column; overflow: hidden;">
        
        <div id="sheet-content" style="flex: 1; overflow-y: auto; background: #fdf1dc; border-radius: 8px 8px 0 0; border: 1px solid #dcdcdc; border-bottom: none;">
            </div>

        <button onclick="closeModal('sheet-modal')" style="flex-shrink: 0; width:100%; background:#333; color:#fff; border:none; padding:15px; font-weight:bold; border-radius: 0 0 8px 8px; cursor:pointer; font-size: 1.1em;">
            å…³é—­é¢æ¿
        </button>
    </div>
</div>

<div id="dossier-modal" class="modal">
    <div class="modal-box">
        <div class="dossier-left">
            <div id="dossier-bg-blur" class="dossier-bg-blur"></div>
            <img id="dossier-stand-img" src="" class="dossier-stand-img">
            <div id="dossier-watermark" class="dossier-watermark">ARCHIVE</div>
        </div>

        <div class="dossier-right">
            <div class="dossier-header">
                <div>
                    <div id="dossier-name" class="dossier-name">NAME</div>
                    <div class="dossier-meta"><span id="dossier-meta">RACE / CLASS</span></div>
                </div>
                <div id="dossier-stars" style="color:#f1c40f; font-size:1.2em; letter-spacing:2px;">â˜…â˜…â˜…â˜…â˜…â˜…</div>
            </div>

            <div class="dossier-tabs">
                <button class="dossier-tab-btn active" onclick="switchDossierTab('basic')">åŸºç¡€æ¡£æ¡ˆ</button>
                <button class="dossier-tab-btn" onclick="switchDossierTab('combat')">æˆ˜æ–—å±æ€§</button>
                <button class="dossier-tab-btn" onclick="switchDossierTab('resume')">å®¢è§‚å±¥å†</button>
                <button class="dossier-tab-btn" onclick="closeModal('dossier-modal')" style="margin-left:auto; color:#666;">âœ• å…³é—­</button>
            </div>

            <div class="dossier-content">
                
                <div id="dossier-pane-basic" class="dossier-pane active">
                    <div class="info-grid">
                        <div class="info-item">
                            <span class="info-label">ã€å§“åã€‘</span>
                            <span id="info-name" class="info-val">--</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">ã€ç§æ—ã€‘</span>
                            <span id="info-race" class="info-val">--</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">ã€ä½“å‹ã€‘</span>
                            <span id="info-size" class="info-val">--</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">ã€æ€§åˆ«ã€‘</span>
                            <span id="info-gender" class="info-val">--</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">ã€å‡ºèº«ã€‘</span>
                            <span id="info-origin" class="info-val">--</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">ã€èº«é«˜ã€‘</span>
                            <span id="info-height" class="info-val">--</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">ã€ç”Ÿæ—¥ã€‘</span>
                            <span id="info-birthday" class="info-val">--</span>
                        </div>
                        <div class="info-item" style="grid-column: 1 / -1;">
                            <span class="info-label">ã€æ ‡ç­¾ã€‘</span>
                            <div id="info-tags" style="margin-top:5px;"></div>
                        </div>
                    </div>
                </div>

                <div id="dossier-pane-combat" class="dossier-pane">
                    <div class="combat-top-bar">
                        <div class="combat-stat-box hp">
                            <span class="stat-label-top">MAX HP</span>
                            <div id="combat-hp" class="stat-val-top">0</div>
                            <div id="combat-hp-note" class="stat-note-top"></div>
                        </div>
                        <div class="combat-stat-box ac">
                            <span class="stat-label-top">ARMOR</span>
                            <div id="combat-ac" class="stat-val-top">10</div>
                            <div id="combat-ac-note" class="stat-note-top"></div>
                        </div>
                        <div class="combat-stat-box spd">
                            <span class="stat-label-top">SPEED</span>
                            <div id="combat-speed" class="stat-val-top">30</div>
                            <div id="combat-speed-note" class="stat-note-top"></div>
                        </div>
                    </div>

                    <div id="combat-stats-grid" class="ability-grid"></div>

                    <div id="combat-props" class="props-list"></div>

                    <div id="combat-abilities-list"></div>
                </div>

                <div id="dossier-pane-resume" class="dossier-pane">
                    <div id="resume-content" class="resume-text"></div>
                </div>

            </div>
        </div>
    </div>
</div>

<!-- DM ä¸Šå¸æ§åˆ¶å° -->
<div id="admin-panel">
    <div style="display:flex; justify-content:space-between; margin-bottom:20px; border-bottom:1px solid #eee; padding-bottom:15px;">
        <h2 style="margin:0;">DM æ§åˆ¶å° <span id="role-badge" style="font-size:0.5em; background:#333; color:white; padding:2px 8px; border-radius:12px; font-weight:normal;"></span></h2>
        <button onclick="toggleAdmin()" style="background:#e74c3c; color:white; border:none; padding:8px 20px; border-radius:6px; font-weight:bold;">å…³é—­</button>
    </div>
    
    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:25px; overflow-y:auto;">
        
        <!-- å·¦ä¾§åˆ— -->
        <div style="display:flex; flex-direction:column; gap:20px;">

            <!-- äº‹åŠ¡å®¡æ‰¹ä¸­å¿ƒ -->
            <div id="approval-box" class="admin-box" style="border:1px solid #e67e22; padding:15px; border-radius:8px; background:#fffcf0; display:none;">
                <h3 style="margin-top:0; color:#d35400;">âš–ï¸ å¾…åŠå®¡æ‰¹</h3>
                <div id="approval-list" style="font-size:0.9em;">
                    æ­£åœ¨åŠ è½½è¯·æ±‚...
                </div>
            </div>

            <!-- æ—¶é—´æ§åˆ¶ -->
            <div class="admin-box" style="border:1px solid #ddd; padding:15px; border-radius:8px;">
                <h3 style="margin-top:0">â³ æ—¶é—´çº¿æ“æ§</h3>
                <div style="display:flex; gap:5px; margin-bottom:10px;">
                    <input type="number" id="time-year" style="width:70px"> å¹´ 
                    <input type="number" id="time-month" style="width:50px"> æœˆ 
                    <input type="number" id="time-day" style="width:50px"> æ—¥
                </div>
                <button onclick="updateTimeManual()" style="width:100%; padding:10px; background:#34495e; color:white; border:none;">åŒæ­¥æ—¶ç©º</button>
            </div>

            <!-- é›†å¸‚è¿›è´§ -->
            <div class="admin-box" style="border:1px solid #ddd; padding:15px; border-radius:8px;">
                <h3 style="margin-top:0">ğŸ¬ ç‰©èµ„ä¸Šæ¶</h3>
            <!-- æŸ¥åº“åŒºåŸŸ -->
                <div style="background:#f0f8ff; padding:10px; border-radius:4px; margin-bottom:15px; border:1px dashed #3498db;">
                    <div style="display:flex; gap:5px;">
                        <input type="text" id="compendium-search" placeholder="ğŸ” æœç´¢å›¾é‰´åº“..." style="flex:1; padding:6px;">
                        <button onclick="searchCompendium()" style="padding:6px 12px;">æŸ¥æ‰¾</button>
                    </div>
                    <div id="compendium-results" style="max-height:100px; overflow-y:auto; margin-top:5px; background:#fff; border:1px solid #eee;"></div>
                </div>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:8px;">
                    <input type="text" id="adm-shop-name" placeholder="å•†å“åç§°" style="grid-column: 1/3;">
                    <select id="adm-shop-rarity"><option>æ™®é€š</option><option>éæ™®é€š</option><option>çç¨€</option><option>æçç¨€</option><option>ä¼ è¯´</option><option>ç¥å™¨</option></select>
                    <select id="adm-shop-cat"><option>é­”æ³•ç‰©å“</option><option>è£…å¤‡</option><option>å·è½´</option><option>è¯æ°´</option><option>ææ–™</option></select>
                    <input type="number" id="adm-shop-price" placeholder="ä»·æ ¼">
                    <input type="number" id="adm-shop-stock" placeholder="åº“å­˜">
                    <select id="adm-shop-target" style="grid-column: 1/3;"><option value="public">ğŸŒ å…¨æœå…¬å…±</option><option value="private">ğŸ‘¤ ä»…å½“å‰é€‰ä¸­çš„ç©å®¶</option></select>
                    <textarea id="adm-shop-desc" placeholder="æè¿°..." style="grid-column: 1/3; height:50px;"></textarea>
                </div>
                <button onclick="adminAddItem()" style="width:100%; margin-top:10px; background:#2ecc71; color:white; border:none; padding:10px;">ç¡®è®¤ä¸Šæ¶</button>
                <!-- éšæœºè¿›è´§æŒ‰é’® -->
                <button onclick="randomRestock()" style="width:100%; margin-top:10px; background:#8e44ad; color:white; border:none; padding:10px; border-radius:4px; font-weight:bold;">ğŸ² éšæœºè¿›è´§ (æ ‡å‡†åŒ…)</button>
                <div style="font-size:0.8em; color:#666; text-align:center; margin-top:5px;">åŒ…å«: 2ä¼ è¯´, 12æçç¨€, 20çç¨€, 30éæ™®é€š, 10æ™®é€š</div>
            </div>
        </div>

        <!-- å³ä¾§åˆ— -->
        <div style="display:flex; flex-direction:column; gap:20px;">
            <!-- ç©å®¶èµ„äº§æ§åˆ¶ -->
            <div class="admin-box" style="border:1px solid #333; padding:15px; border-radius:8px; background:#fafafa;">
                <h3 style="margin-top:0">ğŸ‘¤ ç©å®¶èµ„äº§æ“æ§ (è§†è§’åˆ‡æ¢)</h3>
                <select id="adm-user-list" onchange="loadUserDetail()" style="width:100%; padding:10px; margin-bottom:10px; border:2px solid #333;"></select>
                
                <div id="user-detail" style="display:none;">
                    <div style="margin-bottom:10px;">
                        ğŸ’° é‡‘å¸: <input type="number" id="adm-user-gold" style="width:80px"> <button onclick="updateUserGold()">ä¿®æ”¹</button>
                    </div>
                    <!-- Root ä¸“ç”¨ï¼šåˆ†é…è´Ÿè´£ DM -->
                    <div id="root-assign-dm" style="display:none; margin-bottom:10px; padding:10px; border:1px dashed #3498db;">
                        ğŸ”— æŒ‡æ´¾è´Ÿè´£ DM: <select id="adm-assign-dm-list"></select> <button onclick="assignDM()">ä¿å­˜</button>
                    </div>
                    <div style="margin-bottom:10px;">
                        ğŸ å‘æ”¾: <input type="text" id="adm-new-item" style="width:100px"> 
                        <select id="adm-new-item-cat"><option>é­”æ³•ç‰©å“</option><option>è£…å¤‡</option><option>å·è½´</option><option>è¯æ°´</option></select>
                        <button onclick="admAddInv()">å‘æ”¾</button>
                    </div>
                    <div style="font-size:0.8em; color:#666;">èƒŒåŒ…é¢„è§ˆ:</div>
                    <div id="adm-user-inv" style="max-height:150px; overflow-y:auto; background:#fff; padding:5px; border:1px solid #ddd; margin-top:5px;"></div>
                </div>
            </div>

            <div class="admin-box" style="border:1px solid #f1c40f; padding:15px; border-radius:8px; background:#fffff0;">
                <h3 style="margin-top:0; color:#f39c12;">ğŸŒŸ é›‡å‘˜æ˜Ÿçº§è°ƒæ•´</h3>
                <div style="font-size:0.8em; color:#666; margin-bottom:5px;">å…ˆåœ¨ä¸Šæ–¹[ç©å®¶èµ„äº§]é€‰æ‹©ç©å®¶ï¼Œå†é€‰é›‡å‘˜</div>
                <div style="display:flex; gap:5px;">
                    <select id="adm-rarity-emp-list" style="flex:1;"></select>
                    <select id="adm-rarity-val" style="width:80px;">
                        <option value="6">6æ˜Ÿ</option>
                        <option value="5">5æ˜Ÿ</option>
                        <option value="4">4æ˜Ÿ</option>
                        <option value="3">3æ˜Ÿ</option>
                        <option value="2">2æ˜Ÿ</option>
                        <option value="1">1æ˜Ÿ</option>
                    </select>
                </div>
                <button onclick="updateEmpRarity()" style="width:100%; margin-top:5px; background:#f1c40f; border:none; color:#fff; padding:5px; font-weight:bold;">æ›´æ–°æ˜Ÿçº§</button>
            </div>

            <div class="admin-box" style="border:1px solid #9b59b6; padding:15px; border-radius:8px; background:#faf0ff;">
                <h3 style="margin-top:0; color:#8e44ad;">ğŸ² å¡æ± å¤´åƒä¸Šä¼ </h3>
                <div style="margin-bottom:5px;">
                    <input type="text" id="adm-pool-search" placeholder="è¾“å…¥å¡æ± è§’è‰²å..." onblur="searchPoolChar()" style="width:100%;">
                    <input type="hidden" id="adm-pool-id">
                </div>
                <div id="adm-pool-preview" style="font-size:0.8em; color:#666; margin-bottom:5px;">ç­‰å¾…æœç´¢...</div>
                <div style="display:flex; gap:5px;">
                    <input type="file" id="adm-pool-file">
                    <button onclick="uploadPoolAvatar()">ä¸Šä¼ </button>
                </div>
            </div>

            <!-- é›‡å‘˜å¤´åƒ -->
            <div class="admin-box" style="border:1px solid #9b59b6; padding:15px; border-radius:8px; background:#fbf0ff;">
                <h3 style="margin-top:0; color:#8e44ad;">ğŸ¨ é›‡å‘˜å›¾ç‰‡ç®¡ç†</h3>
                <div style="font-size:0.8em; color:#666; margin-bottom:10px;">
                    å…ˆåœ¨ä¸Šæ–¹ [ç©å®¶èµ„äº§æ“æ§] é€‰æ‹©ç©å®¶ï¼Œå†åœ¨æ­¤å¤„é€‰æ‹©é›‡å‘˜
                </div>
                
                <select id="adm-emp-list" style="width:100%; margin-bottom:15px; padding:8px; border:2px solid #8e44ad; border-radius:4px; font-weight:bold;"></select>
                
                <div style="margin-bottom:15px; border-bottom:1px dashed #cca; padding-bottom:10px;">
                    <div style="font-size:0.85em; font-weight:bold; margin-bottom:5px; display:flex; align-items:center;">
                        <span style="font-size:1.2em; margin-right:5px;">ğŸŸ¢</span> 
                        åˆ—è¡¨å¤´åƒ
                    </div>
                    <div style="display:flex; gap:5px;">
                        <input type="file" id="adm-emp-avatar" style="flex:1; font-size:0.8em;">
                        <button onclick="uploadAvatar()" style="padding:5px 10px;">æ›´æ–°å¤´åƒ</button>
                    </div>
                </div>

                <div>
                    <div style="font-size:0.85em; font-weight:bold; margin-bottom:5px; color:#8e44ad; display:flex; align-items:center;">
                        <span style="font-size:1.2em; margin-right:5px;">ğŸŸ£</span> 
                        æ¡£æ¡ˆç«‹ç»˜
                    </div>
                    <div style="display:flex; gap:5px;">
                        <input type="file" id="adm-emp-stand" style="flex:1; font-size:0.8em;">
                        <button onclick="uploadExistingStand()" style="background:#8e44ad; color:#fff; border:none; padding:5px 10px; border-radius:4px;">æ›´æ–°ç«‹ç»˜</button>
                    </div>
                </div>
            </div>

            <div class="admin-box" style="border:1px solid #1abc9c; padding:15px; border-radius:8px; background:#fafffd; margin-top:20px;">
    <h3 style="margin-top:0; color:#16a085;">ğŸ–¼ï¸ å¹²å‘˜å…¨å¹…ç«‹ç»˜ä¸Šä¼ </h3>
    <div style="font-size:0.8em; color:#666; margin-bottom:5px;">å»ºè®®æ¯”ä¾‹ 3:5 çš„çºµå‘ç«‹ç»˜ï¼ˆå…¨èº«åƒï¼‰</div>
    <div style="margin-bottom:10px;">
        <input type="text" id="adm-pool-stand-search" placeholder="è¾“å…¥å¡æ± è§’è‰²å..." onblur="searchPoolCharForStand()" style="width:100%;">
        <input type="hidden" id="adm-pool-stand-id">
        <div id="adm-pool-stand-preview" style="font-size:0.8em; color:#666; margin-top:5px;">ç­‰å¾…æœç´¢...</div>
    </div>
    <div style="display:flex; gap:10px;">
        <input type="file" id="adm-pool-stand-file" style="flex:1">
        <button onclick="uploadPoolStand()">ä¸Šä¼ ç«‹ç»˜</button>
    </div>
</div>

            <div class="admin-box" style="border:1px solid #822000; padding:15px; border-radius:8px; background:#fffcf0;">
                <h3 style="margin-top:0; color:#822000;">ğŸ“œ è§’è‰²å¡æ•°æ®å½•å…¥ (JSON)</h3>
                <select id="adm-sheet-list" style="width:100%; margin-bottom:10px;"></select>
                <textarea id="adm-sheet-json" placeholder="åœ¨æ­¤ç²˜è´´ JSON æ•°æ®..." style="width:100%; height:150px; font-family:monospace; font-size:0.8em;"></textarea>
                <div style="display:flex; gap:10px; margin-top:5px;">
                <button onclick="saveCharacterSheet()" style="flex:1; background:#822000; color:white; border:none; padding:8px; border-radius:4px; font-weight:bold;">
                ğŸ’¾ ä¿å­˜ / æ›´æ–°
                </button>

                <button onclick="deleteCharacterSheet()" style="width:100px; background:#fff; color:#c0392b; border:1px solid #c0392b; padding:8px; border-radius:4px; font-weight:bold;">
                ğŸ—‘ï¸ æ¸…ç©º
                </button>
                </div>
            </div>

            
            <div class="admin-box" style="border:1px solid #c0392b; padding:15px; border-radius:8px; background:#fff;">
                <h3 style="margin-top:0; color:#c0392b;">â˜ ï¸ ç­¾å‘é€šç¼‰ä»¤</h3>
    
                <!-- å•ä¸ªæ·»åŠ  -->
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:5px; margin-bottom:10px;">
                    <input type="text" id="adm-wanted-name" placeholder="å§“å" style="grid-column: 1/3;">
                    <input type="number" id="adm-wanted-amount" placeholder="èµé‡‘ GP">
                    <select id="adm-wanted-status">
                        <option value="DEAD OR ALIVE">DEAD OR ALIVE</option>
                        <option value="CAPTURED">CAPTURED (å·²æ•è·)</option>
                    </select>
                    <input type="text" id="adm-wanted-source" placeholder="æ‚¬èµç»„ç»‡">
                </div>
                <button onclick="addWantedPoster()" style="width:100%; background:#c0392b; color:white; border:none; padding:8px; border-radius:4px; font-weight:bold;">å•ä»½ç­¾å‘</button>
    
                <hr style="margin:15px 0;">

                <!-- æ‰¹é‡å¯¼å…¥ -->
                <h4 style="margin:0 0 5px 0;">æ‰¹é‡å¯¼å…¥ (æ¯è¡Œä¸€ä¸ªï¼šåå­—,é‡‘é¢,ç»„ç»‡)</h4>
                <textarea id="adm-wanted-bulk" placeholder="ç›å°”ä½æ‹‰,34500,é¾™å·«æ•™&#10;è·¯äººç”²,500,é¢†ä¸»è”ç›Ÿ" style="width:100%; height:60px; font-size:0.8em;"></textarea>
                <button onclick="bulkAddWanted()" style="width:100%; margin-top:5px; border:1px solid #c0392b; color:#c0392b; background:none; padding:5px;">å¼€å§‹æ‰¹é‡ç­¾å‘ (æ— å¤´åƒ)</button>
           </div>
        </div>
    </div>
</div>

<script>
    let mainRealtimeChannel = null;
    let viewingUserId = null; // å½“å‰æ­£åœ¨æŸ¥çœ‹è°çš„åœºæ™¯
    let myId = null; // ç™»å½•è€…è‡ªå·±çš„ ID
    let presenceChannel = null;
    let currentUserRole = 'player'; //æƒé™åˆ’åˆ†
    let currentUserEmail = ''; 
    let isSellMode = false;
    const SUPABASE_URL = 'https://vbzfpgucpciqgaakqndz.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZiemZwZ3VjcGNpcWdhYWtxbmR6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc1OTc2MzMsImV4cCI6MjA4MzE3MzYzM30.fBVDirEJ52bvrYJZ5DNv7fVDLNgCwITKwdKqT6YJDYw';
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    const DM_EMAIL = '739477825@qq.com';
    // --- ã€è¡¥å›ã€‘ç¨€æœ‰åº¦é¢œè‰²å®šä¹‰ ---
    const rarityColors = { 
        'æ™®é€š': '#95a5a6', 
        'éæ™®é€š': '#2ecc71', 
        'çç¨€': '#3498db', 
        'æçç¨€': '#9b59b6', 
        'ä¼ è¯´': '#f1c40f', 
        'ç¥å™¨': '#e74c3c' 
    };
    let userProfile = null;
    let currentEquipTarget = { empId: null, slotIdx: null };

    function showLoading() { document.getElementById('loading-overlay').style.display = 'flex'; }
    function hideLoading() { document.getElementById('loading-overlay').style.display = 'none'; }
    function setupMainRealtime(targetId) {
        // å¦‚æœå·²ç»æœ‰é¢‘é“åœ¨è¿è¡Œï¼Œå…ˆå…³æ‰ï¼ˆé˜²æ­¢è§†è§’åˆ‡æ¢æ—¶é‡å¤ç›‘å¬ï¼‰
        if (mainRealtimeChannel) {
            supabaseClient.removeChannel(mainRealtimeChannel);
        }

        // åˆ›å»ºæ–°é¢‘é“
        mainRealtimeChannel = supabaseClient.channel('main_sync_channel');

        mainRealtimeChannel
            // 1. ç›‘å¬é‡‘å¸å’Œæ—¶é—´å˜åŠ¨ (Profilesè¡¨)
            .on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'profiles', filter: `id=eq.${targetId}` }, (payload) => {
                console.log('æ£€æµ‹åˆ°èµ„äº§/æ—¶é—´å˜åŠ¨');
                loadGold();
                loadUserDate();
            })
            // 2. ç›‘å¬é›†å¸‚å˜åŠ¨ (Shop è¡¨)
            .on('postgres_changes', { event: '*', schema: 'public', table: 'shop_items' }, (payload) => {
                console.log('é›†å¸‚è´§æ¶æœ‰æ›´æ–°');
                loadShop();
            })
            // 3. ç›‘å¬èƒŒåŒ…å˜åŠ¨ (Inventory è¡¨)
            .on('postgres_changes', { event: '*', schema: 'public', table: 'user_inventory', filter: `user_id=eq.${targetId}` }, (payload) => {
                console.log('èƒŒåŒ…ç‰©å“æœ‰æ›´æ–°');
                loadInventory();
            })
            // 4. ç›‘å¬é›‡å‘˜/å°é˜Ÿå˜åŠ¨ (Employees è¡¨)
            .on('postgres_changes', { event: '*', schema: 'public', table: 'employees', filter: `user_id=eq.${targetId}` }, (payload) => {
                console.log('äººå‘˜/å°é˜ŸçŠ¶æ€å˜åŠ¨');
                loadTeam();
                loadEmployees();
            })
            // 5. ç›‘å¬è£…å¤‡æ å˜åŠ¨ (Equipped è¡¨)
            .on('postgres_changes', { event: '*', schema: 'public', table: 'equipped_items' }, (payload) => {
                console.log('è£…å¤‡ç©¿æˆ´æœ‰æ›´æ–°');
                loadTeam();
            })
            .subscribe();
    }

    // --- é˜Ÿä¼ç®¡ç† (ç»Ÿä¸€æ˜¾ç¤ºï¼Œä¸éš”å¼€) ---
    async function loadTeam() {
        const container = document.getElementById('team-container');
        if (!container) return; 
        
        container.innerHTML = 'åŠ è½½é˜Ÿå‘˜æ•°æ®...';
        
        // æŸ¥è¯¢æ•°æ®
        const { data: members } = await supabaseClient
            .from('employees')
            .select('*')
            .eq('is_in_party', true)
            .eq('user_id', viewingUserId) // åªçœ‹å½“å‰è§†è§’çš„
            .order('id');
            
        const { data: equipped } = await supabaseClient.from('equipped_items').select('*');

        // æ¸…ç©ºå®¹å™¨ï¼Œå‡†å¤‡é‡æ–°æ¸²æŸ“
        container.innerHTML = '';
        
        // 1. æ¸²æŸ“ç°æœ‰é˜Ÿå‘˜
        if (members && members.length > 0) {
            members.forEach(m => {
                let slotsHtml = '';
                for (let i = 0; i < 10; i++) {
                    const item = equipped.find(e => e.employee_id === m.id && e.slot_index === i);
                    if (item) {
                        slotsHtml += `<div class="slot filled" onclick="unequipItem(${item.id})" title="${item.item_name}"><div class="slot-name">${item.item_name}</div></div>`;
                    } else {
                        slotsHtml += `<div class="slot" onclick="openEquipModal(${m.id}, ${i})">+</div>`;
                    }
                }
                
                // å°†å¡ç‰‡åŠ å…¥å®¹å™¨
                container.innerHTML += `
                    <div class="team-card">
                        <div class="btn-leave" onclick="removeFromParty(${m.id})" title="ç§»å‡ºé˜Ÿä¼">âœ• ç¦»é˜Ÿ</div>
                        <div class="team-header">
                            <img src="${m.avatar_url || 'https://via.placeholder.com/60'}" class="team-avatar">
                            <div class="team-info">
                                <h3>${m.name}</h3>
                                <p>${m.role || 'é›‡å‘˜'}${m.role === 'æ ¸å¿ƒé˜Ÿå‹' ? '' : ' | ' + m.salary + ' GP'}</p>
                            </div>
                        </div>
                        <div class="slots-container">${slotsHtml}</div>
                    </div>`;
            });
        }

        // 2. æ¸²æŸ“æ·»åŠ æŒ‰é’® (å¦‚æœäººæ•°ä¸æ»¡8äºº)
        if (!members || members.length < 8) {
            container.innerHTML += `
                <div class="team-card add-member-card" onclick="openMemberModal()">
                    <div style="font-size:3em;">+</div>
                    <div>æ·»åŠ é˜Ÿå‘˜ (${members ? members.length : 0}/8)</div>
                </div>`;
        }
        
        container.className = 'team-grid';
    }
    // --- å›¾ç‰‡é¢„åŠ è½½ç³»ç»Ÿ ---
    const preloadedCache = new Set(); 

    function preloadImages(urlList) {
        if (!urlList || urlList.length === 0) return;

        // ä½¿ç”¨ requestIdleCallback æˆ– setTimeout æ¥é¿å…é˜»å¡ä¸»ç•Œé¢æ¸²æŸ“
        const runPreload = () => {
            urlList.forEach(url => {
                if (!url || preloadedCache.has(url)) return; // å·²ç»åŠ è½½è¿‡å°±ä¸ç®¡äº†
                
                const img = new Image();
                img.src = url;
                preloadedCache.add(url);
            });
        };

        if ('requestIdleCallback' in window) {
            requestIdleCallback(runPreload);
        } else {
            setTimeout(runPreload, 1000); // å»¶è¿Ÿ1ç§’æ‰§è¡Œï¼Œä¼˜å…ˆæ¸²æŸ“ç•Œé¢
        }
    }

    // --- é›‡å‘˜ç³»ç»Ÿ ---
    async function loadEmployees() {
        const container = document.getElementById('emp-container');
        container.innerHTML = 'æ­£åœ¨è¯»å–ä½é¢åå•...';
        
        const { data, error } = await supabaseClient
            .from('employees')
            .select('*')
            .eq('user_id', viewingUserId);
        
        if (error) {
            container.innerHTML = '<div style="color:red; padding:20px;">æ— æ³•åŠ è½½åå•ã€‚</div>';
            return;
        }

        // 1. è§¦å‘ç«‹ç»˜é¢„åŠ è½½
        const standUrls = data.map(e => e.stand_url).filter(u => u && u.length > 0);
        preloadImages(standUrls);

        // 2. çŠ¶æ€æƒé‡é…ç½®
        const statusWeight = {
            'åœ¨èŒ': 1, 'ä¼‘å‡': 2, 'ç‰¹æ®ŠçŠ¶æ€': 3, 'ç¦»èŒ': 4, 'ç”³è¯·è§£é›‡': 5
        };

        // --- æ’åºæƒé‡è®¡ç®— ---
        const getSortWeight = (e) => {
            const sWeight = statusWeight[e.status] || 99;
            const isPlayer = e.salary === -1;
            return {
                status: sWeight,
                isPlayer: isPlayer,
                rarity: e.rarity || 3,
                salary: Math.max(0, e.salary)
            };
        };

        // 3. æ ¸å¿ƒæ’åºé€»è¾‘
        const sortLogic = (a, b) => {
            const wA = getSortWeight(a);
            const wB = getSortWeight(b);

            // 1. çŠ¶æ€
            if (wA.status !== wB.status) return wA.status - wB.status;
            // 2. ç©å®¶èº«ä»½ (-1 ä¼˜å…ˆ)
            if (wA.isPlayer && !wB.isPlayer) return -1;
            if (!wA.isPlayer && wB.isPlayer) return 1;
            // 3. æ˜Ÿçº§
            if (wA.rarity !== wB.rarity) return wB.rarity - wA.rarity;
            // 4. è–ªèµ„
            return wB.salary - wA.salary;
        };

        // è®¡ç®—æ€»è–ªèµ„
        const totalSalary = data
            .filter(e => e.status === 'åœ¨èŒ' && e.salary > 0)
            .reduce((sum, e) => sum + e.salary, 0);

        // åˆ†ç»„å¹¶æ’åº
        const coreMembers = data.filter(e => e.role === 'æ ¸å¿ƒé˜Ÿå‹').sort(sortLogic);
        const hirelings = data.filter(e => e.role !== 'æ ¸å¿ƒé˜Ÿå‹').sort(sortLogic);

        // 4. æ¸²æŸ“å‡½æ•°
        const renderGrid = (list) => {
            if (list.length === 0) return '<div style="color:#999; padding:20px; grid-column:1/-1;">(ç©º)</div>';
            return list.map(e => {
                // çŠ¶æ€è‰²
                const config = { color: '#666' };
                if(e.status === 'åœ¨èŒ') config.color = '#2ecc71';
                else if(e.status === 'ä¼‘å‡') config.color = '#3498db';
                else if(e.status === 'ç‰¹æ®ŠçŠ¶æ€') config.color = '#9b59b6';
                else if(e.status === 'ç¦»èŒ') config.color = '#95a5a6';
                else if(e.status === 'ç”³è¯·è§£é›‡') config.color = '#e67e22';

                const isCore = e.role === 'æ ¸å¿ƒé˜Ÿå‹';
                const isPlayer = e.salary === -1;
                const hasSheet = e.stat_block ? true : false;
                const roleDisplay = isCore || isPlayer 
                    ? `<div>${e.role || 'é˜Ÿå‹'}</div>`
                    : `<div>${e.role || 'é›‡å‘˜'} | ${e.salary} GP</div>`;
                const canFire = !isCore && !isPlayer && e.status === 'åœ¨èŒ';

                const rarity = e.rarity || 3;
                const stars = 'â˜…'.repeat(rarity);
                const borderClass = `rarity-border-${rarity}`; 

                return `
                <div class="card emp-card-content ${borderClass}" style="position:relative;">
                    <div style="position:absolute; top:5px; right:10px; color:#f1c40f; font-size:0.8em; letter-spacing:1px; text-shadow:0 1px 2px rgba(0,0,0,0.1);">
                        ${stars}
                    </div>

                    <img src="${e.avatar_url || 'https://via.placeholder.com/70'}" 
                         style="width:70px; height:70px; border-radius:50%; object-fit:cover; margin-bottom:10px; border:1px solid #eee; margin-top:10px;">
                    
                    <div style="font-weight:bold; font-size:1.1em;">${e.name}</div>
                    
                    <div style="font-size:0.8em; color:#666; margin:4px 0;">
                        ${roleDisplay}
                    </div>

                    <div style="font-size:0.75em; display:inline-block; padding:2px 10px; border-radius:12px; background:${config.color}; color:white; font-weight:bold; margin-bottom:8px;">
                        ${e.status}
                    </div>

                    <div style="margin-top:5px; display:flex; justify-content:center; gap:5px; flex-wrap:wrap;">
                        ${hasSheet ? `<button onclick="openDossierModal(${e.id})" style="font-size:0.8em; padding:4px 8px; border:1px solid #822000; background:#fffcf0; color:#822000; border-radius:4px; cursor:pointer;">ğŸ“œ æ¡£æ¡ˆ</button>` : ''}
                        ${canFire ? `<button class="danger-btn" onclick="requestFire(${e.id})" style="width:auto; margin-top:0; display:none;">è§£é›‡</button>` : ''}
                    </div>
                </div>`;
            }).join('');
        };

        container.innerHTML = `
            <div style="background:#f8f9fa; border:1px solid #ddd; padding:15px; margin-bottom:30px; text-align:center; border-radius:8px;">
                <h3 style="margin:0; color:#d35400;">ğŸ“‰ æ¯æœˆè–ªèµ„æ€»æ”¯å‡º: ${totalSalary} GP</h3>
            </div>
            <div class="section-title">âš”ï¸ æ ¸å¿ƒé˜Ÿå‹</div>
            <div class="shop-grid" style="margin-bottom:40px;">${renderGrid(coreMembers)}</div>
            <div class="section-title">ğŸ›¡ï¸ é›‡å‘˜ / éšä»</div>
            <div class="shop-grid">${renderGrid(hirelings)}</div>
        `;
    }

async function equipItem(invId, itemName) {
        showLoading(); // å¼€å¯è½¬åœˆ
        try {
            // 1. ä¸¥æ ¼æ£€æŸ¥ï¼šå»æ•°æ®åº“æŸ¥æœ€æ–°çš„åº“å­˜
            const { data: invItem, error } = await supabaseClient
                .from('user_inventory')
                .select('id, quantity')
                .eq('id', invId)
                .single();

            // å¼‚å¸¸å¤„ç†ï¼šå¦‚æœåº“å­˜ä¹Ÿæ²¡äº†ï¼Œæˆ–è€…æŠ¥é”™
            if (error || !invItem || invItem.quantity < 1) {
                alert('è£…å¤‡å¤±è´¥ï¼šç‰©å“ä¸å­˜åœ¨æˆ–æ•°é‡ä¸è¶³ï¼');
                closeModal('equip-modal');
                await loadInventory(); // å¼ºåˆ¶åˆ·æ–°çº æ­£å‰ç«¯æ˜¾ç¤º
                hideLoading();
                return;
            }

            // 2. æ‰£åº“å­˜
            if (invItem.quantity > 1) {
                await supabaseClient.from('user_inventory').update({ quantity: invItem.quantity - 1 }).eq('id', invId);
            } else {
                // å¦‚æœåªå‰©1ä¸ªï¼Œç›´æ¥åˆ é™¤
                await supabaseClient.from('user_inventory').delete().eq('id', invId);
            }

            // 3. å†™å…¥è£…å¤‡æ 
            const { error: equipError } = await supabaseClient.from('equipped_items').insert([{ 
                employee_id: currentEquipTarget.empId, 
                slot_index: currentEquipTarget.slotIdx, 
                item_name: itemName 
            }]);

            if (equipError) throw equipError;

            // 4. ã€è¡¥å›ã€‘è®°å½•æ“ä½œæ—¥å¿—
            // è¿™æ ·åœ¨åå°å°±èƒ½çœ‹åˆ°ï¼šâ€œmaster@... å°† [è´¤è€…æ³•æ–] è£…å¤‡ç»™äº† ç‹å‚æ¨±â€
            await logAction('è£…å¤‡ç‰©å“', `å°† [${itemName}] è£…å¤‡ç»™é˜Ÿå‘˜ (ID:${currentEquipTarget.empId})`);

            closeModal('equip-modal'); 
            
            // 5. åˆ·æ–°ç•Œé¢
            await Promise.all([loadTeam(), loadInventory()]);

        } catch (e) {
            console.error("è£…å¤‡å‡ºé”™:", e);
            alert('æ“ä½œå¼‚å¸¸ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ');
        } finally {
            hideLoading(); // å…³é—­è½¬åœˆ
        }
    }

    async function unequipItem(equipId) {
        if (!confirm('ç¡®å®šå¸ä¸‹è¯¥è£…å¤‡ï¼Ÿ')) return;
        showLoading();
        try {
            // 1. è·å–è£…å¤‡ä¿¡æ¯
            const { data: eqItem } = await supabaseClient.from('equipped_items').select('*').eq('id', equipId).single();
            if (!eqItem) throw new Error("è£…å¤‡ä¸å­˜åœ¨");

            // 2. å°è¯•æ”¾å›èƒŒåŒ…
            const { data: exist } = await supabaseClient.from('user_inventory')
                .select('*')
                .eq('user_id', userProfile.id)
                .eq('item_name', eqItem.item_name)
                .maybeSingle();

            if (exist) {
                await supabaseClient.from('user_inventory').update({ quantity: exist.quantity + 1 }).eq('id', exist.id);
            } else {
                await supabaseClient.from('user_inventory').insert([{ 
                    user_id: userProfile.id, 
                    item_name: eqItem.item_name, 
                    quantity: 1, 
                    category: 'è£…å¤‡' // é»˜è®¤å½’ç±»
                }]);
            }

            // 3. ä»èº«ä¸Šåˆ é™¤
            await supabaseClient.from('equipped_items').delete().eq('id', equipId);

            // 4. è®°å½•æ—¥å¿—
            await logAction('å¸ä¸‹è£…å¤‡', `å¸ä¸‹äº† [${eqItem.item_name}] (é˜Ÿå‘˜ID:${eqItem.employee_id})`);

            await loadTeam(); 
            await loadInventory();
        } catch(e) { 
            console.error(e); 
            alert('å¸è½½å¤±è´¥');
        } finally {
            hideLoading();
        }
    }

async function openEquipModal(empId, slotIdx) {
        currentEquipTarget = { empId, slotIdx };
        const list = document.getElementById('equip-list');
        list.innerHTML = 'æ­£åœ¨å¼€å¯ä½é¢èƒŒåŒ…...';
        document.getElementById('equip-modal').style.display = 'flex';
        
        const { data: inv, error } = await supabaseClient
            .from('user_inventory')
            .select('*')
            .eq('user_id', viewingUserId) 
            .in('category', ['è£…å¤‡', 'é­”æ³•ç‰©å“'])
            .gt('quantity', 0);

        if (error) {
            console.error(error);
            list.innerHTML = '<div style="color:red">èƒŒåŒ…å¼€å¯å¤±è´¥</div>';
            return;
        }

        list.innerHTML = '';
        if (!inv || inv.length === 0) {
            list.innerHTML = '<div style="text-align:center; color:#999; padding:20px;">èƒŒåŒ…ä¸­æ²¡æœ‰å¯ç”¨çš„è£…å¤‡æˆ–é­”æ³•ç‰©å“</div>';
            return;
        }

        inv.forEach(item => {
            list.innerHTML += `
                <div onclick="equipItem(${item.id}, '${item.item_name}')">
                    <span>${item.item_name}</span>
                    <span style="color:#999; font-size:0.8em;">x${item.quantity}</span>
                </div>`;
        });
    }

    async function addToParty(id) {
        showLoading();
        await supabaseClient.from('employees').update({ is_in_party: true }).eq('id', id);
        closeModal('member-modal'); await loadTeam();
        hideLoading();
    }
    async function removeFromParty(id) {
        if (!confirm('ç¡®å®šç¦»é˜Ÿï¼Ÿ')) return;
        showLoading();
        await supabaseClient.from('employees').update({ is_in_party: false }).eq('id', id);
        await loadTeam();
        hideLoading();
    }
    async function requestFire(id) {
        if (!confirm('ç¡®å®šç”³è¯·è§£é›‡ï¼Ÿ')) return;
        showLoading();
        await supabaseClient.from('employees').update({ status: 'ç”³è¯·è§£é›‡' }).eq('id', id);
        await loadEmployees();
        hideLoading();
    }
    
    // åŸºç¡€åŠ è½½ (ä¿®å¤èƒŒåŒ…åˆ†ç±»)
    async function loadInventory() {
        const container = document.getElementById('inventory-container');
        container.innerHTML = 'æ¸…ç‚¹ä¸­...';
        const { data: inv } = await supabaseClient.from('user_inventory').select('*').eq('user_id', viewingUserId).order('category');
        if (!inv) return;
        container.innerHTML = '';
        const categories = [...new Set(inv.map(i => i.category || 'æ‚é¡¹'))];
        categories.forEach(cat => {
            const section = document.createElement('div');
            section.className = 'inventory-category';
            section.innerHTML = `<h3>${cat}</h3>`;
            const grid = document.createElement('div');
            grid.className = 'inventory-grid';
            inv.filter(i => (i.category || 'æ‚é¡¹') === cat).forEach(item => {
                grid.innerHTML += `<div class="inv-card"><span>${item.item_name}</span><span style="font-weight:bold; color:#666">x${item.quantity}</span></div>`;
            });
            section.appendChild(grid);
            container.appendChild(section);
        });
    }

    // è¾…åŠ©
    function closeModal(id) { document.getElementById(id).style.display = 'none'; }
    //é˜Ÿå‘˜å¼¹çª—
    async function openMemberModal() {
        const list = document.getElementById('member-select-list');
        list.innerHTML = 'åŠ è½½ä¸­...';
        document.getElementById('member-modal').style.display = 'flex';
        
        // è¿™æ ·å½“å‰è§†è§’æ˜¯è°ï¼Œå°±åªèƒ½çœ‹åˆ°è°çš„é›‡å‘˜
        const { data: candidates } = await supabaseClient
            .from('employees')
            .select('*')
            .eq('status', 'åœ¨èŒ')
            .eq('is_in_party', false)
            .eq('user_id', viewingUserId) 
            .order('id');
            
        list.innerHTML = '';
        if (!candidates || candidates.length === 0) {
            return list.innerHTML = '<div style="padding:10px;text-align:center;color:#999">æ²¡æœ‰å¯ç”¨çš„é›‡å‘˜</div>';
        }
        
        candidates.forEach(c => {
            list.innerHTML += `
                <div onclick="addToParty(${c.id})">
                    <span>
                        <img src="${c.avatar_url||''}" style="width:24px;border-radius:50%;vertical-align:middle;margin-right:8px;"> 
                        ${c.name}
                    </span>
                    <span style="color:#999">${c.role||'é›‡å‘˜'}</span>
                </div>`;
        });
    }

// ç™»å½•é€»è¾‘---

async function login() {
    const email = document.getElementById('login-email').value;
    const password = document.getElementById('login-password').value;
    const btn = document.querySelector('#login-section button');

    if (!email || !password) return alert('è¯·è¾“å…¥è´¦å·å¯†ç ');

    // 1. è·å–éªŒè¯ç  Token
    const captchaToken = turnstile.getResponse(); 
    if (!captchaToken) {
        alert('è¯·ç‚¹å‡»éªŒè¯ç è¿›è¡ŒäººæœºéªŒè¯');
        return;
    }

    // 2. é”å®šæŒ‰é’®ï¼Œé˜²æ­¢é‡å¤ç‚¹å‡»
    const originalBtnText = btn.innerText;
    btn.innerText = 'æ­£åœ¨å»ºç«‹å®‰å…¨è¿æ¥...';
    btn.disabled = true;

    // 3. å¹¶è¡Œå¤„ç†ï¼šåŒæ—¶å¼€å§‹ç™»å½•å’Œè·å– IP 
    
    // --- è·å–è®¾å¤‡æŒ‡çº¹ ---
    const fingerprint = [
        navigator.language,
        screen.colorDepth,
        screen.width + 'x' + screen.height,
        new Date().getTimezoneOffset(),
        navigator.hardwareConcurrency
    ].join('|');

    // --- âœ… è·å– IP ---
    let clientIp = 'æ£€æµ‹ä¸­...';
    try {
        clientIp = await getRobustIP();
        console.log("å½“å‰å®¢æˆ·ç«¯ IP:", clientIp);
    } catch (e) {
        console.log("IP è·å–è·³è¿‡");
    }

    // 4. å‘èµ· Supabase ç™»å½•è¯·æ±‚
    const { data, error } = await supabaseClient.auth.signInWithPassword({ 
        email, 
        password,
        options: {
            captchaToken: captchaToken, // åç«¯æ ¡éªŒ Token
        }
    });

    // 5. æ— è®ºæˆåŠŸå¤±è´¥ï¼Œéƒ½å¿…é¡»é‡ç½®éªŒè¯ç 
    turnstile.reset();

    const statusMsg = error ? `å¤±è´¥: ${error.message}` : 'æˆåŠŸ';

    // 6. å†™å…¥ç™»å½•æ—¥å¿— (è®°å½• IP å’ŒæŒ‡çº¹)
    supabaseClient.from('login_logs').insert([{
        email: email,
        ip_address: clientIp, // å†™å…¥åˆšæ‰è·å–åˆ°çš„å¼ºå£® IP
        status: statusMsg,
        user_agent: `${fingerprint} | ${navigator.userAgent}` 
    }]).then(({ error }) => {
        if (error) console.error("æ—¥å¿—å†™å…¥å¤±è´¥:", error);
    });

    // 7. æ¢å¤æŒ‰é’®çŠ¶æ€
    btn.innerText = originalBtnText;
    btn.disabled = false;

    // 8. å¤„ç†ç™»å½•ç»“æœ
    if (error) {
        alert('éªŒè¯å¤±è´¥ï¼šè¯·æ£€æŸ¥è´¦å·å¯†ç æˆ–éªŒè¯ç ã€‚');
    } else {
        // ç™»å½•æˆåŠŸï¼Œè¿›å…¥ä¸»æµç¨‹
        checkUser();
    }
}

    async function logout() {
        // ç¦»å¼€é¢‘é“
        if (presenceChannel) {
            await presenceChannel.untrack();
            await supabaseClient.removeChannel(presenceChannel);
        }
        await supabaseClient.auth.signOut();
        location.reload();
    }

     // checkUserï¼šè·å–ç®¡ç†å‘˜ç­‰çº§
    async function checkUser() {
    // 1. è·å–å½“å‰ç™»å½•ç”¨æˆ·
    const { data: { user } } = await supabaseClient.auth.getUser();

    if (user) {
        // åˆå§‹åŒ–å…¨å±€å˜é‡
        myId = user.id;
        currentUserEmail = user.email;
        
        // 2. æ£€æŸ¥ç®¡ç†å‘˜æƒé™
        const { data: adminData } = await supabaseClient
            .from('admin_users')
            .select('role_level')
            .eq('id', user.id)
            .maybeSingle();

        if (adminData) {
            currentUserRole = adminData.role_level;
            
            // æ˜¾ç¤º DM å…¥å£
            document.getElementById('admin-link').style.display = 'inline';
            const badge = document.getElementById('role-badge');
            if (badge) badge.innerText = currentUserRole.toUpperCase();
            
            if (currentUserRole === 'root') {
                const secBtn = document.getElementById('security-tab-btn');
                if (secBtn) secBtn.style.display = 'inline-block';
            }
            
            loadAdminData();
        } else {
            currentUserRole = 'player';
        }
        
        // 3. åˆå§‹åŒ–è§†å›¾ ID
        if (!viewingUserId) viewingUserId = user.id;

        // 4. åˆ‡æ¢ç•Œé¢æ˜¾ç¤º
        document.getElementById('login-section').style.display = 'none';
        document.getElementById('main-section').style.display = 'block';
        
        // 5. åŠ è½½æ‰€æœ‰ä¸šåŠ¡æ•°æ®
        await refreshAllData();
        setupMainRealtime(viewingUserId); 

        // 6. ğŸš€ å…³é”®ä¿®å¤ï¼šç¡®ä¿åœ¨è¿™é‡Œå¯åŠ¨åœ¨çº¿ç³»ç»Ÿ
        console.log("æ­£åœ¨å¯åŠ¨åœ¨çº¿çŠ¶æ€ç³»ç»Ÿ...");
        initPresenceSystem(); 

    } else {
        // æœªç™»å½•ï¼Œæ˜¾ç¤ºç™»å½•æ¡†
        document.getElementById('login-section').style.display = 'block';
        document.getElementById('main-section').style.display = 'none';
    }
}


let currentDate = { year: 1494, month: 2, day: 12 }; // é»˜è®¤å€¼

    // 1. ä¿®æ”¹åŠ è½½æ—¶é—´å‡½æ•°ï¼šé¡ºä¾¿æŠŠæ—¶é—´å¡«å…¥è¾“å…¥æ¡†
    async function loadUserDate() {
        const { data: prof } = await supabaseClient.from('profiles').select('world_date').eq('id', viewingUserId).single();
        if (prof && prof.world_date) {
            currentDate = prof.world_date;
            document.getElementById('date-text').innerText = `FR${currentDate.year} ${currentDate.month}æœˆ${currentDate.day}æ—¥`;
            
            // ã€ã€‘å›æ˜¾åˆ° DM åå°è¾“å…¥æ¡†
            if(document.getElementById('time-year')) {
                document.getElementById('time-year').value = currentDate.year;
                document.getElementById('time-month').value = currentDate.month;
                document.getElementById('time-day').value = currentDate.day;
            }
        }
    }

    // 2. ï¼šä»»æ„ä¿®æ”¹æ—¶é—´é€»è¾‘
    async function updateTimeManual() {
        if (!viewingUserId) return alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªè§†è§’');

        const y = parseInt(document.getElementById('time-year').value);
        const m = parseInt(document.getElementById('time-month').value);
        const d = parseInt(document.getElementById('time-day').value);

        if (!y || !m || !d) return alert('æ—¥æœŸæ ¼å¼ä¸å¯¹');

        // åˆ¤æ–­æ˜¯å¦è·¨æœˆï¼ˆç®€å•çš„é€»è¾‘ï¼šåªè¦æœˆä»½æˆ–å¹´ä»½å˜äº†ï¼Œå°±æç¤ºæ‰£æ¬¾ï¼‰
        const isMonthChanged = (y !== currentDate.year) || (m !== currentDate.month);
        
        if (isMonthChanged) {
            const confirmPay = confirm(`âš ï¸ æ£€æµ‹åˆ°æœˆä»½å˜åŒ–ï¼\n\næ˜¯å¦è§¦å‘è¯¥ç©å®¶çš„ [æœˆåº¦è‡ªåŠ¨æ‰£è–ª]ï¼Ÿ\n\n[ç¡®å®š] = æ‰£é’±å¹¶è·³è½¬\n[å–æ¶ˆ] = ä¸æ‰£é’±ï¼Œä»…è·³è½¬`);
            
            if (confirmPay) {
                // æ‰§è¡Œæ‰£æ¬¾é€»è¾‘
                const { data: emps } = await supabaseClient.from('employees').select('salary').eq('user_id', viewingUserId).eq('status', 'åœ¨èŒ');
                if (emps && emps.length > 0) {
                    const totalSalary = emps.reduce((sum, e) => sum + e.salary, 0);
                    if (totalSalary > 0) {
                        const { data: prof } = await supabaseClient.from('profiles').select('gold_gp').eq('id', viewingUserId).single();
                        await supabaseClient.from('profiles').update({ gold_gp: prof.gold_gp - totalSalary }).eq('id', viewingUserId);
                        await logAction('ç³»ç»Ÿæ‰£æ¬¾', `æ—¶é—´è·ƒè¿è§¦å‘æ‰£è–ªï¼š${totalSalary} GP`);
                        alert(`å·²æ‰£é™¤ ${totalSalary} GP`);
                    }
                }
            }
        }

        // æ›´æ–°æ•°æ®åº“æ—¶é—´
        showLoading();
        await supabaseClient.from('profiles').update({ 
            world_date: { year: y, month: m, day: d } 
        }).eq('id', viewingUserId);
        
        await logAction('æ—¶é—´è·ƒè¿', `DM å°†æ—¶é—´è°ƒæ•´ä¸º FR${y}/${m}/${d}`);
        await refreshAllData();
        hideLoading();
    }


async function loadGold() {
        // æ¯æ¬¡éƒ½æ ¹æ®å½“å‰ viewingUserId é‡æ–°æŠ“å–
        const { data: profile, error } = await supabaseClient
            .from('profiles')
            .select('*')
            .eq('id', viewingUserId)
            .single();

        if (error) {
            console.error("åŠ è½½èµ„äº§å¤±è´¥:", error);
            userProfile = null;
            document.getElementById('gold-amount').innerText = "???";
            return;
        }

        userProfile = profile; // èµ‹å€¼ç»™å…¨å±€å˜é‡ä¾›å…¶ä»–å‡½æ•°ä½¿ç”¨
        document.getElementById('gold-amount').innerText = profile.gold_gp.toLocaleString();
    }


    function switchTab(tab) {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        
        // æ‰¾åˆ°ç‚¹å‡»çš„æŒ‰é’®å¹¶æ¿€æ´»
        const activeBtn = Array.from(document.querySelectorAll('.tab-btn')).find(b => b.getAttribute('onclick').includes(`'${tab}'`));
        if (activeBtn) activeBtn.classList.add('active');
        
        document.getElementById(`${tab}-section`).classList.add('active');
        
        // å¦‚æœåˆ‡åˆ°å®‰å…¨æ¨¡å—ï¼Œè‡ªåŠ¨åŠ è½½æ—¥å¿—
        if (tab === 'security') {
            loadAllAccounts();
            loadLogs();
            loadLoginLogs();
        }
    }

    function toggleAdmin() {
        const p = document.getElementById('admin-panel');
        p.style.display = p.style.display === 'block' ? 'none' : 'block';

        if (p.style.display === 'block') {
            const securityPanel = document.getElementById('security-panel-container');
            loadPendingRequests(); 
            if (securityPanel) {
                // åªæœ‰ Root èƒ½çœ‹ç½‘å®‰
                securityPanel.style.display = (currentUserRole === 'root') ? 'flex' : 'none';
            }
        }
        if (p.style.display === 'block' && currentUserRole === 'root') {
            loadAllAccounts(); // è‡ªåŠ¨åŠ è½½è´¦å·
        }
    }
// --- é›†å¸‚åŠ è½½ ---
    async function loadShop() {
        const grid = document.getElementById('shop-grid');
        const searchInput = document.getElementById('shop-search-input');
        const searchTerm = searchInput ? searchInput.value.toLowerCase() : '';
        
        grid.innerHTML = 'æ­£åœ¨è¿æ¥ä½é¢é›†å¸‚...';

        // 1. æ•°æ®åº“æŸ¥è¯¢ (éš”ç¦»é€»è¾‘)
        // æŸ¥è¯¢æ¡ä»¶ï¼š(user_id ä¸ºç©º) OR (user_id ç­‰äºå½“å‰è§†è§’)
        const { data, error } = await supabaseClient
            .from('shop_items')
            .select('*')
            .or(`user_id.is.null,user_id.eq.${viewingUserId}`);

        if (error) {
            console.error('é›†å¸‚åŠ è½½å¤±è´¥:', error);
            grid.innerHTML = '<div style="color:red; padding:20px;">é›†å¸‚è¿æ¥ä¸­æ–­</div>';
            return;
        }

        // 2. å‰ç«¯è¿‡æ»¤ (æœç´¢æ¡†)
        const filteredData = data.filter(i => {
            if (!searchTerm) return true;
            return (i.name && i.name.toLowerCase().includes(searchTerm)) || 
                   (i.category && i.category.toLowerCase().includes(searchTerm));
        });

        if (filteredData.length === 0) {
            grid.innerHTML = '<div style="color:#999; padding:20px; grid-column:1/-1; text-align:center;">æš‚æ— ç¬¦åˆæ¡ä»¶çš„å•†å“</div>';
            return;
        }

        // 3. æƒé‡æ’åº (ç¨€æœ‰åº¦ > ä»·æ ¼)
        const rarityWeight = { 'ç¥å™¨': 6, 'ä¼ è¯´': 5, 'æçç¨€': 4, 'çç¨€': 3, 'éæ™®é€š': 2, 'æ™®é€š': 1 };
        
        filteredData.sort((a, b) => {
            const weightA = rarityWeight[a.rarity] || 0;
            const weightB = rarityWeight[b.rarity] || 0;
            // å…ˆæ¯”ç¨€æœ‰åº¦ (å¤§åˆ°å°)
            if (weightA !== weightB) return weightB - weightA;
            // å†æ¯”ä»·æ ¼ (é«˜åˆ°ä½)
            return b.price - a.price;
        });

        // 4. æ¸²æŸ“å¡ç‰‡
        const canManage = currentUserRole === 'root' || currentUserRole === 'dm';
        
        grid.innerHTML = filteredData.map(i => {
            const color = rarityColors[i.rarity] || '#ccc';
            const isOut = i.stock <= 0;
            
            // ä¸‹æ¶æŒ‰é’® (ä»…ç®¡ç†å‘˜å¯è§)
            const deleteBtn = canManage ? 
                `<button onclick="deleteShopItem(${i.id}, '${i.name}')" 
                    style="background:#e74c3c; color:white; border:none; margin-top:8px; font-size:0.8em; padding:5px; width:100%; border-radius:4px; opacity:0.8;">
                    ğŸ—‘ï¸ ä¸‹æ¶å•†å“
                </button>` : '';

            // ç‰¹ä¾›æ ‡è¯†
            const specialTag = i.user_id ? 
                `<div style="font-size:0.7em; color:#3498db; margin-bottom:4px; font-weight:bold;">ğŸ‘¤ ç‰¹ä¾›ç‰©èµ„</div>` : 
                `<div style="font-size:0.7em; color:#999; margin-bottom:4px;">ğŸŒ å…¬å…±ç‰©èµ„</div>`;

            // å¡ç‰‡æ ·å¼ (å”®ç½„å˜ç°)
            const cardStyle = `position:relative; padding-top:25px; ${isOut ? 'opacity:0.6; background:#f9f9f9;' : ''}`;

            return `
                <div class="card" style="${cardStyle}">
                    <!-- å³ä¸Šè§’ç¨€æœ‰åº¦æ ‡ç­¾ -->
                    <span class="rarity-tag" style="
                        background:${color}; 
                        color:white; 
                        font-size:0.7em; 
                        padding:2px 8px; 
                        border-radius:2px; 
                        position:absolute; 
                        top:8px; 
                        right:8px; 
                        font-weight:bold; 
                        box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                        ${i.rarity || 'æ™®é€š'}
                    </span>

                    ${specialTag}
                    
                    <b style="font-size:1.1em;">${i.name}</b>
                    
                    <div style="font-size:0.8em; color:#666; margin:5px 0;">
                        [${i.category || 'æ‚é¡¹'}]
                    </div>
                    
                    <div style="font-size:0.75em; color:#777; margin:5px 0; line-height:1.4; min-height:2.8em;">
                        ${i.description || 'æš‚æ— æè¿°'}
                    </div>
                    
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-top:10px;">
                        <span style="color:#d35400; font-weight:bold; font-size:1.1em;">ğŸ’° ${i.price}</span>
                        <span style="font-size:0.8em; color:${isOut ? 'red' : '#27ae60'};">
                            ${isOut ? 'âŒ å”®ç½„' : `åº“å­˜: ${i.stock}`}
                        </span>
                    </div>
                    
                    <button class="btn-buy" 
                        onclick="buy(${i.id}, ${i.price}, '${i.name}', '${i.category}')" 
                        ${isOut ? 'disabled' : ''}
                        style="margin-top:10px;">
                        ${isOut ? 'ç¼ºè´§' : 'ç¡®è®¤è´­ä¹°'}
                    </button>
                    
                    ${deleteBtn}
                </div>`;
        }).join('');
    }

    // 3. ï¼šä¸‹æ¶å•†å“é€»è¾‘
    async function deleteShopItem(id, name) {
        if (!confirm(`ç¡®å®šè¦å°† [${name}] æ°¸ä¹…ä¸‹æ¶å—ï¼Ÿ`)) return;
        
        showLoading();
        const { error } = await supabaseClient.from('shop_items').delete().eq('id', id);
        
        if (error) {
            alert('ä¸‹æ¶å¤±è´¥ï¼š' + error.message);
        } else {
            await logAction('DMæ“ä½œ', `ä¸‹æ¶äº†é›†å¸‚å•†å“ [${name}]`);
            loadShop();
        }
        hideLoading();
    }

    // --- åŠ è½½å¾…å®¡æ‰¹è¯·æ±‚ ---
    async function loadPendingRequests() {
        const box = document.getElementById('approval-box');
        const list = document.getElementById('approval-list');
        
        // 1. æŸ¥è¯¢æ‰€æœ‰çŠ¶æ€ä¸º 'ç”³è¯·è§£é›‡' çš„é›‡å‘˜
        // å¦‚æœæ˜¯ Rootï¼ŒæŸ¥æ‰€æœ‰ï¼›å¦‚æœæ˜¯ DMï¼ŒæŸ¥è‡ªå·±è´Ÿè´£ç©å®¶çš„ (åˆ©ç”¨ RLS æˆ–ç­›é€‰)
        let query = supabaseClient.from('employees').select('*, profiles(email)').eq('status', 'ç”³è¯·è§£é›‡');
        
        if (currentUserRole === 'dm') {
            // è¿™é‡Œä¾èµ– profiles è¡¨çš„ RLS æˆ–è€…æˆ‘ä»¬æ‰‹åŠ¨è¿‡æ»¤
            // ç®€å•èµ·è§ï¼Œæˆ‘ä»¬å‡è®¾ RLS å·²ç»é…ç½®å¥½ï¼ŒDM åªèƒ½è¯»åˆ°è‡ªå·±è´Ÿè´£çš„ç©å®¶çš„é›‡å‘˜
        }

        const { data: requests, error } = await query;

        // 2. æ§åˆ¶ç›’å­æ˜¾éš
        if (!requests || requests.length === 0) {
            box.style.display = 'none'; // æ²¡æœ‰è¯·æ±‚å°±éšè—ç›’å­ï¼Œä¿æŒç•Œé¢æ¸…çˆ½
            return;
        }
        
        box.style.display = 'block'; // æœ‰è¯·æ±‚æ‰æ˜¾ç¤º
        list.innerHTML = '';

        // 3. æ¸²æŸ“åˆ—è¡¨
        requests.forEach(req => {
            const ownerEmail = req.profiles ? req.profiles.email : 'æœªçŸ¥ä¹°å®¶';
            list.innerHTML += `
                <div style="border-bottom:1px dashed #eca; padding:8px 0; display:flex; justify-content:space-between; align-items:center;">
                    <div>
                        <strong>${req.name}</strong> <span style="font-size:0.8em; color:#666;">(${req.salary} GP)</span><br>
                        <span style="font-size:0.75em; color:#999;">é›‡ä¸»: ${ownerEmail}</span>
                    </div>
                    <div style="display:flex; gap:5px;">
                        <button onclick="approveFire(${req.id}, true)" style="background:#2ecc71; color:white; border:none; border-radius:4px; padding:4px 8px; cursor:pointer;">æ‰¹å‡†</button>
                        <button onclick="approveFire(${req.id}, false)" style="background:#e74c3c; color:white; border:none; border-radius:4px; padding:4px 8px; cursor:pointer;">é©³å›</button>
                    </div>
                </div>
            `;
        });
    }

    // --- å¤„ç†å®¡æ‰¹ ---
    async function approveFire(empId, isApproved) {
        showLoading();
        try {
            // å¦‚æœæ‰¹å‡†ï¼ŒçŠ¶æ€æ”¹ä¸º 'ç¦»èŒ' (è¿™æ ·å°±ä¸æ‰£é’±äº†ï¼Œä½†ä¹Ÿè¿˜åœ¨åˆ—è¡¨é‡Œ)
            // å¦‚æœé©³å›ï¼ŒçŠ¶æ€æ”¹å› 'åœ¨èŒ'
            const newStatus = isApproved ? 'ç¦»èŒ' : 'åœ¨èŒ';
            
            await supabaseClient
                .from('employees')
                .update({ status: newStatus })
                .eq('id', empId);

            await logAction('å®¡æ‰¹æ“ä½œ', `${isApproved ? 'æ‰¹å‡†' : 'é©³å›'}äº†é›‡å‘˜(ID:${empId}) çš„è§£é›‡ç”³è¯·`);
            
            alert('å¤„ç†å®Œæˆ');
            loadPendingRequests(); // åˆ·æ–°å®¡æ‰¹åˆ—è¡¨
            loadEmployees();       // åˆ·æ–°é›‡å‘˜æ˜¾ç¤º
        } catch (e) {
            console.error(e);
            alert('æ“ä½œå¤±è´¥');
        } finally {
            hideLoading();
        }
    }



    // --- è´­ä¹°é€»è¾‘ (æ”¯æŒ30åˆ†é’Ÿé€€è´§è®°å½•) ---
    async function buy(id, p, n, c) {
        showLoading();
        try {
            const { data, error } = await supabaseClient.rpc('atomic_buy_item', {
                p_user_id: viewingUserId, // ç¡®ä¿è¿™æ˜¯æœ‰æ•ˆçš„ UUID å­—ç¬¦ä¸²
                p_item_id: parseInt(id),  // ç¡®ä¿æ˜¯æ•°å­—
                p_price: parseInt(p),     // ç¡®ä¿æ˜¯æ•°å­—
                p_item_name: n,
                p_category: c || 'æ‚é¡¹'    // ç¡®ä¿ä¸ä¸º null
            });

            if (error) {
                console.error("RPC Error:", error);
                throw error;
            }

            if (data && data.startsWith('success')) {
                // æˆåŠŸ
                await Promise.all([loadGold(), loadInventory()]);
                alert(`[${n}] è´­ä¹°æˆåŠŸï¼`);
            } else {
                // åç«¯è¿”å›çš„ä¸šåŠ¡é”™è¯¯
                alert(data ? data.replace('error:', '') : 'æœªçŸ¥é”™è¯¯');
                loadShop(); 
            }
        } catch (e) {
            console.error("Full Error Info:", e);
            alert('äº¤æ˜“å¤±è´¥ï¼š' + (e.message || 'è¯·æ£€æŸ¥ç½‘ç»œ'));
        } finally {
            hideLoading();
        }
    }

    // ================== é€šç”¨æ—¥å¿—å‡½æ•° ==================
    async function logAction(actionType, details) {
        const { data: { user } } = await supabaseClient.auth.getUser();
        if (user) {
            await supabaseClient.from('audit_logs').insert([{
                user_email: user.email,
                action_type: actionType,
                details: details
            }]);
        }
    }

// --- DM ä¸Šå¸æ¨¡å¼é€»è¾‘ (ä¿®å¤ç‰ˆ) ---

    // åŠ è½½ç®¡ç†å‘˜æ‰€éœ€æ•°æ®
    async function loadAdminData() {
        const ulist = document.getElementById('adm-user-list');
        ulist.innerHTML = '<option value="">åŠ è½½ä¸­...</option>';

        // åŸºç¡€æŸ¥è¯¢
        let query = supabaseClient.from('profiles').select('id, email');

        // --- æ ¸å¿ƒéš”ç¦»é€»è¾‘ ---
        if (currentUserRole === 'root') {
            // Root ç”¨æˆ·ï¼šä¸åŠ ä»»ä½• filterï¼Œç›´æ¥æŸ¥å…¨è¡¨
            console.log("Root æƒé™ï¼šåŠ è½½å…¨æœç©å®¶");
        } else if (currentUserRole === 'dm') {
            // æ™®é€š DMï¼šåªæŸ¥å½’å±è‡ªå·±çš„ç©å®¶
            console.log("DM æƒé™ï¼šåŠ è½½åä¸‹ç©å®¶");
            query = query.eq('assigned_dm_id', myId);
        } else {
            // ç©å®¶è§’è‰²ï¼šæ²¡æƒçœ‹è¿™ä¸ªåˆ—è¡¨
            ulist.innerHTML = '<option value="">æƒé™ä¸è¶³</option>';
            return;
        }

        const { data: users, error } = await query;
        
        if (error) {
            ulist.innerHTML = '<option value="">è¯»å–å¤±è´¥</option>';
            return;
        }

        ulist.innerHTML = '<option value="">-- é€‰æ‹©ç©å®¶ --</option>';
        if (users && users.length > 0) {
            users.forEach(u => {
                ulist.innerHTML += `<option value="${u.id}">${u.email}</option>`;
            });
        } else {
            ulist.innerHTML = '<option value="">(æ— å…³è”ç©å®¶)</option>';
        }

        // é¡ºä¾¿åˆ·æ–°ä¸€ä¸‹æ—¥å¿—è®°å½•
        if (currentUserRole === 'root') {
            loadLogs();
            loadLoginLogs();
        }
    }

    // 2. é€‰ä¸­ç©å®¶åï¼ŒåŠ è½½è¯¦ç»†ä¿¡æ¯
     // ================== ä¿®å¤åçš„ DM èƒŒåŒ…è¯»å– ==================
    let selectedUserId = null;
// --- åŠ è½½ç©å®¶è¯¦æƒ… ---
    async function loadUserDetail() {
        selectedUserId = document.getElementById('adm-user-list').value;
        const detailBox = document.getElementById('user-detail');

        if (!selectedUserId) {
            detailBox.style.display = 'none';
            viewingUserId = myId;
            refreshAllData();
            document.getElementById('adm-emp-list').innerHTML = '';
            return;
        }

        detailBox.style.display = 'block';
        viewingUserId = selectedUserId;
        await refreshAllData();
        setupMainRealtime(viewingUserId); // åˆ‡æ¢è§†è§’åï¼Œé‡æ–°æŒ‚è½½å¯¹åº”çš„å®æ—¶ç›‘å¬

        const { data: prof } = await supabaseClient.from('profiles').select('gold_gp').eq('id', selectedUserId).single();
        if (prof) document.getElementById('adm-user-gold').value = prof.gold_gp;

        // ã€æ ¸å¿ƒä¿®å¤ã€‘ï¼šåœ¨ select é‡ŒåŠ ä¸Š 'id'
        const { data: inv } = await supabaseClient
            .from('user_inventory')
            .select('id, item_name, quantity, category') // <--- è¿™é‡ŒåŠ äº† id
            .eq('user_id', selectedUserId)
            .order('category');

        const invDiv = document.getElementById('adm-user-inv');
        
        if (inv && inv.length > 0) {
            invDiv.innerHTML = inv.map(i => `
                <div style="display:flex; justify-content:space-between; font-size:0.85em; border-bottom:1px dashed #eee; padding:2px; align-items:center;">
                    <span>
                        <span style="color:#999; font-size:0.8em;">[${i.category||'æ‚'}]</span> 
                        ${i.item_name} 
                    </span>
                    <div style="display:flex; align-items:center; gap:5px;">
                        <strong>x${i.quantity}</strong>
                        <button onclick="admRemoveInv(${i.id}, '${i.item_name}', ${i.quantity})" 
                            style="border:none; background:#e74c3c; color:white; cursor:pointer; border-radius:3px; padding:0 5px;">Ã—</button>
                    </div>
                </div>
            `).join('');
        } else {
            invDiv.innerHTML = '<div style="color:#999; text-align:center; padding:10px;">(èƒŒåŒ…æ˜¯ç©ºçš„)</div>';
        }

        // åˆ·æ–°é›‡å‘˜å¤´åƒåˆ—è¡¨
        const { data: emps } = await supabaseClient.from('employees').select('id, name').eq('user_id', selectedUserId);
        const empSelect = document.getElementById('adm-emp-list');
        empSelect.innerHTML = '';
        if (emps && emps.length > 0) {
            emps.forEach(e => empSelect.innerHTML += `<option value="${e.id}">${e.name}</option>`);
        } else {
            empSelect.innerHTML = '<option value="">(è¯¥ç©å®¶æ— é›‡å‘˜)</option>';
        }
        updateStatBlockSelect(selectedUserId);
        loadEmpForRarity(selectedUserId);
    }

    async function assignDM() {
        const dmId = document.getElementById('adm-assign-dm-list').value;
        showLoading();
        await supabaseClient.from('profiles').update({ assigned_dm_id: dmId || null }).eq('id', selectedUserId);
        hideLoading();
        alert('åˆ†é…æˆåŠŸ');
    }

    // 2. ï¼šDM åˆ é™¤ç©å®¶ç‰©å“é€»è¾‘
    async function admRemoveInv(itemId, itemName, currentQty) {
        // 1. è·å–åˆ é™¤æ•°é‡
        let removeQty = prompt(`è¦æŠŠ [${itemName}] åˆ é™¤å¤šå°‘ä¸ªï¼Ÿ\n(å½“å‰æ‹¥æœ‰: ${currentQty})\nè¾“å…¥ 'all' æˆ–æ•°å­—`, "1");
        
        if (removeQty === null) return;
        if (removeQty === 'all') removeQty = currentQty;
        else removeQty = parseInt(removeQty);

        if (isNaN(removeQty) || removeQty <= 0) return alert('æ— æ•ˆçš„æ•°é‡');
        if (removeQty > currentQty) return alert('åˆ çš„æ•°é‡ä¸èƒ½å¤§äºæ‹¥æœ‰çš„æ•°é‡');

        showLoading();

        try {
            // 2. æ‰§è¡Œåˆ é™¤é€»è¾‘
            let error;
            
            // ã€æ ¸å¿ƒä¿®å¤ã€‘ï¼šåªè¦åˆ é™¤æ•°é‡ç­‰äºå½“å‰åº“å­˜ï¼Œç›´æ¥æ‰§è¡Œ DELETE
            // ä¸å†å»ç®—å‡æ³•ï¼Œé¿å…æµ®ç‚¹æ•°æˆ–é€»è¾‘æ¼æ´
            if (removeQty === currentQty) {
                console.log(`æ‰§è¡Œå½»åº•åˆ é™¤: ID ${itemId}`);
                const res = await supabaseClient
                    .from('user_inventory')
                    .delete()
                    .eq('id', itemId);
                error = res.error;
            } else {
                console.log(`æ‰§è¡Œéƒ¨åˆ†æ‰£é™¤: ID ${itemId}, å‡å» ${removeQty}`);
                const res = await supabaseClient
                    .from('user_inventory')
                    .update({ quantity: currentQty - removeQty })
                    .eq('id', itemId);
                error = res.error;
            }

            if (error) throw error;

            await logAction('DMæ“ä½œ', `ç§»é™¤äº†ç©å®¶(ID:${selectedUserId}) çš„ [${itemName}] x${removeQty}`);

            hideLoading();
            alert('æ“ä½œæˆåŠŸ');
            
            // 3. åˆ·æ–°åˆ—è¡¨ (ç¨å¾®å»¶æ—¶ä¸€ä¸‹ï¼Œé˜²æ­¢æ•°æ®åº“åŒæ­¥æ…¢)
            setTimeout(() => loadUserDetail(), 300);
            
        } catch (e) {
            console.error("åˆ é™¤å¤±è´¥:", e);
            hideLoading();
            alert('åˆ é™¤å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ§åˆ¶å° (F12)');
        }
    }

    async function refreshAllData() {
        await loadUserDate();
        await loadGold();   
        await loadShop();
        await loadTeam();
        await loadInventory();
        await loadEmployees();
    }

    // ================== ï¼šåŠ è½½æ—¥å¿— ==================
    async function loadLogs() {
        const logBox = document.getElementById('audit-log-container');
        logBox.innerHTML = 'åŠ è½½æ—¥å¿—ä¸­...';
        
        const { data: logs } = await supabaseClient
            .from('audit_logs')
            .select('*')
            .order('created_at', { ascending: false })
            .limit(50); // åªçœ‹æœ€è¿‘50æ¡

        if (!logs || logs.length === 0) {
            logBox.innerHTML = 'æš‚æ— æ“ä½œè®°å½•';
            return;
        }

        logBox.innerHTML = logs.map(log => {
            const time = new Date(log.created_at).toLocaleString();
            return `
                <div style="border-bottom:1px solid #eee; padding:8px 0; font-size:0.9em;">
                    <div style="color:#999; font-size:0.8em;">${time} - ${log.user_email}</div>
                    <div><span style="font-weight:bold; color:#333">[${log.action_type}]</span> ${log.details}</div>
                </div>`;
        }).join('');
    }

    // 3. ä¿®æ”¹é‡‘å¸
async function updateUserGold() {
        if (!selectedUserId) return;
        const newGold = document.getElementById('adm-user-gold').value;
        showLoading();
        await supabaseClient.from('profiles').update({ gold_gp: newGold }).eq('id', selectedUserId);
        
        // è®°å½•æ—¥å¿—
        await logAction('DMæ“ä½œ', `ä¿®æ”¹äº†ç©å®¶(ID:${selectedUserId})çš„é‡‘å¸ä¸º ${newGold}`);
        
        hideLoading(); alert('é‡‘å¸å·²ä¿®æ”¹');
    }

    // 4. ä¸Šå¸å‘è£…å¤‡
    async function admAddInv() {
        if (!selectedUserId) return alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªç©å®¶');
        
        const itemName = document.getElementById('adm-new-item').value;
        const itemCat = document.getElementById('adm-new-item-cat').value; // è·å–é€‰ä¸­çš„åˆ†ç±»
        
        if (!itemName) return alert('è¯·è¾“å…¥ç‰©å“å');

        showLoading();
        try {
            // æ£€æŸ¥ç©å®¶èƒŒåŒ…æ˜¯å¦å·²æœ‰ (åŒåä¸”åŒç±»)
            const { data: exist } = await supabaseClient
                .from('user_inventory')
                .select('*')
                .eq('user_id', selectedUserId)
                .eq('item_name', itemName)
                .maybeSingle();

            if (exist) {
                // å·²æœ‰åˆ™æ•°é‡+1
                await supabaseClient.from('user_inventory').update({ quantity: exist.quantity + 1 }).eq('id', exist.id);
            } else {
                // æ²¡æœ‰åˆ™
                await supabaseClient.from('user_inventory').insert([{ 
                    user_id: selectedUserId, 
                    item_name: itemName, 
                    quantity: 1, 
                    category: itemCat 
                }]);
            }

            // è®°å½•æ—¥å¿—
            await logAction('DMæ“ä½œ', `ç»™ç©å®¶(ID:${selectedUserId}) å‘æ”¾äº† [${itemName}] (${itemCat})`);

            hideLoading();
            alert(`[${itemName}] å·²æˆåŠŸå¡å…¥èƒŒåŒ…`);
            document.getElementById('adm-new-item').value = ''; // æ¸…ç©ºè¾“å…¥æ¡†
            loadUserDetail(); // åˆ·æ–°è¯¦æƒ…
        } catch (e) {
            console.error(e);
            hideLoading();
            alert('å‘æ”¾å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ•°æ®åº“è¿æ¥');
        }
    }

    async function uploadAvatar() {
        const f = document.getElementById('adm-emp-avatar').files[0];
        const id = document.getElementById('adm-emp-list').value;
        showLoading();
        const { data } = await supabaseClient.storage.from('avatars').upload(`ava_${Date.now()}`, f);
        if(data) {
            const { data: u } = supabaseClient.storage.from('avatars').getPublicUrl(data.path);
            await supabaseClient.from('employees').update({avatar_url: u.publicUrl}).eq('id', id);
            alert('OK');
        }
        hideLoading();
    }
// --- çœŸæ­£çš„æ¨è¿›æ—¶é—´é€»è¾‘ ---
async function advanceTime() {
        if (!confirm(`ç¡®å®šæ¨è¿› [å½“å‰è§†è§’] çš„æ—¶é—´å—ï¼Ÿ\n(1å·å°†è‡ªåŠ¨æ‰£é™¤è¯¥ç©å®¶çš„è–ªèµ„)`)) return;

        showLoading();
        try {
            // 1. é€»è¾‘è®¡ç®—
            let { year, month, day } = currentDate;
            day++;
            if (day > 30) { day = 1; month++; }
            if (month > 12) { month = 1; year++; }
            
            const nextDate = { year, month, day };

            // 2. è‡ªåŠ¨æ‰£æ¬¾é€»è¾‘ (åªé’ˆå¯¹ viewingUserId)
            if (day === 1) {
                // ã€æ ¸å¿ƒä¿®æ”¹ã€‘è°ƒç”¨é€šç”¨ç®—è´¦å‡½æ•°
                const netIncome = await calculateCityNetIncome(viewingUserId);
                

                if (netIncome !== 0) {
                    const { data: prof } = await supabaseClient.from('profiles').select('gold_gp').eq('id', viewingUserId).single();
                    const newGold = prof.gold_gp + netIncome; 
                    
                    await supabaseClient.from('profiles').update({ gold_gp: newGold }).eq('id', viewingUserId);
                    
                    const logMsg = netIncome > 0 
                        ? `æ–°æœˆç»“ç®—ï¼šåŸå¸‚ç›ˆåˆ©ï¼Œå›½åº“å¢åŠ  ${netIncome} GP` 
                        : `æ–°æœˆç»“ç®—ï¼šåŸå¸‚èµ¤å­—ï¼Œå›½åº“æ‰£é™¤ ${Math.abs(netIncome)} GP`;
                        
                    await logAction('ç³»ç»Ÿç»“ç®—', logMsg);
                    alert(logMsg);
                }
            }

            // 3. æ›´æ–°æ•°æ®åº“ (åªæ›´æ–° viewingUserId çš„æ—¶é—´)
            await supabaseClient
                .from('profiles')
                .update({ world_date: nextDate })
                .eq('id', viewingUserId);

            // 4. åˆ·æ–°
            await logAction('æ—¶é—´æ¨è¿›', `æ—¶é—´å˜æ›´ä¸º FR${year}/${month}/${day} (User:${viewingUserId})`);
            
            // å±€éƒ¨åˆ·æ–°å³å¯ï¼Œä¸éœ€è¦ reload æ•´ä¸ªé¡µé¢
            await refreshAllData(); 
            
        } catch (e) {
            console.error(e);
            alert('æ“ä½œå¤±è´¥');
        } finally {
            hideLoading();
        }
    }

    // --- è®¡ç®—åŸå¸‚æœˆåº¦å‡€æ”¶æ”¯ ---
    async function calculateCityNetIncome(targetUserId) {
        // 1. è·å–æ‰€æœ‰æ•°æ®
        const [statsRes, expensesRes, incomeRes, empRes] = await Promise.all([
            supabaseClient.from('city_stats').select('*').eq('user_id', targetUserId).maybeSingle(),
            supabaseClient.from('city_expenses').select('*').eq('user_id', targetUserId),
            supabaseClient.from('city_incomes').select('*').eq('user_id', targetUserId),
            supabaseClient.from('employees').select('salary').eq('user_id', targetUserId).eq('status', 'åœ¨èŒ')
        ]);

        const stats = statsRes.data || { population: 0, subsidy: 0, tax_rate: 1.2 };
        const expenses = expensesRes.data || [];
        const incomes = incomeRes.data || [];
        const employees = empRes.data || [];

        // --- æ”¶å…¥è®¡ç®— ---
        const taxIncome = Math.ceil(stats.population * stats.tax_rate);
        
        // è´¸æ˜“æ”¶å…¥ (count * unit_price)
        const tradeIncome = incomes.reduce((sum, item) => {
            const count = item.count || 1;
            const price = item.unit_price || item.amount;
            return sum + (count * price);
        }, 0);
        
        const totalIncome = taxIncome + stats.subsidy + tradeIncome;

        // --- æ”¯å‡ºè®¡ç®— ---
        let totalExpense = 0;
        
        // å›ºå®šæ”¯å‡º (å« staff, building, trade_cost)
        if (expenses) {
            expenses.forEach(e => totalExpense += (e.count * e.unit_cost));
        }
        
        // ç‰¹æ®Šé›‡å‘˜æ”¯å‡º
        if (employees) {
            totalExpense += employees.reduce((sum, e) => sum + e.salary, 0);
        }

        const netIncome = totalIncome - totalExpense;
        console.log(`[è´¢åŠ¡æ ¸ç®—] User:${targetUserId} | æ”¶å…¥:${totalIncome} - æ”¯å‡º:${totalExpense} = å‡€åˆ©:${netIncome}`);
        
        return netIncome;
    }


    async function adminAddItem() {
        const name = document.getElementById('adm-shop-name').value;
        const rarity = document.getElementById('adm-shop-rarity').value;
        const category = document.getElementById('adm-shop-cat').value;
        const price = parseInt(document.getElementById('adm-shop-price').value);
        const stock = parseInt(document.getElementById('adm-shop-stock').value);
        const description = document.getElementById('adm-shop-desc').value;
        const targetType = document.getElementById('adm-shop-target').value;

        if (!name || isNaN(price)) return alert('åç§°å’Œä»·æ ¼å¿…å¡«');

        // ã€æ ¸å¿ƒä¿®å¤ã€‘åŒé‡ä¿é™©è·å–ç›®æ ‡ç©å®¶ID
        // å¦‚æœ selectedUserId ä¸ºç©ºï¼Œå°è¯•ç›´æ¥ä»ä¸‹æ‹‰æ¡†å†å–ä¸€æ¬¡
        let targetUserId = selectedUserId;
        if (!targetUserId) {
            targetUserId = document.getElementById('adm-user-list').value;
        }

        // å¦‚æœé€‰äº† private ä½†æ²¡ IDï¼ŒæŠ¥é”™
        if (targetType === 'private') {
            if (!targetUserId) return alert('è¯·å…ˆåœ¨ä¸Šæ–¹ [ç©å®¶èµ„äº§æ“æ§] åˆ—è¡¨é€‰æ‹©ä¸€ä¸ªç©å®¶ï¼');
        } else {
            targetUserId = null; // å…¬å…±å•†å“ user_id ä¸ºç©º
        }

        showLoading();
        try {
            const { error } = await supabaseClient.from('shop_items').insert([{
                name, rarity, category, price, stock, description,
                user_id: targetUserId // å†™å…¥å½’å±
            }]);

            if (error) throw error;

            await logAction('DMè¿›è´§', `ä¸Šæ¶äº† [${name}] (${targetType === 'private' ? 'ç‰¹ä¾›' : 'å…¬å¼€'})`);
            alert('ä¸Šæ¶æˆåŠŸ');
            
            // æ¸…ç©ºè¾“å…¥
            document.getElementById('adm-shop-name').value = '';
            document.getElementById('adm-shop-price').value = '';
            document.getElementById('adm-shop-desc').value = '';
            loadShop();
        } catch (e) {
            console.error(e);
            alert('å¤±è´¥ï¼š' + e.message);
        } finally {
            hideLoading();
        }
    }


async function loadLoginLogs() {
        const container = document.getElementById('login-log-container');
        container.innerHTML = 'åŠ è½½ä¸­...';

        const { data: logs } = await supabaseClient
            .from('login_logs')
            .select('*')
            .order('created_at', { ascending: false })
            .limit(50);

        if (!logs) return;

        container.innerHTML = logs.map(log => {
            const time = new Date(log.created_at).toLocaleString();
            const isFail = log.status.indexOf('å¤±è´¥') !== -1;
            const color = isFail ? '#e74c3c' : '#2ecc71';
            const bgColor = isFail ? '#fff0f0' : '#f0fff0';
            const uaParts = log.user_agent.split(' | ');
            const deviceId = uaParts[0]; 

            return `
                <div style="border-bottom:1px solid #eee; padding:8px; background:${bgColor}; margin-bottom:2px; border-radius:4px;">
                    <div style="display:flex; justify-content:space-between; font-size:0.8em;">
                        <span style="color:#666;">${time}</span>
                        <span style="font-weight:bold; color:${color}">${isFail ? 'æ‹’ç»è®¿é—®' : 'éªŒè¯é€šè¿‡'}</span>
                    </div>
                    <div style="font-weight:bold; margin:3px 0;">ç”¨æˆ·: ${log.email}</div>
                    <div style="font-size:0.8em; color:#444;">IP: ${log.ip_address}</div>
                    <div style="font-size:0.7em; color:#999; word-break:break-all;">è®¾å¤‡æŒ‡çº¹: ${deviceId}</div>
                    ${isFail ? `<div style="color:red; font-size:0.8em; font-weight:bold;">${log.status}</div>` : ''}
                </div>`;
        }).join('');
    }
    // --- åŠ è½½æ‰€æœ‰è´¦å· (æŸ¥ profiles è¡¨) ---
    async function loadAllAccounts() {
        const container = document.getElementById('account-list-container');
        container.innerHTML = 'æ­£åœ¨æ‹‰å–å…¨æœåå•...';

        // profiles è¡¨é‡Œæœ‰ id, email, assigned_dm_id 
        const { data: users, error } = await supabaseClient
            .from('profiles')
            .select('*')
            .order('email'); 
        
        if (error) {
            container.innerHTML = `<span style="color:red">åŠ è½½å¤±è´¥: ${error.message}</span>`;
            return;
        }

        // è·å–æƒé™è¡¨
        const { data: roles } = await supabaseClient.from('admin_users').select('*');
        
        const getRole = (id) => {
            const r = roles.find(x => x.id === id);
            return r ? r.role_level : 'player';
        };

        // æ¸²æŸ“åˆ—è¡¨
        container.innerHTML = users.map(u => {
            const role = getRole(u.id);
            const roleColor = role === 'root' ? 'red' : (role === 'dm' ? 'blue' : 'green');
            const isMe = u.id === myId;
            // å› ä¸º profiles è¡¨å¯èƒ½æ²¡æœ‰ created_atï¼Œæˆ‘ä»¬æš‚æ—¶ä¸æ˜¾ç¤ºæ³¨å†Œæ—¶é—´ï¼Œæˆ–è€…æ˜¾ç¤º "å·²æ¿€æ´»"
            const statusText = u.assigned_dm_id ? "å·²åˆ†é…DM" : "æœªåˆ†é…";

            return `
                <div style="border-bottom:1px solid #eee; padding:8px 4px; display:flex; justify-content:space-between; align-items:center;">
                    <div style="overflow:hidden; text-overflow:ellipsis;">
                        <div style="font-weight:bold;">${u.email}</div>
                        <div style="font-size:0.8em; color:#999;">${statusText}</div>
                    </div>
                    <div style="text-align:right;">
                        <span style="font-size:0.8em; color:${roleColor}; font-weight:bold; margin-right:5px;">${role.toUpperCase()}</span>
                        ${!isMe ? `
                        <select onchange="changeUserRole('${u.id}', this.value)" style="font-size:0.8em; padding:2px;">
                            <option value="">-- æ”¹æƒé™ --</option>
                            <option value="player">è®¾ä¸º Player</option>
                            <option value="dm">è®¾ä¸º DM</option>
                        </select>` : '<span style="font-size:0.8em; color:#ccc;">(è‡ªå·±)</span>'}
                    </div>
                </div>`;
        }).join('');
    }

    // --- ä¿®æ”¹ç”¨æˆ·æƒé™ ---
    async function changeUserRole(targetId, newRole) {
        if (!newRole) return;
        if (!confirm(`ç¡®å®šè¦å°†è¯¥ç”¨æˆ·çš„æƒé™ä¿®æ”¹ä¸º [${newRole.toUpperCase()}] å—ï¼Ÿ`)) return;

        showLoading();
        try {
            const { error } = await supabaseClient.rpc('update_user_role', { 
                target_id: targetId, 
                new_role: newRole 
            });

            if (error) throw error;

            await logAction('æƒé™ä¿®æ”¹', `å°†ç”¨æˆ·(ID:${targetId}) æƒé™è®¾ä¸º ${newRole}`);
            alert('ä¿®æ”¹æˆåŠŸ');
            loadAllAccounts(); // åˆ·æ–°åˆ—è¡¨
        } catch (e) {
            console.error(e);
            alert('ä¿®æ”¹å¤±è´¥: ' + e.message);
        } finally {
            hideLoading();
        }
    }
    // --- å›¾é‰´æœç´¢åŠŸèƒ½ ---
    async function searchCompendium() {
        const query = document.getElementById('compendium-search').value;
        const resultBox = document.getElementById('compendium-results');
        
        if (!query) return;
        resultBox.innerHTML = 'æŸ¥æ‰¾ä¸­...';

        // ä½¿ç”¨ ilike è¿›è¡Œæ¨¡ç³Šæœç´¢
        const { data } = await supabaseClient
            .from('compendium_items')
            .select('*')
            .ilike('name', `%${query}%`)
            .limit(10);

        if (!data || data.length === 0) {
            resultBox.innerHTML = '<div style="padding:5px; color:#999">æœªæ‰¾åˆ°ç›¸å…³ç‰©å“</div>';
            return;
        }

        resultBox.innerHTML = data.map(item => `
            <div onclick='fillShopForm(${JSON.stringify(item)})' 
                 style="padding:5px; border-bottom:1px solid #eee; cursor:pointer; font-size:0.9em; display:flex; justify-content:space-between;">
                <span>${item.name}</span>
                <span style="color:#666">${item.price} GP</span>
            </div>
        `).join('');
    }

    // é€‰ä¸­åè‡ªåŠ¨å¡«è¡¨
    function fillShopForm(item) {
        document.getElementById('adm-shop-name').value = item.name;
        document.getElementById('adm-shop-price').value = item.price;
        document.getElementById('adm-shop-desc').value = item.description || '';
        
        // å°è¯•è‡ªåŠ¨åŒ¹é…ä¸‹æ‹‰æ¡†
        setSelect('adm-shop-rarity', item.rarity);
        setSelect('adm-shop-cat', item.category);
        
        document.getElementById('compendium-results').innerHTML = ''; // æ¸…ç©ºç»“æœ
    }
    // --- åœ¨çº¿çŠ¶æ€ç³»ç»Ÿ ---//
    function initPresenceSystem() {
    // é˜²æ­¢é‡å¤è¿æ¥
    if (presenceChannel) {
        supabaseClient.removeChannel(presenceChannel);
    }

    console.log("åˆå§‹åŒ–åœ¨çº¿é¢‘é“:", currentUserEmail);

    // 1. åˆ›å»ºé¢‘é“
    presenceChannel = supabaseClient.channel('online-users', {
        config: {
            presence: {
                key: currentUserEmail, 
            },
        },
    });

    // 2. ç»‘å®šç›‘å¬å™¨
    presenceChannel
        .on('presence', { event: 'sync' }, () => {
            const newState = presenceChannel.presenceState();
            console.log("åŒæ­¥åœ¨çº¿åå•:", newState); // è°ƒè¯•æ—¥å¿—
            renderOnlineList(newState);
        })
        .on('presence', { event: 'join' }, ({ key, newPresences }) => {
            console.log("ç”¨æˆ·åŠ å…¥:", key);
        })
        .on('presence', { event: 'leave' }, ({ key, leftPresences }) => {
            console.log("ç”¨æˆ·ç¦»å¼€:", key);
        });

    // 3. å¼€å§‹è®¢é˜…
    presenceChannel.subscribe(async (status) => {
        if (status === 'SUBSCRIBED') {
            console.log("åœ¨çº¿é¢‘é“è®¢é˜…æˆåŠŸï¼");
            // å¹¿æ’­è‡ªå·±çš„çŠ¶æ€
            const trackStatus = await presenceChannel.track({ 
                email: currentUserEmail,
                role: currentUserRole,
                online_at: new Date().toISOString()
            });
            
            if (trackStatus !== 'ok') {
                console.error("åœ¨çº¿çŠ¶æ€å¹¿æ’­å¤±è´¥");
            } else {
                // å¦‚æœä¸æ˜¯ Rootï¼Œè‡ªå·±ä¹Ÿåˆ·æ–°ä¸€ä¸‹åˆ—è¡¨çœ‹çœ‹æœ‰æ²¡æœ‰åˆ«äºº
                const state = presenceChannel.presenceState();
                renderOnlineList(state); 
            }
        } else {
            console.error("åœ¨çº¿é¢‘é“è®¢é˜…å¤±è´¥ï¼ŒçŠ¶æ€:", status);
            document.getElementById('online-users-container').innerHTML = 
                '<div style="color:red">è¿æ¥æ–­å¼€ (CSPæˆ–ç½‘ç»œæ‹¦æˆª)</div>';
        }
    });
}

    // --- æ¸²æŸ“åœ¨çº¿åˆ—è¡¨ ---
    function renderOnlineList(presences) {
        const container = document.getElementById('online-users-container');
        if (!container) return;

        // å°† Presence å¯¹è±¡è½¬æ¢ä¸ºæ•°ç»„
        const onlineUsers = [];
        for (const key in presences) {
            // æ¯ä¸ª key å¯èƒ½å¯¹åº”å¤šä¸ªè¿æ¥ï¼ˆå¤šè®¾å¤‡ç™»å½•ï¼‰ï¼Œæˆ‘ä»¬å–ç¬¬ä¸€ä¸ª
            const userState = presences[key][0]; 
            onlineUsers.push({
                email: key, // key å°±æ˜¯æˆ‘ä»¬è®¾ç½®çš„ email
                ...userState // å±•å¼€ role å’Œ online_at
            });
        }

        if (onlineUsers.length === 0) {
            container.innerHTML = '<div style="color:#999; text-align:center; padding:10px;">å½“å‰ä½é¢ç©ºæ— ä¸€äºº...</div>';
            return;
        }

        container.innerHTML = onlineUsers.map(user => {
            const roleColor = user.role === 'root' ? '#e74c3c' : (user.role === 'dm' ? '#3498db' : '#2ecc71');
            const roleName = user.role ? user.role.toUpperCase() : 'PLAYER';
            
            return `
            <div style="border-bottom:1px solid #eee; padding:8px 4px; display:flex; justify-content:space-between; align-items:center;">
                <div style="display:flex; align-items:center; gap:8px;">
                    <span style="display:inline-block; width:8px; height:8px; background-color:${roleColor}; border-radius:50%; box-shadow: 0 0 5px ${roleColor};"></span>
                    <span style="font-weight:bold; font-size:0.9em;">${user.email}</span>
                </div>
                <span style="font-size:0.75em; color:${roleColor}; font-weight:bold; border:1px solid ${roleColor}; padding:1px 4px; border-radius:4px;">${roleName}</span>
            </div>
            `;
        }).join('');
    }

    // è¾…åŠ©å‡½æ•°ï¼šè®¾ç½®ä¸‹æ‹‰æ¡†çš„å€¼
    function setSelect(id, value) {
        const select = document.getElementById(id);
        if(!value) return;
        for (let i = 0; i < select.options.length; i++) {
            if (select.options[i].value === value) {
                select.selectedIndex = i;
                break;
            }
        }
    }
    // --- éšæœºè¿›è´§åŠŸèƒ½ ---
    async function randomRestock() {
        // 1. ç¡®å®šè¿›è´§ç›®æ ‡
        // å¦‚æœ selectedUserId æœ‰å€¼ï¼Œè¯´æ˜ DM é€‰ä¸­äº†æŸä¸ªç©å®¶ï¼Œè¿›è´§ç»™ä»–
        // å¦‚æœæ²¡å€¼ (null)ï¼Œè¯´æ˜æ˜¯å…¬å…±è¿›è´§
        let targetId = selectedUserId || null;
        let targetName = targetId ? 'æŒ‡å®šç©å®¶ç‰¹ä¾›' : 'å…¨æœå…¬å…±';

        if (!confirm(`ç¡®å®šè¦æ‰§è¡Œ [æ ‡å‡†éšæœºåŒ…] è¿›è´§å—ï¼Ÿ\n\nç›®æ ‡: ${targetName}\nå†…å®¹: 2ä¼ è¯´ + 12æçç¨€ + 20çç¨€ + 30éæ™®é€š + 10æ™®é€š\n\n(æ³¨æ„ï¼šè¿™ä¼šç›´æ¥æ·»åŠ åˆ°é›†å¸‚ï¼Œä¸ä¼šè¦†ç›–å·²æœ‰å•†å“)`)) return;

        showLoading();
        try {
            // 2. è°ƒç”¨æ•°æ®åº“å‡½æ•°
            const { error } = await supabaseClient.rpc('admin_random_restock', { 
                target_user_id: targetId 
            });

            if (error) throw error;

            // 3. è®°å½•æ—¥å¿—
            await logAction('DMéšæœºè¿›è´§', `æ‰§è¡Œäº†æ ‡å‡†éšæœºåŒ…è¿›è´§ (ç›®æ ‡: ${targetName})`);

            alert('è¿›è´§å®Œæˆï¼å…±è®¡ä¸Šæ¶ 37 ä»¶ç‰©å“ã€‚');
            loadShop(); // åˆ·æ–°é›†å¸‚æ˜¾ç¤º
        } catch (e) {
            console.error(e);
            alert('è¿›è´§å¤±è´¥: ' + e.message);
        } finally {
            hideLoading();
        }
    }
    

    // è¾…åŠ©å‡½æ•°ï¼šæ¸²æŸ“åœ¨çº¿åˆ—è¡¨
    function renderOnlineList(presences) {
        const container = document.getElementById('online-users-container');
        if (!container) return;

        const onlineUsers = Object.keys(presences).map(key => {
            const user = presences[key][0]; // presenceState è¿”å›çš„æ˜¯ä¸€ä¸ªæ•°ç»„
            return {
                email: key,
                role: user.role,
                online_at: user.online_at
            };
        });

        if (onlineUsers.length === 0) {
            container.innerHTML = '<div style="color:#999; text-align:center;">å½“å‰ä½é¢ç©ºæ— ä¸€äºº...</div>';
            return;
        }

        container.innerHTML = onlineUsers.map(user => {
            const roleColor = user.role === 'root' ? 'red' : (user.role === 'dm' ? 'blue' : 'green');
            return `
            <div style="border-bottom:1px solid #eee; padding:8px 4px; display:flex; justify-content:space-between; align-items:center;">
                <div>
                    <div style="font-weight:bold; display:flex; align-items:center; gap:8px;">
                        <span style="display:inline-block; width:8px; height:8px; background-color:${roleColor}; border-radius:50%;"></span>
                        ${user.email}
                    </div>
                </div>
                <span style="font-size:0.8em; color:${roleColor}; font-weight:bold;">${user.role.toUpperCase()}</span>
            </div>
            `;
        }).join('');
    }

    // --- æ ¹æ®æ—¥æœŸå’Œç‰©å“åç”Ÿæˆå›ºå®šçš„éšæœºæŠ˜æ‰£ ---
    function getDailySellRatio(itemName) {
        // 1. è·å–æ¸¸æˆå†…æ—¥æœŸå­—ç¬¦ä¸² (å¦‚ "1494-2-12")
        const dateStr = `${currentDate.year}-${currentDate.month}-${currentDate.day}`;
        
        // 2. ç»„åˆç§å­ï¼šæ—¥æœŸ + ç©å®¶ID + ç‰©å“å
        // è¿™æ ·æ¯ä¸ªäººã€æ¯å¤©ã€æ¯ä»¶ç‰©å“çš„æŠ˜æ‰£éƒ½æ˜¯ç‹¬ç«‹çš„ï¼Œä¸”å…¨å¤©å›ºå®š
        const seedString = `${dateStr}-${viewingUserId}-${itemName}`;

        // 3. ç®€å•çš„å“ˆå¸Œç®—æ³• (å°†å­—ç¬¦ä¸²è½¬ä¸ºæ•°å­—)
        let hash = 0;
        for (let i = 0; i < seedString.length; i++) {
            const char = seedString.charCodeAt(i);
            hash = ((hash << 5) - hash) + char;
            hash = hash & hash; 
        }

        // 4. å½’ä¸€åŒ–åˆ° 0 ~ 1 ä¹‹é—´
        const random = Math.abs(hash) / 2147483647;

        // 5. æ˜ å°„åˆ° 0.6 ~ 0.9 ä¹‹é—´
        return 0.6 + (random * 0.3);
    }

    async function bulkAddWanted() {
        if (!selectedUserId) return alert('è¯·å…ˆé€‰æ‹©ç›®æ ‡ç©å®¶çš„ä½é¢');
        const text = document.getElementById('adm-wanted-bulk').value;
        if (!text) return;

        const lines = text.split('\n');
        const posters = lines.map(line => {
            const [name, amount, source] = line.split(',');
            return {
                user_id: selectedUserId,
                target_name: name.trim(),
                bounty_amount: parseInt(amount) || 0,
                source_org: source ? source.trim() : 'UNKNOWN',
                status_text: 'DEAD OR ALIVE'
            };
        });

        showLoading();
        const { error } = await supabaseClient.from('wanted_posters').insert(posters);
        if (error) alert(error.message);
        else {
            alert(`æˆåŠŸç­¾å‘ ${posters.length} ä»½æ‚¬èµä»¤ï¼`);
            document.getElementById('adm-wanted-bulk').value = '';
        }
        hideLoading();
    }

    async function addWantedPoster() {
        if (!selectedUserId) return alert('è¯·å…ˆé€‰æ‹©ç©å®¶');
        const name = document.getElementById('adm-wanted-name').value;
        const amount = document.getElementById('adm-wanted-amount').value;
        const status = document.getElementById('adm-wanted-status').value || 'DEAD OR ALIVE';
        const source = document.getElementById('adm-wanted-source').value;
        const avatar = document.getElementById('adm-wanted-avatar').value;

        if(!name || !amount) return alert('å§“åå’Œé‡‘é¢å¿…å¡«');

        showLoading();
        const { error } = await supabaseClient.from('wanted_posters').insert([{
            user_id: selectedUserId,
            target_name: name,
            bounty_amount: amount,
            status_text: status,
            source_org: source,
            avatar_url: avatar
        }]);

        if (error) alert(error.message);
        else {
            alert('æ‚¬èµä»¤å·²ç­¾å‘');
            // æ¸…ç©º
            document.getElementById('adm-wanted-name').value = '';
        }
        hideLoading();
    }

    function toggleShopMode() {
        isSellMode = !isSellMode;
        const btn = document.getElementById('shop-mode-btn');
        const input = document.getElementById('shop-search-input');
        
        if (isSellMode) {
            btn.innerText = "ğŸ”™ è¿”å›ï¼šæˆ‘è¦è´­ä¹°";
            btn.style.background = "#e67e22"; // æ©™è‰²è¡¨ç¤ºå‡ºå”®çŠ¶æ€
            input.placeholder = "ğŸ” æœç´¢èƒŒåŒ…é‡Œçš„ç‰©å“...";
        } else {
            btn.innerText = "ğŸ”„ åˆ‡æ¢ï¼šæˆ‘è¦å‡ºå”®";
            btn.style.background = "#333";
            input.placeholder = "ğŸ” æœç´¢é›†å¸‚å•†å“...";
        }
        refreshShopView(); // åˆ·æ–°æ˜¾ç¤º
    }

    // ç»Ÿä¸€çš„åˆ·æ–°å…¥å£
    function refreshShopView() {
        if (isSellMode) {
            loadSellShop();
        } else {
            loadShop();
        }
    }

    // --- åŠ è½½å‡ºå”®ç•Œé¢ ---
    async function loadSellShop() {
        const grid = document.getElementById('shop-grid');
        const searchTerm = document.getElementById('shop-search-input').value.toLowerCase();
        grid.innerHTML = 'æ­£åœ¨ä¼°ä»·ä¸­...';

        // 1. è·å–ç©å®¶èƒŒåŒ…
        const { data: inventory } = await supabaseClient
            .from('user_inventory')
            .select('*')
            .eq('user_id', viewingUserId);

        if (!inventory || inventory.length === 0) {
            grid.innerHTML = '<div style="color:#999; padding:20px;">èƒŒåŒ…é‡Œç©ºç©ºå¦‚ä¹Ÿï¼Œæ²¡ä¸œè¥¿å¯å–ã€‚</div>';
            return;
        }

        // 2. æå–ç‰©å“åå­—åˆ—è¡¨ï¼Œå» compendium_items (å›¾é‰´) æŸ¥åŸºç¡€ä»·æ ¼
        const itemNames = inventory.map(i => i.item_name);
        const { data: prices } = await supabaseClient
            .from('compendium_items')
            .select('name, price, rarity')
            .in('name', itemNames);

        // 3. æ„å»ºä»·æ ¼å­—å…¸ (åå­— -> ä»·æ ¼å¯¹è±¡)
        const priceMap = {};
        if (prices) {
            prices.forEach(p => priceMap[p.name] = p);
        }

        grid.innerHTML = '';

        // 4. æ¸²æŸ“å¡ç‰‡
        inventory.forEach(item => {
            // æœç´¢è¿‡æ»¤
            if (searchTerm && !item.item_name.toLowerCase().includes(searchTerm)) return;

            const baseInfo = priceMap[item.item_name];
            let sellHtml = '';
            let cardStyle = '';

            if (baseInfo && baseInfo.price) {
                // --- æœ‰å›¾é‰´æ•°æ®ï¼Œå¯ä»¥å– ---
                const ratio = getDailySellRatio(item.item_name); // è·å–ä»Šæ—¥æŠ˜æ‰£
                const sellPrice = Math.floor(baseInfo.price * ratio); // æœ€ç»ˆå›æ”¶ä»·
                const discount = Math.round(ratio * 100); // æ˜¾ç¤ºç™¾åˆ†æ¯”

                sellHtml = `
                    <div style="font-size:0.8em; color:#999;">åŸä»·: ${baseInfo.price} GP</div>
                    <div style="color:#e67e22; font-weight:bold; font-size:1.1em; margin:5px 0;">
                        å›æ”¶ä»·: ${sellPrice} GP <span style="font-size:0.7em; color:#666;">(${discount}%)</span>
                    </div>
                    <div style="font-size:0.75em; color:#aaa; margin-bottom:5px;">ä»Šæ—¥æ±‡ç‡å·²é”å®š</div>
                    <button class="btn-buy" onclick="sellItem(${item.id}, '${item.item_name}', ${sellPrice}, ${item.quantity})" style="border-color:#e67e22; color:#e67e22;">
                        å‡ºå”®
                    </button>
                `;
            } else {
                // --- æ— å›¾é‰´æ•°æ®ï¼Œä¸å¯å– ---
                cardStyle = 'opacity: 0.6; background:#f9f9f9;';
                sellHtml = `
                    <div style="color:#999; margin:10px 0; font-size:0.9em;">
                        æ— æ³•ä¼°ä»·<br>
                        <span style="font-size:0.8em">(å›¾é‰´ä¸­æœªæ”¶å½•æ­¤ç‰©å“)</span>
                    </div>
                    <button disabled style="width:100%; padding:8px; border:1px solid #ddd; background:#eee; color:#aaa; border-radius:4px; cursor:not-allowed;">
                        ä¸å¯å‡ºå”®
                    </button>
                `;
            }

            // æ¸²æŸ“
            grid.innerHTML += `
                <div class="card" style="text-align:center; ${cardStyle}">
                    <div style="font-weight:bold; font-size:1.1em;">${item.item_name}</div>
                    <div style="color:#666; font-size:0.9em;">åº“å­˜: ${item.quantity}</div>
                    <hr style="margin:10px 0; border:0; border-top:1px dashed #eee;">
                    ${sellHtml}
                </div>
            `;
        });
    }

    // --- æ‰§è¡Œå‡ºå”® ---
    async function sellItem(invId, itemName, unitPrice, maxQty) {
        const qtyStr = prompt(`å‡ºå”® [${itemName}] (å•ä»·: ${unitPrice} GP)\nå½“å‰æ‹¥æœ‰: ${maxQty}\n\nè¯·è¾“å…¥å‡ºå”®æ•°é‡:`, "1");
        if (qtyStr === null) return;
        const qty = parseInt(qtyStr);

        if (isNaN(qty) || qty <= 0) return alert("æ•°é‡æ— æ•ˆ");
        if (qty > maxQty) return alert("åº“å­˜ä¸è¶³");

        showLoading();
        try {
            // 1. å†æ¬¡ç¡®è®¤é‡‘å¸ (é˜²æ­¢ userProfile æ²¡åŠ è½½)
            if (!userProfile) await loadGold();

            const totalPrice = unitPrice * qty;

            // 2. æ‰£é™¤èƒŒåŒ…ç‰©å“
            if (qty === maxQty) {
                await supabaseClient.from('user_inventory').delete().eq('id', invId);
            } else {
                await supabaseClient.from('user_inventory').update({ quantity: maxQty - qty }).eq('id', invId);
            }

            // 3. å¢åŠ ç©å®¶é‡‘å¸
            const newGold = userProfile.gold_gp + totalPrice;
            await supabaseClient.from('profiles').update({ gold_gp: newGold }).eq('id', viewingUserId);

            // 4. è®°å½•æ—¥å¿—
            await logAction('å‡ºå”®ç‰©å“', `ä»¥ ${unitPrice} GP çš„å•ä»·å‡ºå”®äº† [${itemName}] x${qty}ï¼Œè·åˆ© ${totalPrice} GP`);

            alert(`å‡ºå”®æˆåŠŸï¼è·å¾— ${totalPrice} GP`);
            
            // åˆ·æ–°
            await loadGold(); // æ›´æ–°å³ä¸Šè§’é‡‘å¸
            loadSellShop();   // åˆ·æ–°åˆ—è¡¨çŠ¶æ€
        } catch (e) {
            console.error(e);
            alert("äº¤æ˜“å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•");
        } finally {
            hideLoading();
        }
    }
    // --- è§’è‰²å±æ€§å¡é€»è¾‘ ---

    async function openSheetModal(empId) {
        document.getElementById('sheet-modal').style.display = 'flex';
        const container = document.getElementById('sheet-content');
        container.innerHTML = '<div style="padding:40px; text-align:center; color:#822000;">æ­£åœ¨è¯»å–...</div>';

        // é‡æ–°è·å–è¯¥é›‡å‘˜çš„æœ€æ–°æ•°æ®
        const { data: emp } = await supabaseClient
            .from('employees')
            .select('stat_block, name')
            .eq('id', empId)
            .single();

        if (!emp || !emp.stat_block) {
            container.innerHTML = '<div style="background:#fff; padding:20px;">æš‚æ— è¯¦ç»†æ•°æ®</div>';
            return;
        }

        renderStatBlock(emp.name, emp.stat_block);
    }

    function renderStatBlock(name, data) {
        const c = document.getElementById('sheet-content');
        
        // 1. æ¸²æŸ“å±æ€§å…­ç»´
        const statsHtml = Object.keys(data.stats).map(key => `
            <div class="stat-box">
                <strong>${key.toUpperCase()}</strong>
                <span>${data.stats[key].score} (${data.stats[key].mod})</span>
            </div>
        `).join('');

        // 2. æ¸²æŸ“é€šç”¨å±æ€§è¡Œ
        const propsHtml = data.props.map(p => `
            <div class="property-line"><strong>${p.label}:</strong> ${p.value}</div>
        `).join('');

        // 3. æ¸²æŸ“ç‰¹æ€§ (Traits)
        const traitsHtml = data.traits ? data.traits.map(t => `
            <div class="trait-section">
                <span class="trait-name">${t.name}.</span> ${t.desc.replace(/\n/g, '<br>')}
            </div>
        `).join('') : '';

        // 4. æ¸²æŸ“åŠ¨ä½œ (Actions)
        const actionsHtml = data.actions ? `
            <div class="action-header">åŠ¨ä½œ</div>
            ${data.actions.map(a => `
                <div class="trait-section">
                    <span class="trait-name">${a.name}.</span> ${a.desc.replace(/\n/g, '<br>')}
                </div>
            `).join('')}
        ` : '';

        // 5. æ¸²æŸ“é™„èµ åŠ¨ä½œ (Bonus Actions)
        const bonusHtml = data.bonus_actions ? `
            <div class="action-header">é™„èµ åŠ¨ä½œ</div>
            ${data.bonus_actions.map(a => `
                <div class="trait-section">
                    <span class="trait-name">${a.name}.</span> ${a.desc.replace(/\n/g, '<br>')}
                </div>
            `).join('')}
        ` : '';

        // 6. æ¸²æŸ“ååº” (Reactions)
        const reactionsHtml = data.reactions ? `
            <div class="action-header">ååº”</div>
            ${data.reactions.map(r => `
                <div class="trait-section">
                    <span class="trait-name">${r.name}.</span> ${r.desc.replace(/\n/g, '<br>')}
                </div>
            `).join('')}
        ` : '';

        // 7. æ¸²æŸ“ä¼ å¥‡åŠ¨ä½œ (Legendary Actions)
        const legendaryHtml = data.legendary_actions ? `
            <div class="action-header">ä¼ å¥‡åŠ¨ä½œ</div>
            <div class="trait-section" style="margin-bottom:10px;">${data.legendary_desc || 'è¯¥ç”Ÿç‰©å¯ä»¥é‡‡å– 3 ä¸ªä¼ å¥‡åŠ¨ä½œï¼Œåœ¨å¦ä¸€ç”Ÿç‰©çš„å›åˆç»“æŸæ—¶é€‰æ‹©æ‰§è¡Œã€‚'}</div>
            ${data.legendary_actions.map(l => `
                <div class="trait-section">
                    <span class="trait-name">${l.name}.</span> ${l.desc.replace(/\n/g, '<br>')}
                </div>
            `).join('')}
        ` : '';

        // 8. æ¸²æŸ“æ³•æœ¯
        let spellsHtml = '';
        if (data.spells) {
            let listContent = '';
            if (Array.isArray(data.spells.list)) {
                listContent = data.spells.list.map(s => `
                    <div class="trait-section">
                        <span class="trait-name">${s.level}:</span> ${s.spells}
                    </div>
                `).join('');
            } else {
                listContent = `<div class="trait-section">${data.spells.list || ''}</div>`;
            }

            spellsHtml = `
                <div class="action-header">æ–½æ³•</div>
                <div class="trait-section" style="margin-bottom:5px;"><em>${data.spells.header}</em></div>
                ${listContent}
            `;
        }

        // 9. ç»„è£…æ•´ä½“ HTML
        c.innerHTML = `
            <div class="stat-block-container">
                <div class="stat-header">
                    <h2>${name}</h2>
                    <i>${data.meta}</i>
                </div>
                <hr class="tapered-rule">
                
                <div class="property-line"><strong>æŠ¤ç”²ç­‰çº§:</strong> ${data.ac}</div>
                <div class="property-line"><strong>ç”Ÿå‘½å€¼:</strong> ${data.hp}</div>
                <div class="property-line"><strong>é€Ÿåº¦:</strong> ${data.speed}</div>
                
                <hr class="red-rule">
                <div class="stat-grid">${statsHtml}</div>
                <hr class="red-rule">
                
                ${propsHtml}
                
                <hr class="tapered-rule">
                ${traitsHtml}
                
                ${actionsHtml}
                ${bonusHtml}
                ${reactionsHtml}
                ${legendaryHtml}
                ${spellsHtml}
            </div>
        `;
    }

    // --- DM æ§åˆ¶å°åŠŸèƒ½ï¼šåŠ è½½é›‡å‘˜åˆ°ä¸‹æ‹‰æ¡† ---

    async function updateStatBlockSelect(userId) {
        const select = document.getElementById('adm-sheet-list');
        select.innerHTML = '<option>åŠ è½½ä¸­...</option>';
        const { data: emps } = await supabaseClient.from('employees').select('id, name, stat_block').eq('user_id', userId);
        
        select.innerHTML = '<option value="">-- é€‰æ‹©é›‡å‘˜å½•å…¥æ•°æ® --</option>';
        if (emps) {
            emps.forEach(e => {
                select.innerHTML += `<option value="${e.id}">${e.name} ${e.stat_block ? 'âœ…' : ''}</option>`;
            });
            
            // ç›‘å¬ä¸‹æ‹‰æ¡†å˜åŒ–ï¼Œå¦‚æœé€‰ä¸­äº†äººï¼Œè‡ªåŠ¨æŠŠç°æœ‰çš„ JSON å¡«è¿›å»æ–¹ä¾¿ä¿®æ”¹
            select.onchange = () => {
                const emp = emps.find(x => x.id == select.value);
                if (emp && emp.stat_block) {
                    document.getElementById('adm-sheet-json').value = JSON.stringify(emp.stat_block, null, 2);
                } else {
                    document.getElementById('adm-sheet-json').value = '';
                }
            };
        }

        if (!emp.stat_block) {
    document.getElementById('adm-sheet-json').value = JSON.stringify({
        name: "å§“å",
        meta: "ç§æ—/ç±»å‹",
        basic_info: {
            gender: "ç”·/å¥³",
            origin: "å‡ºèº«åœ°",
            height: "175cm",
            birthday: "xæœˆxæ—¥",
            tags: ["æ ‡ç­¾1", "æ ‡ç­¾2"]
        },
        resume: "åœ¨æ­¤è¾“å…¥å®¢è§‚å±¥å†æ–‡æœ¬...",
        hp: "100",
        ac: "15",
        speed: "30å°º",
        stats: { str:{score:10, mod:"+0"}, dex:{score:10, mod:"+0"}, con:{score:10, mod:"+0"}, int:{score:10, mod:"+0"}, wis:{score:10, mod:"+0"}, cha:{score:10, mod:"+0"} },
        props: [],
        traits: [],
        actions: []
    }, null, 2);
}
    }

    async function saveCharacterSheet() {
        const empId = document.getElementById('adm-sheet-list').value;
        const jsonStr = document.getElementById('adm-sheet-json').value;

        if (!empId) return alert('è¯·é€‰æ‹©é›‡å‘˜');
        if (!jsonStr) return alert('è¯·è¾“å…¥ JSON');

        try {
            const jsonObj = JSON.parse(jsonStr); // æ ¡éªŒæ ¼å¼
            
            showLoading();
            const { error } = await supabaseClient
                .from('employees')
                .update({ stat_block: jsonObj })
                .eq('id', empId);

            if (error) throw error;
            alert('è§’è‰²å¡ä¿å­˜æˆåŠŸï¼');
            // åˆ·æ–°æ˜¾ç¤º
            updateStatBlockSelect(viewingUserId); 
        } catch (e) {
            alert('ä¿å­˜å¤±è´¥ï¼šJSON æ ¼å¼é”™è¯¯æˆ–ç½‘ç»œé—®é¢˜\n' + e.message);
        } finally {
            hideLoading();
        }
    }

    async function deleteCharacterSheet() {
        const empId = document.getElementById('adm-sheet-list').value;
        
        // 1. æ£€æŸ¥æ˜¯å¦é€‰æ‹©äº†äºº
        if (!empId) return alert('è¯·å…ˆé€‰æ‹©è¦æ“ä½œçš„é›‡å‘˜');

        // 2. äºŒæ¬¡ç¡®è®¤é˜²æ­¢æ‰‹æ»‘
        if (!confirm('âš ï¸ è­¦å‘Šï¼šç¡®å®šè¦å½»åº•åˆ é™¤è¯¥è§’è‰²çš„å±æ€§å¡æ•°æ®å—ï¼Ÿ\n\n(æ­¤æ“ä½œä¸å¯æ’¤é”€ï¼Œè¯¥è§’è‰²å°†ä¸å†æ˜¾ç¤º"æŸ¥çœ‹å±æ€§"æŒ‰é’®)')) return;

        showLoading();
        try {
            // 3. å°† stat_block æ›´æ–°ä¸º NULL 
            const { error } = await supabaseClient
                .from('employees')
                .update({ stat_block: null })
                .eq('id', empId);

            if (error) throw error;

            alert('æ•°æ®å·²æ¸…ç©ºï¼');
            
            // 4. æ¸…ç©ºæ–‡æœ¬æ¡†å¹¶åˆ·æ–°ä¸‹æ‹‰åˆ—è¡¨
            document.getElementById('adm-sheet-json').value = ''; 
            updateStatBlockSelect(viewingUserId); 
            loadEmployees(); 

        } catch (e) {
            console.error(e);
            alert('åˆ é™¤å¤±è´¥: ' + e.message);
        } finally {
            hideLoading();
        }
    }

async function getRobustIP() {
    const timeout = 3000; // 3ç§’è¶…æ—¶ï¼Œé¿å…å¡ä½ç™»å½•

    // å°è£…ä¸€ä¸ªå¸¦è¶…æ—¶çš„ fetch
    const fetchWithTimeout = async (url, type = 'json') => {
        const controller = new AbortController();
        const id = setTimeout(() => controller.abort(), timeout);
        try {
            const res = await fetch(url, { signal: controller.signal });
            clearTimeout(id);
            if (!res.ok) throw new Error('Network response was not ok');
            
            if (type === 'text') return await res.text();
            return await res.json();
        } catch (e) {
            clearTimeout(id);
            throw e;
        }
    };

    try {
        // æ–¹æ¡ˆ A: Cloudflare Trace
        const text = await fetchWithTimeout('https://www.cloudflare.com/cdn-cgi/trace', 'text');
        const match = text.match(/ip=(.+)/);
        if (match && match[1]) return match[1];
    } catch (e) {
        console.warn("æ–¹æ¡ˆAå¤±è´¥ï¼Œå°è¯•æ–¹æ¡ˆB");
    }

    try {
        // æ–¹æ¡ˆ B: Ipify 
        const json = await fetchWithTimeout('https://api.ipify.org?format=json', 'json');
        if (json.ip) return json.ip;
    } catch (e) {
        console.warn("æ–¹æ¡ˆBå¤±è´¥ï¼Œå°è¯•æ–¹æ¡ˆC");
    }
    
    try {
        // æ–¹æ¡ˆ C: Ipip.net 
        const json = await fetchWithTimeout('https://myip.ipip.net/json', 'json');
        if (json.data && json.data.ip) return json.data.ip;
    } catch(e) {
        console.warn("IPè·å–å…¨å†›è¦†æ²¡");
    }

    return 'IP_UNKNOWN'; 
}

    // --- å¯»è®¿ä¸è½¬ç›˜ç³»ç»Ÿ ---

    let currentWheelTarget = null;
    let currentWheelPrice = 0;
    let wheelCtx = null;
    let wheelAngle = 0; 

    function showGachaMode(mode) {
        document.getElementById('gacha-operator-panel').style.display = mode === 'operator' ? 'block' : 'none';
        document.getElementById('gacha-weapon-panel').style.display = mode === 'weapon' ? 'block' : 'none';
        document.getElementById('gacha-history-panel').style.display = 'none';
        
        document.getElementById('btn-mode-op').classList.toggle('active', mode === 'operator');
        document.getElementById('btn-mode-wp').classList.toggle('active', mode === 'weapon');
        
        if (mode === 'operator'){
            loadPityCount();
            initGachaPanel();
        } 
    }

    // --- å†å²è®°å½•åŠŸèƒ½ ---
    async function loadGachaHistory() {
        document.getElementById('gacha-operator-panel').style.display = 'none';
        document.getElementById('gacha-weapon-panel').style.display = 'none';
        const panel = document.getElementById('gacha-history-panel');
        panel.style.display = 'block';
        
        const list = document.getElementById('history-list');
        list.innerHTML = 'æŸ¥è¯¢æ¡£æ¡ˆä¸­...';

        // æŸ¥è¯¢å…¨æœæœ€è¿‘ 50 æ¡è®°å½•
        const { data, error } = await supabaseClient
            .from('gacha_records')
            .select('*')
            .order('created_at', { ascending: false })
            .limit(50);

        if (error) {
            list.innerHTML = `<div style="color:red">åŠ è½½å¤±è´¥: ${error.message}</div>`;
            return;
        }

        if (!data || data.length === 0) {
            list.innerHTML = '<div style="color:#999; text-align:center;">æš‚æ— è®°å½•ï¼Œå¿«å»å½“ç¬¬ä¸€ä¸ªåƒèƒèŸ¹çš„äººï¼</div>';
            return;
        }

        list.innerHTML = data.map(rec => {
            const date = new Date(rec.created_at).toLocaleString();
            const isMe = rec.user_id === viewingUserId;
            // é¢œè‰²åŒºåˆ†ç¨€æœ‰åº¦
            let color = '#333';
            if (rec.rarity === 6) color = '#e74c3c'; // çº¢
            if (rec.rarity === 5) color = '#f1c40f'; // é»„
            if (rec.rarity === 4) color = '#9b59b6'; // ç´«

            const poolName = rec.pool_type === 'operator' ? 'å¹²å‘˜å¯»è®¿' : 'å®šè½¨å†›æ¢°';
            
            return `
                <div style="padding:10px; border-bottom:1px solid #eee; background:${isMe ? '#f0f9ff' : '#fff'};">
                    <div style="display:flex; justify-content:space-between; color:#999; font-size:0.8em;">
                        <span>${poolName}</span>
                        <span>${date}</span>
                    </div>
                    <div style="margin-top:4px;">
                        <span style="font-weight:bold; color:${isMe ? '#2980b9' : '#666'}">${rec.user_email || 'ç¥ç§˜äºº'}</span>
                        è·å¾—äº† 
                        <span style="font-weight:bold; color:${color}; font-size:1.1em;">[${rec.item_name}]</span>
                        ${rec.rarity >= 5 ? 'âœ¨' : ''}
                    </div>
                </div>
            `;
        }).join('');
    }

    // --- å¹²å‘˜æŠ½å¡é€»è¾‘ ---
    async function loadPityCount() {
        const { data } = await supabaseClient.from('profiles').select('pity_count').eq('id', viewingUserId).maybeSingle();
        if (data) document.getElementById('pity-count-display').innerText = data.pity_count || 0;
    }

    // --- æ–°ç‰ˆå¯»è®¿ç³»ç»Ÿ JS ---

    // åˆå§‹åŒ–åŠ è½½
    async function initGachaPanel() {
        await Promise.all([loadPityCount(), loadCerts(), loadUpCharImage()]);
        // åŒæ­¥ä¸€ä¸‹ä¸Šé¢çš„é‡‘å¸æ˜¾ç¤º
        document.getElementById('gacha-gold-display').innerText = document.getElementById('gold-amount').innerText;
    }

    async function loadCerts() {
        const { data } = await supabaseClient.from('profiles').select('gacha_certs').eq('id', viewingUserId).single();
        if (data) document.getElementById('cert-count-display').innerText = data.gacha_certs || 0;
    }

    // åŠ è½½å°é¢ç«‹ç»˜ (æ‰¾ä¸€ä¸ª6æ˜Ÿçš„å¤´åƒ)
    async function loadUpCharImage() {
        // å°è¯•æ‰¾ rarity=6 çš„ç¬¬ä¸€ä¸ª
        const { data } = await supabaseClient.from('gacha_pool').select('avatar_url').eq('rarity', 6).limit(1).maybeSingle();
        if (data && data.avatar_url) {
            document.getElementById('gacha-stand-img').src = data.avatar_url;
        }
    }

    // æŠ½å¡æ ¸å¿ƒé€»è¾‘
   async function pullOperator() {
        if (!confirm('æ¶ˆè€— 600 GP è¿›è¡Œä¸€æ¬¡å¹²å‘˜å¯»è®¿ï¼Ÿ')) return;

        const overlay = document.getElementById('gacha-result-overlay');
        const beam = document.getElementById('gacha-beam');
        const card = document.getElementById('gacha-card-container');
        const tenContainer = document.getElementById('gacha-ten-container');

        // é‡ç½®çŠ¶æ€
        card.style.display = 'block';
        tenContainer.style.display = 'none';
        overlay.style.display = 'flex';
        card.style.transform = 'scale(0)';
        beam.style.display = 'block';
        
        try {
            const { data, error } = await supabaseClient.rpc('rpc_gacha_pull', { p_user_id: viewingUserId });
            
            if (error || (data && data.status === 'error')) {
                overlay.style.display = 'none';
                return alert(error ? error.message : data.msg);
            }

            // ç¡®å®šå…‰è‰²
            let color = '#fff';
            if (data.rarity === 6) color = '#ff4e50';
            else if (data.rarity === 5) color = '#f1c40f';
            else if (data.rarity === 4) color = '#9b59b6';

            beam.style.boxShadow = `0 0 50px 20px ${color}`;
            beam.style.background = color;

            setTimeout(() => {
                beam.style.display = 'none';
                
                // --- æ ¸å¿ƒä¿®æ”¹ï¼šä¼˜å…ˆä½¿ç”¨ç«‹ç»˜ (stand_url) ---
                const resultImg = data.stand_url || data.avatar_url || 'https://via.placeholder.com/300x500';
                document.getElementById('res-img').src = resultImg;
                
                document.getElementById('res-name').innerText = data.name;
                document.getElementById('res-stars').innerText = 'â˜…'.repeat(data.rarity);
                document.getElementById('res-stars').style.color = color;
                
                const typeTag = document.getElementById('res-type-tag');
                if (data.status === 'duplicate') {
                    typeTag.innerHTML = `å·²æ‹¥æœ‰<br><span style="font-size:0.8em; color:#aaa;">è½¬åŒ–ä¸ºé«˜çº§å‡­è¯ x${data.cert_gain}</span>`;
                } else {
                    typeTag.innerHTML = `<span style="color:#f1c40f">NEW!</span><br><span style="font-size:0.8em; color:#aaa;">æ–°å¹²å‘˜å…¥èŒ</span>`;
                }

                card.style.transform = 'scale(1)';
                loadGold(); loadCerts(); loadPityCount();
            }, 600);
        } catch (e) {
            overlay.style.display = 'none'; alert('é€šè®¯é”™è¯¯');
        }
    }

    function closeGachaResult() {
        document.getElementById('gacha-result-overlay').style.display = 'none';
    }

// è¯¦æƒ…å¼¹çª—
    function openGachaRates() {
        alert(
            "ã€æ ‡å‡†å¯»è®¿æ¦‚ç‡å…¬ç¤ºã€‘\n\n" +
            "â˜…â˜…â˜…â˜…â˜…â˜… (6æ˜Ÿ): 0.8%\n" +
            "â˜…â˜…â˜…â˜…â˜… (5æ˜Ÿ): 3.2%\n" +
            "â˜…â˜…â˜…â˜… (4æ˜Ÿ): 10%\n" +  
            "â˜…â˜…â˜… (3æ˜Ÿ): 40%\n" +
            "â˜…â˜… (2æ˜Ÿ): 30%\n" +
            "â˜… (1æ˜Ÿ): 16%\n\n" +   
            "ã€åŠ¨æ€ä¿åº•æœºåˆ¶ã€‘\n" +
            "è‹¥è¿ç»­ 65 æ¬¡å¯»è®¿æœªè·å¾— 6 æ˜Ÿå¹²å‘˜ï¼Œ\n" +
            "ä»ç¬¬ 66 æ¬¡å¼€å§‹ï¼Œè·å¾— 6 æ˜Ÿçš„æ¦‚ç‡æ¯æ¬¡æå‡ 5%ã€‚\n" +
            "ç¬¬ 80 æ¬¡å¯»è®¿å¿…å®šè·å¾— 6 æ˜Ÿå¹²å‘˜ã€‚\n\n" +
            "ã€é‡å¤è·å–ã€‘\n" +
            "é‡å¤è·å¾—å¹²å‘˜æ—¶ï¼Œä¸å†é‡å¤å…¥èŒï¼Œ\n" +
            "è€Œæ˜¯è‡ªåŠ¨è½¬åŒ–ä¸º[é«˜çº§å‡­è¯]ç”¨äºå…‘æ¢ã€‚"
        );
    }

    // å‡­è¯å•†åº—
    async function openCertShop() {
        const modal = document.getElementById('member-modal'); // å¤ç”¨ç°æœ‰çš„å¼¹çª—ç»“æ„
        const list = document.getElementById('member-select-list');
        const title = modal.querySelector('h3');
        const desc = modal.querySelector('p');
        
        title.innerText = "å‡­è¯å…‘æ¢å¤„";
        desc.innerText = "æ¶ˆè€— 300 é«˜çº§å‡­è¯å¯å®šç‚¹æ‹›è˜ä¸€åå…­æ˜Ÿå¹²å‘˜";
        list.innerHTML = "æ­£åœ¨æ‹‰å–èŠ±åå†Œ...";
        modal.style.display = 'flex';

        // æŸ¥æ‰€æœ‰6æ˜Ÿ
        const { data: chars } = await supabaseClient
            .from('gacha_pool')
            .select('*')
            .eq('rarity', 6);
        
        if (!chars) {
            list.innerHTML = "æ— æ•°æ®";
            return;
        }

        list.innerHTML = chars.map(c => `
            <div style="display:flex; align-items:center; justify-content:space-between; padding:10px;">
                <div style="display:flex; align-items:center; gap:10px;">
                    <img src="${c.avatar_url}" style="width:40px; height:40px; border-radius:4px; object-fit:cover;">
                    <div>
                        <div style="font-weight:bold; color:#e67e22;">${c.name}</div>
                        <div style="font-size:0.8em; color:#aaa;">${c.role}</div>
                    </div>
                </div>
                <button onclick="exchangeSixStar(${c.id}, '${c.name}')" style="background:#333; color:#f1c40f; border:1px solid #f1c40f; padding:5px 10px; cursor:pointer;">
                    300 ğŸ« å…‘æ¢
                </button>
            </div>
        `).join('');
    }

    async function exchangeSixStar(poolId, name) {
        if (!confirm(`ç¡®è®¤æ¶ˆè€— 300 å‡­è¯å…‘æ¢ [${name}] å—ï¼Ÿ`)) return;
        
        showLoading();
        const { data, error } = await supabaseClient.rpc('rpc_exchange_six_star', {
            p_user_id: viewingUserId,
            p_pool_id: poolId
        });
        
        hideLoading();
        if (error || (data && data.status === 'error')) {
            alert(error ? error.message : data.msg);
        } else {
            alert(`å…‘æ¢æˆåŠŸï¼${name} å·²åŠ å…¥é˜Ÿä¼ã€‚`);
            loadEmployees();
            loadCerts();
            closeModal('member-modal');
        }
    }

    

    // --- å†›æ¢°åº“è½¬ç›˜é€»è¾‘---

    // 1. åˆå§‹åŒ–å’Œç»˜åˆ¶
    function initCanvas() {
        const canvas = document.getElementById('wheel-canvas');
        wheelCtx = canvas.getContext('2d');
        wheelAngle = 0; // é‡ç½®è§’åº¦
        drawWheel(8); // é»˜è®¤ç”»æ»¡8æ ¼
    }

    function drawWheel(slotsCount) {
        if (!wheelCtx) return;
        const ctx = wheelCtx;
        const cx = 150, cy = 150, radius = 140;
        const arc = (2 * Math.PI) / slotsCount; // åŠ¨æ€è®¡ç®—æ‰‡å½¢å¤§å°

        ctx.clearRect(0, 0, 300, 300);
        ctx.save();
        ctx.translate(cx, cy);
        ctx.rotate(wheelAngle); // åº”ç”¨å½“å‰æ—‹è½¬

        for (let i = 0; i < slotsCount; i++) {
            ctx.beginPath();
            ctx.moveTo(0, 0);
            ctx.arc(0, 0, radius, i * arc, (i + 1) * arc);
            ctx.closePath();

            // é¢œè‰²é€»è¾‘ï¼š0å·ä½æ°¸è¿œæ˜¯å¤§å¥–(çº¢)ï¼Œå…¶ä»–æ˜¯æ‚é¡¹(ç°)
            if (i === 0) {
                ctx.fillStyle = '#e74c3c'; // çº¢è‰²å¤§å¥–
            } else {
                ctx.fillStyle = (i % 2 === 0) ? '#ecf0f1' : '#bdc3c7'; // ç°ç™½äº¤æ›¿
            }
            ctx.fill();
            ctx.stroke();

            // æ–‡å­—
            ctx.save();
            ctx.rotate(i * arc + arc / 2);
            ctx.textAlign = "right";
            ctx.fillStyle = i === 0 ? "#fff" : "#333";
            ctx.font = "bold 14px Arial";
            const text = i === 0 ? "ç›®æ ‡" : "æƒ é¡¾";
            ctx.fillText(text, radius - 10, 5);
            ctx.restore();
        }
        ctx.restore();
    }

    // 2. æœç´¢é€»è¾‘
    async function searchWheelTarget() {
        const query = document.getElementById('wheel-search').value;
        if (!query) return;
        const { data } = await supabaseClient.from('compendium_items').select('*').ilike('name', `%${query}%`).limit(1);
        if (!data || data.length === 0) return alert('æ‰¾ä¸åˆ°è¯¥ç‰©å“');
        
        currentWheelTarget = data[0];
        currentWheelPrice = data[0].price;
        document.getElementById('wheel-target-display').innerHTML = `ç›®æ ‡: <span style="color:#f1c40f">${currentWheelTarget.name}</span>`;
        document.getElementById('wheel-stage').style.display = 'block';
        
        // åˆå§‹ç»˜åˆ¶
        initCanvas(); 
        refreshWheelState();
    }

    // 3. åˆ·æ–°çŠ¶æ€å’Œæ ¼å­æ•°
    async function refreshWheelState() {
        const { data } = await supabaseClient.from('wheel_sessions')
            .select('steps_taken, is_finished')
            .eq('user_id', viewingUserId)
            .eq('target_item_name', currentWheelTarget.name)
            .eq('is_finished', false)
            .maybeSingle();

        const step = data ? data.steps_taken : 0;
        const prices = [0.10, 0.20, 0.30, 0.50, 0.75, 1.00, 1.50, 2.50];
        
        if (step >= 8 || (data && data.is_finished)) {
            document.getElementById('wheel-stage').innerHTML = '<div style="padding:20px; color:#2ecc71">è¯¥è½®æ¬¡å·²ç»“æŸï¼ˆç‰©å“å·²è·å–ï¼‰</div>';
            return;
        }

        const cost = Math.ceil(currentWheelTarget.price * prices[step]);
        document.getElementById('wheel-step').innerText = step + 1;
        document.getElementById('wheel-cost').innerText = cost;
        document.getElementById('btn-spin').disabled = false;

        const remainingSlots = 8 - step;
        drawWheel(remainingSlots);
    }

    // 4. æ—‹è½¬åŠ¨ç”»
    async function spinWheel() {
        const btn = document.getElementById('btn-spin');
        btn.disabled = true;

        // 1. è°ƒç”¨åç«¯æ¥å£
        const { data, error } = await supabaseClient.rpc('rpc_spin_wheel', {
            p_user_id: viewingUserId,
            p_item_name: currentWheelTarget.name,
            p_base_price: parseInt(currentWheelPrice)
        });

        // 2. é”™è¯¯å¤„ç†
        if (error || (data && data.status === 'error')) {
            btn.disabled = false;
            return alert(error ? error.message : data.msg);
        }

        // 3. è®¡ç®—ç›®æ ‡è§’åº¦é€»è¾‘
        
        // è·å–å½“å‰ç›˜é¢çš„æ ¼å­æ€»æ•°
        const currentStepStr = document.getElementById('wheel-step').innerText;
        const currentSlotsCount = 8 - (parseInt(currentStepStr) - 1);

        // ç¡®å®šç›®æ ‡æ‰‡åŒºç´¢å¼•
        let targetIndex = 0;
        if (data.hit) {
            targetIndex = 0;
        } else {
            targetIndex = Math.floor(Math.random() * (currentSlotsCount - 1)) + 1;
        }

        // è®¡ç®—å•ä¸ªæ‰‡åŒºçš„å¼§åº¦ (è§’åº¦åˆ¶)
        const arcDeg = 360 / currentSlotsCount;
        const targetSectorAngle = (targetIndex * arcDeg) + (arcDeg / 2);
        
        const currentRotMod = wheelAngle % 360; // è·å–å½“å‰è½¬ç›˜å·²ç»è½¬è¿‡çš„è§’åº¦ä½™æ•°
        
        // ç›®æ ‡å¢é‡ Delta = (270 - ç›®æ ‡åˆå§‹è§’åº¦) - å½“å‰å·²è½¬è§’åº¦
        let delta = (270 - targetSectorAngle) - currentRotMod;
        
        // å½’ä¸€åŒ–ï¼šç¡®ä¿ delta æ˜¯æ­£æ•°ï¼ˆä¿è¯é¡ºæ—¶é’ˆæ—‹è½¬ï¼Œä¸å€’è½¬ï¼‰
        while (delta < 0) {
            delta += 360;
        }

        // 4. è®¾å®šæ€»æ—‹è½¬è§’åº¦
        const minSpins = 8;
        const finalAngle = wheelAngle + (360 * minSpins) + delta;
        
        // 5. æ‰§è¡ŒåŠ¨ç”» (6000ms = 6ç§’)
        animateRotation(wheelAngle, finalAngle, 6000, () => {
            // --- åŠ¨ç”»ç»“æŸåçš„å›è°ƒ ---
            
            if (data.hit) {
                alert(`ğŸ‰ æ­å–œï¼å‘½è¿çš„æŒ‡é’ˆæŒ‡å‘äº† [${data.item}]ï¼`);
            } else {
                alert(`ğŸ’¨ è°¢è°¢æƒ é¡¾... è·å¾— [çºªå¿µå¸] x1`);
            }
            
            // åˆ·æ–°é‡‘å¸å’Œç•Œé¢çŠ¶æ€
            loadGold();
            refreshWheelState(); 
        });
    }

    // ç¼“åŠ¨åŠ¨ç”»å‡½æ•°
    function animateRotation(startDeg, endDeg, duration, callback) {
        const startTime = performance.now();
        
        function animate(currentTime) {
            const elapsed = currentTime - startTime;
            const progress = Math.min(elapsed / duration, 1);
            
            // Ease Out Quart (æ›´å¼ºçƒˆçš„å‡é€Ÿæ„Ÿ)
            const ease = 1 - Math.pow(1 - progress, 4);
            
            // æ›´æ–°å…¨å±€è§’åº¦
            wheelAngle = startDeg + (endDeg - startDeg) * ease;
            
            // é‡ç»˜ (ä¼ å…¥å¼§åº¦)
            const currentStepStr = document.getElementById('wheel-step').innerText;
            const slots = 8 - (parseInt(currentStepStr) - 1);
            
            // ç»˜åˆ¶æ—¶éœ€è¦å¼§åº¦
            wheelCtx.clearRect(0, 0, 300, 300);
            wheelCtx.save();
            wheelCtx.translate(150, 150);
            wheelCtx.rotate(wheelAngle * Math.PI / 180); // è§’åº¦è½¬å¼§åº¦
            wheelCtx.translate(-150, -150);
            drawWheelContent(slots); // æŠŠå…·ä½“çš„ç»˜åˆ¶é€»è¾‘æŠ½ç¦»å‡ºæ¥
            wheelCtx.restore();

            if (progress < 1) {
                requestAnimationFrame(animate);
            } else {
                callback();
            }
        }
        requestAnimationFrame(animate);
    }

    
    function drawWheel(slotsCount) {
        if (!wheelCtx) return;
        wheelCtx.clearRect(0, 0, 300, 300);
        wheelCtx.save();
        wheelCtx.translate(150, 150);
        wheelCtx.rotate(wheelAngle * Math.PI / 180); 
        wheelCtx.translate(-150, -150);
        drawWheelContent(slotsCount);
        wheelCtx.restore();
    }
    
    function drawWheelContent(slotsCount) {
         const ctx = wheelCtx;
         const cx = 150, cy = 150, radius = 140;
         const arc = (2 * Math.PI) / slotsCount;
         
         for (let i = 0; i < slotsCount; i++) {
            ctx.beginPath();
            ctx.moveTo(cx, cy);
            ctx.arc(cx, cy, radius, i * arc, (i + 1) * arc);
            ctx.closePath();
            if (i === 0) ctx.fillStyle = '#e74c3c'; 
            else ctx.fillStyle = (i % 2 === 0) ? '#ecf0f1' : '#bdc3c7';
            ctx.fill();
            ctx.stroke();
            
            ctx.save();
            ctx.translate(cx, cy);
            ctx.rotate(i * arc + arc / 2);
            ctx.textAlign = "right";
            ctx.fillStyle = i === 0 ? "#fff" : "#333";
            ctx.font = "bold 14px Arial";
            ctx.fillText(i === 0 ? "ç›®æ ‡" : "æƒ é¡¾", radius - 10, 5);
            ctx.restore();
        }
    }

    // --- DMåŠŸèƒ½ï¼šä¿®æ”¹ç°æœ‰é›‡å‘˜æ˜Ÿçº§ ---
    // 1. å½“ DM åœ¨â€œç©å®¶èµ„äº§â€é‡Œé€‰ä¸­ç©å®¶æ—¶ï¼Œè‡ªåŠ¨å¡«å……è¿™é‡Œçš„ä¸‹æ‹‰æ¡†
    // éœ€è¦ä¿®æ”¹ç°æœ‰çš„ loadUserDetail å‡½æ•°ï¼Œåœ¨æœ€ååŠ ä¸Šï¼š
    /* // åœ¨ loadUserDetail å‡½æ•°æœ«å°¾æ·»åŠ è¿™ä¸€è¡Œï¼š
       loadEmpForRarity(selectedUserId); 
    */

    async function loadEmpForRarity(uid) {
        const select = document.getElementById('adm-rarity-emp-list');
        select.innerHTML = '<option>åŠ è½½ä¸­...</option>';
        const { data } = await supabaseClient.from('employees').select('id, name, rarity').eq('user_id', uid);
        select.innerHTML = '';
        if(data) {
            data.forEach(e => {
                select.innerHTML += `<option value="${e.id}">${e.name} (${e.rarity||3}â˜…)</option>`;
            });
        }
    }

    async function updateEmpRarity() {
        const empId = document.getElementById('adm-rarity-emp-list').value;
        const rarity = document.getElementById('adm-rarity-val').value;
        if(!empId) return;

        showLoading();
        await supabaseClient.from('employees').update({ rarity: parseInt(rarity) }).eq('id', empId);
        hideLoading();
        alert('æ˜Ÿçº§å·²æ›´æ–°');
        // åˆ·æ–°åˆ—è¡¨
        loadEmpForRarity(selectedUserId);
        loadEmployees(); // åˆ·æ–°ä¸»ç•Œé¢
    }

    // --- DMåŠŸèƒ½ï¼šå¡æ± å¤´åƒä¸Šä¼  ---
    
    async function searchPoolChar() {
        const name = document.getElementById('adm-pool-search').value;
        if(!name) return;
        
        const { data } = await supabaseClient.from('gacha_pool').select('*').ilike('name', name).maybeSingle();
        const preview = document.getElementById('adm-pool-preview');
        
        if(data) {
            document.getElementById('adm-pool-id').value = data.id;
            preview.innerHTML = `âœ… é€‰ä¸­: <b>${data.name}</b> (${data.rarity}â˜…) <br> å¤´åƒ: ${data.avatar_url ? 'å·²å­˜åœ¨' : 'æ— '}`;
        } else {
            document.getElementById('adm-pool-id').value = '';
            preview.innerHTML = `âŒ æœªæ‰¾åˆ°è¯¥è§’è‰²`;
        }
    }

    async function uploadPoolAvatar() {
        const id = document.getElementById('adm-pool-id').value;
        const file = document.getElementById('adm-pool-file').files[0];
        
        if(!id || !file) return alert('è¯·å…ˆæœç´¢è§’è‰²å¹¶é€‰æ‹©æ–‡ä»¶');

        showLoading();
        try {
            // ä¸Šä¼ å›¾ç‰‡
            const fileName = `pool_${id}_${Date.now()}`;
            const { data, error } = await supabaseClient.storage.from('avatars').upload(fileName, file);
            if(error) throw error;

            // è·å– URL
            const { data: urlData } = supabaseClient.storage.from('avatars').getPublicUrl(data.path);
            
            // æ›´æ–°æ•°æ®åº“
            await supabaseClient.from('gacha_pool').update({ avatar_url: urlData.publicUrl }).eq('id', id);
            
            alert('å¤´åƒä¸Šä¼ æˆåŠŸ');
            searchPoolChar(); // åˆ·æ–°é¢„è§ˆ
        } catch(e) {
            console.error(e);
            alert('ä¸Šä¼ å¤±è´¥');
        } finally {
            hideLoading();
        }
    }

    // --- åè¿æŠ½é€»è¾‘ ---
    async function pullOperatorTen() {
        if (!confirm('ç¡®è®¤æ¶ˆè€— 6000 GP è¿›è¡Œåæ¬¡å¯»è®¿ï¼Ÿ\n(ä¿åº•æœºåˆ¶ä¼šåœ¨åè¿å†…éƒ¨åŠ¨æ€ç”Ÿæ•ˆ)')) return;

        const overlay = document.getElementById('gacha-result-overlay');
        const beam = document.getElementById('gacha-beam');
        const singleCard = document.getElementById('gacha-card-container');
        const tenContainer = document.getElementById('gacha-ten-container');
        const tenGrid = document.getElementById('gacha-ten-grid');

        // 1. å‡†å¤‡åŠ¨ç”»
        singleCard.style.display = 'none'; // éšè—å•æŠ½
        tenContainer.style.display = 'none'; // å…ˆéšè—åè¿ç»“æœ
        overlay.style.display = 'flex';
        beam.style.display = 'block'; // æ’­æ”¾å…‰æŸ
        
        // é»˜è®¤å…‰æŸæ˜¯é‡‘è‰²çš„ï¼Œç¨åæ ¹æ®æœ€é«˜æ˜Ÿçº§å˜è‰²
        beam.style.boxShadow = `0 0 50px 20px #f1c40f`;
        beam.style.background = '#f1c40f';

        try {
            // 2. è°ƒç”¨åè¿ RPC
            const { data, error } = await supabaseClient.rpc('rpc_gacha_pull_ten', { p_user_id: viewingUserId });

            if (error || (data && data.status === 'error')) {
                overlay.style.display = 'none';
                return alert(error ? error.message : data.msg);
            }

            const results = data.data;

            // 3. åˆ¤å®šæœ€é«˜æ˜Ÿçº§æ¥æ”¹å˜å…‰æŸé¢œè‰²
            const maxRarity = Math.max(...results.map(r => r.rarity));
            let beamColor = '#fff'; 
            if (maxRarity === 6) beamColor = '#ff4e50'; // æœ‰6æ˜Ÿå°±æ˜¯çº¢å…‰
            else if (maxRarity === 5) beamColor = '#f1c40f';
            else if (maxRarity === 4) beamColor = '#9b59b6';
            
            beam.style.boxShadow = `0 0 50px 20px ${beamColor}`;
            beam.style.background = beamColor;

            // 4. æ„å»ºç½‘æ ¼ DOM
            tenGrid.innerHTML = results.map((item, index) => {
                let color = '#95a5a6';
                if (item.rarity === 6) color = '#e74c3c';
                else if (item.rarity === 5) color = '#f1c40f';
                else if (item.rarity === 4) color = '#9b59b6';
                else if (item.rarity === 3) color = '#3498db';

                const stars = 'â˜…'.repeat(item.rarity);
                const delay = index * 0.1; 

                // --- æ ¸å¿ƒä¿®æ”¹ï¼šåè¿å°å¡ç‰‡ä¹Ÿä¼˜å…ˆç”¨ç«‹ç»˜ ---
                const cardImg = item.stand_url || item.avatar_url || 'https://via.placeholder.com/100';

                let tag = item.type === 'duplicate' 
                    ? `<div style="position:absolute; top:0; right:0; background:rgba(0,0,0,0.7); color:#fff; font-size:0.7em; padding:2px 5px;">å‡­è¯+${item.cert_gain}</div>`
                    : `<div style="position:absolute; top:0; right:0; background:#e74c3c; color:#fff; font-size:0.7em; padding:2px 5px; font-weight:bold;">NEW</div>`;

                return `
                    <div class="ak-mini-card" style="border-bottom: 4px solid ${color}; animation: popIn 0.4s ease backwards ${delay}s;">
                        ${tag}
                        <img src="${cardImg}" onerror="this.src='https://via.placeholder.com/100'">
                        <div class="ak-mini-bar" style="background:${color}">
                            ${item.name}
                        </div>
                        <div style="font-size:0.7em; color:${color}; padding:2px;">${stars}</div>
                    </div>
                `;
            }).join('');

            // 5. æ˜¾ç¤ºç»“æœ
            setTimeout(() => {
                beam.style.display = 'none'; // å…³ç¯
                tenContainer.style.display = 'flex'; // å¼€ç½‘æ ¼
                
                loadGold();
                loadCerts();
                loadPityCount();
            }, 800);

        } catch (e) {
            console.error(e);
            overlay.style.display = 'none';
            alert('åè¿å¤±è´¥ï¼šç½‘ç»œæˆ–èµ„é‡‘é—®é¢˜');
        }
    }

    async function uploadPoolStand() {
    const id = document.getElementById('adm-pool-id').value; // å¤ç”¨ä¹‹å‰çš„æœç´¢é€‰æ‹©ID
    const file = document.getElementById('adm-pool-stand-file').files[0];
    
    if(!id || !file) return alert('è¯·å…ˆæœç´¢ç¡®å®šå¡æ± è§’è‰²');

    showLoading();
    try {
        const fileName = `stand_${id}_${Date.now()}`;
        const { data } = await supabaseClient.storage.from('avatars').upload(fileName, file);
        const { data: urlData } = supabaseClient.storage.from('avatars').getPublicUrl(data.path);
        
        await supabaseClient.from('gacha_pool').update({ stand_url: urlData.publicUrl }).eq('id', id);
        alert('ç«‹ç»˜æ›´æ–°æˆåŠŸï¼');
    } catch(e) {
        alert('ä¸Šä¼ å¤±è´¥');
    } finally {
        hideLoading();
    }
}  
// æœç´¢å¡æ± è§’è‰²ï¼ˆä¸“é—¨ç”¨äºç«‹ç»˜ä¸Šä¼ ï¼‰
    async function searchPoolCharForStand() {
        const name = document.getElementById('adm-pool-stand-search').value;
        if(!name) return;
        const { data } = await supabaseClient.from('gacha_pool').select('*').ilike('name', name).maybeSingle();
        const preview = document.getElementById('adm-pool-stand-preview');
        if(data) {
            document.getElementById('adm-pool-stand-id').value = data.id;
            preview.innerHTML = `âœ… é€‰ä¸­: <b>${data.name}</b> | ç«‹ç»˜: ${data.stand_url ? 'å·²å­˜åœ¨' : 'æš‚æ— '}`;
        } else {
            preview.innerHTML = `âŒ æœªæ‰¾åˆ°è¯¥è§’è‰²`;
        }
    }

    // æ‰§è¡Œä¸Šä¼ 
    async function uploadPoolStand() {
        const id = document.getElementById('adm-pool-stand-id').value;
        const file = document.getElementById('adm-pool-stand-file').files[0];
        if(!id || !file) return alert('è¯·å…ˆæœç´¢ç¡®å®šè§’è‰²å¹¶é€‰æ‹©æ–‡ä»¶');

        showLoading();
        try {
            const fileName = `stand_${id}_${Date.now()}`;
            const { data, error } = await supabaseClient.storage.from('avatars').upload(fileName, file);
            if(error) throw error;

            const { data: urlData } = supabaseClient.storage.from('avatars').getPublicUrl(data.path);
            await supabaseClient.from('gacha_pool').update({ stand_url: urlData.publicUrl }).eq('id', id);
            
            alert('å…¨å¹…ç«‹ç»˜æ›´æ–°æˆåŠŸï¼');
            searchPoolCharForStand();
        } catch(e) {
            alert('ä¸Šä¼ å¤±è´¥');
        } finally {
            hideLoading();
        }
    }

    // --- æ¡£æ¡ˆç³»ç»Ÿé€»è¾‘ ---

    // 1. æ‰“å¼€æ¡£æ¡ˆå¼¹çª—
    async function openDossierModal(empId) {
        const modal = document.getElementById('dossier-modal');
        
        // --- åœ¨è¯·æ±‚æ•°æ®å‰ï¼Œå…ˆæ¸…ç©º/é‡ç½®æ‰€æœ‰ UI å…ƒç´  ---
        resetDossierUI(); 
        
        // æ˜¾ç¤ºå¼¹çª—
        modal.style.display = 'flex';
        
        // åˆ‡å›ç¬¬ä¸€ä¸ª Tab
        switchDossierTab('basic');
        
        // è·å–é›‡å‘˜æ•°æ®
        const { data: emp, error } = await supabaseClient
            .from('employees')
            .select('*')
            .eq('id', empId)
            .single();

        if (error || !emp) {
            alert("æ— æ³•è¯»å–æ¡£æ¡ˆæ•°æ®");
            modal.style.display = 'none';
            return;
        }

        const data = emp.stat_block || {};
        const basic = data.basic_info || {};

        // --- æ¸²æŸ“å·¦ä¾§ç«‹ç»˜ ---
        const standImg = emp.stand_url || emp.avatar_url || 'https://via.placeholder.com/300x500';
        const imgEl = document.getElementById('dossier-stand-img');
        
        // å›¾ç‰‡åŠ è½½é€»è¾‘
        imgEl.classList.remove('loaded'); 
        imgEl.src = standImg;
        imgEl.onload = () => imgEl.classList.add('loaded');
        if (imgEl.complete) imgEl.classList.add('loaded');

        // èƒŒæ™¯æ¨¡ç³Šå›¾
        document.getElementById('dossier-bg-blur').style.backgroundImage = `url('${emp.avatar_url || standImg}')`;
        // æ°´å°
        document.getElementById('dossier-watermark').innerText = (data.meta || 'ARCHIVE').split(' ')[0].toUpperCase();

        // --- æ¸²æŸ“å¤´éƒ¨ ---
        document.getElementById('dossier-name').innerText = emp.name;
        document.getElementById('dossier-meta').innerText = data.meta || 'æœªçŸ¥å®ä½“';
        document.getElementById('dossier-stars').innerText = 'â˜…'.repeat(emp.rarity || 3);
        
        // --- æ¸²æŸ“ Tab 1: åŸºç¡€æ¡£æ¡ˆ ---
        document.getElementById('info-name').innerText = emp.name;
        document.getElementById('info-race').innerText = data.meta || '--';
        document.getElementById('info-gender').innerText = basic.gender || 'æœªçŸ¥';
        document.getElementById('info-size').innerText = basic.size || 'ä¸­å‹';
        document.getElementById('info-origin').innerText = basic.origin || 'æœªçŸ¥åŒºåŸŸ';
        document.getElementById('info-height').innerText = basic.height || '--';
        document.getElementById('info-birthday').innerText = basic.birthday || '--';
        
        // æ¸²æŸ“æ ‡ç­¾
        const tagsContainer = document.getElementById('info-tags');
        tagsContainer.innerHTML = '';
        if (basic.tags && Array.isArray(basic.tags)) {
            basic.tags.forEach(tag => {
                tagsContainer.innerHTML += `<span class="tag-box">${tag}</span>`;
            });
        } else {
            tagsContainer.innerHTML = '<span style="color:#666">--</span>';
        }

        // --- æ¸²æŸ“ Tab 2: æˆ˜æ–—å±æ€§ ---
        renderCombatTab(data);

        // --- æ¸²æŸ“ Tab 3: å®¢è§‚å±¥å† ---
        const resumeText = data.resume || "ã€æ•°æ®ç¼ºå¤±ã€‘\næš‚æ— è¯¥å¹²å‘˜çš„è¯¦ç»†å±¥å†è®°å½•ã€‚";
        document.getElementById('resume-content').innerText = resumeText;
    }

    // é‡ç½® UI çš„è¾…åŠ©å‡½æ•°
    function resetDossierUI() {
        // 1. é‡ç½®å›¾ç‰‡å’ŒèƒŒæ™¯
        document.getElementById('dossier-stand-img').src = ''; 
        document.getElementById('dossier-stand-img').classList.remove('loaded'); // éšè—å›¾ç‰‡ç›´åˆ°åŠ è½½å®Œæˆ
        document.getElementById('dossier-bg-blur').style.backgroundImage = 'none';
        
        // 2. é‡ç½®æ–‡å­—ä¸ºåŠ è½½çŠ¶æ€
        document.getElementById('dossier-name').innerText = 'LOADING...';
        document.getElementById('dossier-meta').innerText = '...';
        document.getElementById('dossier-stars').innerText = '';
        document.getElementById('dossier-watermark').innerText = '';

        // 3. é‡ç½®åŸºç¡€ä¿¡æ¯
        ['info-name', 'info-race', 'info-size', 'info-gender', 'info-origin', 'info-height', 'info-birthday'].forEach(id => {
            document.getElementById(id).innerText = '--';
        });
        document.getElementById('info-tags').innerHTML = '...';

        // 4. é‡ç½®æˆ˜æ–—é¢æ¿
        document.getElementById('combat-hp').innerText = '--';
        document.getElementById('combat-ac').innerText = '--';
        document.getElementById('combat-speed').innerText = '--';
        document.getElementById('combat-stats-grid').innerHTML = '<div style="color:#666;padding:10px;">æ•°æ®åŠ è½½ä¸­...</div>';
        document.getElementById('combat-props').innerHTML = '';
        document.getElementById('combat-abilities-list').innerHTML = '';

        // 5. é‡ç½®å±¥å†
        document.getElementById('resume-content').innerText = 'æ­£åœ¨è§£å¯†æ¡£æ¡ˆ...';
    }

    // 2. æ¸²æŸ“æˆ˜æ–—å±æ€§ Tab
    function renderCombatTab(data) {
        
        // --- A. é¡¶éƒ¨æ•°å€¼ (HP/AC) æ™ºèƒ½è§£æ ---
        // è§£æ "19 (24 æŠ¤ç›¾æœ¯)" è¿™ç§æ ¼å¼ -> val="19", note="24 æŠ¤ç›¾æœ¯"
        const parseVal = (str) => {
            if(!str) return { val: '--', note: '' };
            // åŒ¹é…ä¸­æ–‡æˆ–è‹±æ–‡æ‹¬å·
            const match = str.match(/^([^\uff08(]+)(?:[\uff08(](.*)[\uff09)])?$/);
            return match ? { val: match[1].trim(), note: match[2] || '' } : { val: str, note: '' };
        };

        // æ¸²æŸ“ HP
        const hpData = parseVal(data.hp);
        document.getElementById('combat-hp').innerText = hpData.val;
        document.getElementById('combat-hp-note').innerText = hpData.note;

        // æ¸²æŸ“ AC
        const acData = parseVal(data.ac);
        document.getElementById('combat-ac').innerText = acData.val;
        document.getElementById('combat-ac-note').innerText = acData.note;

        // --- B. é€Ÿåº¦ (Speed) æ™ºèƒ½æ‹†åˆ† ---
        // è§£æ "30å°º, æ”€çˆ¬ 30å°º" -> main="30å°º", note="æ”€çˆ¬ 30å°º"
        const speedRaw = data.speed || '--';
        let mainSpeed = speedRaw;
        let extraSpeed = '';
        const splitRegex = /[,ï¼Œ]/; // æ”¯æŒä¸­è‹±æ–‡é€—å·

        if (splitRegex.test(speedRaw)) {
            const parts = speedRaw.split(splitRegex);
            mainSpeed = parts[0].trim();
            // æŠŠå‰©ä¸‹çš„éƒ¨åˆ†é‡æ–°ç»„åˆèµ·æ¥
            extraSpeed = parts.slice(1).join(', ').trim(); 
        }

        // æ¸²æŸ“ä¸»é€Ÿåº¦
        document.getElementById('combat-speed').innerText = mainSpeed;
        
        // æ¸²æŸ“å‰¯é€Ÿåº¦ (éœ€è¦è·å–æˆ–åˆ›å»º note å®¹å™¨)
        let spdBox = document.querySelector('.combat-stat-box.spd');
        let spdNote = document.getElementById('combat-speed-note');
        
        // å®¹é”™ï¼šå¦‚æœ HTML é‡Œæ²¡å†™ id="combat-speed-note"ï¼Œè‡ªåŠ¨è¡¥ä¸€ä¸ª
        if (!spdNote && spdBox) {
            spdNote = document.createElement('div');
            spdNote.id = 'combat-speed-note';
            spdNote.className = 'stat-note-top';
            spdNote.style.color = '#f1c40f'; // å¼ºåˆ¶åŠ ä¸Šé«˜äº®è‰²
            spdBox.appendChild(spdNote);
        }
        if (spdNote) spdNote.innerText = extraSpeed;


        // --- C. å…­ç»´å±æ€§ (Stats) ---
        const statKeys = ['str', 'dex', 'con', 'int', 'wis', 'cha'];
        const grid = document.getElementById('combat-stats-grid');
        grid.innerHTML = '';
        
        if (data.stats) {
            statKeys.forEach(k => {
                const s = data.stats[k] || { score: 10, mod: '+0' };
                grid.innerHTML += `
                    <div class="ability-box">
                        <span class="ability-title">${k.toUpperCase()}</span>
                        <span class="ability-mod">${s.mod}</span>
                        <span class="ability-score">${s.score}</span>
                    </div>`;
            });
        } else {
            grid.innerHTML = '<div style="grid-column:1/-1; color:#666; padding:10px;">æš‚æ— å±æ€§æ•°æ®</div>';
        }

        // --- D. åˆ—è¡¨å±æ€§ (Props: è±å…/æŠ€èƒ½/æ„Ÿå®˜ç­‰) ---
        const propsDiv = document.getElementById('combat-props');
        propsDiv.innerHTML = '';
        if (data.props && data.props.length > 0) {
            data.props.forEach(p => {
                propsDiv.innerHTML += `
                    <div class="props-row">
                        <div class="props-key">${p.label}</div>
                        <div class="props-val">${p.value}</div>
                    </div>`;
            });
        }

        // --- E. èƒ½åŠ›è¯¦æƒ… (ç‰¹æ€§/åŠ¨ä½œ/æ³•æœ¯) ---
        const listDiv = document.getElementById('combat-abilities-list');
        listDiv.innerHTML = '';

        // å†…éƒ¨è¾…åŠ©å‡½æ•°ï¼šæ¸²æŸ“å¸¦æ ‡é¢˜çš„æ¿å—
        const renderSection = (title, list, typeClass) => {
            if (!list || list.length === 0) return;

            // 1. æ¸²æŸ“åˆ†ç±»æ ‡é¢˜
            listDiv.innerHTML += `<div class="combat-section-title ${typeClass}">${title}</div>`;

            // 2. æ¸²æŸ“å¡ç‰‡
            list.forEach(item => {
                let desc = item.desc || '';
                // å¤„ç†æ¢è¡Œç¬¦
                desc = desc.replace(/\n/g, '<br>'); 
                // å¤„ç†å¥é¦–å°æ ‡é¢˜åŠ ç²— (ä¾‹å¦‚ "æ­»å’’ã€‚xxx" -> "<b>æ­»å’’ã€‚</b>xxx")
                desc = desc.replace(/^([^ã€‚]+ã€‚)/gm, '<b>$1</b>');

                listDiv.innerHTML += `
                    <div class="trait-card ${typeClass}">
                        <div class="trait-title">${item.name}</div>
                        <div class="trait-desc">${desc}</div>
                    </div>`;
            });
        };

        // æŒ‰é¡ºåºæ¸²æŸ“å„ä¸ªæ¿å—
        // ç‰¹æ€§ (æ— è‰²/ç°è‰²)
        renderSection('ç‰¹æ€§ / TRAITS', data.traits, '');
        // åŠ¨ä½œ (çº¢è‰²)
        renderSection('åŠ¨ä½œ / ACTIONS', data.actions, 'action');       
        // é™„èµ  (æ©™è‰²)
        renderSection('é™„èµ  / BONUS', data.bonus_actions, 'bonus');   
        // ååº” (ç´«è‰²) - å¿…é¡»ç¡®ä¿ CSS é‡ŒåŠ äº† .trait-card.reaction { border-left-color: #9b59b6; }
        renderSection('ååº” / REACTIONS', data.reactions, 'reaction'); 
        // ä¼ å¥‡åŠ¨ä½œ (é‡‘è‰²) - é¢„ç•™
        renderSection('ä¼ å¥‡ / LEGENDARY', data.legendary_actions, 'legendary'); 

        // --- F. æ–½æ³•åˆ—è¡¨ (Spells) ---
        if (data.spells && data.spells.list && data.spells.list.length > 0) {
            // æ–½æ³•æ ‡é¢˜
            listDiv.innerHTML += `<div class="combat-section-title" style="border-left-color:#3498db; color:#3498db;">æ–½æ³• / SPELLS</div>`;

            // æ–½æ³•æ€»è§ˆå¡ç‰‡
            let spellHtml = `<div class="trait-card" style="border-left-color:#3498db;">
                <div class="trait-desc" style="margin-bottom:10px; font-style:italic; color:#aaa;">${data.spells.header || ''}</div>`;
            
            // å¾ªç¯æ¸²æŸ“æ¯ä¸€ç¯
            data.spells.list.forEach(s => {
                spellHtml += `
                    <div class="spell-group">
                        <span class="spell-level">${s.level}</span>
                        <span class="spell-items">${s.spells}</span>
                    </div>`;
            });
            spellHtml += '</div>';
            listDiv.innerHTML += spellHtml;
        }
    }

    // 3. Tab åˆ‡æ¢é€»è¾‘
    function switchDossierTab(tabName) {
        // æŒ‰é’®æ ·å¼
        document.querySelectorAll('.dossier-tab-btn').forEach(btn => {
            btn.classList.remove('active');
            if (btn.getAttribute('onclick').includes(tabName)) btn.classList.add('active');
        });

        // å†…å®¹æ˜¾ç¤º
        document.querySelectorAll('.dossier-pane').forEach(pane => pane.classList.remove('active'));
        document.getElementById(`dossier-pane-${tabName}`).classList.add('active');
    }

    // --- ä¸ºç°æœ‰é›‡å‘˜ä¸Šä¼ ç«‹ç»˜ ---
    async function uploadExistingStand() {
        const file = document.getElementById('adm-emp-stand').files[0];
        const empId = document.getElementById('adm-emp-list').value;
        
        if (!empId) return alert('è¯·å…ˆåœ¨åˆ—è¡¨ä¸­é€‰æ‹©ä¸€åé›‡å‘˜');
        if (!file) return alert('è¯·é€‰æ‹©ç«‹ç»˜å›¾ç‰‡æ–‡ä»¶');

        showLoading();
        try {
            // 1. ç”Ÿæˆæ–‡ä»¶å (stand_emp_ID_æ—¶é—´æˆ³)
            const fileName = `stand_emp_${empId}_${Date.now()}`;
            
            // 2. ä¸Šä¼ åˆ° Supabase Storage (å¤ç”¨ avatars æ¡¶)
            const { data, error } = await supabaseClient.storage.from('avatars').upload(fileName, file);
            if (error) throw error;

            // 3. è·å–å…¬å¼€é“¾æ¥
            const { data: urlData } = supabaseClient.storage.from('avatars').getPublicUrl(data.path);
            
            // 4. æ›´æ–°æ•°æ®åº“ (employees è¡¨çš„ stand_url å­—æ®µ)
            const { error: dbError } = await supabaseClient
                .from('employees')
                .update({ stand_url: urlData.publicUrl })
                .eq('id', empId);

            if (dbError) throw dbError;
            
            alert('âœ… å…¨èº«ç«‹ç»˜æ›´æ–°æˆåŠŸï¼\nè¯·é‡æ–°æ‰“å¼€è¯¥è§’è‰²çš„æ¡£æ¡ˆæŸ¥çœ‹æ•ˆæœã€‚');
            
            // æ¸…ç©ºæ–‡ä»¶æ¡†
            document.getElementById('adm-emp-stand').value = '';

        } catch (e) {
            console.error(e);
            alert('ä¸Šä¼ å¤±è´¥: ' + (e.message || 'ç½‘ç»œé”™è¯¯'));
        } finally {
            hideLoading();
        }
    }


    
    checkUser();
</script>
</body>
</html>




