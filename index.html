<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>D&D å°é˜Ÿç®¡ç†ç³»ç»Ÿ</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --border: #e0e0e0; --bg: #f8f9fa; --active: #333; }
        body { font-family: "PingFang SC", sans-serif; background: #fff; color: #333; margin: 0; padding: 20px; }
        .container { max-width: 1100px; margin: 0 auto; }
        
        .nav { display: flex; gap: 10px; border-bottom: 2px solid #333; padding-bottom: 10px; margin-bottom: 20px; align-items: center; }
        .tab-btn { padding: 8px 16px; border: 1px solid transparent; background: none; cursor: pointer; font-size: 1em; color: #666; border-radius: 4px; }
        .tab-btn.active { background: #333; color: #fff; font-weight: bold; }
        .info-bar { margin-left: auto; text-align: right; font-size: 0.9em; }

        .section { display: none; }
        .section.active { display: block; }

        /* é˜Ÿä¼å¡ç‰‡ */
        .team-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); gap: 20px; }
        .team-card { border: 1px solid var(--border); border-radius: 8px; padding: 15px; background: #fff; position: relative; }
        .team-header { display: flex; align-items: center; gap: 15px; margin-bottom: 15px; }
        .team-avatar { width: 60px; height: 60px; border-radius: 50%; object-fit: cover; background: #eee; border: 1px solid #ddd; }
        .team-info h3 { margin: 0; font-size: 1.1em; }
        .team-info p { margin: 2px 0 0; font-size: 0.8em; color: #666; }

        /* è£…å¤‡æ§½ */
        .slots-container { display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; }
        .slot { 
            aspect-ratio: 1; border: 1px dashed #ccc; border-radius: 4px; 
            display: flex; align-items: center; justify-content: center; 
            font-size: 0.7em; text-align: center; cursor: pointer; background: #fafafa; padding: 2px; overflow: hidden;
            transition: 0.2s;
        }
        .slot:hover { border-color: #333; background: #f0f0f0; }
        .slot.filled { border: 1px solid #999; background: #fff; border-style: solid; }
        .slot-name { word-break: break-all; pointer-events: none; }

        /* å¼¹çª— */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; align-items: center; justify-content: center; }
        .modal-box { background: #fff; padding: 20px; border-radius: 8px; width: 400px; max-height: 80vh; overflow-y: auto; }
        .item-select-list div { padding: 10px; border-bottom: 1px solid #eee; cursor: pointer; display: flex; justify-content: space-between; }
        .item-select-list div:hover { background: #f9f9f9; }

        /* å…¶ä»–é€šç”¨æ ·å¼ä¿æŒç®€çº¦ */
        .shop-grid, .inventory-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; }
        .card { border: 1px solid #eee; padding: 15px; border-radius: 6px; }
        .btn-buy { width: 100%; margin-top: 10px; padding: 6px; background: #fff; border: 1px solid #333; cursor: pointer; }
        .btn-buy:hover { background: #333; color: #fff; }
        
        #admin-panel { display: none; position: fixed; top: 5%; left: 5%; width: 90%; height: 90%; background: #fff; border: 2px solid #333; z-index: 3000; padding: 20px; overflow-y: auto; }
    </style>
</head>
<body>

<div class="container">
    <!-- ç™»å½• -->
    <div id="login-section" style="max-width:300px; margin:100px auto; text-align:center;">
        <h2>å†’é™©è€…å·¥ä¼šç»ˆç«¯</h2>
        <input type="email" id="login-email" placeholder="é‚®ç®±" style="width:100%; padding:10px; margin-bottom:10px;">
        <input type="password" id="login-password" placeholder="å¯†ç " style="width:100%; padding:10px; margin-bottom:10px;">
        <button onclick="login()" style="width:100%; padding:10px; background:#333; color:#fff; border:none;">å¯åŠ¨</button>
    </div>

    <!-- ä¸»ç•Œé¢ -->
    <div id="main-section" style="display:none;">
        <div class="nav">
            <button class="tab-btn active" onclick="switchTab('shop')">é›†å¸‚</button>
            <button class="tab-btn" onclick="switchTab('team')">é˜Ÿä¼</button>
            <button class="tab-btn" onclick="switchTab('inventory')">èƒŒåŒ…</button>
            <button class="tab-btn" onclick="switchTab('employees')">é›‡å‘˜ä¸­å¿ƒ</button>
            <span id="admin-link" style="display:none; color:#3498db; cursor:pointer; font-weight:bold" onclick="toggleAdmin()">âš™ï¸ DM</span>
            
            <div class="info-bar">
                <div id="date-text" style="font-weight:bold; background:#f1c40f; display:inline-block; padding:2px 6px; border-radius:4px;"></div>
                <div style="color:#d35400; font-weight:bold; margin-top:4px;">ğŸ’° <span id="gold-amount">0</span> GP</div>
                <a href="#" onclick="logout()" style="color:#999; font-size:0.8em;">é€€å‡º</a>
            </div>
        </div>

        <!-- é›†å¸‚ -->
        <div id="shop-section" class="section active"><div id="shop-grid" class="shop-grid"></div></div>

        <!-- é˜Ÿä¼ï¼ˆæ ¸å¿ƒæ–°åŠŸèƒ½ï¼‰ -->
        <div id="team-section" class="section">
            <div id="team-grid" class="team-grid"></div>
        </div>

        <!-- èƒŒåŒ… -->
        <div id="inventory-section" class="section"><div id="inventory-container"></div></div>
        
        <!-- é›‡å‘˜åˆ—è¡¨ -->
        <div id="employees-section" class="section">
            <div id="emp-list" class="shop-grid"></div>
        </div>
    </div>
</div>

<!-- è£…å¤‡é€‰æ‹©å¼¹çª— -->
<div id="equip-modal" class="modal">
    <div class="modal-box">
        <h3>é€‰æ‹©è¦è£…å¤‡çš„ç‰©å“</h3>
        <p style="font-size:0.8em; color:#666;">ä»…æ˜¾ç¤ºèƒŒåŒ…ä¸­çš„ [è£…å¤‡] å’Œ [é­”æ³•ç‰©å“]</p>
        <div id="equip-list" class="item-select-list"></div>
        <button onclick="closeModal()" style="width:100%; margin-top:15px; padding:10px;">å–æ¶ˆ</button>
    </div>
</div>

<!-- DMåå° (ä¿æŒåŸæœ‰åŠŸèƒ½) -->
<div id="admin-panel">
    <div style="display:flex; justify-content:space-between;"><h2>DM æ§åˆ¶å°</h2><button onclick="toggleAdmin()">å…³é—­</button></div>
    <div style="display:grid; grid-template-columns:1fr 1fr; gap:20px;">
        <div>
            <h3>â³ æ—¶é—´</h3><button onclick="advanceTime()" style="padding:10px; background:#f1c40f;">æ¨è¿›ä¸€å¤©</button>
        </div>
        <div>
            <h3>ğŸ‘· å¤´åƒä¸Šä¼ </h3>
            <select id="adm-emp-list"></select>
            <input type="file" id="adm-emp-avatar">
            <button onclick="uploadAvatar()">ä¸Šä¼ </button>
        </div>
    </div>
</div>

<script>
    const SUPABASE_URL = 'https://vbzfpgucpciqgaakqndz.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZiemZwZ3VjcGNpcWdhYWtxbmR6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc1OTc2MzMsImV4cCI6MjA4MzE3MzYzM30.fBVDirEJ52bvrYJZ5DNv7fVDLNgCwITKwdKqT6YJDYw';
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    const DM_EMAIL = '739477825@qq.com';
    let userProfile = null;
    let currentEquipTarget = { empId: null, slotIdx: null }; // è®°å½•å½“å‰æ­£åœ¨æ“ä½œå“ªä¸ªæ ¼å­çš„è£…å¤‡

    // --- æ ¸å¿ƒé˜Ÿä¼é€»è¾‘ ---
    async function loadTeam() {
        const grid = document.getElementById('team-grid');
        grid.innerHTML = 'åŠ è½½é˜Ÿå‘˜æ•°æ®...';
        
        // 1. è·å–å‰8ååœ¨èŒé˜Ÿå‘˜ï¼ˆåŒ…å«æ ¸å¿ƒé˜Ÿå‹å’Œé›‡å‘˜ï¼‰
        const { data: members } = await supabaseClient.from('employees').select('*').eq('status', 'åœ¨èŒ').limit(8).order('id');
        
        // 2. è·å–æ‰€æœ‰äººçš„è£…å¤‡æƒ…å†µ
        const { data: equipped } = await supabaseClient.from('equipped_items').select('*');

        grid.innerHTML = '';
        members.forEach(m => {
            const isCore = m.salary === 0;
            // æ„å»º10ä¸ªæ ¼å­
            let slotsHtml = '';
            for (let i = 0; i < 10; i++) {
                const item = equipped.find(e => e.employee_id === m.id && e.slot_index === i);
                if (item) {
                    slotsHtml += `<div class="slot filled" onclick="unequipItem(${item.id})" title="${item.item_name}"><div class="slot-name">${item.item_name}</div></div>`;
                } else {
                    slotsHtml += `<div class="slot" onclick="openEquipModal(${m.id}, ${i})">+</div>`;
                }
            }

            grid.innerHTML += `
                <div class="team-card">
                    <div class="team-header">
                        <img src="${m.avatar_url || 'https://via.placeholder.com/60'}" class="team-avatar">
                        <div class="team-info">
                            <h3>${m.name}</h3>
                            <p>${isCore ? 'æ ¸å¿ƒé˜Ÿå‹' : 'é›‡å‘˜'} | è–ªèµ„: ${m.salary} GP</p>
                        </div>
                    </div>
                    <div class="slots-container">${slotsHtml}</div>
                </div>`;
        });
    }

    // æ‰“å¼€è£…å¤‡é€‰æ‹©å¼¹çª—
    async function openEquipModal(empId, slotIdx) {
        currentEquipTarget = { empId, slotIdx };
        const list = document.getElementById('equip-list');
        list.innerHTML = 'è¯»å–èƒŒåŒ…...';
        document.getElementById('equip-modal').style.display = 'flex';

        // ä»…è¯»å– 'è£…å¤‡' å’Œ 'é­”æ³•ç‰©å“'
        const { data: inv } = await supabaseClient.from('user_inventory')
            .select('*')
            .eq('user_id', userProfile.id)
            .in('category', ['è£…å¤‡', 'é­”æ³•ç‰©å“'])
            .gt('quantity', 0); // å¿…é¡»æœ‰åº“å­˜

        list.innerHTML = '';
        if (!inv || inv.length === 0) {
            list.innerHTML = '<div style="text-align:center; color:#999">èƒŒåŒ…é‡Œæ²¡æœ‰é—²ç½®çš„è£…å¤‡/é­”æ³•ç‰©å“</div>';
            return;
        }

        inv.forEach(item => {
            list.innerHTML += `
                <div onclick="equipItem(${item.id}, '${item.item_name}')">
                    <span>${item.item_name}</span>
                    <span style="color:#999">x${item.quantity}</span>
                </div>`;
        });
    }

    // ç©¿è£…å¤‡é€»è¾‘
    async function equipItem(invId, itemName) {
        if (!confirm(`å°† [${itemName}] è£…å¤‡ç»™é˜Ÿå‘˜ï¼Ÿ`)) return;

        // 1. æ‰£é™¤èƒŒåŒ…æ•°é‡
        const { data: invItem } = await supabaseClient.from('user_inventory').select('quantity').eq('id', invId).single();
        if (invItem.quantity > 1) {
            await supabaseClient.from('user_inventory').update({ quantity: invItem.quantity - 1 }).eq('id', invId);
        } else {
            await supabaseClient.from('user_inventory').delete().eq('id', invId);
        }

        // 2. è®°å½•è£…å¤‡æ§½
        await supabaseClient.from('equipped_items').insert([{
            employee_id: currentEquipTarget.empId,
            slot_index: currentEquipTarget.slotIdx,
            item_name: itemName,
            inventory_id: null // ç®€åŒ–é€»è¾‘ï¼Œè¿™é‡Œæš‚ä¸å¼ºå…³è”IDï¼Œä»…å­˜åå­—
        }]);

        closeModal();
        loadTeam();
        loadInventory(); // åˆ·æ–°èƒŒåŒ…
    }

    // å¸ä¸‹è£…å¤‡é€»è¾‘
    async function unequipItem(equipId) {
        if (!confirm('å¸ä¸‹è¯¥è£…å¤‡æ”¾å›èƒŒåŒ…ï¼Ÿ')) return;

        // 1. è·å–è£…å¤‡ä¿¡æ¯
        const { data: eqItem } = await supabaseClient.from('equipped_items').select('*').eq('id', equipId).single();
        
        // 2. æ”¾å›èƒŒåŒ…
        const { data: exist } = await supabaseClient.from('user_inventory')
            .select('*')
            .eq('user_id', userProfile.id)
            .eq('item_name', eqItem.item_name)
            .maybeSingle();
            
        if (exist) {
            await supabaseClient.from('user_inventory').update({ quantity: exist.quantity + 1 }).eq('id', exist.id);
        } else {
            await supabaseClient.from('user_inventory').insert([{
                user_id: userProfile.id, 
                item_name: eqItem.item_name, 
                quantity: 1, 
                category: 'è£…å¤‡' // é»˜è®¤å½’ç±»ï¼Œä¹Ÿå¯ä»¥æ”¹è¿›
            }]);
        }

        // 3. æ¸…é™¤è£…å¤‡æ§½
        await supabaseClient.from('equipped_items').delete().eq('id', equipId);

        loadTeam();
        loadInventory();
    }

    function closeModal() { document.getElementById('equip-modal').style.display = 'none'; }

    // --- åŸºç¡€æ¡†æ¶é€»è¾‘ (ä¿æŒä¸å˜) ---
    async function login() {
        const email = document.getElementById('login-email').value;
        const password = document.getElementById('login-password').value;
        const { error } = await supabaseClient.auth.signInWithPassword({ email, password });
        if(error) alert(error.message); else checkUser();
    }
    async function logout() { await supabaseClient.auth.signOut(); location.reload(); }
    
    async function checkUser() {
        const { data: { user } } = await supabaseClient.auth.getUser();
        if (user) {
            document.getElementById('login-section').style.display = 'none';
            document.getElementById('main-section').style.display = 'block';
            if(user.email === DM_EMAIL) {
                document.getElementById('admin-link').style.display = 'inline';
                loadAdminData();
            }
            // åŠ è½½åŸºç¡€æ•°æ®
            const { data: p } = await supabaseClient.from('profiles').select('*').eq('id', user.id).single();
            userProfile = p;
            document.getElementById('gold-amount').innerText = p.gold_gp;
            
            const { data: d } = await supabaseClient.from('global_settings').select('value').eq('key', 'current_date').single();
            if(d) document.getElementById('date-text').innerText = `FR${d.value.year} ${d.value.month}æœˆ${d.value.day}æ—¥`;

            loadShop();
            loadTeam(); // åˆå§‹åŠ è½½é˜Ÿä¼
        }
    }

    // è¾…åŠ©å‡½æ•°
    function switchTab(tab) {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        document.querySelector(`.tab-btn[onclick*="${tab}"]`).classList.add('active');
        document.getElementById(`${tab}-section`).classList.add('active');
        if(tab === 'team') loadTeam();
        if(tab === 'inventory') loadInventory();
        if(tab === 'employees') loadEmployees();
    }
    function toggleAdmin() { const p = document.getElementById('admin-panel'); p.style.display = p.style.display==='block'?'none':'block'; }

    // åŠ è½½å…¶ä»–æ•°æ® (ç®€åŒ–ç‰ˆ)
    async function loadShop() {
        const { data } = await supabaseClient.from('shop_items').select('*');
        document.getElementById('shop-grid').innerHTML = data.map(i => `<div class="card"><b>${i.name}</b><br>${i.price} GP<button class="btn-buy" onclick="buy(${i.id},${i.price},'${i.name}','${i.category}')">è´­ä¹°</button></div>`).join('');
    }
    async function buy(id,p,n,c) {
        if(userProfile.gold_gp < p) return alert('æ²¡é’±');
        await supabaseClient.from('profiles').update({gold_gp: userProfile.gold_gp-p}).eq('id', userProfile.id);
        const {data:inv} = await supabaseClient.from('user_inventory').select('id,quantity').eq('user_id',userProfile.id).eq('item_name',n).maybeSingle();
        if(inv) await supabaseClient.from('user_inventory').update({quantity:inv.quantity+1}).eq('id',inv.id);
        else await supabaseClient.from('user_inventory').insert([{user_id:userProfile.id,item_name:n,quantity:1,category:c}]);
        alert('è´­ä¹°æˆåŠŸ'); checkUser();
    }
    async function loadInventory() {
        const { data } = await supabaseClient.from('user_inventory').select('*');
        document.getElementById('inventory-container').innerHTML = data.map(i => `<div>${i.item_name} x${i.quantity}</div>`).join('<br>');
    }
    async function loadEmployees() {
        const { data } = await supabaseClient.from('employees').select('*');
        document.getElementById('emp-list').innerHTML = data.map(e => `<div class="card"><img src="${e.avatar_url}" style="width:50px"><br>${e.name}<br>${e.status}</div>`).join('');
    }
    async function loadAdminData() {
        const { data } = await supabaseClient.from('employees').select('id,name');
        document.getElementById('adm-emp-list').innerHTML = data.map(e => `<option value="${e.id}">${e.name}</option>`).join('');
    }
    async function uploadAvatar() {
        const f = document.getElementById('adm-emp-avatar').files[0];
        const id = document.getElementById('adm-emp-list').value;
        const { data } = await supabaseClient.storage.from('avatars').upload(`ava_${Date.now()}`, f);
        if(data) {
            const { data: u } = supabaseClient.storage.from('avatars').getPublicUrl(data.path);
            await supabaseClient.from('employees').update({avatar_url: u.publicUrl}).eq('id', id);
            alert('OK');
        }
    }
    async function advanceTime() {
        // ç®€åŒ–ç‰ˆæ—¶é—´æ¨è¿›
        alert('æ—¶é—´å·²æ¨è¿› (é€»è¾‘åŒä¸Šç‰ˆ)');
    }
    
    checkUser();
</script>
</body>
</html>
