<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>æ”¿åŠ¡å… - è‰¾å°”è«ç‘å°”</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --bg-color: #f4f1ea; --card-bg: #fff; --text: #2c3e50; --border: #dcd6cc; }
        body { font-family: "PingFang SC", "Microsoft YaHei", serif; background-color: var(--bg-color); color: var(--text); margin: 0; padding: 40px; }
        
        .container { max-width: 900px; margin: 0 auto; }
        .header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #8e44ad; padding-bottom: 15px; margin-bottom: 30px; }
        .back-btn { padding: 8px 15px; border: 1px solid #333; text-decoration: none; color: #333; border-radius: 4px; font-size: 0.9em; transition: 0.2s; }
        .back-btn:hover { background: #333; color: #fff; }

        .section-title { font-weight: bold; margin: 30px 0 15px; color: #555; border-left: 4px solid #8e44ad; padding-left: 10px; }
        
        /* ææ¡ˆå¡ç‰‡ */
        .proposal-card { background: var(--card-bg); border: 1px solid var(--border); border-radius: 8px; padding: 20px; margin-bottom: 20px; display: flex; gap: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.03); transition: 0.2s; }
        .proposal-card:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(0,0,0,0.08); }
        
        .avatar-box { flex-shrink: 0; text-align: center; width: 80px; }
        .avatar { width: 70px; height: 70px; border-radius: 50%; object-fit: cover; border: 2px solid #eee; margin-bottom: 5px; }
        .proposer-name { font-size: 0.85em; font-weight: bold; color: #666; }

        .content-box { flex: 1; display: flex; flex-direction: column; justify-content: space-between; }
        .prop-title { font-size: 1.2em; font-weight: bold; margin-bottom: 5px; color: #2c3e50; }
        .prop-desc { font-size: 0.95em; color: #555; line-height: 1.6; margin-bottom: 15px; background: #f9f9f9; padding: 10px; border-radius: 4px; border-left: 3px solid #ddd; }
        
        .action-bar { display: flex; justify-content: space-between; align-items: center; border-top: 1px dashed #eee; padding-top: 15px; }
        .cost-tag { font-family: monospace; font-weight: bold; color: #c0392b; font-size: 1.1em; display: flex; align-items: center; gap: 5px; }
        
        /* æŒ‰é’® */
        .btn-group { display: flex; gap: 10px; }
        button { cursor: pointer; border: none; padding: 8px 20px; border-radius: 4px; font-weight: bold; transition: 0.2s; }
        .btn-approve { background: #27ae60; color: white; }
        .btn-approve:hover { background: #219150; }
        .btn-reject { background: #c0392b; color: white; }
        .btn-reject:hover { background: #a93226; }
        
        /* å†å²è®°å½•æ ·å¼ä¼˜åŒ– */
        .history-card { opacity: 0.8; background: #fcfcfc; border-left: 4px solid transparent; }
        .history-card.approved { border-left-color: #27ae60; }
        .history-card.rejected { border-left-color: #c0392b; }
        
        .status-badge { padding: 2px 8px; border-radius: 4px; font-size: 0.8em; font-weight: bold; }
        .status-approved { background: #d5f5e3; color: #27ae60; }
        .status-rejected { background: #fadbd8; color: #c0392b; }
        
        /* ä¼˜åŒ–åçš„æ‰¹æ³¨æ¡†æ ·å¼ */
        .decision-note { 
            margin-top: 10px; 
            padding: 10px; 
            background: #fffbe6; 
            border: 1px solid #f1c40f; 
            border-radius: 4px; 
            font-size: 0.9em; 
            color: #7f6000; 
            display: flex; /* ä¿æŒ flex å¸ƒå±€ */
            align-items: flex-start; /* é¡¶éƒ¨å¯¹é½ */
            gap: 10px; 
            line-height: 1.6;
        }

        /* å›ºå®šå·¦ä¾§æ ‡ç­¾ï¼Œä¸è®©å®ƒç¼©è¿›æˆ–æ¢è¡Œ */
        .decision-label {
            flex-shrink: 0; /* ç¦æ­¢ç¼©å° */
            font-weight: bold;
            white-space: nowrap; /* ç¦æ­¢æ¢è¡Œ */
            display: flex;
            align-items: center;
        }

        /* å³ä¾§æ–‡æœ¬è‡ªåŠ¨æ¢è¡Œå¹¶ä¿æŒç¼©è¿›å¯¹é½ */
        .decision-text {
            word-break: break-all; /* å…è®¸åœ¨å•è¯å†…æ¢è¡Œ */
            text-align: justify; /* ä¸¤ç«¯å¯¹é½ï¼Œæ›´å·¥æ•´ */
        }
        .decision-time { font-size: 0.8em; color: #999; margin-top: 5px; text-align: right; }

        #loading { text-align: center; color: #999; margin-top: 50px; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1 style="margin:0;">ğŸ’¼ é¢†åœ°æ”¿åŠ¡å…</h1>
        <a href="index.html" class="back-btn">â¬… è¿”å›ä¸»æ§å°</a>
    </div>

    <!-- é¡¶éƒ¨èµ„äº§æ˜¾ç¤º -->
    <div style="text-align: right; margin-bottom: 20px; font-weight: bold; color: #d35400;">
        å½“å‰å›½åº“: <span id="current-gold">Loading...</span> GP
    </div>

    <div id="loading">æ­£åœ¨åŠ è½½...</div>

    <!-- å¾…å®¡æ‰¹ -->
    <div id="pending-section" style="display:none;">
        <div class="section-title">ğŸ”´ å¾…å®¡æ‰¹è®®æ¡ˆ</div>
        <div id="pending-list"></div>
    </div>

    <!-- å†å²è®°å½• -->
    <div id="history-section" style="display:none;">
        <div class="section-title">ğŸ—„ï¸ å†å²å†³ç­–æ¡£æ¡ˆ</div>
        <div id="history-list"></div>
    </div>
</div>

<script>
    const SUPABASE_URL = 'https://vbzfpgucpciqgaakqndz.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZiemZwZ3VjcGNpcWdhYWtxbmR6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc1OTc2MzMsImV4cCI6MjA4MzE3MzYzM30.fBVDirEJ52bvrYJZ5DNv7fVDLNgCwITKwdKqT6YJDYw';
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    let userProfile = null;
    let employeeMap = {}; 

    async function init() {
        const { data: { user } } = await supabaseClient.auth.getUser();
        if (!user) { alert('è¯·å…ˆç™»å½•'); window.location.href = 'index.html'; return; }

        // --- æ”¯æŒä» URL è·å– ID  ---
        const urlParams = new URLSearchParams(window.location.search);
        const targetId = urlParams.get('uid') || user.id;

        // è·å–ç›®æ ‡ç”¨æˆ·çš„é‡‘å¸
        const { data: prof } = await supabaseClient.from('profiles').select('*').eq('id', targetId).single();
        if (prof) {
            userProfile = prof;
            document.getElementById('current-gold').innerText = prof.gold_gp.toLocaleString();
        }

        // è·å–ç›®æ ‡ç”¨æˆ·çš„é›‡å‘˜å¤´åƒ
        const { data: emps } = await supabaseClient.from('employees').select('name, avatar_url').eq('user_id', targetId);
        if (emps) { emps.forEach(e => employeeMap[e.name] = e.avatar_url); }

        // åŠ è½½ç›®æ ‡ç”¨æˆ·çš„è®®æ¡ˆ
        loadProposals(targetId);

        setupRealtime(targetId);
    }

    async function loadProposals(userId) {
        // æŒ‰æœ€åæ›´æ–°æ—¶é—´æ’åºï¼Œè¿™æ ·åˆšå†³ç­–çš„ä¼šåœ¨æœ€ä¸Šé¢
        const { data: list, error } = await supabaseClient
            .from('city_proposals')
            .select('*')
            .eq('user_id', userId)
            .order('decided_at', { ascending: false, nullsFirst: true }) // å·²å†³ç­–çš„æŒ‰æ—¶é—´å€’åºï¼Œæœªå†³ç­–çš„æ’æœ€å‰
            .order('created_at', { ascending: false });

        if (error) return alert('åŠ è½½å¤±è´¥');

        document.getElementById('loading').style.display = 'none';
        const pendingBox = document.getElementById('pending-list');
        const historyBox = document.getElementById('history-list');
        pendingBox.innerHTML = '';
        historyBox.innerHTML = '';

        let hasPending = false;
        let hasHistory = false;

        list.forEach(item => {
            const avatarUrl = employeeMap[item.proposer_name] || 'https://via.placeholder.com/70';
            const costHtml = item.cost > 0 
                ? `<div class="cost-tag">ğŸ’° -${item.cost.toLocaleString()} GP</div>` 
                : `<div class="cost-tag" style="color:#27ae60; font-size:0.9em;">æ— éœ€é¢å¤–é¢„ç®—</div>`;

            if (item.status === 'pending') {
                hasPending = true;
                pendingBox.innerHTML += `
                    <div class="proposal-card">
                        <div class="avatar-box">
                            <img src="${avatarUrl}" class="avatar">
                            <div class="proposer-name">${item.proposer_name}</div>
                        </div>
                        <div class="content-box">
                            <div>
                                <div class="prop-title">${item.title}</div>
                                <div class="prop-desc">${item.description}</div>
                            </div>
                            <div class="action-bar">
                                ${costHtml}
                                <div class="btn-group">
                                    <button class="btn-approve" onclick="handleDecision(${item.id}, 'approved', ${item.cost}, '${item.title}')">âœ… æ‰¹å‡†</button>
                                    <button class="btn-reject" onclick="handleDecision(${item.id}, 'rejected', 0, '${item.title}')">âŒ å¦å†³</button>
                                </div>
                            </div>
                        </div>
                    </div>`;
            } else {
                hasHistory = true;
                const isApproved = item.status === 'approved';
                const statusTag = isApproved 
                    ? `<span class="status-badge status-approved">å·²æ‰¹å‡†</span>`
                    : `<span class="status-badge status-rejected">å·²å¦å†³</span>`;
                
                // å¤„ç†æ—¶é—´æ˜¾ç¤º
                const dateStr = item.decided_at ? new Date(item.decided_at).toLocaleString() : 'æœªçŸ¥æ—¥æœŸ';
                
                // å¤„ç†æ‰¹æ³¨æ˜¾ç¤º
                const reasonHtml = item.decision_reason 
                    ? `<div class="decision-note">
                         <span class="decision-label">ğŸ“ é¢†ä¸»æ‰¹æ³¨ï¼š</span>
                         <span class="decision-text">${item.decision_reason}</span>
                       </div>` 
                    : '';


                historyBox.innerHTML += `
                    <div class="proposal-card history-card ${item.status}">
                        <div class="avatar-box">
                            <img src="${avatarUrl}" class="avatar" style="filter:grayscale(80%)">
                            <div class="proposer-name">${item.proposer_name}</div>
                        </div>
                        <div class="content-box">
                            <div style="display:flex; justify-content:space-between;">
                                <div class="prop-title">${item.title}</div>
                                ${statusTag}
                            </div>
                            <div class="prop-desc" style="color:#888;">${item.description}</div>
                            
                            ${reasonHtml}
                            <div class="decision-time">å†³ç­–æ—¶é—´: ${dateStr}</div>
                        </div>
                    </div>`;
            }
        });

        if (hasPending) document.getElementById('pending-section').style.display = 'block';
        if (hasHistory) document.getElementById('history-section').style.display = 'block';
        if (!hasPending && !hasHistory) document.getElementById('loading').innerText = "æš‚æ— ä»»ä½•è®®æ¡ˆã€‚";
    }

    // --- å†³ç­–é€»è¾‘ ---
    async function handleDecision(id, decision, cost, title) {
        // 1. å¼¹å‡ºè¾“å…¥æ¡†è¯¢é—®ç†ç”±
        const actionName = decision === 'approved' ? 'æ‰¹å‡†' : 'å¦å†³';
        const defaultReason = decision === 'approved' ? 'åŒæ„æ‰§è¡Œã€‚' : 'æš‚ç¼“è®®æ¡ˆã€‚';
        
        const reason = prompt(`æ‚¨å†³å®š [${actionName}] ææ¡ˆï¼š${title}\n\nè¯·è¾“å…¥å†³ç­–ç†ç”±/æ‰¹æ³¨ (å¯é€‰):`, defaultReason);
        
        if (reason === null) return; // ç‚¹å‡»å–æ¶ˆï¼Œç»ˆæ­¢æ“ä½œ

        // 2. èµ„é‡‘æ£€æŸ¥
        if (decision === 'approved' && cost > 0) {
            if (userProfile.gold_gp < cost) {
                return alert('å›½åº“èµ„é‡‘ä¸è¶³ï¼Œæ— æ³•æ‰¹å‡†ï¼');
            }
            const newGold = userProfile.gold_gp - cost;
            const { error } = await supabaseClient.from('profiles').update({ gold_gp: newGold }).eq('id', userProfile.id);
            if (error) return alert('æ‰£æ¬¾å¤±è´¥');
            userProfile.gold_gp = newGold;
            document.getElementById('current-gold').innerText = newGold.toLocaleString();
        }

        // 3. æ›´æ–°æ•°æ®åº“ (çŠ¶æ€ + ç†ç”± + æ—¶é—´)
        const { error: updateErr } = await supabaseClient
            .from('city_proposals')
            .update({ 
                status: decision,
                decision_reason: reason,
                decided_at: new Date().toISOString()
            })
            .eq('id', id);

        if (updateErr) {
            alert('æ“ä½œå¤±è´¥');
        } else {
            alert('å…¬æ–‡å·²å½’æ¡£ã€‚');
            location.reload(); 
        }
    }

    function setupRealtime(targetId) {
        // åˆ›å»ºä¸€ä¸ªå®æ—¶é¢‘é“
        const proposalChannel = supabaseClient
            .channel('proposal_realtime')
            .on(
                'postgres_changes', 
                { 
                    event: '*', // ç›‘å¬æ‰€æœ‰å˜åŠ¨ï¼šæ–°å¢ã€ä¿®æ”¹ã€åˆ é™¤
                    schema: 'public', 
                    table: 'city_proposals',
                    filter: `user_id=eq.${targetId}` // å…³é”®ï¼šåªç›‘å¬å½“å‰æ­£åœ¨çœ‹çš„é‚£ä¸ªç©å®¶çš„å˜åŠ¨
                }, 
                (payload) => {
                    console.log('æ£€æµ‹åˆ°ä½é¢æ³¢åŠ¨ï¼Œææ¡ˆè¡¨å·²æ›´æ–°:', payload);
                    // åªè¦æ•°æ®åº“å˜äº†ï¼Œå°±é‡æ–°åŠ è½½åˆ—è¡¨å’Œé‡‘å¸
                    loadProposals(targetId); 
                    // é¡ºä¾¿åˆ·æ–°ä¸€ä¸‹é‡‘å¸æ˜¾ç¤ºï¼Œé˜²æ­¢é’±æ‰£äº†è¿™è¾¹ä¸çŸ¥é“
                    refreshGoldDisplay(targetId);
                }
            )
            .subscribe();
    }

    // å•ç‹¬åˆ·æ–°é‡‘å¸æ˜¾ç¤º
    async function refreshGoldDisplay(userId) {
        const { data: prof } = await supabaseClient.from('profiles').select('gold_gp').eq('id', userId).single();
        if (prof) {
            document.getElementById('current-gold').innerText = prof.gold_gp.toLocaleString();
            userProfile.gold_gp = prof.gold_gp; // æ›´æ–°æœ¬åœ°ç¼“å­˜
        }
    }

    init();
</script>
</body>
</html>
