<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>è‰¾å°”è«ç‘å°” - é¢†åœ°è¡Œæ”¿ç»ˆç«¯</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        :root {
            --bg-color: #f4f1ea; 
            --panel-bg: #ffffff;
            --text-main: #2c3e50;
            --accent-gold: #c5a059; 
            --accent-blue: #34495e;
            --border-color: #dcd6cc;
            --danger-color: #c0392b;
            --success-color: #27ae60;
            --state-color: #8e44ad; /* å›½è¥äº§ä¸šä¸“ç”¨ç´« */
            --trade-color: #2980b9; /* è´¸æ˜“ä¸“ç”¨è“ */
        }

        body { font-family: "PingFang SC", "Microsoft YaHei", serif; background-color: var(--bg-color); color: var(--text-main); margin: 0; padding: 0; height: 100vh; overflow: hidden; }
        .layout { display: grid; grid-template-columns: 1fr 260px; height: 100%; }
        
        /* å†…å®¹åŒº */
        .main-content { padding: 40px; overflow-y: auto; display: flex; flex-direction: column; }
        .city-header { border-bottom: 2px solid var(--accent-gold); padding-bottom: 15px; margin-bottom: 30px; display: flex; justify-content: space-between; align-items: end; }
        .city-name { font-size: 2.5em; font-weight: bold; letter-spacing: 2px; color: var(--text-main); }
        .city-info { font-size: 0.9em; color: #666; font-family: sans-serif; }

        /* æ¦‚è§ˆ */
        #overview-panel { display: block; animation: fadeIn 0.5s; }
        .kpi-row { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 30px; }
        .kpi-card { background: var(--panel-bg); padding: 20px; border-radius: 4px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); border-top: 4px solid var(--accent-blue); text-align: center; }
        .kpi-value { font-size: 2em; font-weight: bold; margin: 10px 0; }
        .kpi-label { color: #7f8c8d; font-size: 0.9em; text-transform: uppercase; letter-spacing: 1px; }
        .kpi-sub { font-size: 0.8em; font-weight: bold; }

        /* å›¾è¡¨åŒºåŸŸ */
        .charts-row { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px; }
        .chart-box { background: var(--panel-bg); padding: 20px; border-radius: 4px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); position: relative; display: flex; flex-direction: column; }
        .chart-title { text-align: center; font-weight: bold; margin-bottom: 15px; color: var(--accent-blue); border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .canvas-container { position: relative; height: 300px; width: 100%; }

        /* æ•°æ®è¡¨æ ¼æ ·å¼ */
        .data-section { background: var(--panel-bg); padding: 25px; border-radius: 4px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); margin-bottom: 30px; border: 1px solid var(--border-color); }
        .section-header { font-size: 1.2em; font-weight: bold; color: var(--accent-blue); border-left: 5px solid var(--accent-gold); padding-left: 15px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; }
        
        .finance-table, .staff-table { width: 100%; border-collapse: collapse; font-size: 0.95em; }
        .finance-table th, .staff-table th { text-align: left; padding: 12px; background: #f8f9fa; border-bottom: 2px solid #eee; color: #666; }
        .finance-table td, .staff-table td { padding: 12px; border-bottom: 1px solid #eee; }
        .finance-table tr:last-child td { border-bottom: none; }
        
        .amount-col { text-align: right; font-family: monospace; font-weight: bold; }
        .income-text { color: var(--success-color); }
        .expense-text { color: var(--danger-color); }
        .total-row { background: #fdfdfd; font-weight: bold; border-top: 2px solid #ddd; }
        
        .tag-box { display: inline-block; padding: 2px 8px; border-radius: 4px; font-size: 0.8em; background: #eee; color: #555; }
        
        /* ç‰¹å®šæ ‡ç­¾é¢œè‰² */
        .tag-tax { background: #e3f2fd; color: #1976d2; } /* äººå¤´ç¨è“ */
        .tag-state { background: #f3e5f5; color: #8e44ad; } /* å›½è¥ç´« */
        .tag-trade { background: #eafaf1; color: #27ae60; } /* è´¸æ˜“ç»¿ */
        .tag-cost { background: #fdeaea; color: #c0392b; } /* æˆæœ¬çº¢ */
        .tag-special { background: #fff8e1; color: #f39c12; } /* ä¸“é¡¹ç¨æ©™ */


        /* è¯¦æƒ… */
        #detail-panel { display: none; animation: fadeIn 0.3s; height: 100%; }
        .suzerain-container { background: var(--panel-bg); border: 1px solid var(--border-color); box-shadow: 0 10px 30px rgba(0,0,0,0.1); height: 100%; display: flex; flex-direction: column; max-width: 800px; margin: 0 auto; }
        .suz-header { background: var(--accent-blue); color: #fff; padding: 15px; text-align: center; font-size: 1.2em; letter-spacing: 2px; font-weight: bold; border-bottom: 4px solid var(--accent-gold); }
        .suz-list { flex: 1; overflow-y: auto; padding: 20px; background: #fff; }
        .suz-item { padding: 15px; border: 1px solid #eee; margin-bottom: 10px; cursor: pointer; transition: 0.2s; border-left: 4px solid transparent; }
        .suz-item:hover { background: #f9f9f9; border-left-color: #ddd; }
        .suz-item.active { background: #f0f4f8; border-left-color: var(--accent-gold); border-color: var(--accent-gold); }
        .suz-item-title { font-weight: bold; font-size: 1.1em; }
        .suz-desc-box { background: var(--accent-blue); color: #fff; padding: 25px; min-height: 140px; font-size: 0.95em; line-height: 1.6; border-top: 4px solid var(--accent-gold); box-shadow: inset 0 5px 15px rgba(0,0,0,0.2); }

        /* ä¾§è¾¹æ  */
        .sidebar { background: #fff; border-left: 1px solid var(--border-color); padding: 20px 10px; display: flex; flex-direction: column; gap: 8px; box-shadow: -5px 0 20px rgba(0,0,0,0.02); z-index: 10; }
        .menu-btn { display: flex; align-items: center; gap: 12px; padding: 12px 15px; border: none; background: #fdfdfd; color: #666; cursor: pointer; transition: 0.2s; border-radius: 6px; font-size: 0.95em; text-align: left; font-family: inherit; }
        .menu-btn:hover { background: #f4f1ea; color: #333; }
        .menu-btn.active { background: var(--accent-blue); color: #fff; box-shadow: 0 4px 8px rgba(52, 73, 94, 0.2); }
        .menu-icon { width: 24px; text-align: center; }
        .back-link { margin-top: auto; text-align: center; color: #999; text-decoration: none; font-size: 0.8em; padding: 10px; }
        .back-link:hover { color: #333; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

<div class="layout">
    <div class="main-content">
        <div class="city-header">
            <div class="city-name">ALMOREL <span style="font-size:0.5em; font-weight:normal; color:#666;">è‰¾å°”è«ç‘å°”</span></div>
            <div class="city-info" id="date-display">FR1494</div>
        </div>

        <div id="overview-panel">
            <div class="kpi-row">
                <div class="kpi-card">
                    <div class="kpi-label">å½“å‰äººå£</div>
                    <div class="kpi-value" id="kpi-pop">6,109</div>
                    <div style="font-size:0.8em; color:green;">â–² ç¨³å®šå¢é•¿</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-label">æœˆåº¦å‡€æ”¶å…¥</div>
                    <div class="kpi-value" id="kpi-income">Calculating...</div>
                    <div class="kpi-sub" id="kpi-income-sub">...</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-label">æ²»å®‰æŒ‡æ•°</div>
                    <div class="kpi-value" style="color:green;">ä¼˜ç§€</div>
                    <div style="font-size:0.8em; color:#666;">ç¥è¿¹å·²ç»é™ä¸´</div>
                </div>
            </div>

            <div class="charts-row">
                <div class="chart-box">
                    <div class="chart-title">ç§æ—æ„æˆ (Demographics)</div>
                    <div class="canvas-container"><canvas id="raceChart"></canvas></div>
                </div>
                <div class="chart-box">
                    <div class="chart-title">å®—æ•™ä¿¡ä»° (Religion)</div>
                    <div class="canvas-container"><canvas id="faithChart"></canvas></div>
                </div>
            </div>

            <div class="data-section">
                <div class="section-header">
                    <span>ğŸ“œ æœˆåº¦è´¢æ”¿æ”¶æ”¯è¯¦å•</span>
                    <span style="font-size:0.8em; color:#666; font-weight:normal;">å•ä½: é‡‘å¸ (GP)</span>
                </div>
                <table class="finance-table">
                    <thead>
                        <tr><th>é¡¹ç›®</th><th>è¯´æ˜</th><th class="amount-col">é‡‘é¢</th></tr>
                    </thead>
                    <tbody id="finance-table-body">
                        </tbody>
                </table>
            </div>

            <div class="data-section">
                <div class="section-header">
                    <span>ğŸ’° ç¨æ”¶æ˜ç»† (Tax Revenue)</span>
                    <span style="font-size:0.8em; color:#666; font-weight:normal;">å«äººå¤´ç¨ä¸ä¸“é¡¹ç¨</span>
                </div>
                <table class="finance-table">
                    <thead>
                        <tr>
                            <th>ç¨ç§</th>
                            <th>å¾æ”¶æ ‡å‡†/æ¥æº</th>
                            <th class="amount-col">å¾æ”¶æ€»é¢</th>
                        </tr>
                    </thead>
                    <tbody id="tax-table-body">
                        </tbody>
                </table>
            </div>

            <div class="data-section">
                <div class="section-header">
                    <span>ğŸ‘¥ åŸå¸‚èŒå‘˜ç¼–åˆ¶ (ä¸å«ç‰¹æ®Šé›‡å‘˜)</span>
                </div>
                <table class="staff-table">
                    <thead>
                        <tr><th>èŒèƒ½</th><th>äººæ•°</th><th>æœˆè–ªæ ‡å‡†</th><th class="amount-col">æœˆåº¦æ€»æ”¯å‡º</th></tr>
                    </thead>
                    <tbody id="staff-table-body">
                        </tbody>
                </table>
            </div>

            <div class="data-section">
                <div class="section-header">
                    <span>âš–ï¸ è´¸æ˜“ä¸äº§ä¸šæ”¶æ”¯</span>
                </div>
                <table class="finance-table">
                    <thead>
                        <tr><th>é¡¹ç›®åç§°</th><th>ç±»å‹</th><th>è¯¦æƒ…</th><th class="amount-col">æœˆåº¦é¢åº¦</th></tr>
                    </thead>
                    <tbody id="trade-table-body">
                        </tbody>
                </table>
            </div>

            <div class="data-section">
                <div class="section-header">
                    <span>ğŸ—ï¸ åŸå¸‚åŸºç¡€è®¾æ–½ç»´æŠ¤è¯¦å•</span>
                </div>
                <table class="finance-table">
                    <thead>
                        <tr><th>è®¾æ–½åç§°</th><th>æ•°é‡</th><th>å•é¡¹ç»´æŠ¤è´¹</th><th class="amount-col">æœˆåº¦æ€»æ”¯å‡º</th></tr>
                    </thead>
                    <tbody id="building-table-body">
                        </tbody>
                </table>
            </div>
        </div>

        <div id="detail-panel">
            <div class="suzerain-container">
                <div class="suz-header" id="suz-title">...</div>
                <div class="suz-list" id="suz-list"></div>
                <div class="suz-desc-box" id="suz-desc">è¯·ä»ä¸Šæ–¹é€‰æ‹©ä¸€é¡¹æ¡ç›®ä»¥æŸ¥çœ‹è¯¦ç»†æŠ¥å‘Šã€‚</div>
            </div>
        </div>
    </div>

    <div class="sidebar">
        <button class="menu-btn active" onclick="showOverview()"><span class="menu-icon">ğŸ“Š</span> åŸå¸‚æ¦‚è§ˆ</button>
        <div style="height:1px; background:#eee; margin:5px 0;"></div>
        <button class="menu-btn" onclick="showCategory('economy')"><span class="menu-icon">ğŸ’°</span> ç»æµ</button>
        <button class="menu-btn" onclick="showCategory('law')"><span class="menu-icon">âš–ï¸</span> æ³•å¾‹</button>
        <button class="menu-btn" onclick="showCategory('military')"><span class="menu-icon">âš”ï¸</span> å†›äº‹</button>
        <button class="menu-btn" onclick="showCategory('welfare')"><span class="menu-icon">â¤ï¸</span> ç¦åˆ©</button>
        <button class="menu-btn" onclick="showCategory('order')"><span class="menu-icon">ğŸ‘®</span> æ²»å®‰</button>
        <button class="menu-btn" onclick="showCategory('diplomacy')"><span class="menu-icon">ğŸ¤</span> å¤–äº¤</button>
        <a href="index.html" class="back-link">â¬… è¿”å›ä¸»æ§å°</a>
    </div>
</div>

<script>
    // --- é…ç½® Supabase ---
    const SUPABASE_URL = 'https://vbzfpgucpciqgaakqndz.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZiemZwZ3VjcGNpcWdhYWtxbmR6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc1OTc2MzMsImV4cCI6MjA4MzE3MzYzM30.fBVDirEJ52bvrYJZ5DNv7fVDLNgCwITKwdKqT6YJDYw';
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    let cityStats = {
        population: 0,       
        subsidy: 0,          
        employee_expense: 0  
    };

    // --- é™æ€æè¿°æ€§æ–‡æœ¬ (å·²æ›´æ–°ï¼šå»é“å¾·åŒ–ï¼Œå®¢è§‚æè¿°) ---
    const dataStore = {
        'military': {
            title: "MILITARY / å†›äº‹æ¦‚å†µ",
            items: [
                { title: "è±¡å¾æ€§å…µå½¹åˆ¶", desc: "æ‰€æœ‰é€‚é¾„äººå£åœ¨è¾¾åˆ° 18 å²æ—¶å¿…é¡»æœå½¹2ä¸ªæœˆã€‚è¿™ç¡®ä¿äº†åœ¨è¾¹å¢ƒå†²çªé¢‘ç¹çš„åŠ¨è¡å¹´ä»£ï¼ŒåŸå¸‚å§‹ç»ˆä¿æœ‰å……è¶³çš„å…µå‘˜å‚¨å¤‡ã€‚" },
                { title: "ä½èƒ½çš„å‚è°‹éƒ¨", desc: "è™½ç„¶åä¹‰ä¸Šæ‹¥æœ‰å‚è°‹æŒ‡æŒ¥ç³»ç»Ÿï¼Œä½†ç”±äºç¼ºä¹ç»éªŒä¸°å¯Œçš„é«˜çº§å†›å®˜ï¼Œç›®å‰çš„å‚è°‹éƒ¨ååº”è¿Ÿé’ã€‚" },
                { title: "ä¸­å¤®å°–å¡”", desc: "è¿™æ˜¯è‰¾å°”è«ç‘å°”æœ€ä»¤äººæ•¬ç•çš„é˜²å¾¡æ ¸å¿ƒã€‚è¿™åº§é­”æ³•å°–å¡”èƒ½å¤Ÿå‘å…¨åŸèŒƒå›´é‡Šæ”¾æ¯ç­æ€§çš„é—ªç”µé£æš´ã€‚" },
                { title: "æ­»çµåŒ»å­¦ç ”ç©¶æ‰€", desc: "å¯¹å¤–ä¸æŒ‚ç‰Œï¼Œå®åˆ™æ˜¯ä¸€ä¸ªåŠåœ°ä¸‹çš„æ­»çµæ³•æœ¯è®¾æ–½ã€‚" },
                { title: "å†›å¤‡å‚¨å¤‡", desc: "å¾—ç›Šäºä¸“é¡¹æ‹¨æ¬¾ï¼Œå«é˜Ÿçš„æ­¦å™¨è£…å¤‡å¾—åˆ°äº†å…¨é¢æ›´æ–°ï¼Œæ²»å®‰æ‰€ä¹Ÿè¿›è¡Œäº†æ‰©å»ºã€‚" }
            ]
        },
        'economy': {
            title: "ECONOMY / ç»æµæ¦‚å†µ",
            items: [
                { title: "é­”æ³•ç‰©å“è´¸æ˜“", desc: "åŸå¸‚ä¸é­”æ³•å›½åº¦å“ˆé²é˜¿è¾¾æˆäº†å…³é”®è´¸æ˜“åå®šï¼šè‰¾å°”è«ç‘å°”æ¯ä¸ƒå¤©å‘å…¶ä¾›ç»™ä¸¤ä»¶éæ™®é€šçº§é­”æ³•ç‰©å“ã€‚ä½œä¸ºå›æŠ¥ï¼Œå“ˆé²é˜¿è´Ÿè´£ä¾›ç»™ç»´æŒ 5000 äººç”Ÿå­˜çš„ç²®é£Ÿã€‚" },
                { title: "ç²®é£Ÿä¾èµ–", desc: "æœ¬åœ°å†œä¸šäº§å‡ºä¸è¶³ä»¥ç»´æŒäººå£æ¶ˆè€—ï¼ŒåŸå¸‚å‘½è„‰å®Œå…¨ç³»äºé­”æ³•ç‰©å“è´¸æ˜“ã€‚ä¸€æ—¦é­”æ³•å·¥åŠåœäº§æˆ–è´¸æ˜“è·¯çº¿è¢«åˆ‡æ–­ï¼Œé¥¥è’å°†ä¸å¯é¿å…ã€‚" },
                { title: "é£èˆ¹è´¸æ˜“", desc: "æ–°å»ºçš„é£èˆ¹åœæ³Šæ¸¯æå¤§æå‡äº†ç‰©æµæ•ˆç‡ã€‚åŸå¸‚æ­£æˆä¸ºåŒºåŸŸæ€§çš„ç©ºä¸­äº¤é€šæ¢çº½ã€‚" },
                { title: "å€ºåŠ¡æ‰©å¼ å‹ç»æµ", desc: "é€šè¿‡å‘è¡Œâ€œä¸¤å¹´æœŸåŸå¸‚å€ºåˆ¸â€ï¼Œå¸‚æ”¿å…ç¬é—´è·å¾—äº†å·¨å¤§çš„ç°é‡‘æµç”¨äºåŸºå»ºã€‚" },
                { title: "å„æ–­èµ„æœ¬", desc: "å¸‚æ”¿å…å¼ºåˆ¶å„æ–­äº†æ²»ç–—è¯æ°´äº§ä¸šï¼Œå¹¶æ¨è¡Œäº†æ€ªç‰©ç‹©çŒè®¸å¯åˆ¶åº¦ï¼Œå¤§éƒ¨åˆ†é«˜åˆ©æ¶¦è¡Œä¸šå·²è¢«æ”¶å½’å›½æœ‰æˆ–å®˜æ–¹ç‰¹è®¸ç»è¥ã€‚" },
                { title: "é’ˆå¯¹æ€§å…³ç¨", desc: "è™½ç„¶åŸºç¡€å•†ä¸šç¨ç»´æŒä¸­ç­‰ï¼Œä½†é’ˆå¯¹å¤–æ¥å•†é˜Ÿå’Œå¥¢ä¾ˆå“äº¤æ˜“å¾æ”¶äº†é‡ç¨ã€‚" }
            ]
        },
        'law': {
            title: "LAW / æ³•å¾‹ä¸æ”¿ç­–",
            items: [
                { title: "å¸‚è®®ä¼šèŒèƒ½æš‚åœ", desc: "é‰´äºå½“å‰çš„ç´§æ€¥çŠ¶æ€ï¼Œæ°‘é€‰å¸‚è®®ä¼šçš„ç«‹æ³•ä¸å†³ç­–èŒèƒ½å·²è¢«æ— é™æœŸå†»ç»“ã€‚æ‰€æœ‰è¡Œæ”¿å‘½ä»¤ç›´æ¥ç”±é¢†ä¸»åºœç­¾å‘ã€‚" },
                { title: "åŸä¸»è±å…æƒ", desc: "æ³•å¾‹æ˜ç¡®è§„å®šï¼Œç°ä»»åŸä¸»åœ¨è¡Œä½¿èŒæƒæ—¶äº«æœ‰å®Œå…¨çš„å¸æ³•è±å…æƒã€‚è¿™ä¸€æ¡æ¬¾ç¡®ä¿äº†å†³ç­–å±‚çš„ç»å¯¹æƒå¨ã€‚" },
                { title: "å¤œé—´å®µç¦ä»¤", desc: "æ¯æ™š 22:00 è‡³æ¬¡æ—¥ 6:00 å®æ–½å…¨åŸå®µç¦ã€‚" },
                { title: "å®˜æ–¹å–‰èˆŒ", desc: "ã€ŠçœŸç†æŠ¥ã€‹ä½œä¸ºå¸‚æ”¿å…ç»å¯¹æ§è‚¡çš„åª’ä½“ï¼Œä¸»å¯¼äº†åŸå¸‚çš„èˆ†è®ºæ–¹å‘ã€‚" },
                { title: "å®—æ•™ä¿¡ä»°è‡ªç”±", desc: "è¿™æ›¾æ˜¯è‰¾å°”è«ç‘å°”ç¹è£çš„åŸºçŸ³ï¼Œä¹Ÿæ˜¯å¦‚ä»Šä¿¡ä»°æ··æ‚çš„åŸå› ã€‚åªè¦ä¸è¿›è¡Œè¡€ç¥­æˆ–å¬å”¤æ¶é­”ï¼Œä»»ä½•ç¥ç¥‡çš„ä¿¡å¾’éƒ½èƒ½åœ¨æ­¤æ‰¾åˆ°ä¸€å¸­ä¹‹åœ°ã€‚" }
            ]
        },
        'welfare': { 
            title: "WELFARE / ç¤¾ä¼šç¦åˆ©", 
            items: [
                { title: "é˜¶çº§åˆ†åŒ–çš„æ•™è‚²", desc: "ç²¾è‹±åŒ–çš„â€œæç±³æ©æ–¯é­”æ³•å­¦é™¢â€åˆ†æ ¡ä¸åŸºç¡€è¯†å­—ç­å¹¶å­˜ã€‚é­”æ³•åŠ›é‡æŒæ¡åœ¨å°‘æ•°ä»˜è´¹è€…å’Œè´µæ—æ‰‹ä¸­ã€‚" },
                { title: "é¢åŒ…ä¸é©¬æˆ", desc: "é€šè¿‡å»ºè®¾å…¬å…±æµ´åœºã€é­”æ³•å–·æ³‰å’Œè§’æ–—åœºï¼Œå¸‚æ”¿å…ä¸ºå¸‚æ°‘æä¾›äº†é«˜å¼ºåº¦çš„å¨±ä¹æ´»åŠ¨ã€‚è¿™åœ¨å®¢è§‚ä¸Šä¸°å¯Œäº†ä¸šä½™ç”Ÿæ´»ï¼Œå¹¶æœ‰æ•ˆç»´æŒäº†ç¤¾ä¼šç§©åºçš„ç¨³å®šã€‚" }, // å·²ä¿®æ­£ï¼šå®¢è§‚æè¿°
                { title: "ä¸‹æ°´é“ä¸å«ç”Ÿ", desc: "è™½ç„¶ç¼ºä¹å™±å¤´ï¼Œä½†ä¸‹æ°´é“ç–é€šå·¥ç¨‹å®æ‰“å®åœ°é™ä½äº†ç˜Ÿç–«é£é™©ã€‚" },
                { title: "å…è´¹ä¸§è‘¬æœåŠ¡", desc: "ç”±å¸‚æ”¿å…å‡ºèµ„ï¼Œç¡®ä¿æ¯ä½é€è€…éƒ½èƒ½å¾—åˆ°ä½“é¢çš„å®‰è‘¬ã€‚è¿™ä¸ä»…æ˜¯å¯¹ç”Ÿå‘½çš„å°Šé‡ï¼Œä¹Ÿæ˜¯ä¸ºäº†é˜²æ­¢äº¡çµç˜Ÿç–«åœ¨è´«æ°‘çªŸæ»‹ç”Ÿçš„ä¸€é¡¹å…¬å…±å«ç”Ÿæªæ–½ã€‚" }
            ] 
        },
        'order': { 
            title: "ORDER / æ²»å®‰", 
            items: [
                { title: "å•†ä¸šåŒ–æ²»å®‰ä½“ç³»", desc: "æ²»å®‰å®˜çš„èƒ½åŠ›ä¾ç„¶å¹³åº¸ï¼Œä½†é€šè¿‡â€œæ€ªç‰©ç‹©çŒè®¸å¯â€ï¼ŒåŸæœ¬ä¹Ÿæ˜¯æ²»å®‰éšæ‚£çš„å†’é™©è€…è¢«è½¬åŒ–ä¸ºä»˜è´¹çš„æ€ªç‰©æ¸…ç†å·¥ã€‚åŸå¸‚å‘¨è¾¹çš„å¨èƒè¢«å¤–åŒ…è§£å†³äº†ã€‚" },
                { title: "é«˜å‹ç®¡æ§", desc: "å®µç¦ä»¤å’Œæ‰©å»ºçš„æ²»å®‰æ‰€è®©åŸå†…çš„æ˜¾æ€§çŠ¯ç½ªç‡æ˜¾è‘—ä¸‹é™ã€‚" }
            ] 
        },
        'diplomacy': { 
            title: "DIPLOMACY / å¤–äº¤å…³ç³»", 
            items: [
                { title: "è±ç‘Ÿæ›¼é“ç›Ÿ", desc: "ç­¾è®¢äº†å…±åŒé˜²å¾¡æ¡çº¦ï¼Œä¸é¥è¿œçš„è±ç‘Ÿæ›¼ç¼”ç»“äº†åšä¸å¯æ‘§çš„å†›äº‹åŒç›Ÿã€‚" }
            ] 
        }
    };

    // --- åˆå§‹åŒ–å‡½æ•° ---
    async function init() {
        const { data: { user } } = await supabaseClient.auth.getUser();
        if (!user) { alert('è¯·å…ˆç™»å½•'); window.location.href = 'index.html'; return; }
        
        const urlParams = new URLSearchParams(window.location.search);
        const targetId = urlParams.get('uid');
        
        const viewingId = targetId || user.id;

        console.log("å½“å‰æŸ¥çœ‹çš„é¢†åœ°å½’å± ID:", viewingId);

        renderCharts();
        
        await syncEmployeeData(viewingId); 
        await loadAndRenderFinance(viewingId); 
    }

    // --- ä»æ•°æ®åº“åŠ è½½å¹¶è®¡ç®—è´¢åŠ¡ ---
    async function loadAndRenderFinance(userId) {
        const [statsRes, expensesRes, incomesRes, employeesRes] = await Promise.all([
            supabaseClient.from('city_stats').select('*').eq('user_id', userId).maybeSingle(),
            supabaseClient.from('city_expenses').select('*').eq('user_id', userId),
            supabaseClient.from('city_incomes').select('*').eq('user_id', userId),
            supabaseClient.from('employees').select('salary').eq('user_id', userId).eq('status', 'åœ¨èŒ')
        ]);

        const stats = statsRes.data || { population: 0, subsidy: 0, tax_rate: 1.2 };
        const expenses = expensesRes.data || [];
        const incomes = incomesRes.data || [];
        const employees = employeesRes.data || [];

        // ==========================================
        // 2. æ”¶å…¥è®¡ç®— 
        // ==========================================
        
        // A. åŸºç¡€äººå¤´ç¨ (Head Tax)
        const baseTaxRaw = Math.ceil(stats.population * stats.tax_rate);
        
        // B. å®šä¹‰åˆ†ç±»å…³é”®è¯
        const taxKeywords = ['å¥¢ä¾ˆå“ä¸èƒ­è„‚ç¨', 'è´¸æ˜“å…³ç¨', 'ç¨']; 
        const stateRunKeywords = ['å®˜æ–¹æ²»ç–—è¯æ°´', 'è§’æ–—åœº', 'æ€ªç‰©ç‹©çŒ']; 

        let specializedTaxTotal = 0; // ä¸“é¡¹ç¨æ€»é¢
        let tradeRevenue = 0;        // äº§ä¸š/è´¸æ˜“æ€»é¢
        
        let taxHtml = '';   // ç¨æ”¶è¡¨ HTML
        let tradeHtml = ''; // äº§ä¸šè¡¨ HTML

        // --- ç¨æ”¶è¡¨ç¬¬ä¸€è¡Œï¼šäººå¤´ç¨ (ä½¿ç”¨æ–°æ ‡ç­¾) ---
        taxHtml += `
            <tr>
                <td>åŸºç¡€äººå¤´ç¨</td>
                <td><span class="tag-box tag-tax">äººå¤´ç¨</span></td>
                <td class="amount-col income-text">+${baseTaxRaw}</td>
            </tr>`;

        // --- éå†æ•°æ®åº“æ”¶å…¥é¡¹ ---
        incomes.forEach(i => {
            const count = i.count || 1;
            const unitPrice = i.unit_price || i.amount;
            const total = count * unitPrice;

            // 1. åˆ¤æ–­æ˜¯å¦ä¸ºç¨æ”¶
            const isTax = taxKeywords.some(keyword => i.name.includes(keyword));

            // 2. åˆ¤æ–­æ˜¯å¦ä¸ºå›½è¥ (å¦‚æœä¸æ˜¯ç¨æ”¶)
            const isStateRun = stateRunKeywords.some(keyword => i.name.includes(keyword));

            if (isTax) {
                // ---> å½’å…¥ç¨æ”¶è¡¨
                specializedTaxTotal += total;
                taxHtml += `
                    <tr>
                        <td>${i.name}</td>
                        <td><span class="tag-box tag-special">ä¸“é¡¹ç¨</span></td>
                        <td class="amount-col income-text">+${total}</td>
                    </tr>`;
            } else {
                // ---> å½’å…¥è´¸æ˜“ä¸äº§ä¸šè¡¨
                tradeRevenue += total;
                
                let tagHtml = '';
                if (isStateRun) {
                    // å›½è¥äº§ä¸š (ç´«è‰²)
                    tagHtml = `<span class="tag-box tag-state">å›½è¥</span>`;
                } else {
                    // å¯¹å¤–è´¸æ˜“ (ç»¿è‰²)
                    tagHtml = `<span class="tag-box tag-trade">è´¸æ˜“</span>`;
                }

                tradeHtml += `
                    <tr>
                        <td>${i.name}</td>
                        <td>${tagHtml}</td>
                        <td style="font-family:monospace; color:#555;">${count} x ${unitPrice} GP</td>
                        <td class="amount-col income-text">+${total}</td>
                    </tr>`;
            }
        });

        const totalTaxIncome = baseTaxRaw + specializedTaxTotal;

        // ==========================================
        // 3. æ”¯å‡ºè®¡ç®—
        // ==========================================
        let staffCost = 0;
        let buildingCost = 0;
        let tradeCost = 0;
        
        let staffHtml = '';
        let buildingHtml = '';

        expenses.forEach(e => {
            const cost = e.count * e.unit_cost;
            
            if (e.category === 'staff') {
                staffCost += cost;
                staffHtml += `<tr><td>${e.name}</td><td>${e.count}</td><td>${e.unit_cost} GP</td><td class="amount-col expense-text">-${cost}</td></tr>`;
            } else if (e.category === 'building') {
                buildingCost += cost;
                buildingHtml += `<tr><td>${e.name}</td><td>${e.count}</td><td>${e.unit_cost} GP</td><td class="amount-col expense-text">-${cost}</td></tr>`;
            } else if (e.category === 'trade_cost') {
                tradeCost += cost;
                // è´¸æ˜“æˆæœ¬æ˜¾ç¤ºåœ¨äº§ä¸šè¡¨ä¸­ï¼Œæ ‡çº¢
                tradeHtml += `
                    <tr>
                        <td>${e.name}</td>
                        <td><span class="tag-box tag-cost">æˆæœ¬</span></td>
                        <td style="font-family:monospace; color:#555;">${e.count} x ${e.unit_cost} GP</td>
                        <td class="amount-col expense-text">-${cost}</td>
                    </tr>`;
            }
        });

        const empCost = employees.reduce((sum, e) => sum + e.salary, 0);
        
        // 4. æ±‡æ€»è®¡ç®—
        const totalIncome = totalTaxIncome + stats.subsidy + tradeRevenue;
        const totalExpense = staffCost + buildingCost + tradeCost + empCost;
        const netIncome = totalIncome - totalExpense;

        // 5. æ›´æ–° UI
        document.getElementById('kpi-pop').innerText = stats.population.toLocaleString();
        
        const kpiIncome = document.getElementById('kpi-income');
        kpiIncome.innerText = `${netIncome} GP`;
        kpiIncome.style.color = netIncome >= 0 ? '#27ae60' : '#c0392b';
        document.getElementById('kpi-income-sub').innerText = netIncome < 0 ? 'âš ï¸ èµ¤å­—é¢„è­¦' : 'âœ… è´¢æ”¿å¥åº·';

        // å¡«å……å„åˆ†è¡¨
        document.getElementById('tax-table-body').innerHTML = taxHtml; 
        document.getElementById('staff-table-body').innerHTML = staffHtml;
        document.getElementById('building-table-body').innerHTML = buildingHtml;
        document.getElementById('trade-table-body').innerHTML = tradeHtml;

        // å¡«å……æ€»è´¦å• (Summary Table)
        document.getElementById('finance-table-body').innerHTML = `
            <tr>
                <td><strong>ç¨æ”¶æ€»æ”¶å…¥</strong></td>
                <td>äººå¤´ç¨ + ä¸“é¡¹ç¨</td>
                <td class="amount-col income-text">+${totalTaxIncome}</td>
            </tr>
            <tr><td>å¤–äº¤è¡¥è´´</td><td>è±ç‘Ÿæ›¼æ´åŠ©</td><td class="amount-col income-text">+${stats.subsidy}</td></tr>
            <tr><td>äº§ä¸šè¥æ”¶</td><td>å›½è¥/è´¸æ˜“/è®¸å¯è´¹</td><td class="amount-col income-text">+${tradeRevenue}</td></tr>
            <tr style="background:#f0f9f0;font-weight:bold;"><td colspan="2">æ”¶å…¥å°è®¡</td><td class="amount-col income-text">+${totalIncome}</td></tr>
            
            <tr><td>åŸå¸‚èŒå‘˜</td><td>å«å…µ/æ–‡èŒ/å·¥åŒ </td><td class="amount-col expense-text">-${staffCost}</td></tr>
            <tr><td>è®¾æ–½ç»´æŠ¤</td><td>å»ºç­‘/ç‰©èµ„</td><td class="amount-col expense-text">-${buildingCost}</td></tr>
            <tr><td>è´¸æ˜“æˆæœ¬</td><td>åŸæ–™è¿›å£</td><td class="amount-col expense-text">-${tradeCost}</td></tr>
            <tr><td>ç‰¹æ®Šé›‡å‘˜</td><td>æ ¸å¿ƒå›¢é˜Ÿ</td><td class="amount-col expense-text">-${empCost}</td></tr>
            <tr style="background:#fff0f0;font-weight:bold;"><td colspan="2">æ”¯å‡ºå°è®¡</td><td class="amount-col expense-text">-${totalExpense}</td></tr>
            
            <tr class="total-row"><td colspan="2">æœˆåº¦å‡€åˆ©æ¶¦</td><td class="amount-col" style="color:${netIncome>=0?'#27ae60':'#c0392b'}">${netIncome} GP</td></tr>
        `;
    }

    // åŒæ­¥æ ¸å¿ƒå›¢é˜Ÿæ”¯å‡º
    async function syncEmployeeData(userId) {
        const { data, error } = await supabaseClient
            .from('employees')
            .select('salary')
            .eq('user_id', userId)
            .eq('status', 'åœ¨èŒ'); 

        if (error) {
            console.error("æ— æ³•åŒæ­¥é›‡å‘˜æ•°æ®:", error);
            return;
        }

        const totalSalary = data.reduce((sum, emp) => sum + emp.salary, 0);
        cityStats.employee_expense = totalSalary;
    }

    // --- UI äº¤äº’é€»è¾‘ ---
    function showOverview() {
        document.getElementById('overview-panel').style.display = 'block';
        document.getElementById('detail-panel').style.display = 'none';
        updateActiveBtn(document.querySelector("button[onclick='showOverview()']"));
    }

    function showCategory(key) {
        document.getElementById('overview-panel').style.display = 'none';
        document.getElementById('detail-panel').style.display = 'block';
        
        const data = dataStore[key];
        document.getElementById('suz-title').innerText = data.title;
        const listEl = document.getElementById('suz-list');
        const descEl = document.getElementById('suz-desc');
        
        listEl.innerHTML = '';
        descEl.innerText = "è¯·ä»ä¸Šæ–¹é€‰æ‹©ä¸€é¡¹æ¡ç›®ä»¥æŸ¥çœ‹è¯¦ç»†æŠ¥å‘Šã€‚";

        data.items.forEach(item => {
            const div = document.createElement('div');
            div.className = 'suz-item';
            div.innerHTML = `<div class="suz-item-title">${item.title}</div>`;
            div.onclick = function() {
                document.querySelectorAll('.suz-item').forEach(i => i.classList.remove('active'));
                div.classList.add('active');
                descEl.innerText = item.desc;
            };
            listEl.appendChild(div);
        });

        const btn = document.querySelector(`button[onclick="showCategory('${key}')"]`);
        updateActiveBtn(btn);
    }

    function updateActiveBtn(activeBtn) {
        document.querySelectorAll('.menu-btn').forEach(b => b.classList.remove('active'));
        if(activeBtn) activeBtn.classList.add('active');
    }

    // --- å›¾è¡¨æ¸²æŸ“ ---
    // --- æ›´æ–°åçš„å›¾è¡¨æ¸²æŸ“ ---
function renderCharts() {

    new Chart(document.getElementById('raceChart'), {
        type: 'doughnut',
        data: {
            labels: ['äººç±»', 'çŸ®äºº', 'åŠç²¾çµ', 'ç²¾çµ', 'åœ°ç²¾', 'å…½äºº', 'æå¤«æ—', 'é¾™è£”', 'ä¾å„’', 'é˜¿æ–¯è«', 'ç‹å¦–', 'ç‹—å¤´äºº', 'é¾™'],
            datasets: [{
                data: [62.5, 11.0, 6.8, 3.7, 3.0, 2.5, 2.5, 2.0, 2.0, 1.5, 1.3, 1.0, 0.2],
                backgroundColor: [
                    '#2c3e50', // äººç±»
                    '#7f8c8d', // çŸ®äºº
                    '#e67e22', // åŠç²¾çµ
                    '#27ae60', // ç²¾çµ
                    '#8e44ad', // åœ°ç²¾ 
                    '#f1c40f', // å…½äºº
                    '#800000', // æå¤«æ— 
                    '#B22222', // é¾™è£”
                    '#c0392b', // ä¾å„’
                    '#FFD700', // é˜¿æ–¯è« 
                    '#ff9ff3', // ç‹å¦–
                    '#8B4513', // ç‹—å¤´äºº
                    '#E5E4E2', // çœŸé¾™
                ],
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { 
                legend: { position: 'right', labels: { boxWidth: 12, font: { size: 11 } } },
                title: { display: true, text: 'åŸå¸‚ç§æ—æ„æˆ (åŒ—é£é™ä¸´å)', font: { size: 14 } }
            }
        }
    });

    new Chart(document.getElementById('faithChart'), {
        type: 'pie',
        data: {
            labels: ['å·´å“ˆå§†ç‰¹', 'æ¸¥é‡‘', 'æ´›å±±è¾¾', 'å¡ä¼¦æ¶…', 'æ¬§æ ¼ç›', 'å¯†ä¸ç‰¹æ‹‰', 'æ·‘å¦®', 'å¦å¸•æ–¯', 'è´¡å¾·', 'æµ·å§†', 'å…¶ä»–'],
            datasets: [{
                data: [71, 8, 6, 4, 3, 2, 2, 1, 1, 1, 1],
                backgroundColor: [
                    '#D7BE69', // å·´å“ˆå§†ç‰¹ - åœ£æ´é‡‘
                    '#f1c40f', // æ¸¥é‡‘
                    '#f39c12', // æ´›å±±è¾¾
                    '#bdc3c7', // å¡ä¼¦æ¶…
                    '#3498db', // æ¬§æ ¼ç›
                    '#9b59b6', // å¯†ä¸ç‰¹æ‹‰
                    '#e84393', // æ·‘å¦®
                    '#7f8c8d', // å¦å¸•æ–¯
                    '#d35400', // è´¡å¾·
                    '#2980b9', // æµ·å§†
                    '#ecf0f1'  // å…¶ä»–
                ],
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { 
                legend: { position: 'right', labels: { boxWidth: 10, font: { size: 10 } } },
                title: { display: true, text: 'åŸå¸‚ä¿¡ä»°åˆ†å¸ƒ (ç™½é‡‘ç¥è¿¹å)', font: { size: 14 } }
            }
        }
    });
}

    // å¯åŠ¨åˆå§‹åŒ–
    init();
</script>
</body>
</html>
