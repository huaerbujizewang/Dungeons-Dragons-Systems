<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>è‰¾å°”è«ç‘å°” - é¢†åœ°è¡Œæ”¿ç»ˆç«¯</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        :root {
            --bg-color: #f4f1ea; 
            --panel-bg: #ffffff;
            --text-main: #2c3e50;
            --accent-gold: #c5a059; 
            --accent-blue: #34495e;
            --border-color: #dcd6cc;
            --danger-color: #c0392b;
            --success-color: #27ae60;
        }

        body { font-family: "PingFang SC", "Microsoft YaHei", serif; background-color: var(--bg-color); color: var(--text-main); margin: 0; padding: 0; height: 100vh; overflow: hidden; }
        .layout { display: grid; grid-template-columns: 1fr 260px; height: 100%; }
        
        /* å†…å®¹åŒº */
        .main-content { padding: 40px; overflow-y: auto; display: flex; flex-direction: column; }
        .city-header { border-bottom: 2px solid var(--accent-gold); padding-bottom: 15px; margin-bottom: 30px; display: flex; justify-content: space-between; align-items: end; }
        .city-name { font-size: 2.5em; font-weight: bold; letter-spacing: 2px; color: var(--text-main); }
        .city-info { font-size: 0.9em; color: #666; font-family: sans-serif; }

        /* æ¦‚è§ˆ */
        #overview-panel { display: block; animation: fadeIn 0.5s; }
        .kpi-row { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 30px; }
        .kpi-card { background: var(--panel-bg); padding: 20px; border-radius: 4px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); border-top: 4px solid var(--accent-blue); text-align: center; }
        .kpi-value { font-size: 2em; font-weight: bold; margin: 10px 0; }
        .kpi-label { color: #7f8c8d; font-size: 0.9em; text-transform: uppercase; letter-spacing: 1px; }
        .kpi-sub { font-size: 0.8em; font-weight: bold; }

        /* å›¾è¡¨åŒºåŸŸ */
        .charts-row { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px; }
        .chart-box { background: var(--panel-bg); padding: 20px; border-radius: 4px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); position: relative; display: flex; flex-direction: column; }
        .chart-title { text-align: center; font-weight: bold; margin-bottom: 15px; color: var(--accent-blue); border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .canvas-container { position: relative; height: 300px; width: 100%; }

        /* æ•°æ®è¡¨æ ¼æ ·å¼ */
        .data-section { background: var(--panel-bg); padding: 25px; border-radius: 4px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); margin-bottom: 30px; border: 1px solid var(--border-color); }
        .section-header { font-size: 1.2em; font-weight: bold; color: var(--accent-blue); border-left: 5px solid var(--accent-gold); padding-left: 15px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; }
        
        .finance-table, .staff-table { width: 100%; border-collapse: collapse; font-size: 0.95em; }
        .finance-table th, .staff-table th { text-align: left; padding: 12px; background: #f8f9fa; border-bottom: 2px solid #eee; color: #666; }
        .finance-table td, .staff-table td { padding: 12px; border-bottom: 1px solid #eee; }
        .finance-table tr:last-child td { border-bottom: none; }
        
        .amount-col { text-align: right; font-family: monospace; font-weight: bold; }
        .income-text { color: var(--success-color); }
        .expense-text { color: var(--danger-color); }
        .total-row { background: #fdfdfd; font-weight: bold; border-top: 2px solid #ddd; }
        
        .tag-box { display: inline-block; padding: 2px 8px; border-radius: 4px; font-size: 0.8em; background: #eee; color: #555; }

        /* è¯¦æƒ… */
        #detail-panel { display: none; animation: fadeIn 0.3s; height: 100%; }
        .suzerain-container { background: var(--panel-bg); border: 1px solid var(--border-color); box-shadow: 0 10px 30px rgba(0,0,0,0.1); height: 100%; display: flex; flex-direction: column; max-width: 800px; margin: 0 auto; }
        .suz-header { background: var(--accent-blue); color: #fff; padding: 15px; text-align: center; font-size: 1.2em; letter-spacing: 2px; font-weight: bold; border-bottom: 4px solid var(--accent-gold); }
        .suz-list { flex: 1; overflow-y: auto; padding: 20px; background: #fff; }
        .suz-item { padding: 15px; border: 1px solid #eee; margin-bottom: 10px; cursor: pointer; transition: 0.2s; border-left: 4px solid transparent; }
        .suz-item:hover { background: #f9f9f9; border-left-color: #ddd; }
        .suz-item.active { background: #f0f4f8; border-left-color: var(--accent-gold); border-color: var(--accent-gold); }
        .suz-item-title { font-weight: bold; font-size: 1.1em; }
        .suz-desc-box { background: var(--accent-blue); color: #fff; padding: 25px; min-height: 140px; font-size: 0.95em; line-height: 1.6; border-top: 4px solid var(--accent-gold); box-shadow: inset 0 5px 15px rgba(0,0,0,0.2); }

        /* ä¾§è¾¹æ  */
        .sidebar { background: #fff; border-left: 1px solid var(--border-color); padding: 20px 10px; display: flex; flex-direction: column; gap: 8px; box-shadow: -5px 0 20px rgba(0,0,0,0.02); z-index: 10; }
        .menu-btn { display: flex; align-items: center; gap: 12px; padding: 12px 15px; border: none; background: #fdfdfd; color: #666; cursor: pointer; transition: 0.2s; border-radius: 6px; font-size: 0.95em; text-align: left; font-family: inherit; }
        .menu-btn:hover { background: #f4f1ea; color: #333; }
        .menu-btn.active { background: var(--accent-blue); color: #fff; box-shadow: 0 4px 8px rgba(52, 73, 94, 0.2); }
        .menu-icon { width: 24px; text-align: center; }
        .back-link { margin-top: auto; text-align: center; color: #999; text-decoration: none; font-size: 0.8em; padding: 10px; }
        .back-link:hover { color: #333; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

<div class="layout">
    <div class="main-content">
        <div class="city-header">
            <div class="city-name">ALMOREL <span style="font-size:0.5em; font-weight:normal; color:#666;">è‰¾å°”è«ç‘å°”</span></div>
            <div class="city-info" id="date-display">FR1494</div>
        </div>

        <!-- æ¦‚è§ˆé¢æ¿ -->
        <div id="overview-panel">
            <!-- KPI -->
            <div class="kpi-row">
                <div class="kpi-card">
                    <div class="kpi-label">å½“å‰äººå£</div>
                    <div class="kpi-value" id="kpi-pop">6,109</div>
                    <div style="font-size:0.8em; color:green;">â–² ç¨³å®šå¢é•¿</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-label">æœˆåº¦å‡€æ”¶å…¥</div>
                    <div class="kpi-value" id="kpi-income">Calculating...</div>
                    <div class="kpi-sub" id="kpi-income-sub">...</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-label">æ²»å®‰æŒ‡æ•°</div>
                    <div class="kpi-value" style="color:#f39c12;">ä¸­ç­‰</div>
                    <div style="font-size:0.8em; color:#666;">æœ‰äº›è®¸åŠ¨è¡</div>
                </div>
            </div>

            <!-- å›¾è¡¨ -->
            <div class="charts-row">
                <div class="chart-box">
                    <div class="chart-title">ç§æ—æ„æˆ (Demographics)</div>
                    <div class="canvas-container"><canvas id="raceChart"></canvas></div>
                </div>
                <div class="chart-box">
                    <div class="chart-title">å®—æ•™ä¿¡ä»° (Religion)</div>
                    <div class="canvas-container"><canvas id="faithChart"></canvas></div>
                </div>
            </div>

            <!-- è´¢åŠ¡è¯¦æƒ… -->
            <div class="data-section">
                <div class="section-header">
                    <span>ğŸ“œ æœˆåº¦è´¢æ”¿æ”¶æ”¯è¯¦å•</span>
                    <span style="font-size:0.8em; color:#666; font-weight:normal;">å•ä½: é‡‘å¸ (GP)</span>
                </div>
                <table class="finance-table">
                    <thead>
                        <tr><th>é¡¹ç›®</th><th>è¯´æ˜</th><th class="amount-col">é‡‘é¢</th></tr>
                    </thead>
                    <tbody id="finance-table-body">
                        <!-- JS å¡«å…… -->
                    </tbody>
                </table>
            </div>

            <!-- äººå‘˜è¯¦æƒ… -->
            <div class="data-section">
                <div class="section-header">
                    <span>ğŸ‘¥ åŸå¸‚èŒå‘˜ç¼–åˆ¶ (ä¸å«ç‰¹æ®Šé›‡å‘˜)</span>
                </div>
                <table class="staff-table">
                    <thead>
                        <tr><th>èŒèƒ½</th><th>äººæ•°</th><th>æœˆè–ªæ ‡å‡†</th><th class="amount-col">æœˆåº¦æ€»æ”¯å‡º</th></tr>
                    </thead>
                    <tbody id="staff-table-body">
                        <!-- JS å¡«å…… -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- è¯¦æƒ…é¢æ¿ -->
        <div id="detail-panel">
            <div class="suzerain-container">
                <div class="suz-header" id="suz-title">...</div>
                <div class="suz-list" id="suz-list"></div>
                <div class="suz-desc-box" id="suz-desc">è¯·ä»ä¸Šæ–¹é€‰æ‹©ä¸€é¡¹æ¡ç›®ä»¥æŸ¥çœ‹è¯¦ç»†æŠ¥å‘Šã€‚</div>
            </div>
        </div>
    </div>

    <div class="sidebar">
        <button class="menu-btn active" onclick="showOverview()"><span class="menu-icon">ğŸ“Š</span> åŸå¸‚æ¦‚è§ˆ</button>
        <div style="height:1px; background:#eee; margin:5px 0;"></div>
        <button class="menu-btn" onclick="showCategory('economy')"><span class="menu-icon">ğŸ’°</span> ç»æµ</button>
        <button class="menu-btn" onclick="showCategory('law')"><span class="menu-icon">âš–ï¸</span> æ³•å¾‹</button>
        <button class="menu-btn" onclick="showCategory('military')"><span class="menu-icon">âš”ï¸</span> å†›äº‹</button>
        <button class="menu-btn" onclick="showCategory('welfare')"><span class="menu-icon">â¤ï¸</span> ç¦åˆ©</button>
        <button class="menu-btn" onclick="showCategory('order')"><span class="menu-icon">ğŸ‘®</span> æ²»å®‰</button>
        <button class="menu-btn" onclick="showCategory('diplomacy')"><span class="menu-icon">ğŸ¤</span> å¤–äº¤</button>
        <a href="index.html" class="back-link">â¬… è¿”å›ä¸»æ§å°</a>
    </div>
</div>

<script>
    const SUPABASE_URL = 'https://vbzfpgucpciqgaakqndz.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZiemZwZ3VjcGNpcWdhYWtxbmR6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc1OTc2MzMsImV4cCI6MjA4MzE3MzYzM30.fBVDirEJ52bvrYJZ5DNv7fVDLNgCwITKwdKqT6YJDYw';
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // ================== åŸºç¡€æ•°æ®åº“ ==================
    
    // 1. åŸå¸‚åŸºç¡€æ•°æ®
    const cityStats = {
        population: 6109,
        subsidy: 800, 
        employee_expense: 0 // â³ å¾…åŒæ­¥...
    };

    // 2. èŒå‘˜è¡¨ - åŸå¸‚å›ºå®šç¼–åˆ¶
    const staffData = [
        { role: "åŸå«é˜Ÿ (è€å…µ)", count: 18, wage: 60 },
        { role: "åŸå«é˜Ÿ (å«å…µ)", count: 106, wage: 30 },
        { role: "å¸‚æ”¿æ–‡èŒäººå‘˜", count: 40, wage: 60 },
        { role: "å¸‚æ”¿æ‚å·¥", count: 50, wage: 10 }
    ];

    // 3. å»ºç­‘ç»´æŠ¤è¡¨ - åŸå¸‚å›ºå®šè®¾æ–½
    const buildingData = [
        { name: "å…¬å‘Šæ ", cost: 1 },
        { name: "ä¸­å¤®å¡”æ¥¼", cost: 100 },
        { name: "å…‹è±é—¨æ±€åºœé‚¸", cost: 150 },
        { name: "å¸‚æ”¿ä»“åº“", cost: 50 },
        { name: "ç§æ¤å›­", cost: 50 },
        { name: "é€šç”¨å·¥åŠ", cost: 50 },
        { name: "é“åŒ é“º", cost: 50 },
        { name: "å¥¥æœ¯ç ”ç©¶å®¤", cost: 50 },
        { name: "å†›æ¢°åº“", cost: 50 },
        { name: "åŸé˜²å…µè¥", cost: 50 },
        { name: "å†’é™©è€…å…¬ä¼š", cost: 100 },
        { name: "åŸå¢™ç»´æŠ¤", cost: 100 },
        { name: "é“è·¯ç»´æŠ¤", cost: 50 },
        { name: "ä¸‹æ°´é“ä¸ä¾›æ°´ç³»ç»Ÿ", cost: 150 },
        { name: "æ­¦å¤‡ç»´æŠ¤", cost: 30 },
        { name: "è‰¾ç³çš„å·¥åŠ", cost: 50 },
        { name: "å‘˜å·¥å®¿èˆ", cost: 100 },
        { name: "æ‚é¡¹é‡‡è´­å¤‡ç”¨é‡‘", cost: 500 }
    ];

    const dataStore = {
        'military': {
            title: "MILITARY / å†›äº‹æ¦‚å†µ",
            items: [
                { title: "è±¡å¾æ€§å…µå½¹åˆ¶", desc: "æ‰€æœ‰é€‚é¾„äººå£åœ¨è¾¾åˆ° 18 å²æ—¶å¿…é¡»æœå½¹2ä¸ªæœˆã€‚è¿™ç¡®ä¿äº†åœ¨è¾¹å¢ƒå†²çªé¢‘ç¹çš„åŠ¨è¡å¹´ä»£ï¼ŒåŸå¸‚å§‹ç»ˆä¿æœ‰å……è¶³çš„å…µå‘˜å‚¨å¤‡ã€‚" },
                { title: "ä½èƒ½çš„å‚è°‹éƒ¨", desc: "è™½ç„¶åä¹‰ä¸Šæ‹¥æœ‰å‚è°‹æŒ‡æŒ¥ç³»ç»Ÿï¼Œä½†ç”±äºä¹‹å‰çš„æˆ˜äº‰ï¼Œå¯¼è‡´ç¼ºä¹ç»éªŒä¸°å¯Œçš„é«˜çº§å†›å®˜å’Œå®æˆ˜å†ç»ƒï¼Œç›®å‰çš„å‚è°‹éƒ¨ååº”è¿Ÿé’ï¼Œå†³ç­–å¾€å¾€æ»åäºæˆ˜åœºå½¢åŠ¿ã€‚" },
                { title: "ä¸­å¤®å°–å¡”", desc: "è¿™æ˜¯è‰¾å°”è«ç‘å°”æœ€ä»¤äººæ•¬ç•çš„é˜²å¾¡æ ¸å¿ƒã€‚è¿™åº§é­”æ³•å°–å¡”èƒ½å¤Ÿå‘å…¨åŸèŒƒå›´é‡Šæ”¾æ¯ç­æ€§çš„é—ªç”µé£æš´ã€‚" }
            ]
        },
        'economy': {
            title: "ECONOMY / ç»æµæ¦‚å†µ",
            items: [
                { title: "é­”æ³•ç‰©å“è´¸æ˜“", desc: "åŸå¸‚ä¸é­”æ³•å›½åº¦å“ˆé²é˜¿è¾¾æˆäº†å…³é”®è´¸æ˜“åå®šï¼šè‰¾å°”è«ç‘å°”æ¯ä¸ƒå¤©å‘å…¶ä¾›ç»™ä¸¤ä»¶éæ™®é€šçº§é­”æ³•ç‰©å“ã€‚ä½œä¸ºå›æŠ¥ï¼Œå“ˆé²é˜¿è´Ÿè´£ä¾›ç»™ç»´æŒ 5000 äººç”Ÿå­˜çš„ç²®é£Ÿã€‚" },
                { title: "ç²®é£Ÿä¾èµ–", desc: "æœ¬åœ°å†œä¸šäº§å‡ºä¸è¶³ä»¥ç»´æŒäººå£æ¶ˆè€—ï¼ŒåŸå¸‚å‘½è„‰å®Œå…¨ç³»äºé­”æ³•ç‰©å“è´¸æ˜“ã€‚ä¸€æ—¦é­”æ³•å·¥åŠåœäº§æˆ–è´¸æ˜“è·¯çº¿è¢«åˆ‡æ–­ï¼Œé¥¥è’å°†ä¸å¯é¿å…ã€‚" },
                { title: "è´¢æ”¿èµ¤å­—", desc: "è´¸æ˜“è·¯çº¿çš„ä¸­æ–­å’Œä¸¥å³»çš„åœ°ç†ä½ç½®å¯¼è‡´å›½åº“ç©ºè™šã€‚" }
            ]
        },
        'law': {
            title: "LAW / æ³•å¾‹ä¸æ”¿ç­–",
            items: [
                { title: "å¸‚è®®ä¼šèŒèƒ½æš‚åœ", desc: "é‰´äºå½“å‰çš„ç´§æ€¥çŠ¶æ€ï¼Œæ°‘é€‰å¸‚è®®ä¼šçš„ç«‹æ³•ä¸å†³ç­–èŒèƒ½å·²è¢«æ— é™æœŸå†»ç»“ã€‚æ‰€æœ‰è¡Œæ”¿å‘½ä»¤ç›´æ¥ç”±é¢†ä¸»åºœç­¾å‘ã€‚" },
                { title: "åŸä¸»è±å…æƒ", desc: "æ³•å¾‹æ˜ç¡®è§„å®šï¼Œç°ä»»åŸä¸»åœ¨è¡Œä½¿èŒæƒæ—¶äº«æœ‰å®Œå…¨çš„å¸æ³•è±å…æƒã€‚è¿™ä¸€æ¡æ¬¾ç¡®ä¿äº†å†³ç­–å±‚çš„ç»å¯¹æƒå¨ã€‚" },
                { title: "ä¸­ç­‰ç¨æ”¶", desc: "å®è¡Œå¹³æ‘Šå¼çš„ä¸­ç­‰ç¨ç‡ã€‚æ—¢æ²¡æœ‰è¿‡åˆ†å‹æ¦¨å•†äººå’Œå¸‚æ°‘ï¼Œä¹Ÿæœªèƒ½é€šè¿‡é«˜ç¨æ”¶å¿«é€Ÿå……ç›ˆå›½åº“ã€‚è¿™æ˜¯ä¸€ç§æ¸©å’Œä½†å¹³åº¸çš„è´¢æ”¿æ‰‹æ®µã€‚" },
                { title: "æ–°é—»ä¸è¨€è®ºè‡ªç”±", desc: "å°½ç®¡å¤„äºé›†æƒçŠ¶æ€ï¼ŒåŸå¸‚ä¾ç„¶ä¿ç•™äº†æƒŠäººçš„è¨€è®ºè‡ªç”±åº¦ã€‚æŠ¥çº¸ã€åŸæ¸¸è¯—äººå’Œè¡—å¤´æ¼”è¯´å®¶å¯ä»¥è‡ªç”±è¯„è®ºæ—¶æ”¿ã€‚" },
                { title: "å®—æ•™ä¿¡ä»°è‡ªç”±", desc: "è¿™æ›¾æ˜¯è‰¾å°”è«ç‘å°”ç¹è£çš„åŸºçŸ³ï¼Œä¹Ÿæ˜¯å¦‚ä»Šä¿¡ä»°æ··æ‚çš„åŸå› ã€‚åªè¦ä¸è¿›è¡Œè¡€ç¥­æˆ–å¬å”¤æ¶é­”ï¼Œä»»ä½•ç¥ç¥‡çš„ä¿¡å¾’éƒ½èƒ½åœ¨æ­¤æ‰¾åˆ°ä¸€å¸­ä¹‹åœ°ã€‚" }
            ]
        },
        'welfare': { 
            title: "WELFARE / ç¤¾ä¼šç¦åˆ©", 
            items: [
                { title: "å››å¹´ä¹‰åŠ¡æ•™è‚²", desc: "é¢†åœ°ä¸ºæ‰€æœ‰é€‚é¾„å„¿ç«¥æä¾›ä¸ºæœŸå››å¹´çš„å…è´¹åŸºç¡€æ•™è‚²ï¼Œæ¶µç›–é€šç”¨è¯­è¯»å†™ã€ç®—æœ¯ä¸åŸºç¡€å†å²ã€‚è¿™æ˜¾è‘—æé«˜äº†å¸‚æ°‘çš„è¯†å­—ç‡ã€‚" },
                { title: "å…è´¹ä¸§è‘¬æœåŠ¡", desc: "ç”±å¸‚æ”¿å…å‡ºèµ„ï¼Œç¡®ä¿æ¯ä½é€è€…éƒ½èƒ½å¾—åˆ°ä½“é¢çš„å®‰è‘¬ã€‚è¿™ä¸ä»…æ˜¯å¯¹ç”Ÿå‘½çš„å°Šé‡ï¼Œä¹Ÿæ˜¯ä¸ºäº†é˜²æ­¢äº¡çµç˜Ÿç–«åœ¨è´«æ°‘çªŸæ»‹ç”Ÿçš„ä¸€é¡¹å…¬å…±å«ç”Ÿæªæ–½ã€‚" }
            ] 
        },
        'order': { 
            title: "ORDER / æ²»å®‰", 
            items: [
                { title: "ä½èƒ½çš„æ²»å®‰å®˜", desc: "ç›®å‰çš„æ²»å®‰å®˜ç¼ºä¹å¤„ç†å¤æ‚çŠ¯ç½ªçš„èƒ½åŠ›ï¼Œå¾€å¾€åªèƒ½åº”å¯¹é†‰é…’æ–—æ®´æˆ–å°å·å°æ‘¸ã€‚é¢å¯¹æœ‰ç»„ç»‡çš„é»‘å¸®æ´»åŠ¨æˆ–é­”æ³•çŠ¯ç½ªæ—¶ï¼Œæ²»å®‰é˜Ÿæ˜¾å¾—åŠ›ä¸ä»å¿ƒï¼Œç”šè‡³éœ€è¦å†’é™©è€…å…¬ä¼šä»£åŠ³ã€‚" }
            ] 
        },
        'diplomacy': { 
            title: "DIPLOMACY / å¤–äº¤å…³ç³»", 
            items: [
                { title: "è±ç‘Ÿæ›¼é“ç›Ÿ", desc: "ç­¾è®¢äº†å…±åŒé˜²å¾¡æ¡çº¦ï¼Œä¸é¥è¿œçš„è±ç‘Ÿæ›¼ç¼”ç»“äº†åšä¸å¯æ‘§çš„å†›äº‹åŒç›Ÿã€‚" }
            ] 
        }
    };

    // ================== æ ¸å¿ƒé€»è¾‘ ==================

    async function init() {
        const { data: { user } } = await supabaseClient.auth.getUser();
        if (!user) { alert('è¯·å…ˆç™»å½•'); window.location.href = 'index.html'; return; }
        renderCharts();
        
        // åŒæ­¥é›‡å‘˜æ•°æ®
        await syncEmployeeData(user.id);
        
        // è®¡ç®—ç»æµ
        calculateEconomy();
    }

    // åŒæ­¥æ ¸å¿ƒå›¢é˜Ÿæ”¯å‡º
    async function syncEmployeeData(userId) {
        // å» employees è¡¨æŸ¥è¯¢è¯¥ç”¨æˆ·ä¸‹æ‰€æœ‰â€œåœ¨èŒâ€çš„é›‡å‘˜
        const { data, error } = await supabaseClient
            .from('employees')
            .select('salary')
            .eq('user_id', userId)
            .eq('status', 'åœ¨èŒ'); // åªæœ‰åœ¨èŒçš„æ‰å‘å·¥èµ„

        if (error) {
            console.error("æ— æ³•åŒæ­¥é›‡å‘˜æ•°æ®:", error);
            // å¦‚æœå‡ºé”™ï¼Œä¿æŒä¸º 0 æˆ–è€…æç¤º
            return;
        }

        // è®¡ç®—æ€»å’Œ
        const totalSalary = data.reduce((sum, emp) => sum + emp.salary, 0);
        
        // æ›´æ–°å…¨å±€é…ç½®
        cityStats.employee_expense = totalSalary;
        
        console.log(`å·²åŒæ­¥æ ¸å¿ƒå›¢é˜Ÿæ”¯å‡º: ${totalSalary} GP`);
    }

    // è®¡ç®—å¹¶æ¸²æŸ“æ‰€æœ‰è´¢åŠ¡æ•°æ®
    function calculateEconomy() {
        const taxIncome = Math.ceil(cityStats.population * 1.2);
        const subsidyIncome = cityStats.subsidy;
        const totalIncome = taxIncome + subsidyIncome;

        let staffExpense = 0;
        const staffTbody = document.getElementById('staff-table-body');
        staffTbody.innerHTML = '';
        
        staffData.forEach(s => {
            const subTotal = s.count * s.wage;
            staffExpense += subTotal;
            staffTbody.innerHTML += `
                <tr>
                    <td>${s.role}</td>
                    <td>${s.count} äºº</td>
                    <td>${s.wage} GP</td>
                    <td class="amount-col expense-text">-${subTotal}</td>
                </tr>`;
        });

        let buildingExpense = 0;
        buildingData.forEach(b => buildingExpense += b.cost);

        //  cityStats.employee_expense æ˜¯å®æ—¶åŒæ­¥è¿‡æ¥çš„æ•°æ®
        const totalExpense = staffExpense + buildingExpense + cityStats.employee_expense;
        const netIncome = totalIncome - totalExpense;

        const financeTbody = document.getElementById('finance-table-body');
        financeTbody.innerHTML = `
            <tr>
                <td>ç¨æ”¶æ”¶å…¥</td>
                <td>äººå£ ${cityStats.population} * 1.2</td>
                <td class="amount-col income-text">+${taxIncome}</td>
            </tr>
            <tr>
                <td>è±ç‘Ÿæ›¼è¡¥è´´</td>
                <td>å¤–äº¤æ´åŠ©</td>
                <td class="amount-col income-text">+${subsidyIncome}</td>
            </tr>
            <tr style="background:#f0f9f0; font-weight:bold;">
                <td colspan="2">æ”¶å…¥å°è®¡</td>
                <td class="amount-col income-text">+${totalIncome}</td>
            </tr>
            <tr>
                <td>åŸå¸‚èŒå‘˜è–ªèµ„</td>
                <td>å«å…µ/æ–‡èŒ/æ‚å·¥</td>
                <td class="amount-col expense-text">-${staffExpense}</td>
            </tr>
            <tr>
                <td>åŸºç¡€è®¾æ–½ç»´æŠ¤</td>
                <td>å« ${buildingData.length} é¡¹å»ºç­‘è®¾æ–½</td>
                <td class="amount-col expense-text">-${buildingExpense}</td>
            </tr>
            <tr>
                <td>æ ¸å¿ƒå›¢é˜Ÿæ”¯å‡º</td>
                <td>é›‡å‘˜ä¸­å¿ƒ (å®æ—¶åŒæ­¥)</td> <!-- æç¤ºæ–‡æœ¬æ›´æ–° -->
                <td class="amount-col expense-text">-${cityStats.employee_expense}</td>
            </tr>
            <tr style="background:#fff0f0; font-weight:bold;">
                <td colspan="2">æ”¯å‡ºå°è®¡</td>
                <td class="amount-col expense-text">-${totalExpense}</td>
            </tr>
            <tr class="total-row">
                <td colspan="2" style="font-size:1.1em;">æœˆåº¦å‡€åˆ©æ¶¦ (Net Income)</td>
                <td class="amount-col" style="font-size:1.2em; color:${netIncome >= 0 ? '#27ae60' : '#c0392b'};">
                    ${netIncome} GP
                </td>
            </tr>
        `;

        const kpiIncomeEl = document.getElementById('kpi-income');
        const kpiSubEl = document.getElementById('kpi-income-sub');
        
        kpiIncomeEl.innerText = `${netIncome} GP`;
        kpiIncomeEl.style.color = netIncome >= 0 ? '#27ae60' : '#c0392b';
        
        if (netIncome < 0) {
            kpiSubEl.innerText = 'âš ï¸ è´¢æ”¿èµ¤å­—';
            kpiSubEl.style.color = '#c0392b';
        } else {
            kpiSubEl.innerText = 'âœ… è´¢æ”¿å¥åº·';
            kpiSubEl.style.color = '#27ae60';
        }
    }

    // UI åˆ‡æ¢ä¸ renderCharts å‡½æ•°
    function showOverview() {
        document.getElementById('overview-panel').style.display = 'block';
        document.getElementById('detail-panel').style.display = 'none';
        updateActiveBtn(document.querySelector("button[onclick='showOverview()']"));
    }

    function showCategory(key) {
        document.getElementById('overview-panel').style.display = 'none';
        document.getElementById('detail-panel').style.display = 'block';
        
        const data = dataStore[key];
        document.getElementById('suz-title').innerText = data.title;
        const listEl = document.getElementById('suz-list');
        const descEl = document.getElementById('suz-desc');
        
        listEl.innerHTML = '';
        descEl.innerText = "è¯·ä»ä¸Šæ–¹é€‰æ‹©ä¸€é¡¹æ¡ç›®ä»¥æŸ¥çœ‹è¯¦ç»†æŠ¥å‘Šã€‚";

        data.items.forEach(item => {
            const div = document.createElement('div');
            div.className = 'suz-item';
            div.innerHTML = `<div class="suz-item-title">${item.title}</div>`;
            div.onclick = function() {
                document.querySelectorAll('.suz-item').forEach(i => i.classList.remove('active'));
                div.classList.add('active');
                descEl.innerText = item.desc;
            };
            listEl.appendChild(div);
        });

        const btn = document.querySelector(`button[onclick="showCategory('${key}')"]`);
        updateActiveBtn(btn);
    }

    function updateActiveBtn(activeBtn) {
        document.querySelectorAll('.menu-btn').forEach(b => b.classList.remove('active'));
        if(activeBtn) activeBtn.classList.add('active');
    }

    function renderCharts() {
        new Chart(document.getElementById('raceChart'), {
            type: 'doughnut',
            data: {
                labels: ['äººç±»', 'çŸ®äºº', 'åŠç²¾çµ', 'ç²¾çµ', 'åœ°ç²¾', 'ä¾å„’', 'å…½äºº', 'ç‹å¦–'],
                datasets: [{
                    data: [71, 12, 7, 3, 3, 2, 1, 1],
                    backgroundColor: ['#2c3e50', '#7f8c8d', '#e67e22', '#27ae60', '#8e44ad', '#f1c40f', '#c0392b', '#ff9ff3'],
                    borderWidth: 0
                }]
            },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right', labels: { boxWidth: 12, font: { size: 11 } } } } }
        });

        new Chart(document.getElementById('faithChart'), {
            type: 'pie',
            data: {
                labels: ['æ¸¥é‡‘', 'æ¬§æ ¼ç›', 'æ·‘å¦®', 'å¯†ä¸ç‰¹æ‹‰', 'æ´›å±±è¾¾', 'é˜¿æ–¯è’™è’‚æ–¯', 'å¦å¸•æ–¯', 'è´¡å¾·', 'æµ·å§†', 'çº¢éª‘å£«', 'å¡ä¼¦æ¶…', 'è¨å¼—æ‹‰æ–¯'],
                datasets: [{
                    data: [21, 12, 10, 9, 8, 7, 6, 6, 6, 5, 5, 5],
                    backgroundColor: ['#f1c40f', '#3498db', '#e84393', '#9b59b6', '#f39c12', '#c0392b', '#7f8c8d', '#d35400', '#2980b9', '#c0392b', '#bdc3c7', '#16a085'],
                    borderWidth: 0
                }]
            },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right', labels: { boxWidth: 10, font: { size: 10 } } } } }
        });
    }

    init();
</script>
</body>
</html>

